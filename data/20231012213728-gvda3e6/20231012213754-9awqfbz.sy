{"ID":"20231012213754-9awqfbz","Spec":"1","Type":"NodeDocument","Properties":{"id":"20231012213754-9awqfbz","scroll":"\u0026#123;\u0026quot;rootId\u0026quot;:\u0026quot;20231012213754-9awqfbz\u0026quot;,\u0026quot;startId\u0026quot;:\u0026quot;20231012213754-bzrf8x3\u0026quot;,\u0026quot;endId\u0026quot;:\u0026quot;20231012223005-6mtee9e\u0026quot;,\u0026quot;scrollTop\u0026quot;:13832.6669921875\u0026#125;","tags":"公众号-网络技术平台,K8s,K8s 网络","title":"K8s 网络","updated":"20231012223014"},"Children":[{"ID":"20231012213754-bzrf8x3","Type":"NodeParagraph","Properties":{"id":"20231012213754-bzrf8x3","updated":"20231012213926"},"Children":[{"Type":"NodeText","Data":"本文将探讨 Kubernetes 中的网络模型，以及对各种网络模型进行分析。"}]},{"ID":"20231012213932-ti5pek4","Type":"NodeParagraph","Properties":{"id":"20231012213932-ti5pek4"}},{"ID":"20231012213958-cyz2j5z","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20231012213958-cyz2j5z","updated":"20231012214009"},"Children":[{"Type":"NodeText","Data":"Underlay Network Model"}]},{"ID":"20231012214009-340f8bv","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20231012214009-340f8bv","updated":"20231012214032"},"Children":[{"Type":"NodeText","Data":"什么是 Underlay Network"}]},{"ID":"20231012214032-xtmejo1","Type":"NodeParagraph","Properties":{"id":"20231012214032-xtmejo1","updated":"20231012214137"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"底层网络 Underlay Network 顾名思义是指网络设备基础设施，如交换机，路由器"},{"Type":"NodeText","Data":", DWDM 使用网络介质将其链接成的物理网络拓扑，负责网络之间的数据包传输。"}]},{"ID":"20231012214742-ejmjzym","Type":"NodeParagraph","Properties":{"id":"20231012214742-ejmjzym","updated":"20231012214742"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012214742-jh3ymtu.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012214839-kja27v3","Type":"NodeParagraph","Properties":{"id":"20231012214839-kja27v3","updated":"20231012214839"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"underlay network 可以是二层，也可以是三层"},{"Type":"NodeText","Data":"；二层的典型例子是以太网 Ethernet，三层是的典型例子是互联网 Internet。"}]},{"ID":"20231012214839-ss6n390","Type":"NodeParagraph","Properties":{"id":"20231012214839-ss6n390","updated":"20231012214839"},"Children":[{"Type":"NodeText","Data":"而工作于二层的技术是 vlan，工作在三层的技术是由 OSPF, BGP 等协议组成。"}]},{"ID":"20231012214842-u9cg13n","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20231012214842-u9cg13n","updated":"20231012214859"},"Children":[{"Type":"NodeText","Data":"k8s 中的 underlay network"}]},{"ID":"20231012214859-awvv6wt","Type":"NodeParagraph","Properties":{"id":"20231012214859-awvv6wt","updated":"20231012215418"},"Children":[{"Type":"NodeText","Data":"在Kubernetes 中， underlay network 中比较典型的例子是通过将宿主机作为路由器设备， Pod 的网络则通过学习路由条目从而实现跨节点通讯。"}]},{"ID":"20231012215546-0q5yyg6","Type":"NodeParagraph","Properties":{"id":"20231012215546-0q5yyg6","updated":"20231012215546"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012215546-syf6cps.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012215558-iti3nds","Type":"NodeParagraph","Properties":{"id":"20231012215558-iti3nds","updated":"20231012215559"},"Children":[{"Type":"NodeText","Data":"这种模型下"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"典型的有 flannel 的 host-gw 模式与 calico BGP 模式"},{"Type":"NodeText","Data":"。"}]},{"ID":"20231012215615-1lkpnrp","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20231012215615-1lkpnrp","updated":"20231012215623"},"Children":[{"Type":"NodeText","Data":"flannel host-gw"}]},{"ID":"20231012215623-kz4nrnq","Type":"NodeParagraph","Properties":{"id":"20231012215623-kz4nrnq","updated":"20231012215838"},"Children":[{"Type":"NodeText","Data":"flannel host-gw 模式中每个 Node 需要在同一个二层网络中，并将Node 作为一个路由器，跨节点通讯将通过路由表方式进行，这样方式下将网络模拟成一个 underlay network。"}]},{"ID":"20231012215956-tymxdg6","Type":"NodeParagraph","Properties":{"id":"20231012215956-tymxdg6","updated":"20231012220003"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012215956-aq8hdup.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012220007-25lptkv","Type":"NodeBlockquote","Properties":{"id":"20231012220007-25lptkv","updated":"20231012220135"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20231012220007-wipm9g9","Type":"NodeParagraph","Properties":{"id":"20231012220007-wipm9g9","updated":"20231012220135"},"Children":[{"Type":"NodeText","Data":"Notes： "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"通过路由方式，集群的cidr 至少要配置 16，"},{"Type":"NodeText","Data":"因为这样可以保证，跨节点的Node 作为一层网络，同节点的 Pod 作为一个网络。如果不是这种用情况，路由表处于相同的网络中，会存在网络不可达"}]}]},{"ID":"20231012220136-eyuiqqu","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20231012220136-eyuiqqu","updated":"20231012220150"},"Children":[{"Type":"NodeText","Data":"Calico BGP"}]},{"ID":"20231012220150-mi8rtcw","Type":"NodeParagraph","Properties":{"id":"20231012220150-mi8rtcw","updated":"20231012220157"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"BGP（Border Gateway Protocol）是去中心化自治路由协议"},{"Type":"NodeText","Data":"。它是通过维护 IP 路由表或前缀表来实现 AS （Autonomous System）之间的可访问性，属于向量路由协议。"}]},{"ID":"20231012220207-2h03cm6","Type":"NodeParagraph","Properties":{"id":"20231012220207-2h03cm6","updated":"20231012220207"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012220206-07cwd32.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012220225-vyq6kdb","Type":"NodeParagraph","Properties":{"id":"20231012220225-vyq6kdb","updated":"20231012220225"},"Children":[{"Type":"NodeText","Data":"与 flannel 不同的是，"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Calico 提供了的 BGP 网络解决方案"},{"Type":"NodeText","Data":"，在网络模型上，Calico 与 Flannel host-gw 是近似的，但在软件架构的实现上，"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"flannel 使用 flanneld 进程来维护路由信息"},{"Type":"NodeText","Data":"；而 Calico 是包含多个守护进程的，其中 Brid 进程是一个 BGP 客户端与路由反射器(Router Reflector)，BGP 客户端负责从 Felix 中获取路由并分发到其他 BGP Peer，而反射器在 BGP 中起了优化的作用。在同一个 IBGP 中，BGP 客户端仅需要和一个 RR 相连，这样减少了AS内部维护的大量的 BGP 连接。通常情况下，RR 是真实的路由设备，而 Bird 作为 BGP 客户端工作。"}]},{"ID":"20231012220236-jlzwudv","Type":"NodeParagraph","Properties":{"id":"20231012220236-jlzwudv","updated":"20231012220236"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012220236-yq1t3v9.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012220301-dyofq4j","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20231012220301-dyofq4j","updated":"20231012220320"},"Children":[{"Type":"NodeText","Data":"IPVLAN \u0026 MACVLAN"}]},{"ID":"20231012220321-5zpal3w","Type":"NodeParagraph","Properties":{"id":"20231012220321-5zpal3w","updated":"20231012220332"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"IPVLAN 和 MACVLAN 是一种网卡虚拟化技术"},{"Type":"NodeText","Data":"，两者之间的区别为， "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"IPVLAN 允许一个物理网卡拥有多个 IP 地址"},{"Type":"NodeText","Data":"，并且所有的虚拟接口"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"用同一个 MAC 地址"},{"Type":"NodeText","Data":"；而 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"MACVLAN 则是相反的，其允许同一个网卡拥有多个 MAC 地址"},{"Type":"NodeText","Data":"，而虚拟出的网卡可以"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"没有 IP 地址"},{"Type":"NodeText","Data":"。"}]},{"ID":"20231012220339-51l0w54","Type":"NodeParagraph","Properties":{"id":"20231012220339-51l0w54","updated":"20231012220339"},"Children":[{"Type":"NodeText","Data":"因为是网卡虚拟化技术，而不是网络虚拟化技术，本质上来说属于 Overlay network，这种方式在虚拟化环境中"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"与 Overlay network 相比最大的特点就是可以将 Pod 的网络拉平到 Node 网络同级"},{"Type":"NodeText","Data":"，从而提供更高的性能、低延迟的网络接口。本质上来说其网络模型属于下图中第二个。"}]},{"ID":"20231012220427-h1elqqn","Type":"NodeParagraph","Properties":{"id":"20231012220427-h1elqqn","updated":"20231012220427"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012220427-b87fy4h.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012220526-yhxk2dg","Type":"NodeList","ListData":{},"Properties":{"id":"20231012220526-yhxk2dg","updated":"20231012220526"},"Children":[{"ID":"20231012220526-hwh0nya","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231012220526-hwh0nya","updated":"20231012220526"},"Children":[{"ID":"20231012220526-hu2qara","Type":"NodeParagraph","Properties":{"id":"20231012220526-hu2qara","updated":"20231012220526"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"虚拟网桥"},{"Type":"NodeText","Data":"：创建一个虚拟网卡对(veth pair)，一头在容器内，一头在宿主机的 root namespaces 内。这样一来容器内发出的数据包可以通过网桥直接进入宿主机网络栈，而发往容器的数据包也可以经过网桥进入容器。"}]}]},{"ID":"20231012220526-jari3l3","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231012220526-jari3l3","updated":"20231012220526"},"Children":[{"ID":"20231012220526-wf9w24k","Type":"NodeParagraph","Properties":{"id":"20231012220526-wf9w24k","updated":"20231012220559"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"多路复用"},{"Type":"NodeText","Data":"：使用一个中间网络设备，暴露多个虚拟网卡接口，容器网卡都可以介入这个中间设备，并通过 MAC/IP 地址来区分 packet 应该发往哪个容器设备。"}]}]},{"ID":"20231012220526-3ythok8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231012220526-3ythok8","updated":"20231012220526"},"Children":[{"ID":"20231012220526-49333x4","Type":"NodeParagraph","Properties":{"id":"20231012220526-49333x4","updated":"20231012220603"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"硬件交换"},{"Type":"NodeText","Data":"，为每个 Pod 分配一个虚拟网卡，这样一来，Pod 与 Pod 之间的连接关系就会变得非常清晰，因为近乎物理机之间的通信基础。如今大多数网卡都支持 SR-IOV 功能，该功能将单一的物理网卡虚拟成多个 VF 接口，每个 VF 接口都有单独的虚拟 PCIe 通道，这些虚拟的 PCIe 通道共用物理网卡的 PCIe 通道。"}]}]}]},{"ID":"20231012220649-ht21x7z","Type":"NodeParagraph","Properties":{"id":"20231012220649-ht21x7z","updated":"20231012220649"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"在 kubernetes 中 IPVLAN 这种网络模型下典型的 CNI 有，multus 与 danm"},{"Type":"NodeText","Data":"。"}]},{"ID":"20231012220651-hhsj8yp","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20231012220651-hhsj8yp","updated":"20231012220655"},"Children":[{"Type":"NodeText","Data":"multus"}]},{"ID":"20231012220656-cq4o4tq","Type":"NodeParagraph","Properties":{"id":"20231012220656-cq4o4tq","updated":"20231012221509"},"Children":[{"Type":"NodeText","Data":"multus 是 intel 开源的 CNI 方案，是由传统的 cni 与 multus，并且提供了 SR-IOV CNI 插件使 K8s pod 能够连接到 SR-IOV VF 。这是使用了 IPVLAN/MACVLAN 的功能。"}]},{"ID":"20231012221534-yfz0nx9","Type":"NodeParagraph","Properties":{"id":"20231012221534-yfz0nx9","updated":"20231012221534"},"Children":[{"Type":"NodeText","Data":"当创建新的 Pod 后，SR-IOV 插件开始工作。配置 VF 将被移动到新的 CNI 名称空间。该插件根据 CNI 配置文件中的 “name” 选项设置接口名称。最后将 VF 状态设置为 UP。"}]},{"ID":"20231012221534-ia33k5o","Type":"NodeParagraph","Properties":{"id":"20231012221534-ia33k5o","updated":"20231012221534"},"Children":[{"Type":"NodeText","Data":"下图是一个 Multus 和 SR-IOV CNI 插件的网络环境，具有三个接口的 pod。"}]},{"ID":"20231012221534-dk5rk8f","Type":"NodeList","ListData":{},"Properties":{"id":"20231012221534-dk5rk8f","updated":"20231012221534"},"Children":[{"ID":"20231012221534-pkyv49u","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231012221534-pkyv49u","updated":"20231012221534"},"Children":[{"ID":"20231012221534-ca4h8cu","Type":"NodeParagraph","Properties":{"id":"20231012221534-ca4h8cu","updated":"20231012221534"},"Children":[{"Type":"NodeText","Data":"• eth0 是 flannel 网络插件，也是作为 Pod 的默认网络"}]}]},{"ID":"20231012221534-et1pl6b","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231012221534-et1pl6b","updated":"20231012221534"},"Children":[{"ID":"20231012221534-jmjrasu","Type":"NodeParagraph","Properties":{"id":"20231012221534-jmjrasu","updated":"20231012221534"},"Children":[{"Type":"NodeText","Data":"• VF 是主机的物理端口 ens2f0 的实例化。这是英特尔 X710-DA4 上的一个端口。在 Pod 端的 VF 接口名称为 south0 。"}]}]},{"ID":"20231012221534-dj251sm","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231012221534-dj251sm","updated":"20231012221534"},"Children":[{"ID":"20231012221534-c3tcw4y","Type":"NodeParagraph","Properties":{"id":"20231012221534-c3tcw4y","updated":"20231012221534"},"Children":[{"Type":"NodeText","Data":"• 这个 VF 使用了 DPDK 驱动程序，此 VF 是从主机的物理端口 ens2f1 实例化出的。这个是英特尔 ® X710-DA4 上另外一个端口。Pod 内的 VF 接口名称为 north0。该接口绑定到 DPDK 驱动程序 vfio-pci 。"}]}]}]},{"ID":"20231012221712-a2lmtkx","Type":"NodeParagraph","Properties":{"id":"20231012221712-a2lmtkx","updated":"20231012221712"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012221712-l8to3y4.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012221534-14ljtgn","Type":"NodeBlockquote","Properties":{"id":"20231012221534-14ljtgn","updated":"20231012221534"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20231012221534-nffvmhs","Type":"NodeParagraph","Properties":{"id":"20231012221534-nffvmhs","updated":"20231012221534"},"Children":[{"Type":"NodeText","Data":"Notes：术语"}]},{"ID":"20231012221534-kodehlx","Type":"NodeList","ListData":{},"Properties":{"id":"20231012221534-kodehlx","updated":"20231012221534"},"Children":[{"ID":"20231012221534-swkjxre","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231012221534-swkjxre","updated":"20231012221534"},"Children":[{"ID":"20231012221534-qgzddz6","Type":"NodeParagraph","Properties":{"id":"20231012221534-qgzddz6","updated":"20231012221534"},"Children":[{"Type":"NodeText","Data":"• "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"NIC"},{"Type":"NodeText","Data":"：network interface card，网卡"}]}]},{"ID":"20231012221534-szygz5r","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231012221534-szygz5r","updated":"20231012221534"},"Children":[{"ID":"20231012221534-yibgt8h","Type":"NodeParagraph","Properties":{"id":"20231012221534-yibgt8h","updated":"20231012221534"},"Children":[{"Type":"NodeText","Data":"• "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"SR-IOV"},{"Type":"NodeText","Data":"：single root I/O virtualization，硬件实现的功能，允许各虚拟机间共享 PCIe 设备。"}]}]},{"ID":"20231012221534-vivmdse","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231012221534-vivmdse","updated":"20231012221534"},"Children":[{"ID":"20231012221534-ajri55d","Type":"NodeParagraph","Properties":{"id":"20231012221534-ajri55d","updated":"20231012221534"},"Children":[{"Type":"NodeText","Data":"• "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"VF"},{"Type":"NodeText","Data":"：Virtual Function，基于 PF，与 PF 或者其他 VF 共享一个物理资源。"}]}]},{"ID":"20231012221534-12r45ky","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231012221534-12r45ky","updated":"20231012221534"},"Children":[{"ID":"20231012221534-polbqm9","Type":"NodeParagraph","Properties":{"id":"20231012221534-polbqm9","updated":"20231012221534"},"Children":[{"Type":"NodeText","Data":"• "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"PF"},{"Type":"NodeText","Data":"：PCIe Physical Function，拥有完全控制 PCIe 资源的能力"}]}]},{"ID":"20231012221534-vkut7d5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231012221534-vkut7d5","updated":"20231012221534"},"Children":[{"ID":"20231012221534-qrpw44t","Type":"NodeParagraph","Properties":{"id":"20231012221534-qrpw44t","updated":"20231012221534"},"Children":[{"Type":"NodeText","Data":"• "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"DPDK"},{"Type":"NodeText","Data":"：Data Plane Development Kit"}]}]}]}]},{"ID":"20231012221604-mds74wa","Type":"NodeParagraph","Properties":{"id":"20231012221604-mds74wa","updated":"20231012221604"},"Children":[{"Type":"NodeText","Data":"与此同时，也可以将主机接口直接移动到 Pod 的网络名称空间，当然这个接口是必须存在，并且不能是与默认网络使用同一个接口。这种情况下，在普通网卡的环境中，就直接将 Pod 网络与 Node 网络处于同一个平面内了。"}]},{"ID":"20231012221726-iwvb4sc","Type":"NodeParagraph","Properties":{"id":"20231012221726-iwvb4sc","updated":"20231012221752"},"Children":[{"Type":"NodeText","Data":"​​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012221752-l5wdr4a.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​​"}]},{"ID":"20231012221604-zvu6r2v","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20231012221604-zvu6r2v","updated":"20231012221604"},"Children":[{"Type":"NodeText","Data":"danm"}]},{"ID":"20231012221604-c8xgysd","Type":"NodeParagraph","Properties":{"id":"20231012221604-c8xgysd","updated":"20231012221604"},"Children":[{"Type":"NodeText","Data":"DANM 是诺基亚开源的 CNI 项目，目的是将电信级网络引入 kubernetes 中，与 multus 相同的是，也提供了 SR-IOV/DPDK 的硬件技术，并且支持 IPVLAN."}]},{"ID":"20231012221624-4vivwql","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20231012221624-4vivwql","updated":"20231012221805"},"Children":[{"Type":"NodeText","Data":"Overlay Network Model"}]},{"ID":"20231012221806-b30fbwo","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20231012221806-b30fbwo","updated":"20231012221812"},"Children":[{"Type":"NodeText","Data":"什么是Overlay"}]},{"ID":"20231012221756-m488rfx","Type":"NodeParagraph","Properties":{"id":"20231012221756-m488rfx","updated":"20231012221819"},"Children":[{"Type":"NodeText","Data":"覆盖网络是使用网络虚拟化技术，在 underlay 网络上构建出的虚拟逻辑网络，而无需对物理网络架构进行更改。本质上来说，"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"overlay network 使用的是一种或多种隧道协议 (tunneling)，通过将数据包封装，实现一个网络到另一个网络中的传输，具体来说隧道协议关注的是数据包（帧）。"}]},{"ID":"20231012221843-59zqiwl","Type":"NodeParagraph","Properties":{"id":"20231012221843-59zqiwl","updated":"20231012221843"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012221843-zjz9ut5.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012221854-w336o0c","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20231012221854-w336o0c","updated":"20231012221911"},"Children":[{"Type":"NodeText","Data":"常见的网络隧道技术"}]},{"ID":"20231012221920-zyr8cu5","Type":"NodeList","ListData":{},"Properties":{"id":"20231012221920-zyr8cu5","updated":"20231012221920"},"Children":[{"ID":"20231012221920-5hokbjf","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231012221920-5hokbjf","updated":"20231012221920"},"Children":[{"ID":"20231012221920-r9h1t3x","Type":"NodeParagraph","Properties":{"id":"20231012221920-r9h1t3x","updated":"20231012221920"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"通用路由封装 ( Generic Routing Encapsulation )"},{"Type":"NodeText","Data":" 用于将来自 IPv4/IPv6 的数据包封装为另一个协议的数据包中，通常工作与 L3 网络层中。"}]}]},{"ID":"20231012221920-th7l54d","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231012221920-th7l54d","updated":"20231012221920"},"Children":[{"ID":"20231012221920-qd257zg","Type":"NodeParagraph","Properties":{"id":"20231012221920-qd257zg","updated":"20231012221920"},"Children":[{"Type":"NodeText","Data":"• "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"VxLAN (Virtual Extensible LAN)"},{"Type":"NodeText","Data":"，是一个简单的隧道协议，本质上是将 L2 的以太网帧封装为 L4 中 UDP 数据包的方法，使用 4789 作为默认端口。VxLAN 也是 VLAN 的扩展，对于 4096（ 位 VLAN ID） 扩展为 1600 万（ 位 VN·ID ）个逻辑网络。"}]}]}]},{"ID":"20231012221920-0r5eiuu","Type":"NodeParagraph","Properties":{"id":"20231012221920-0r5eiuu","updated":"20231012221920"},"Children":[{"Type":"NodeText","Data":"这种工作在 overlay 模型下典型的有 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"flannel 与 calico 中的的 VxLAN, IPIP 模式"},{"Type":"NodeText","Data":"。"}]},{"ID":"20231012221936-2em5yzl","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20231012221936-2em5yzl","updated":"20231012221945"},"Children":[{"Type":"NodeText","Data":"IPIP"}]},{"ID":"20231012221946-5md4a7f","Type":"NodeParagraph","Properties":{"id":"20231012221946-5md4a7f","updated":"20231012221951"},"Children":[{"Type":"NodeText","Data":"IP in IP 也是一种隧道协议，与 VxLAN 类似的是，IPIP 的实现也是通过 Linux 内核功能进行的封装。IPIP 需要内核模块 ipip.ko 使用命令查看内核是否加载 IPIP 模块lsmod | grep ipip ；使用命令modprobe ipip 加载。"}]},{"ID":"20231012222000-lh1vt0y","Type":"NodeParagraph","Properties":{"id":"20231012222000-lh1vt0y","updated":"20231012222000"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012222000-glo3v2i.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012222007-ujz18ck","Type":"NodeParagraph","Properties":{"id":"20231012222007-ujz18ck","updated":"20231012222007"},"Children":[{"Type":"NodeText","Data":"Kubernetes 中 IPIP 与 VxLAN 类似，也是通过网络隧道技术实现的。"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"与 VxLAN 差别就是，VxLAN 本质上是一个 UDP 包，而 IPIP 则是将包封装在本身的报文包上。"}]},{"ID":"20231012222021-15v1dkb","Type":"NodeParagraph","Properties":{"id":"20231012222021-15v1dkb","updated":"20231012222021"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012222021-cl2888n.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012222035-q30x8ev","Type":"NodeParagraph","Properties":{"id":"20231012222035-q30x8ev","updated":"20231012222041"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012222035-hglv610.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012222046-w0veim8","Type":"NodeBlockquote","Properties":{"id":"20231012222046-w0veim8","updated":"20231012222110"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20231012222046-4kiz8dz","Type":"NodeParagraph","Properties":{"id":"20231012222046-4kiz8dz","updated":"20231012222110"},"Children":[{"Type":"NodeText","Data":"Notes：公有云可能不允许 IPIP流量，例如Azure"}]}]},{"ID":"20231012222115-qv37gyp","Type":"NodeParagraph","Properties":{"id":"20231012222115-qv37gyp"}},{"ID":"20231012222117-i0vidwx","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20231012222117-i0vidwx","updated":"20231012222607"},"Children":[{"Type":"NodeText","Data":"VxLAN"}]},{"ID":"20231012222607-sywjkxj","Type":"NodeParagraph","Properties":{"id":"20231012222607-sywjkxj","updated":"20231012222619"},"Children":[{"Type":"NodeText","Data":"Linux 对 vxlan 协议的支持时间并不久，2012 年 Stephen Hemminger 才把相关的工作合并到 kernel 中，并最终出现在 kernel 3.7.0 版本。为了稳定性和很多的功能，你可以会看到某些软件推荐在 3.9.0 或者 3.10.0 以后版本的 kernel 上使用 VxLAN。"}]},{"ID":"20231012222630-3i887on","Type":"NodeParagraph","Properties":{"id":"20231012222630-3i887on","updated":"20231012222630"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012222630-c209sg0.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012222637-cuvsxx8","Type":"NodeParagraph","Properties":{"id":"20231012222637-cuvsxx8","updated":"20231012222637"},"Children":[{"Type":"NodeText","Data":"在 kubernetes 中 vxlan 网络，例如 flannel，守护进程会根据 kubernetes 的 Node 而维护 VxLAN，名称为 flannel.1 这是 VNID，并维护这个网络的路由，当发生跨节点的流量时，本地会维护对端 VxLAN 设备的 MAC 地址，通过这个地址可以知道发送的目的端，这样就可以封包发送到对端，收到包的对端 VxLAN 设备 flannel.1 解包后得到真实的目的地址。"}]},{"ID":"20231012222637-kxmb2ip","Type":"NodeParagraph","Properties":{"id":"20231012222637-kxmb2ip","updated":"20231012222637"},"Children":[{"Type":"NodeText","Data":"查看 Forwarding database 列表"}]},{"ID":"20231012222701-tmb88x2","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231012222701-tmb88x2","updated":"20231012222741"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"c2hlbGw="},{"Type":"NodeCodeBlockCode","Data":"$ bridge fdb\n26:5e:87:90:91:fc dev flannel.1 dst 10.0.0.3 self permanent$ bridge fdb\n26:5e:87:90:91:fc dev flannel.1 dst 10.0.0.3 self permanent\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231012222811-wwodi5g","Type":"NodeParagraph","Properties":{"id":"20231012222811-wwodi5g","updated":"20231012222811"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012222811-vkbow2g.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012222815-p7yqzmg","Type":"NodeBlockquote","Properties":{"id":"20231012222815-p7yqzmg","updated":"20231012222821"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20231012222816-gov5xar","Type":"NodeParagraph","Properties":{"id":"20231012222816-gov5xar","updated":"20231012222821"},"Children":[{"Type":"NodeText","Data":"Notes：VxLAN 使用的 4789 端口，wireshark 应该是根据端口进行分析协议的，而 flannel 在 linux 中默认端口是 8472，此时抓包仅能看到是一个 UDP 包。"}]}]},{"ID":"20231012222822-akz4myn","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20231012222822-akz4myn","updated":"20231012222842"},"Children":[{"Type":"NodeText","Data":"weave vxlan"}]},{"ID":"20231012222842-hi16guh","Type":"NodeParagraph","Properties":{"id":"20231012222842-hi16guh","updated":"20231012222931"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"weave 也是使用了 VxLAN 技术完成的包的封装，这个技术在 weave 中称之为 fastdp (fast data path)，"},{"Type":"NodeText","Data":"与 calico 和 flannel 中用到的技术不同的，这里使用的是 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Linux 内核中的 openvswitch datapath module，并且 weave 对网络流量进行了加密"},{"Type":"NodeText","Data":"。"}]},{"ID":"20231012223003-wm1d14i","Type":"NodeParagraph","Properties":{"id":"20231012223003-wm1d14i","updated":"20231012223003"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231012223003-s6olxpo.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231012223005-6mtee9e","Type":"NodeBlockquote","Properties":{"id":"20231012223005-6mtee9e","updated":"20231012223014"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20231012223007-wsr8903","Type":"NodeParagraph","Properties":{"id":"20231012223007-wsr8903","updated":"20231012223014"},"Children":[{"Type":"NodeText","Data":"Notes：fastdp 工作在 Linux 内核版本 3.12 及更高版本，如果低于此版本的例如 CentOS7，weave 将工作在用户空间，weave 中称之为 sleeve mode。"}]}]}]}