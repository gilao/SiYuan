{"ID":"20240511101638-ny8q92e","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f9a5","id":"20240511101638-ny8q92e","title":"负载均衡测试报告","type":"doc","updated":"20240512234612"},"Children":[{"ID":"20240511154600-giorqk8","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240511154600-giorqk8","updated":"20240511154625"},"Children":[{"Type":"NodeText","Data":"FastChat 的负载均衡策略"}]},{"ID":"20240511154626-khn64xt","Type":"NodeParagraph","Properties":{"id":"20240511154626-khn64xt","updated":"20240511161113"},"Children":[{"Type":"NodeText","Data":"FastChat 的负载均衡策略有两种："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"shortest_queue"},{"Type":"NodeText","Data":"​（最短队列）和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"lottery"},{"Type":"NodeText","Data":"​（彩票抽奖）；"}]},{"ID":"20240511161117-x2ijoep","Type":"NodeList","ListData":{},"Properties":{"id":"20240511161117-x2ijoep","updated":"20240512103058"},"Children":[{"ID":"20240511161118-xukas2d","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240511161118-xukas2d","updated":"20240512103058"},"Children":[{"ID":"20240511161118-r7v2aui","Type":"NodeParagraph","Properties":{"id":"20240511161118-r7v2aui","updated":"20240512103058"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"shortest_queue"},{"Type":"NodeText","Data":"​是获取Controller 中的所有相同 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"model_name"},{"Type":"NodeText","Data":"​的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​(启动模型后对应的IP+端口号)、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"speed"},{"Type":"NodeText","Data":"​,将"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length/speed"},{"Type":"NodeText","Data":"​分别存储到"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_names"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_qlen"},{"Type":"NodeText","Data":"​列表中，且索引是对应。判断"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_qlen"},{"Type":"NodeText","Data":"​列表中最小值的索引，并通过该索引从 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_names"},{"Type":"NodeText","Data":"​中获取对应的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​，将"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​对应的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Worker"},{"Type":"NodeText","Data":"​的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​加一，模拟分配任务后队列增长的情况。最后将获取到的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​返回给调用者；"}]},{"ID":"20240512100640-g7kaco1","Type":"NodeParagraph","Properties":{"id":"20240512100640-g7kaco1","updated":"20240512100640"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240512100640-gy32hfx.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240511161914-du6q382","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240511161914-du6q382","updated":"20240512102501"},"Children":[{"ID":"20240511161914-n8u0alv","Type":"NodeParagraph","Properties":{"id":"20240511161914-n8u0alv","updated":"20240512091125"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"lottery"},{"Type":"NodeText","Data":"​是获取Controller 中的所有相同 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"model_name"},{"Type":"NodeText","Data":"​的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​(启动模型后对应的IP+端口号)和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"speed"},{"Type":"NodeText","Data":"​,将"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_speed"},{"Type":"NodeText","Data":"​分别存储到"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_names"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_speeds"},{"Type":"NodeText","Data":"​中，且索引是对应的。然后将"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_speeds"},{"Type":"NodeText","Data":"​转化为numpy数组，然后进行归一化。最后会从 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_names"},{"Type":"NodeText","Data":"​中随机选择一个元素，选择的概率由 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_speeds"},{"Type":"NodeText","Data":"​决定。"}]},{"ID":"20240512102501-sstde9b","Type":"NodeParagraph","Properties":{"id":"20240512102501-sstde9b","updated":"20240512102501"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240512102500-w4rihqg.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]}]}]},{"ID":"20240511155213-awlwqly","Type":"NodeParagraph","Properties":{"id":"20240511155213-awlwqly","updated":"20240512102647"},"Children":[{"Type":"NodeText","Data":"负载均衡的使用场景是：当 openai_api_server等服务需要调用FastChat中的模型进行推理时，会首先调用Controller 中的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/get_worker_address"},{"Type":"NodeText","Data":"​，Controller 会基于请求体中的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"model"},{"Type":"NodeText","Data":"​ 从 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Worker_info"},{"Type":"NodeText","Data":"​去筛选对应的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Worker"},{"Type":"NodeText","Data":"​，并根据已经设定的负载均衡调度策略来获取"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​就是对应worker 的基础访问信息），服务得到"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​后即可根据 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​+路由来调用模型进行推理。"}]},{"ID":"20240511154401-4g45n90","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240511154401-4g45n90","updated":"20240512103005"},"Children":[{"Type":"NodeText","Data":"FastChat的负载均衡的实现原理"}]},{"ID":"20240512103410-81gdnyf","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240512103410-81gdnyf","updated":"20240512103413"},"Children":[{"Type":"NodeText","Data":"lottery"}]},{"ID":"20240512103413-78p9u1t","Type":"NodeParagraph","Properties":{"id":"20240512103413-78p9u1t","updated":"20240512111734"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"lottery"},{"Type":"NodeText","Data":"​的负载均衡策略主要由 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Worker"},{"Type":"NodeText","Data":"​ 的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"speed"},{"Type":"NodeText","Data":"​参数实现的，该参数主要是由模型的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker"},{"Type":"NodeText","Data":"​向"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"controller"},{"Type":"NodeText","Data":"​中注册时发送的。该参数目前在FastChat框架中固定为1，故会平均分配符合条件的模型的worker_name的。"}]},{"ID":"20240512111954-900qmdk","Type":"NodeParagraph","Properties":{"id":"20240512111954-900qmdk","updated":"20240512112049"},"Children":[{"Type":"NodeText","Data":"在FastChat框架中，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"lottery"},{"Type":"NodeText","Data":"​负载均衡策略主要依赖"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Worker"},{"Type":"NodeText","Data":"​的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"speed"},{"Type":"NodeText","Data":"​参数，这个参数是由各个模型的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker"},{"Type":"NodeText","Data":"​在向"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"controller"},{"Type":"NodeText","Data":"​注册时传递的。值得注意的是，当前"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"speed"},{"Type":"NodeText","Data":"​参数在系统设计中被固定为1，这一设定导致了所有符合要求的模型"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​将会被均匀地分配任务。"}]},{"ID":"20240512103007-u2qesn9","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240512103007-u2qesn9","updated":"20240512103005"},"Children":[{"Type":"NodeText","Data":"shortest_queue"}]},{"ID":"20240512103251-soe7z98","Type":"NodeParagraph","Properties":{"id":"20240512103251-soe7z98","updated":"20240512114004"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"shortest_queue"},{"Type":"NodeText","Data":"​的负载均衡策略主要是由"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Worker"},{"Type":"NodeText","Data":"​的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"speed"},{"Type":"NodeText","Data":"​参数实现的。"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"speed"},{"Type":"NodeText","Data":"​参数同上，固定为1。"}]},{"ID":"20240512114055-wimub6p","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240512114055-wimub6p","updated":"20240512114102"},"Children":[{"Type":"NodeText","Data":"queue_length"}]},{"ID":"20240512114743-j5cqr8x","Type":"NodeList","ListData":{},"Properties":{"id":"20240512114743-j5cqr8x","updated":"20240512114750"},"Children":[{"ID":"20240512114750-yas0l6h","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240512114750-yas0l6h","updated":"20240512114750"},"Children":[{"ID":"20240512114750-qcsygel","Type":"NodeParagraph","Properties":{"id":"20240512114750-qcsygel","updated":"20240512114949"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code strong","TextMarkTextContent":"queue_length"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"的初始化"},{"Type":"NodeText","Data":"："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Worker"},{"Type":"NodeText","Data":"​向"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Controller"},{"Type":"NodeText","Data":"​中注册"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Worker"},{"Type":"NodeText","Data":"​的基础信息，包括"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​；"}]}]},{"ID":"20240512114908-dq5vake","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240512114908-dq5vake"},"Children":[{"ID":"20240512114908-3o06naz","Type":"NodeParagraph","Properties":{"id":"20240512114908-3o06naz","updated":"20240512115206"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code strong","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"的更改："},{"Type":"NodeTextMark","TextMarkType":"strong code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​有两种更改方式"}]},{"ID":"20240512115212-c3vbn6b","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240512115212-c3vbn6b","updated":"20240512115254"},"Children":[{"ID":"20240512115254-xrv44gg","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240512115254-xrv44gg","updated":"20240512115254"},"Children":[{"ID":"20240512115254-ey7mgg2","Type":"NodeParagraph","Properties":{"id":"20240512115254-ey7mgg2","updated":"20240512175342"},"Children":[{"Type":"NodeText","Data":"使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"shortest_queue"},{"Type":"NodeText","Data":"​负载均衡调度策略时，系统会首先识别出具有最小"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​值的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker"},{"Type":"NodeText","Data":"​。一旦确定了这一"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker"},{"Type":"NodeText","Data":"​，其名称"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​会被记录下来。随后，在"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Controller"},{"Type":"NodeText","Data":"​层面，会对选定的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker"},{"Type":"NodeText","Data":"​实例的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​属性值增加1，这一操作象征着即将向该"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker"},{"Type":"NodeText","Data":"​分配一个新的任务，从而有效反映了任务队列状态的变化，确保后续的调度决策能够基于更新后的队列长度进行，维持整个系统负载的均衡分布。"}]}]},{"ID":"20240512120047-y8la0qk","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240512120047-y8la0qk"},"Children":[{"ID":"20240512120047-055rg2c","Type":"NodeParagraph","Properties":{"id":"20240512120047-055rg2c","updated":"20240512181714"},"Children":[{"Type":"NodeText","Data":"模型的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Worker"},{"Type":"NodeText","Data":"​会每45秒向"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"controller"},{"Type":"NodeText","Data":"​发送一个心跳信号，包括"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​；"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​是基于"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Worker"},{"Type":"NodeText","Data":"​的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"semaphore"},{"Type":"NodeText","Data":"​和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"limit_worker_concurrency"},{"Type":"NodeText","Data":"​来确定的，具体的计算方法是"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self.limit_worker_concurrency - sempahore_value + waiter_count"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"limit_worker_concurrency"},{"Type":"NodeText","Data":"​是限制并发数的参数，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sempahore"},{"Type":"NodeText","Data":"​是利用python 中的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sempahore"},{"Type":"NodeText","Data":"​来实现的，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sempahore_value"},{"Type":"NodeText","Data":"​等于"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sempahore._value"},{"Type":"NodeText","Data":"​，表示访问"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sempahore"},{"Type":"NodeText","Data":"​的线程数，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"waiter_count"},{"Type":"NodeText","Data":"​等于"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"len(sempahore._waiters)"},{"Type":"NodeText","Data":"​，表示等待访问 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sempahore"},{"Type":"NodeText","Data":"​的线程数。"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Controller"},{"Type":"NodeText","Data":"​收到"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Worker"},{"Type":"NodeText","Data":"​发送的心跳信号后，会更新"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_info"},{"Type":"NodeText","Data":"​中对应"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_name"},{"Type":"NodeText","Data":"​的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​。"}]}]}]}]}]},{"ID":"20240512181741-zhqu9c7","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240512181741-zhqu9c7","updated":"20240512184502"},"Children":[{"Type":"NodeText","Data":"FastChat的负载均衡测试方案"}]},{"ID":"20240512184503-mutlod2","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240512184503-mutlod2","updated":"20240512184509"},"Children":[{"Type":"NodeText","Data":"测试目标："}]},{"ID":"20240512184200-q4xv13r","Type":"NodeParagraph","Properties":{"id":"20240512184200-q4xv13r","updated":"20240512184545"},"Children":[{"Type":"NodeText","Data":"该测试方案主要验证两个方向"}]},{"ID":"20240512184548-ufiy6ia","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240512184548-ufiy6ia","updated":"20240512184554"},"Children":[{"ID":"20240512184549-96arbiz","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240512184549-96arbiz","updated":"20240512184549"},"Children":[{"ID":"20240512184549-k9plrl3","Type":"NodeParagraph","Properties":{"id":"20240512184549-k9plrl3","updated":"20240512184553"},"Children":[{"Type":"NodeText","Data":"模型的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker"},{"Type":"NodeText","Data":"​是否可以如实的记录接受到的请求，并反应到"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​上；"}]}]},{"ID":"20240512184553-oyz3vi1","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240512184553-oyz3vi1","updated":"20240512184554"},"Children":[{"ID":"20240512184553-2moazjb","Type":"NodeParagraph","Properties":{"id":"20240512184553-2moazjb","updated":"20240512184554"},"Children":[{"Type":"NodeText","Data":"验证"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Controller"},{"Type":"NodeText","Data":"​的负载均衡策略是否是有效的。"}]}]}]},{"ID":"20240512184511-gpa7fdw","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240512184511-gpa7fdw","updated":"20240512184520"},"Children":[{"Type":"NodeText","Data":"实施方案："}]},{"ID":"20240512181854-xicl5j9","Type":"NodeParagraph","Properties":{"id":"20240512181854-xicl5j9","updated":"20240512184808"},"Children":[{"Type":"NodeText","Data":"由于启动多个模型需要占用大量的资源，无法在电脑中启动多个模型实例，故通过分析FastChat 中的 Base_model_worker和Vllm_worker，使用Go语言仿真了模型的运行状态和开放的接口。该仿真模型模拟了向"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Controller"},{"Type":"NodeText","Data":"​中发送"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker"},{"Type":"NodeText","Data":"​的注册信息和心跳信息，同时模拟了"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/worker_generate_stream"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/worker_generate"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/worker_get_status"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/count_token"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/worker_get_conv_template"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/model_details"},{"Type":"NodeText","Data":"​的路由。"}]},{"ID":"20240512183302-5qt8yjw","Type":"NodeParagraph","Properties":{"id":"20240512183302-5qt8yjw","updated":"20240512183928"},"Children":[{"Type":"NodeText","Data":"测试方案如下："}]},{"ID":"20240512185128-376secb","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240512185128-376secb","updated":"20240512185954"},"Children":[{"ID":"20240512185130-5lj5jy4","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240512185130-5lj5jy4","updated":"20240512185130"},"Children":[{"ID":"20240512185130-irgb8iy","Type":"NodeParagraph","Properties":{"id":"20240512185130-irgb8iy","updated":"20240512185130"},"Children":[{"Type":"NodeText","Data":"使用"}]},{"ID":"20240512185153-pmocbm7","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240512185153-pmocbm7","updated":"20240512185207"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"  python -m fastchat.serve.controller 2\u003e\u00261 | tee -a /mnt/e/go/src/FastChatSimulation/controller-log.txt\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240512185156-r51qxet","Type":"NodeParagraph","Properties":{"id":"20240512185156-r51qxet","updated":"20240512185211"},"Children":[{"Type":"NodeText","Data":"启动"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Controller"},{"Type":"NodeText","Data":"​并收集"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Controller"},{"Type":"NodeText","Data":"​ 的日志。"}]}]},{"ID":"20240512185215-2y7hrqo","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240512185215-2y7hrqo"},"Children":[{"ID":"20240512185215-eg83e5r","Type":"NodeParagraph","Properties":{"id":"20240512185215-eg83e5r","updated":"20240512185228"},"Children":[{"Type":"NodeText","Data":"使用"}]},{"ID":"20240512185230-s5dw3vg","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240512185230-s5dw3vg","updated":"20240512185242"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":" python -m fastchat.serve.vllm_worker --model-path /root/.cache/huggingface/hub/models--THUDM--chatglm3-6b/snapshots/103caa40027ebfd8450289ca2f278eac4ff26405\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240512185233-9cf2rsz","Type":"NodeParagraph","Properties":{"id":"20240512185233-9cf2rsz","updated":"20240512185254"},"Children":[{"Type":"NodeText","Data":" 启动 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vllm_worker"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20240512185234-e7s98iq","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240512185234-e7s98iq"},"Children":[{"ID":"20240512185234-m6scu0d","Type":"NodeParagraph","Properties":{"id":"20240512185234-m6scu0d","updated":"20240512185334"},"Children":[{"Type":"NodeText","Data":"启动模拟仿真模型"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"test_model_1"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"test_model_2"},{"Type":"NodeText","Data":"​；"}]}]},{"ID":"20240512185346-l53lvej","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20240512185346-l53lvej"},"Children":[{"ID":"20240512185346-08uorgk","Type":"NodeParagraph","Properties":{"id":"20240512185346-08uorgk","updated":"20240512185405"},"Children":[{"Type":"NodeText","Data":"使用"}]},{"ID":"20240512185407-2jpa38l","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240512185407-2jpa38l","updated":"20240512185417"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":" python -m fastchat.serve.openai_api_server --host localhost --port 8000\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240512185408-uihgmv7","Type":"NodeParagraph","Properties":{"id":"20240512185408-uihgmv7","updated":"20240512185509"},"Children":[{"Type":"NodeText","Data":"启动 openai_api。"}]}]},{"ID":"20240512185738-uffntte","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20240512185738-uffntte","updated":"20240512185954"},"Children":[{"ID":"20240512185738-lh09eqr","Type":"NodeParagraph","Properties":{"id":"20240512185738-lh09eqr","updated":"20240512185954"},"Children":[{"Type":"NodeText","Data":"监控 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vllm_worker"},{"Type":"NodeText","Data":"​的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/worker_get_status"},{"Type":"NodeText","Data":"​，返回的内容包括"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"speed"},{"Type":"NodeText","Data":"​和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20240512185516-eciv1mg","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Ni4=","Num":6},"Properties":{"id":"20240512185516-eciv1mg"},"Children":[{"ID":"20240512185516-8agxlku","Type":"NodeParagraph","Properties":{"id":"20240512185516-8agxlku","updated":"20240512185731"},"Children":[{"Type":"NodeText","Data":"并发调用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"openai_api"},{"Type":"NodeText","Data":"​的接口。"}]}]},{"ID":"20240512185732-9z65jsn","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Ny4=","Num":7},"Properties":{"id":"20240512185732-9z65jsn"},"Children":[{"ID":"20240512185732-3m0bpst","Type":"NodeParagraph","Properties":{"id":"20240512185732-3m0bpst","updated":"20240512223156"},"Children":[{"Type":"NodeText","Data":"使用脚本将Controller的日志中关于负载均衡的日志单独筛选出来进行分析；"}]}]},{"ID":"20240512223203-3wc2z85","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"OC4=","Num":8},"Properties":{"id":"20240512223203-3wc2z85"},"Children":[{"ID":"20240512223203-f6qg7ap","Type":"NodeParagraph","Properties":{"id":"20240512223203-f6qg7ap","updated":"20240512223625"},"Children":[{"Type":"NodeText","Data":"基于监控"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vllm_worker"},{"Type":"NodeText","Data":"​的日志观察"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vllm_worker"},{"Type":"NodeText","Data":"​的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​的变化；"}]}]}]},{"ID":"20240512223648-i08huw0","Type":"NodeParagraph","Properties":{"id":"20240512223648-i08huw0","updated":"20240512223648"}},{"ID":"20240512223649-wag9xaf","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240512223649-wag9xaf","updated":"20240512223710"},"Children":[{"Type":"NodeText","Data":"FastChat的负载均衡的测试结果"}]},{"ID":"20240512223711-hakwvfh","Type":"NodeParagraph","Properties":{"id":"20240512223711-hakwvfh","updated":"20240512224301"},"Children":[{"Type":"NodeText","Data":"测试日志数据文件如下："}]},{"ID":"20240512224336-p90d1q4","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240512224336-p90d1q4","updated":"20240512224809"},"Children":[{"ID":"20240512224343-9g5z1yx","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240512224343-9g5z1yx","updated":"20240512224809"},"Children":[{"ID":"20240512224343-hr91aa5","Type":"NodeParagraph","Properties":{"id":"20240512224343-hr91aa5","updated":"20240512224809"},"Children":[{"Type":"NodeText","Data":"使用脚本筛选出来的Controller中关于负载均衡的日志："}]}]}]},{"ID":"20240512224312-b8ls4yp","Type":"NodeParagraph","Properties":{"id":"20240512224312-b8ls4yp","updated":"20240512224312"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"assets/2024-05-11_10-25-19-controller-workeraddress-20240512224312-6ptbzbg.txt","TextMarkTextContent":"2024-05-11_10-25-19-controller-workeraddress.txt"}]},{"ID":"20240512224249-3nnpe5u","Type":"NodeParagraph","Properties":{"id":"20240512224249-3nnpe5u","updated":"20240512224249"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"assets/2024-05-11_10-48-57-controller-workeraddress-20240512224249-vx45nrb.txt","TextMarkTextContent":"2024-05-11_10-48-57-controller-workeraddress.txt"}]},{"ID":"20240512224239-yug8u08","Type":"NodeParagraph","Properties":{"id":"20240512224239-yug8u08","updated":"20240512224239"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"assets/2024-05-11_10-56-17-controller-workeraddress-20240512224239-du35fzf.txt","TextMarkTextContent":"2024-05-11_10-56-17-controller-workeraddress.txt"}]},{"ID":"20240512224053-jghi8de","Type":"NodeParagraph","Properties":{"id":"20240512224053-jghi8de","updated":"20240512224053"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"assets/2024-05-11_11-10-38-controller-workeraddress-20240512224045-jt7mbpf.txt","TextMarkTextContent":"2024-05-11_11-10-38-controller-workeraddress.txt"}]},{"ID":"20240512224824-hbzfo93","Type":"NodeParagraph","Properties":{"id":"20240512224824-hbzfo93","updated":"20240512225602"},"Children":[{"Type":"NodeText","Data":"从上面的文件可以看出，Controller的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"shortest_queue"},{"Type":"NodeText","Data":"​的负载均衡策略是有效的，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vllm_worker"},{"Type":"NodeText","Data":"​和仿真的模型worker发送的心跳信号也可以反应"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Worker"},{"Type":"NodeText","Data":"​的实时状态，也可以更新"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Controller"},{"Type":"NodeText","Data":"​中对应"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Worker"},{"Type":"NodeText","Data":"​的状态。"}]},{"ID":"20240512225602-kks957r","Type":"NodeParagraph","Properties":{"id":"20240512225602-kks957r","updated":"20240512225813"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Controller"},{"Type":"NodeText","Data":"​的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker_info"},{"Type":"NodeText","Data":"​中"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker"},{"Type":"NodeText","Data":"​的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​只会加一，想要更新状态需要接受"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"worker"},{"Type":"NodeText","Data":"​的心跳信号来更新。"}]},{"ID":"20240512223929-4uj36vj","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240512223929-4uj36vj","updated":"20240512230041"},"Children":[{"ID":"20240512230041-m473046","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240512230041-m473046","updated":"20240512230041"},"Children":[{"ID":"20240512230041-ialpvuy","Type":"NodeParagraph","Properties":{"id":"20240512230041-ialpvuy","updated":"20240512230452"},"Children":[{"Type":"NodeText","Data":"监控"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Vllm_worker"},{"Type":"NodeText","Data":"​的日志文件："}]}]}]},{"ID":"20240512230512-5tyqgf0","Type":"NodeParagraph","Properties":{"id":"20240512230512-5tyqgf0","updated":"20240512230512"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"assets/5-11-11-03log-20240512230512-hbkv10b.txt","TextMarkTextContent":"5-11-11-03log.txt"}]},{"ID":"20240512230520-kvl9m6z","Type":"NodeParagraph","Properties":{"id":"20240512230520-kvl9m6z","updated":"20240512230520"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"assets/log-20240512230520-skr5f31.txt","TextMarkTextContent":"log.txt"}]},{"ID":"20240512230522-fwvugvk","Type":"NodeParagraph","Properties":{"id":"20240512230522-fwvugvk","updated":"20240512232130"},"Children":[{"Type":"NodeText","Data":"基于上述文件可以看出"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vllm_worker"},{"Type":"NodeText","Data":"​的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​的实时变化，证明"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vllm_worker"},{"Type":"NodeText","Data":"​的接收的请求可以反应在"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​中。"}]},{"ID":"20240512232141-pc0mc1v","Type":"NodeParagraph","Properties":{"id":"20240512232141-pc0mc1v","updated":"20240512232141"}},{"ID":"20240512232142-fbb4z6h","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240512232142-fbb4z6h","updated":"20240512232158"},"Children":[{"Type":"NodeText","Data":"FastChat的负载均衡的测试结果"}]},{"ID":"20240512232159-aisxkx8","Type":"NodeParagraph","Properties":{"id":"20240512232159-aisxkx8","updated":"20240512234226"},"Children":[{"Type":"NodeText","Data":"通过测试验证，可以发现"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vllm_worker"},{"Type":"NodeText","Data":"​是可以记录接收到的请求的，并反应到"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"queue_length"},{"Type":"NodeText","Data":"​上。"}]},{"ID":"20240512234226-3fq73iz","Type":"NodeParagraph","Properties":{"id":"20240512234226-3fq73iz","updated":"20240512234309"},"Children":[{"Type":"NodeText","Data":"通过分析"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Controller"},{"Type":"NodeText","Data":"​的日志和仿真模型的日志可以发现"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Controller"},{"Type":"NodeText","Data":"​的负载均衡策略是有效的；"}]},{"ID":"20240512234309-mfbzprl","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240512234309-mfbzprl","updated":"20240512234325"},"Children":[{"Type":"NodeText","Data":"后续优化："}]},{"ID":"20240512234326-1duex8i","Type":"NodeParagraph","Properties":{"id":"20240512234326-1duex8i","updated":"20240512234612"},"Children":[{"Type":"NodeText","Data":"后续将优化上述的测试方案，并开发在服务器多模型条件下通过程序监控FastChat的负载均衡策略和模型的状态的程序。"}]},{"ID":"20240512234203-2q7porh","Type":"NodeParagraph","Properties":{"id":"20240512234203-2q7porh","updated":"20240512234325"}}]}