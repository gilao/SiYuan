{"ID":"20240411162056-u6yahwy","Spec":"1","Type":"NodeDocument","Properties":{"icon":"2604-fe0f","id":"20240411162056-u6yahwy","title":"本地化部署大模型方案二：fastchat + llm(vllm)","updated":"20240412004009"},"Children":[{"ID":"20240411162056-3f76tbc","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240411162056-3f76tbc","updated":"20240412002940"},"Children":[{"Type":"NodeText","Data":"FastChat介绍"}]},{"ID":"20240412002953-9ov1cyj","Type":"NodeParagraph","Properties":{"id":"20240412002953-9ov1cyj","updated":"20240412002953"},"Children":[{"Type":"NodeText","Data":"FastChat 是一个开放平台，用于训练、服务和评估基于大型语言模型的聊天机器人。"}]},{"ID":"20240412002953-fayky15","Type":"NodeList","ListData":{},"Properties":{"id":"20240412002953-fayky15","updated":"20240412003024"},"Children":[{"ID":"20240412003024-w72t1t5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240412003024-w72t1t5","updated":"20240412003024"},"Children":[{"ID":"20240412003024-0vtty2u","Type":"NodeParagraph","Properties":{"id":"20240412003024-0vtty2u","updated":"20240412003026"},"Children":[{"Type":"NodeText","Data":"FastChat 为 Chatbot Arena ( https://chat.lmsys.org/ ) 提供支持，为 50 多名法学硕士提供超过 600 万个聊天请求。"}]}]},{"ID":"20240412003027-nzj5ekk","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240412003027-nzj5ekk"},"Children":[{"ID":"20240412003027-pehblwv","Type":"NodeParagraph","Properties":{"id":"20240412003027-pehblwv"},"Children":[{"Type":"NodeText","Data":"Arena 从并列的 LLM 比赛中收集了超过 10 万个人投票，编制了在线LLM Elo 排行榜。\nFastChat 的核心功能包括："}]}]}]},{"ID":"20240412002953-v4g7xvs","Type":"NodeList","ListData":{},"Properties":{"id":"20240412002953-v4g7xvs","updated":"20240412003005"},"Children":[{"ID":"20240412003005-qf6xfgk","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240412003005-qf6xfgk","updated":"20240412003005"},"Children":[{"ID":"20240412003005-x1kalfe","Type":"NodeParagraph","Properties":{"id":"20240412003005-x1kalfe","updated":"20240412003007"},"Children":[{"Type":"NodeText","Data":"最先进模型的训练和评估代码（例如，Vicuna、MT-Bench）。"}]}]},{"ID":"20240412003007-9u3zsw2","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240412003007-9u3zsw2","updated":"20240412003007"},"Children":[{"ID":"20240412003007-kirjpcv","Type":"NodeParagraph","Properties":{"id":"20240412003007-kirjpcv","updated":"20240412003007"},"Children":[{"Type":"NodeText","Data":"具有 Web UI 和 OpenAI 兼容 RESTful API 的分布式多模型服务系统。\n"}]}]}]},{"ID":"20240412003035-fyiir80","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240412003035-fyiir80","updated":"20240412003042"},"Children":[{"Type":"NodeText","Data":"FastChat 实战"}]},{"ID":"20240412003043-fba7444","Type":"NodeParagraph","Properties":{"id":"20240412003043-fba7444","updated":"20240412003211"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"支持模型"}]},{"ID":"20240412003211-qewcmh3","Type":"NodeParagraph","Properties":{"id":"20240412003211-qewcmh3","updated":"20240412003225"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"准备环境"}]},{"ID":"20240412003226-qd33jvn","Type":"NodeParagraph","Properties":{"id":"20240412003226-qd33jvn","updated":"20240412003247"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"下载大模型"}]},{"ID":"20240412003237-nb1v19c","Type":"NodeParagraph","Properties":{"id":"20240412003237-nb1v19c","updated":"20240412003301"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"安装FastChat"}]},{"ID":"20240412003302-axl561l","Type":"NodeParagraph","Properties":{"id":"20240412003302-axl561l","updated":"20240412003403"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"使用FastChat"}]},{"ID":"20240412003404-1amw2d0","Type":"NodeParagraph","Properties":{"id":"20240412003404-1amw2d0","updated":"20240412003520"},"Children":[{"Type":"NodeText","Data":"一共要启动三个服务分别是 controller、model_worker (vllm 使用 vllm_worker)、openai_api_server"}]},{"ID":"20240412003520-24k3mfq","Type":"NodeList","ListData":{},"Properties":{"id":"20240412003520-24k3mfq","updated":"20240412003522"},"Children":[{"ID":"20240412003522-s4h4c4v","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240412003522-s4h4c4v","updated":"20240412003522"},"Children":[{"ID":"20240412003522-dx0av9j","Type":"NodeParagraph","Properties":{"id":"20240412003522-dx0av9j","updated":"20240412003550"},"Children":[{"Type":"NodeText","Data":"vllm 加快推理速度："}]},{"ID":"20240412003553-7ozunt6","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240412003553-7ozunt6","updated":"20240412003607"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":" pip install vllm\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]}]},{"ID":"20240412003609-1mass66","Type":"NodeParagraph","Properties":{"id":"20240412003609-1mass66","updated":"20240412003735"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"第一步 启动 controller"}]},{"ID":"20240412003638-c7ugjru","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240412003638-c7ugjru","updated":"20240412003659"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"python -m fastchat.serve.controller --host 0.0.0.0\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240412003700-v70c0xf","Type":"NodeParagraph","Properties":{"id":"20240412003700-v70c0xf","updated":"20240412003705"},"Children":[{"Type":"NodeText","Data":"其他参数"}]},{"ID":"20240412003706-ws9urqg","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240412003706-ws9urqg","updated":"20240412003716"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"--host参数指定应用程序绑定的主机名或IP地址。默认情况下，应用程序将绑定在本地回环地址（即localhost或127.0.0.1）上。\n--port参数指定应用程序监听的端口号。默认情况下，应用程序将监听21001端口。\n--dispatch-method参数指定请求调度算法。lottery表示抽奖式随机分配请求，shortest_queue表示将请求分配给队列最短的服务器。默认情况下，使用抽奖式随机分配请求。\n--ssl参数指示应用程序是否使用SSL加密协议。如果指定了此参数，则应用程序将使用HTTPS协议。否则，应用程序将使用HTTP协议。\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240412003718-sjgydo7","Type":"NodeParagraph","Properties":{"id":"20240412003718-sjgydo7","updated":"20240412003753"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"第二步： 启动model_worker (llm)"}]},{"ID":"20240412003754-p56fzra","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240412003754-p56fzra","updated":"20240412003805"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"python -m fastchat.serve.model_worker --model-path /root/autodl-tmp/models_from_modelscope/baichuan-inc/Baichuan2-13B-Chat --host 0.0.0.0  --load-8bit\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240412003806-b8js4hj","Type":"NodeParagraph","Properties":{"id":"20240412003806-b8js4hj","updated":"20240412003813"},"Children":[{"Type":"NodeText","Data":"其他参数"}]},{"ID":"20240412003814-c7v7kgd","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240412003814-c7v7kgd","updated":"20240412003822"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"--host：指定模型工作进程绑定的主机名或IP地址。\n\n--port：指定模型工作进程绑定的端口号。\n\n--worker-address：指定模型工作进程的地址。\n\n--controller-address：指定模型控制器的地址。\n\n--model-path：指定要加载的模型文件的路径。\n\n--revision：指定模型文件的版本。\n\n--device：指定模型运行的设备类型，可以是CPU、GPU等。\n\n--gpus：指定用于模型运行的GPU设备的数量。\n\n--num-gpus：指定用于模型运行的GPU设备的数量。\n\n--max-gpu-memory：指定用于模型运行的GPU设备的最大内存限制。\n\n--dtype：指定模型的数据类型，可以是float32、float16等。\n\n--load-8bit：启用8位量化模型。\n\n--cpu-offloading：启用CPU卸载。\n\n--gptq-ckpt：指定GPTQ检查点的路径。\n\n--gptq-wbits：指定GPTQ权重的位数。\n\n--gptq-groupsize：指定GPTQ分组大小。\n\n--awq-ckpt：指定AWQ检查点的路径。\n\n--awq-wbits：指定AWQ权重的位数。\n\n--awq-groupsize：指定AWQ分组大小。\n\n--enable-exllama：启用Exllama。\n\n--exllama-max-seq-len：指定Exllama的最大序列长度。\n\n--exllama-gpu-split：指定Exllama的GPU划分。\n\n--exllama-cache-8bit：启用Exllama的8位缓存。\n\n--enable-xft：启用XFT。\n\n--xft-max-seq-len：指定XFT的最大序列长度。\n\n--xft-dtype：指定XFT的数据类型。\n\n--model-names：指定要加载的模型文件的名称。\n\n--conv-template：指定卷积模板的路径。\n\n--embed-in-truncate：启用嵌入截断。\n\n--limit-worker-concurrency：限制工作进程并发性的数量。\n\n--stream-interval：指定流间隔。\n\n--no-register：不注册模型。\n\n--seed：指定随机种子。\n\n--debug：启用调试模式。\n\n--ssl：启用SSL。\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240412003825-qu91wwh","Type":"NodeParagraph","Properties":{"id":"20240412003825-qu91wwh","updated":"20240412003840"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"代替方案"}]},{"ID":"20240412003840-5k3v0ti","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240412003840-5k3v0ti","updated":"20240412003842"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"python -m fastchat.serve.vllm_worker --model-path /root/autodl-tmp/models_from_modelscope/baichuan-inc/Baichuan2-13B-Chat  --host 0.0.0.0  \n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240412003848-ebvgx0b","Type":"NodeParagraph","Properties":{"id":"20240412003848-ebvgx0b","updated":"20240412003848"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240412003848-6lv0358.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240412003849-jdbr1m3","Type":"NodeParagraph","Properties":{"id":"20240412003849-jdbr1m3"}},{"ID":"20240412003854-761jgal","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240412003854-761jgal","updated":"20240412003859"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"--host HOST：指定该工作节点的主机名或 IP 地址，默认为 localhost。\n--port PORT：指定该工作节点监听的端口号，默认为 8000。\n--worker-address WORKER_ADDRESS：指定该工作节点的地址。如果未指定，则自动从网络配置中获取。\n--controller-address CONTROLLER_ADDRESS：指定控制节点的地址。如果未指定，则自动从环境变量中获取。如果环境变量也未设置，则默认使用 http://localhost:8001。\n--model-path MODEL_PATH：指定模型文件的路径。如果未指定，则默认使用 models/model.ckpt。\n--model-names MODEL_NAMES：指定要加载的模型名称。该参数只在多模型情况下才需要使用。\n--limit-worker-concurrency LIMIT_WORKER_CONCURRENCY：指定最大并发工作进程数。默认为 None，表示不限制。\n--no-register：禁止在控制节点上注册该工作节点。\n--num-gpus NUM_GPUS：指定使用的 GPU 数量。默认为 1。\n--conv-template CONV_TEMPLATE：指定对话生成的模板文件路径。如果未指定，则默认使用 conversation_template.json。\n--trust_remote_code：启用远程代码信任模式。\n--gpu_memory_utilization GPU_MEMORY_UTILIZATION：指定 GPU 内存使用率，范围为 [0,1]。默认为 1.0，表示占用全部 GPU 内存。\n--model MODEL：指定要加载的模型类型。默认为 fastchat.serve.vllm_worker.VLLMModel。\n--tokenizer TOKENIZER：指定要使用的分词器类型。默认为 huggingface。\n--revision REVISION：指定加载的模型版本号。默认为 None，表示加载最新版本。\n--tokenizer-revision TOKENIZER_REVISION：指定加载的分词器版本号。默认为 None，表示加载最新版本。\n--tokenizer-mode {auto,slow}：指定分词器模式。默认为 auto，表示自动选择最佳模式。\n--download-dir DOWNLOAD_DIR：指定模型下载目录。默认为 downloads/。\n--load-format {auto,pt,safetensors,npcache,dummy}：指定模型加载格式。默认为 auto，表示自动选择最佳格式。\n--dtype {auto,half,float16,bfloat16,float,float32}：指定模型数据类型。默认为 auto，表示自动选择最佳类型。\n--max-model-len MAX_MODEL_LEN：指定模型的最大长度。默认为 None，表示不限制。\n--worker-use-ray：启用 Ray 分布式训练模式。\n--pipeline-parallel-size PIPELINE_PARALLEL_SIZE：指定管道并行的大小。默认为 None，表示不使用管道并行。\n--tensor-parallel-size TENSOR_PARALLEL_SIZE：指定张量并行的大小。默认为 None，表示不使用张量并行。\n--max-parallel-loading-workers MAX_PARALLEL_LOADING_WORKERS：指定最大并发加载工作数。默认为 4。\n--block-size {8,16,32}：指定块大小。默认为 16。\n--seed SEED：指定随机种子。默认为 None。\n--swap-space SWAP_SPACE：指定交换空间的大小。默认为 4GB。\n--max-num-batched-tokens MAX_NUM_BATCHED_TOKENS：指定每个批次的最大令牌数。默认为 2048。\n--max-num-seqs MAX_NUM_SEQS：指定每个批次的最大序列数。默认为 64。\n--max-paddings MAX_PADDINGS：指定每个批次的最大填充数。默认为 1024。\n--disable-log-stats：禁止记录统计信息。\n--quantization {awq,gptq,squeezellm,None}：指定模型量化类型。默认为 None，表示不进行量化。\n--enforce-eager：强制启用 Eager Execution 模式。\n--max-context-len-to-capture MAX_CONTEXT_LEN_TO_CAPTURE：指定要捕获的上下文长度。默认为 1024。\n--engine-use-ray：在引擎中启用 Ray 分布式训练模式。\n--disable-log-requests：禁止记录请求信息。\n--max-log-len MAX_LOG_LEN：指定最大日志长度。默认为 10240。\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240412003903-q3hu2hh","Type":"NodeParagraph","Properties":{"id":"20240412003903-q3hu2hh","updated":"20240412003914"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"第三步 openai 服务启动"}]},{"ID":"20240412003914-b2swstw","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240412003914-b2swstw","updated":"20240412003925"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"python3 -m fastchat.serve.openai_api_server --host 0.0.0.0 --port 8000\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240412003928-uty0ift","Type":"NodeParagraph","Properties":{"id":"20240412003928-uty0ift"}},{"ID":"20240412003930-ycjejd5","Type":"NodeParagraph","Properties":{"id":"20240412003930-ycjejd5","updated":"20240412003937"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"第四步 验证"}]},{"ID":"20240412003937-r9itc9t","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240412003937-r9itc9t","updated":"20240412003943"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"pip install langchain\npip install openai\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240412003944-9f8phqw","Type":"NodeParagraph","Properties":{"id":"20240412003944-9f8phqw"}},{"ID":"20240412003949-khoo220","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240412003949-khoo220","updated":"20240412003955"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"from langchain import PromptTemplate\nfrom langchain.chat_models import ChatOpenAI\nfrom langchain.schema import HumanMessage\n\nllm = ChatOpenAI(\n    streaming=True,\n    verbose=True,\n    # callbacks=[callback],\n    openai_api_key=\"none\",\n    openai_api_base=\"http://localhost:8000/v1\",\n    model_name=\"Baichuan2-13B-Chat\"\n)\n\n\n\n# 提示词\ntemplate = \"\"\"\n我很想去{location}旅行，我应该在哪里做什么？\n\"\"\"\nprompt = PromptTemplate(\n    input_variables=[\"location\"],\n    template=template,\n\n)\n# 说白了就是在提示词的基础上，把输入的话进行格式化方法输入，前后添加了一些固定词\nfinal_prompt = prompt.format(location='安徽合肥')\n\nprint(f\"最终提升次：{final_prompt}\")\noutput = llm([HumanMessage(content=final_prompt)])\nprint(f\"LLM输出结果：{output}\")\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240412004001-buxqlro","Type":"NodeParagraph","Properties":{"id":"20240412004001-buxqlro","updated":"20240412004004"},"Children":[{"Type":"NodeText","Data":"启动"}]},{"ID":"20240412004005-axqfh6z","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240412004005-axqfh6z","updated":"20240412004009"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"python test.py\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]}