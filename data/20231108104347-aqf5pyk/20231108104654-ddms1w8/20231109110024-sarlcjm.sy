{"ID":"20231109110024-sarlcjm","Spec":"1","Type":"NodeDocument","Properties":{"icon":"26ea","id":"20231109110024-sarlcjm","scroll":"\u0026#123;\u0026quot;rootId\u0026quot;:\u0026quot;20231109110024-sarlcjm\u0026quot;,\u0026quot;startId\u0026quot;:\u0026quot;20231109110024-2ti95ex\u0026quot;,\u0026quot;endId\u0026quot;:\u0026quot;20231109201522-52t77jo\u0026quot;,\u0026quot;scrollTop\u0026quot;:1483,\u0026quot;focusId\u0026quot;:\u0026quot;20231109201522-52t77jo\u0026quot;,\u0026quot;focusStart\u0026quot;:0,\u0026quot;focusEnd\u0026quot;:0\u0026#125;","tags":"用户态\u0026amp;内核态","title":"系统调用\u0026amp;用户态与内核态的切换","updated":"20231109201522"},"Children":[{"ID":"20231109110024-2ti95ex","Type":"NodeParagraph","Properties":{"id":"20231109110024-2ti95ex","updated":"20231109112240"},"Children":[{"Type":"NodeText","Data":"如果用户态程序需要执行系统调用，就需要切换到内核态执行。在上一篇文章也提到过下面讲这个过程的原理："}]},{"ID":"20231109112247-t3njlel","Type":"NodeParagraph","Properties":{"id":"20231109112247-t3njlel","updated":"20231109112247"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231109112247-x2k2h0i.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231109112247-3b032zn","Type":"NodeParagraph","Properties":{"id":"20231109112247-3b032zn","updated":"20231109112254"},"Children":[{"Type":"NodeText","Data":"如上图所示："},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"内核程序执行在内核态（Kernal Mode），用户程序执行在用户态（User Mode）。当发生系统调用时，用户态的程序发起系统调用。因为系统调用中牵扯特权指令，用户态程序权限不足，因此会中断执行，也就是 Trap（Trap 是一种中断）。"}]},{"ID":"20231109112308-qsy8g3r","Type":"NodeParagraph","Properties":{"id":"20231109112308-qsy8g3r","updated":"20231109112309"},"Children":[{"Type":"NodeText","Data":"发生中断后，当前 CPU 执行的程序会中断，跳转到中断处理程序。内核程序开始执行，也就是开始处理系统调用。内核处理完成后，主动触发 Trap，这样会再次发生中断，切换回用户态工作。"}]},{"ID":"20231109112310-6frpa7q","Type":"NodeParagraph","Properties":{"id":"20231109112310-6frpa7q","updated":"20231109195507"}},{"ID":"20231109195507-lhpz2gt","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20231109195507-lhpz2gt","updated":"20231109195556"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"用户态和内核态切换"}]},{"ID":"20231109195508-oo5rx9v","Type":"NodeParagraph","Properties":{"id":"20231109195508-oo5rx9v","updated":"20231109195543"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"用户态和内核态切换开销大，开销大的原因有以下几点"}]},{"ID":"20231109195610-nd8o630","Type":"NodeList","ListData":{},"Properties":{"id":"20231109195610-nd8o630","updated":"20231109195822"},"Children":[{"ID":"20231109195612-jsy619l","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231109195612-jsy619l","updated":"20231109195612"},"Children":[{"ID":"20231109195612-0g1wnvb","Type":"NodeParagraph","Properties":{"id":"20231109195612-0g1wnvb","updated":"20231109195639"},"Children":[{"Type":"NodeText","Data":"保留用户态现场（上下文、寄存器、用户栈等）"}]}]},{"ID":"20231109195639-v5j53y4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231109195639-v5j53y4"},"Children":[{"ID":"20231109195639-57vcx3x","Type":"NodeParagraph","Properties":{"id":"20231109195639-57vcx3x","updated":"20231109195702"},"Children":[{"Type":"NodeText","Data":"复制用户态参数，用户栈切到内核栈，进入内核态"}]}]},{"ID":"20231109195703-wyjfdrb","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231109195703-wyjfdrb"},"Children":[{"ID":"20231109195703-hnk0ecs","Type":"NodeParagraph","Properties":{"id":"20231109195703-hnk0ecs","updated":"20231109195735"},"Children":[{"Type":"NodeText","Data":"额外的检查 （因为内核代码对用户不信任）"}]}]},{"ID":"20231109195736-vtthboe","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231109195736-vtthboe"},"Children":[{"ID":"20231109195736-tkml7s3","Type":"NodeParagraph","Properties":{"id":"20231109195736-tkml7s3","updated":"20231109195743"},"Children":[{"Type":"NodeText","Data":"执行内核态代码"}]}]},{"ID":"20231109195743-u7rr4tg","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231109195743-u7rr4tg"},"Children":[{"ID":"20231109195743-v250r11","Type":"NodeParagraph","Properties":{"id":"20231109195743-v250r11","updated":"20231109195758"},"Children":[{"Type":"NodeText","Data":"复制内核态代码执行结果，回到用户态"}]}]},{"ID":"20231109195759-j75zgkp","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20231109195759-j75zgkp","updated":"20231109195822"},"Children":[{"ID":"20231109195759-vrbmt96","Type":"NodeParagraph","Properties":{"id":"20231109195759-vrbmt96","updated":"20231109195822"},"Children":[{"Type":"NodeText","Data":"恢复用户态现场 上下文、寄存器、用户栈等"}]}]}]},{"ID":"20231109195831-0g293nb","Type":"NodeParagraph","Properties":{"id":"20231109195831-0g293nb","updated":"20231109195831"},"Children":[{"Type":"NodeText","Data":"实际上操作系统会比上述的更复杂，这里只是个大概，我们可以发现一次切换经历了"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"「用户态 -\u0026gt; 内核态 -\u0026gt; 用户态」"},{"Type":"NodeText","Data":"。"}]},{"ID":"20231109195832-ysza83p","Type":"NodeParagraph","Properties":{"id":"20231109195832-ysza83p","updated":"20231109195843"},"Children":[{"Type":"NodeText","Data":"用户态要主动切换到内核态，那必须要有入口才行，实际上内核态是提供了统一的入口，下面是Linux整体架构图"}]},{"ID":"20231109201510-ld4oqvq","Type":"NodeParagraph","Properties":{"id":"20231109201510-ld4oqvq","updated":"20231109201521"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20231109201453-v9fy077.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20231109201522-52t77jo","Type":"NodeParagraph","Properties":{"id":"20231109201522-52t77jo"}}]}