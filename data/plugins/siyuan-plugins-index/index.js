"use strict";var He=Object.defineProperty;var Re=(e,t,n)=>t in e?He(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var S=(e,t,n)=>(Re(e,typeof t!="symbol"?t+"":t,n),n);const h=require("siyuan");let y;function je(e){y=e}let T;function ze(e){T=e}function pe(e){return e.replaceAll("[","\\[").replaceAll("]","\\]")}const be=h.getFrontend(),Je=be==="mobile"||be==="browser-mobile",M="config",We={icon:!0,depth:0,listType:"unordered",linkType:"ref",docBuilder:!1,autoUpdate:!0,col:1,fold:0};class Ge{async initData(){await this.load(),(T.data[M]===""||T.data[M]===void 0||T.data[M]===null)&&await T.saveData(M,JSON.stringify(We)),await this.load()}set(t,n){T.data[M][t]=n}get(t){var n;return(n=T.data[M])==null?void 0:n[t]}async load(){await T.loadData(M)}async save(){await T.saveData(M,T.data[M])}loadSettings(t){this.set("icon",t.icon),this.set("depth",t.depth),this.set("listType",t.listType),this.set("linkType",t.linkType),this.set("fold",t.fold),this.set("col",t.col),this.set("autoUpdate",t.autoUpdate)}}const c=new Ge;class Qe{constructor(t,n){S(this,"depth");S(this,"text");S(this,"path");S(this,"children");this.depth=t,this.text=n,this.children=new ge}}class ge{constructor(){S(this,"stack");S(this,"basePath");S(this,"notebookId");S(this,"pPath");this.stack=[]}push(t){return this.stack.push(t)}pop(){return this.stack.pop()}peek(){if(this.stack.length>0)return this.stack[this.stack.length-1]}clear(){this.stack=[]}isEmpty(){return this.stack.length===0}}class Ie{constructor(t,n){S(this,"depth");S(this,"text");S(this,"children");this.depth=t,this.text=n,this.children=new Z}}class Z{constructor(){S(this,"queue");this.queue=[]}push(t){return this.queue.push(t)}pop(){return this.queue.shift()}getFront(){return this.queue[0]}getRear(){return this.queue[this.queue.length-1]}clear(){this.queue=[]}isEmpty(){return this.queue.length===0}getSize(){return this.queue.length}}let O;async function we(){await c.load();let e=re();if(e==null){h.showMessage(y.errorMsg_empty,3e3,"error");return}let[t,n]=await me(e),i="";O=new Z,await ee(t,n,O),i=te(O,i),i!=""?await nt(e,i):h.showMessage(y.errorMsg_miss,3e3,"error")}async function Xe(e){await c.load(),c.set("autoUpdate",!1);let t=re();if(t==null){h.showMessage(y.errorMsg_empty,3e3,"error");return}let[n,i]=await me(t),l="";if(O=new Z,await tt(n,i,O),l=te(O,l),l!="")await it(t,l);else{h.showMessage(y.errorMsg_miss,3e3,"error");return}e.destroy()}async function Ye(e){await c.load();let t=re();if(t==null){h.showMessage(y.errorMsg_empty,3e3,"error");return}let n="",i=await Pe(t);if(console.log(i),n=oe(n,i,0),n!="")await h.fetchSyncPost("/api/block/insertBlock",{data:n,dataType:"markdown",parentID:t}),h.showMessage(y.msg_success,3e3,"info");else{h.showMessage(y.errorMsg_miss_outline,3e3,"error");return}e.destroy()}async function Ze(e,t,n){await c.load();let i="";O=new Z,await ee(e,n,O),i=te(O,i),i!=""?await Ne(t,i):h.showMessage(y.errorMsg_miss,3e3,"error")}async function et(e,t,n){var l;await c.load();let i=await h.fetchSyncPost("/api/query/sql",{stmt:`SELECT * FROM blocks WHERE root_id = '${n}' AND ial like '%custom-index-create%' order by updated desc limit 1`});if(console.log(t),((l=i.data[0])==null?void 0:l.id)!=null){let s=(await h.fetchSyncPost("/api/attr/getBlockAttrs",{id:i.data[0].id})).data["custom-index-create"];if(console.log(s),c.loadSettings(JSON.parse(s)),!c.get("autoUpdate"))return;let u="";O=new Z,await ee(e,t,O),u=te(O,u),console.log(T.data),console.log("data="+u),u!=""?await Ne(i.data[0].id,u):h.showMessage(y.errorMsg_miss,3e3,"error")}}async function me(e){let n=(await h.fetchSyncPost("/api/block/getBlockInfo",{id:e})).data,i=n.box,l=n.path;return[i,l]}function re(){var e,t;return Je?(e=document.querySelector("#editor .protyle-content .protyle-background"))==null?void 0:e.getAttribute("data-node-id"):(t=document.querySelector(".layout__wnd--active .protyle.fn__flex-1:not(.fn__none) .protyle-background"))==null?void 0:t.getAttribute("data-node-id")}async function Be(e,t){let i=(await h.fetchSyncPost("/api/filetree/listDocsByPath",{notebook:e,path:t})).data;return i==null?[]:i.files}async function Pe(e){let n=(await h.fetchSyncPost("/api/outline/getDocOutline",{id:e})).data;return n??[]}function oe(e,t,n){n++,console.log("outlineData.length:"+t.length);for(let i of t){let l=i.id,o="";i.depth==0?o=i.name:o=i.content;let s=i.count;for(let r=1;r<n;r++)e+="    ";o=pe(o),c.get("listType")=="unordered"?e+="* ":e+="1. ",c.get("linkType")=="ref"?e+=`[@${o}](siyuan://blocks/${l})
`:e+=`((${l} '@${o}'))
`,s>0&&(i.depth==0?e=oe(e,i.blocks,n):e=oe(e,i.children,n))}return e}function De(e,t){return e==""||e==null?t?"ðŸ“‘":"ðŸ“„":e.indexOf(".")!=-1?e.indexOf("http://")!=-1||e.indexOf("https://")!=-1?t?"ðŸ“‘":"ðŸ“„":`:${e.substring(0,e.lastIndexOf("."))}:`:String.fromCodePoint(parseInt(e,16))}async function tt(e,t,n,i=0){if(c.get("depth")==0||c.get("depth")>i){let l=await Be(e,t);i++;for(let o of l){let s="",u=o.id,a=o.name.slice(0,-3),r=o.icon,_=o.subFileCount,d=o.path;for(let V=1;V<i;V++)s+="    ";a=pe(a),c.get("listType")=="unordered"?s+="* ":s+="1. ",c.get("icon")&&(s+=`${De(r,_!=0)} `),c.get("linkType")=="ref"?s+=`[${a}](siyuan://blocks/${u})
`:s+=`((${u} '${a}'))
`;let m=await Pe(u);console.log(m),s=oe(s,m,i),console.log(s);let w=new Ie(i,s);n.push(w),_>0&&await ee(e,d,w.children,i)}}}async function ee(e,t,n,i=0){if(c.get("depth")==0||c.get("depth")>i){let l=await Be(e,t);i++;for(let o of l){let s="",u=o.id,a=o.name.slice(0,-3),r=o.icon,_=o.subFileCount,d=o.path;for(let w=1;w<i;w++)s+="    ";a=pe(a),c.get("listType")=="unordered"?s+="* ":s+="1. ",c.get("icon")&&(s+=`${De(r,_!=0)} `),c.get("linkType")=="ref"?s+=`[${a}](siyuan://blocks/${u})
`:s+=`((${u} '${a}'))
`,console.log(s);let m=new Ie(i,s);n.push(m),_>0&&await ee(e,d,m.children,i)}}}async function nt(e,t){var n;try{let i=await h.fetchSyncPost("/api/query/sql",{stmt:`SELECT * FROM blocks WHERE root_id = '${e}' AND ial like '%custom-index-create%' order by updated desc limit 1`});if(((n=i.data[0])==null?void 0:n.id)==null){let l=await h.fetchSyncPost("/api/block/insertBlock",{data:t,dataType:"markdown",parentID:e});await h.fetchSyncPost("/api/attr/setBlockAttrs",{id:l.data[0].doOperations[0].id,attrs:{"custom-index-create":JSON.stringify(T.data[M])}}),h.showMessage(y.msg_success,3e3,"info")}else{let l=await h.fetchSyncPost("/api/block/updateBlock",{data:t,dataType:"markdown",id:i.data[0].id});await h.fetchSyncPost("/api/attr/setBlockAttrs",{id:l.data[0].doOperations[0].id,attrs:{"custom-index-create":JSON.stringify(T.data[M])}}),h.showMessage(y.update_success,3e3,"info")}}catch{h.showMessage(y.dclike,3e3,"error")}}async function it(e,t){await h.fetchSyncPost("/api/block/insertBlock",{data:t,dataType:"markdown",parentID:e}),h.showMessage(y.msg_success,3e3,"info")}async function Ne(e,t){let n=await h.fetchSyncPost("/api/block/updateBlock",{data:t,dataType:"markdown",id:e});await h.fetchSyncPost("/api/attr/setBlockAttrs",{id:n.data[0].doOperations[0].id,attrs:{"custom-index-create":JSON.stringify(T.data[M])}})}function te(e,t){var u;if(((u=e.getFront())==null?void 0:u.depth)==null)return"";let n,i=0,l=0,o=0,s=e.getFront().depth;for(s==1&&c.get("col")!=1&&(t+=`{{{col
`,l=Math.trunc(e.getSize()/c.get("col")),o=c.get("col")-1);!e.isEmpty();){if(i++,n=e.pop(),!n.children.isEmpty()&&c.get("fold")==n.depth){let a=0;c.get("listType")=="unordered"?(a=n.text.indexOf("*"),n.text=n.text.substring(0,a+2)+'{: fold="1"}'+n.text.substring(a+2)):(a=n.text.indexOf("1"),n.text=n.text.substring(0,a+3)+'{: fold="1"}'+n.text.substring(a+3))}t+=n.text,console.log(n.text),n.children.isEmpty()||(t=te(n.children,t)),n.depth==1&&i==l&&o>0&&(t+=`
{: id}
`,i=0,o--)}return s==1&&c.get("col")!=1&&(t+="}}}"),t}function X(){}function Ae(e){return e()}function ke(){return Object.create(null)}function R(e){e.forEach(Ae)}function ye(e){return typeof e=="function"}function Ce(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function st(e){return Object.keys(e).length===0}function b(e,t){e.appendChild(t)}function K(e,t,n){e.insertBefore(t,n||null)}function L(e){e.parentNode&&e.parentNode.removeChild(e)}function lt(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function $(e){return document.createElement(e)}function de(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function _e(e){return document.createTextNode(e)}function v(){return _e(" ")}function F(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}function g(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function Te(e,t,n){e.setAttributeNS("http://www.w3.org/1999/xlink",t,n)}function ot(e){return e===""?null:+e}function at(e){return Array.from(e.childNodes)}function xe(e,t){t=""+t,e.data!==t&&(e.data=t)}function $e(e,t){e.value=t??""}function ve(e,t,n){for(let i=0;i<e.options.length;i+=1){const l=e.options[i];if(l.__value===t){l.selected=!0;return}}(!n||t!==void 0)&&(e.selectedIndex=-1)}function rt(e){const t=e.querySelector(":checked");return t&&t.__value}class ut{constructor(t=!1){this.is_svg=!1,this.is_svg=t,this.e=this.n=null}c(t){this.h(t)}m(t,n,i=null){this.e||(this.is_svg?this.e=de(n.nodeName):this.e=$(n.nodeType===11?"TEMPLATE":n.nodeName),this.t=n.tagName!=="TEMPLATE"?n:n.content,this.c(t)),this.i(i)}h(t){this.e.innerHTML=t,this.n=Array.from(this.e.nodeName==="TEMPLATE"?this.e.content.childNodes:this.e.childNodes)}i(t){for(let n=0;n<this.n.length;n+=1)K(this.t,this.n[n],t)}p(t){this.d(),this.h(t),this.i(this.a)}d(){this.n.forEach(L)}}let Y;function Q(e){Y=e}function Le(){if(!Y)throw new Error("Function called outside component initialization");return Y}function ct(e){Le().$$.before_update.push(e)}function ft(e){Le().$$.on_destroy.push(e)}const J=[],Se=[];let W=[];const Ee=[],dt=Promise.resolve();let he=!1;function ht(){he||(he=!0,dt.then(qe))}function ae(e){W.push(e)}const fe=new Set;let z=0;function qe(){if(z!==0)return;const e=Y;do{try{for(;z<J.length;){const t=J[z];z++,Q(t),pt(t.$$)}}catch(t){throw J.length=0,z=0,t}for(Q(null),J.length=0,z=0;Se.length;)Se.pop()();for(let t=0;t<W.length;t+=1){const n=W[t];fe.has(n)||(fe.add(n),n())}W.length=0}while(J.length);for(;Ee.length;)Ee.pop()();he=!1,fe.clear(),Q(e)}function pt(e){if(e.fragment!==null){e.update(),R(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(ae)}}function gt(e){const t=[],n=[];W.forEach(i=>e.indexOf(i)===-1?t.push(i):n.push(i)),n.forEach(i=>i()),W=t}const le=new Set;let mt;function I(e,t){e&&e.i&&(le.delete(e),e.i(t))}function D(e,t,n,i){if(e&&e.o){if(le.has(e))return;le.add(e),mt.c.push(()=>{le.delete(e),i&&(n&&e.d(1),i())}),e.o(t)}else i&&i()}function N(e){e&&e.c()}function B(e,t,n,i){const{fragment:l,after_update:o}=e.$$;l&&l.m(t,n),i||ae(()=>{const s=e.$$.on_mount.map(Ae).filter(ye);e.$$.on_destroy?e.$$.on_destroy.push(...s):R(s),e.$$.on_mount=[]}),o.forEach(ae)}function P(e,t){const n=e.$$;n.fragment!==null&&(gt(n.after_update),R(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function yt(e,t){e.$$.dirty[0]===-1&&(J.push(e),ht(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function Fe(e,t,n,i,l,o,s,u=[-1]){const a=Y;Q(e);const r=e.$$={fragment:null,ctx:[],props:o,update:X,not_equal:l,bound:ke(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(a?a.$$.context:[])),callbacks:ke(),dirty:u,skip_bound:!1,root:t.target||a.$$.root};s&&s(r.root);let _=!1;if(r.ctx=n?n(e,t.props||{},(d,k,...f)=>{const m=f.length?f[0]:k;return r.ctx&&l(r.ctx[d],r.ctx[d]=m)&&(!r.skip_bound&&r.bound[d]&&r.bound[d](m),_&&yt(e,d)),k}):[],r.update(),_=!0,R(r.before_update),r.fragment=i?i(r.ctx):!1,t.target){if(t.hydrate){const d=at(t.target);r.fragment&&r.fragment.l(d),d.forEach(L)}else r.fragment&&r.fragment.c();t.intro&&I(e.$$.fragment),B(e,t.target,t.anchor,t.customElement),qe()}Q(a)}class Ke{$destroy(){P(this,1),this.$destroy=X}$on(t,n){if(!ye(n))return X;const i=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return i.push(n),()=>{const l=i.indexOf(n);l!==-1&&i.splice(l,1)}}$set(t){this.$$set&&!st(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}function Me(e,t,n){const i=e.slice();return i[10]=t[n][0],i[11]=t[n][1],i}function _t(e){let t,n,i,l,o,s=e[2].text+"",u,a,r;return{c(){t=$("button"),n=de("svg"),i=de("use"),o=v(),u=_e(s),Te(i,"xlink:href",l=e[2].icon),g(t,"class","b3-button b3-button--outline fn__size200 fn__flex-center"),g(t,"id",e[3]),t.disabled=e[5]},m(_,d){K(_,t,d),b(t,n),b(n,i),b(t,o),b(t,u),a||(r=F(t,"click",function(){ye(e[4])&&e[4].apply(this,arguments)}),a=!0)},p(_,d){e=_,d&4&&l!==(l=e[2].icon)&&Te(i,"xlink:href",l),d&4&&s!==(s=e[2].text+"")&&xe(u,s),d&8&&g(t,"id",e[3]),d&32&&(t.disabled=e[5])},d(_){_&&L(t),a=!1,r()}}}function bt(e){let t,n,i,l=Object.entries(e[2].options),o=[];for(let s=0;s<l.length;s+=1)o[s]=Oe(Me(e,l,s));return{c(){t=$("select");for(let s=0;s<o.length;s+=1)o[s].c();g(t,"class","b3-select fn__flex-center fn__size200"),g(t,"id",e[3]),e[0]===void 0&&ae(()=>e[9].call(t))},m(s,u){K(s,t,u);for(let a=0;a<o.length;a+=1)o[a]&&o[a].m(t,null);ve(t,e[0],!0),n||(i=[F(t,"change",e[9]),F(t,"change",e[6])],n=!0)},p(s,u){if(u&4){l=Object.entries(s[2].options);let a;for(a=0;a<l.length;a+=1){const r=Me(s,l,a);o[a]?o[a].p(r,u):(o[a]=Oe(r),o[a].c(),o[a].m(t,null))}for(;a<o.length;a+=1)o[a].d(1);o.length=l.length}u&8&&g(t,"id",s[3]),u&5&&ve(t,s[0])},d(s){s&&L(t),lt(o,s),n=!1,R(i)}}}function wt(e){let t,n,i;return{c(){t=$("input"),g(t,"class","b3-switch fn__flex-center"),g(t,"id",e[3]),g(t,"type","checkbox")},m(l,o){K(l,t,o),t.checked=e[0],n||(i=[F(t,"change",e[8]),F(t,"change",e[6])],n=!0)},p(l,o){o&8&&g(t,"id",l[3]),o&5&&(t.checked=l[0])},d(l){l&&L(t),n=!1,R(i)}}}function kt(e){let t,n,i,l,o,s,u;return{c(){t=$("div"),n=$("input"),g(n,"class","b3-slider fn__size200"),g(n,"id",e[3]),g(n,"type","range"),g(n,"min",i=e[2].min),g(n,"max",l=e[2].max),g(n,"step",o=e[2].step),g(t,"class","b3-tooltips b3-tooltips__n fn__flex-center"),g(t,"aria-label",e[0])},m(a,r){K(a,t,r),b(t,n),$e(n,e[0]),s||(u=[F(n,"change",e[7]),F(n,"input",e[7]),F(n,"change",e[6])],s=!0)},p(a,r){r&8&&g(n,"id",a[3]),r&4&&i!==(i=a[2].min)&&g(n,"min",i),r&4&&l!==(l=a[2].max)&&g(n,"max",l),r&4&&o!==(o=a[2].step)&&g(n,"step",o),r&5&&$e(n,a[0]),r&5&&g(t,"aria-label",a[0])},d(a){a&&L(t),s=!1,R(u)}}}function Oe(e){let t,n=e[11]+"",i,l;return{c(){t=$("option"),i=_e(n),t.__value=l=e[10],t.value=t.__value},m(o,s){K(o,t,s),b(t,i)},p(o,s){s&4&&n!==(n=o[11]+"")&&xe(i,n),s&4&&l!==(l=o[10])&&(t.__value=l,t.value=t.__value)},d(o){o&&L(t)}}}function Tt(e){let t,n,i,l=e[2].title+"",o,s,u=e[2].content+"",a,r,_;function d(m,w){if(m[1]==="range")return kt;if(m[1]==="switch")return wt;if(m[1]==="select")return bt;if(m[1]==="button")return _t}let k=d(e),f=k&&k(e);return{c(){t=$("label"),n=$("div"),i=new ut(!1),o=v(),s=$("div"),a=v(),r=$("span"),_=v(),f&&f.c(),i.a=o,g(s,"class","b3-label__text"),g(n,"class","fn__flex-1"),g(r,"class","fn__space"),g(t,"class","fn__flex b3-label config__item")},m(m,w){K(m,t,w),b(t,n),i.m(l,n),b(n,o),b(n,s),s.innerHTML=u,b(t,a),b(t,r),b(t,_),f&&f.m(t,null)},p(m,[w]){w&4&&l!==(l=m[2].title+"")&&i.p(l),w&4&&u!==(u=m[2].content+"")&&(s.innerHTML=u),k===(k=d(m))&&f?f.p(m,w):(f&&f.d(1),f=k&&k(m),f&&(f.c(),f.m(t,null)))},i:X,o:X,d(m){m&&L(t),f&&f.d()}}}function $t(e,t,n){let{type:i}=t,{content:l}=t,{settingKey:o}=t,{settingValue:s}=t,{onMyClick:u=function(){}}=t,{disabled:a=null}=t;function r(){c.set(o,s),c.save()}function _(){s=ot(this.value),n(0,s),n(2,l)}function d(){s=this.checked,n(0,s),n(2,l)}function k(){s=rt(this),n(0,s),n(2,l)}return e.$$set=f=>{"type"in f&&n(1,i=f.type),"content"in f&&n(2,l=f.content),"settingKey"in f&&n(3,o=f.settingKey),"settingValue"in f&&n(0,s=f.settingValue),"onMyClick"in f&&n(4,u=f.onMyClick),"disabled"in f&&n(5,a=f.disabled)},[s,i,l,o,u,a,r,_,d,k]}class A extends Ke{constructor(t){super(),Fe(this,t,$t,Tt,Ce,{type:1,content:2,settingKey:3,settingValue:0,onMyClick:4,disabled:5})}}function vt(e){let t,n,i,l,o,s,u,a,r,_,d,k,f,m,w,V,q,ne,j,U,ie,C,se,E,G;return i=new A({props:{type:"select",content:y.settingsTab.items.listType,settingKey:"listType",settingValue:e[7]}}),o=new A({props:{type:"select",content:y.settingsTab.items.linkType,settingKey:"linkType",settingValue:e[8]}}),u=new A({props:{type:"switch",content:y.settingsTab.items.icon,settingKey:"icon",settingValue:e[4]}}),r=new A({props:{type:"switch",content:y.settingsTab.items.autoUpdate,settingKey:"autoUpdate",settingValue:e[5]}}),d=new A({props:{type:"range",content:y.settingsTab.items.depth,settingKey:"depth",settingValue:e[6]}}),f=new A({props:{type:"range",content:y.settingsTab.items.fold,settingKey:"fold",settingValue:e[11]}}),w=new A({props:{type:"range",content:y.settingsTab.items.col,settingKey:"col",settingValue:e[10]}}),q=new A({props:{type:"switch",content:y.settingsTab.items.docBuilder,settingKey:"docBuilder",settingValue:e[9]}}),C=new A({props:{type:"button",content:y.settingsTab.items.subOutlineButton,settingKey:"subOutlineButton",settingValue:"",onMyClick:e[0],disabled:e[3]}}),E=new A({props:{type:"button",content:y.settingsTab.items.docOutlineButton,settingKey:"docOutlineButton",settingValue:"",onMyClick:e[1],disabled:e[3]}}),{c(){t=$("div"),n=$("div"),N(i.$$.fragment),l=v(),N(o.$$.fragment),s=v(),N(u.$$.fragment),a=v(),N(r.$$.fragment),_=v(),N(d.$$.fragment),k=v(),N(f.$$.fragment),m=v(),N(w.$$.fragment),V=v(),N(q.$$.fragment),ne=v(),j=$("div"),U=$("div"),ie=v(),N(C.$$.fragment),se=v(),N(E.$$.fragment),g(U,"class","b3-label b3-label--inner"),g(j,"class","b3-label"),g(n,"class","config__tab-container"),g(t,"class","b3-dialog__content")},m(p,H){K(p,t,H),b(t,n),B(i,n,null),b(n,l),B(o,n,null),b(n,s),B(u,n,null),b(n,a),B(r,n,null),b(n,_),B(d,n,null),b(n,k),B(f,n,null),b(n,m),B(w,n,null),b(n,V),B(q,n,null),b(n,ne),b(n,j),b(j,U),U.innerHTML=e[2],b(n,ie),B(C,n,null),b(n,se),B(E,n,null),G=!0},p(p,[H]){(!G||H&4)&&(U.innerHTML=p[2]);const ue={};H&1&&(ue.onMyClick=p[0]),H&8&&(ue.disabled=p[3]),C.$set(ue);const ce={};H&2&&(ce.onMyClick=p[1]),H&8&&(ce.disabled=p[3]),E.$set(ce)},i(p){G||(I(i.$$.fragment,p),I(o.$$.fragment,p),I(u.$$.fragment,p),I(r.$$.fragment,p),I(d.$$.fragment,p),I(f.$$.fragment,p),I(w.$$.fragment,p),I(q.$$.fragment,p),I(C.$$.fragment,p),I(E.$$.fragment,p),G=!0)},o(p){D(i.$$.fragment,p),D(o.$$.fragment,p),D(u.$$.fragment,p),D(r.$$.fragment,p),D(d.$$.fragment,p),D(f.$$.fragment,p),D(w.$$.fragment,p),D(q.$$.fragment,p),D(C.$$.fragment,p),D(E.$$.fragment,p),G=!1},d(p){p&&L(t),P(i),P(o),P(u),P(r),P(d),P(f),P(w),P(q),P(C),P(E)}}}function St(e,t,n){ct(async()=>{await c.load()});let{onSubOutlineButton:i=function(){}}=t,{onDocOutlineButton:l=function(){}}=t,o,s=re(),u=null;s==null?(u="disabled",o=y.noneId):o=y.hadId;let a=c.get("icon"),r=c.get("depth"),_=c.get("listType"),d=c.get("linkType"),k=c.get("docBuilder"),f=c.get("autoUpdate"),m=c.get("col"),w=c.get("fold"),V=a??!0,q=a==null?!0:f,ne=r??0,j=_??"unordered",U=d??"ref",ie=k??!1,C=m??1,se=w??0;return ft(()=>{c.save()}),e.$$set=E=>{"onSubOutlineButton"in E&&n(0,i=E.onSubOutlineButton),"onDocOutlineButton"in E&&n(1,l=E.onDocOutlineButton)},[i,l,o,u,V,q,ne,j,U,ie,C,se]}class Et extends Ke{constructor(t){super(),Fe(this,t,St,vt,Ce,{onSubOutlineButton:0,onDocOutlineButton:1})}}async function Mt(){const e=T.addTopBar({icon:"iconList",title:y.addTopBarIcon,position:"right",callback:async()=>{we()}});T.addCommand({langKey:"addTopBarIcon",hotkey:"âŒ¥âŒ˜I",callback:async()=>{we()}}),e.addEventListener("contextmenu",async()=>{await Ot()})}async function Ot(){await c.load();const e="index-settings",t=new h.Dialog({title:y.settingsTab.name,content:`<div id="${e}">`,width:"70%",height:"80%"});let n=t.element.querySelector(`#${e}`);new Et({target:n,props:{onSubOutlineButton:()=>{Xe(t)},onDocOutlineButton:()=>{Ye(t)}}})}let x;function It({detail:e}){e.blockElements.length>1||e.blockElements[0].getAttribute("data-type")!="NodeList"||!c.get("docBuilder")||e.menu.addItem({icon:"iconList",label:y.settingsTab.items.docBuilder.title,click:async()=>{await Bt(e)}})}async function Bt(e){x=new ge,x.notebookId=e.protyle.notebookId;let t=e.blockElements[0].getAttribute("data-node-id"),n=e.blockElements[0].childNodes;x.basePath=await Pt(t);let i=await me(e.protyle.block.rootID);x.pPath=i[1].slice(0,-3),await Ve(n,x),await Ue(x),await Ze(x.notebookId,t,i[1]),window.location.reload()}async function Ve(e,t,n=0){n++;let i;for(const l of e)if(l.getAttribute("data-type")=="NodeListItem"){let o=l.childNodes;for(const s of o)if(s.getAttribute("data-type")=="NodeParagraph"){let u=window.Lute.BlockDOM2Content(s.innerHTML),a=new Qe(n,u);t.push(a),i=a.children}else s.getAttribute("data-type")=="NodeList"&&await Ve(s.childNodes,i,n)}}async function Pt(e){let n=(await h.fetchSyncPost("/api/query/sql",{stmt:`SELECT * FROM blocks WHERE id = '${e}'`})).data[0];return n==null?void 0:n.hpath}async function Dt(e,t){return(await h.fetchSyncPost("/api/filetree/createDocWithMd",{notebook:e,path:t,markdown:""})).data}async function Ue(e){let t,n=new ge;for(;!e.isEmpty();){t=e.pop();let i=e.basePath+"/"+t.text;t.path=await Dt(x.notebookId,i),t.path=e.pPath+"/"+t.path,n.push(t),t.children.isEmpty()||(t.children.basePath=i,t.children.pPath=t.path,await Ue(t.children))}n.pPath=e.pPath,await Nt(n)}async function Nt(e){let t=[];for(;!e.isEmpty();)t.push(e.pop().path+".sy");await At(t,x.notebookId)}async function At(e,t){await h.fetchSyncPost("/api/filetree/changeSort",{paths:e,notebook:t})}function Ct({detail:e}){if(e.options.mode!=null||!c.get("autoUpdate"))return;console.log(e);let t=e.notebookId,n=e.path,i=e.options.blockId;et(t,n,i)}class xt extends h.Plugin{async onload(){console.log("IndexPlugin onload"),this.init(),await Mt(),await c.initData(),this.eventBus.on("click-blockicon",It),this.eventBus.on("loaded-protyle",Ct)}onunload(){console.log("IndexPlugin onunload")}init(){je(this.i18n),ze(this)}}module.exports=xt;
