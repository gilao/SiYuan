"use strict";var W=Object.defineProperty;var S=(i,n,e)=>n in i?W(i,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[n]=e;var r=(i,n,e)=>(S(i,typeof n!="symbol"?n+"":n,e),e);const c=require("siyuan");var y={},h={};Object.defineProperty(h,"__esModule",{value:!0});h.showChangeLog=h.TypoDialog=h.getFile=void 0;const M=c;async function L(i,n){const e={method:"POST"};return n&&(e.body=JSON.stringify(n)),await(await fetch(i,e)).text()}async function b(i){let n={path:i},e="/api/file/getFile";try{return await L(e,n)}catch{return null}}h.getFile=b;class m extends M.Dialog{constructor(e){super(e);r(this,"eleContainer");this.eleContainer=this.element.querySelector(".b3-dialog__container")}setSize(e){let t=this.element.querySelector(".b3-dialog__container");t.style.width=e.width??t.style.width,t.style.height=e.height??t.style.height}setFont(e){let t=this.element.querySelector("#dialogContent");t.style.fontSize=e}}h.TypoDialog=m;function C(i,n,e){return new m({title:i,content:`
        <div id="dialog" class="b3-typography" style="margin: 2rem; font-size: 1rem">
            <div id="dialogContent" style="font-size: 1rem">
                ${n}
            </div>
        </div>`,width:e,height:"50%"})}let g={zh_CN:"zh_CN",zh_CHT:"zh_CN",en_US:"en_US",es_ES:"en_US",fr_FR:"en_US"};async function F(i,n,e,t){var l,o;try{let s=n.match(/\d+\.\d+\.\d+/g);if(s===null){console.log(`Failed to parse plugin version: ${n}`);return}let d=s[0],a=(o=(l=window==null?void 0:window.siyuan)==null?void 0:l.config)==null?void 0:o.lang;if(a===void 0){console.log("Get Lang error");return}if(t===void 0)t=g;else for(let u in g)t[u]===void 0&&(t[u]=g[u]);a=t[a]??a,e===void 0?e=`i18n/CHANGELOG-${a}-${d}.md`:e=e.replace(/\${lang}/g,a).replace(/\${(?:ver|version)}/g,d);const w=`/data/plugins/${i}/${e}`;let f=await b(w);if(f.match(/"code":404/g)!==null){console.log(`Faild to find changelog file: ${w}`);return}let $=window.Lute.New().Md2HTML(f);return C(`${i} v${n}`,$,"60%")}catch(s){console.log("showChangeLog error:",s)}}h.showChangeLog=F;Object.defineProperty(y,"__esModule",{value:!0});var _=y.changelog=void 0;const p=h,v="PluginVersion";async function x(i,n,e){const t=`/data/plugins/${i.name}/plugin.json`;let l={VersionChanged:void 0,OldVersion:void 0,NewVersion:void 0,Dialog:void 0};try{let o=await(0,p.getFile)(t);if(o===null)return l;o=JSON.parse(o);let s=o.version;console.log(`${i.name} Ver: ${s}`);let d=await i.loadData(v);l.OldVersion=d,l.NewVersion=s,l.VersionChanged=!1,s!==d&&(l.VersionChanged=!0,console.log(`${i.name} got new version: ${d} -> ${s}`),i.saveData(v,s),l.Dialog=await(0,p.showChangeLog)(i.name,s,n,e))}catch(o){console.error(`Setting load error: ${o}`)}return l}_=y.changelog=x;const E=`:root{--centerWidth: 70%;--lrwidth: calc((100% - var(--centerWidth)) / 2)}#layouts .layout__center div.protyle-content:not([data-fullwidth="true"])>div.protyle-title{margin-left:var(--lrwidth)!important;margin-right:var(--lrwidth)!important}#layouts .layout__center div.protyle-content:not([data-fullwidth="true"])>div.protyle-wysiwyg{padding-left:var(--lrwidth)!important;padding-right:var(--lrwidth)!important}div.protyle-content:not([data-fullwidth="true"])>div.protyle-background>div.protyle-background__iconw{left:var(--lrwidth)!important}
`;class P extends c.Dialog{constructor(e){let t=`
        <div id="plugin-width__setting">
            <div style="padding-bottom: 1rem">
                40%
                <input
                    class="b3-slider fn__size200 b3-tooltips b3-tooltips__s"
                    max="100" min="40" step="1" type="range" value="${e.width}"
                    aria-label="${e.width}%" id=""
                />
                100%
            </div>
            <label class="fn__flex">
                <div class="fn__flex-1">${e.i18n.setEnableMobile}</div> 
                <span class="fn__space"></span>
                <input class="b3-switch fn__flex-center" type="checkbox">
            </label>
        </div>
        `;super({title:`${e.i18n.title}: ${e.width}%`,content:t,destroyCallback:()=>{e.save(),e.updateWysiwygPadding(),console.log("Write width",e.width)}});r(this,"value");let l=this.element.querySelector(".b3-dialog__header"),o=this.element.querySelector(".b3-dialog__body");o.style.padding="1rem",l.style.textAlign="center";const s=this.element.querySelector("input.b3-slider");s.addEventListener("input",a=>{e.width=parseInt(a.target.value),l.innerText=`${e.i18n.title}: ${e.width}%`,s.setAttribute("aria-label",`${e.width}%`),document.documentElement.style.setProperty("--centerWidth",`${e.width}%`)});const d=this.element.querySelector("input.b3-switch");d.checked=e.enableMobile,d.addEventListener("change",a=>{e.enableMobile=a.target.checked})}}function V(i,n){let e=document.createElement("style");e.id=i,e.innerHTML=n,document.head.appendChild(e)}function D(i){let n=document.getElementById(i);n&&n.remove()}class z extends c.Plugin{constructor(){super(...arguments);r(this,"width");r(this,"enableMobile");r(this,"iconEle");r(this,"wysiwyg");r(this,"observer");r(this,"onLoadProtyle");r(this,"icon",'<svg t="1684328935774" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1746" width="32" height="32"><path d="M180 176h-60c-4.4 0-8 3.6-8 8v656c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V184c0-4.4-3.6-8-8-8z m724 0h-60c-4.4 0-8 3.6-8 8v656c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V184c0-4.4-3.6-8-8-8zM785.3 504.3L657.7 403.6c-4.7-3.7-11.7-0.4-11.7 5.7V476H378v-62.8c0-6-7-9.4-11.7-5.7L238.7 508.3c-3.7 2.9-3.7 8.5 0 11.3l127.5 100.8c4.7 3.7 11.7 0.4 11.7-5.7V548h268v62.8c0 6 7 9.4 11.7 5.7l127.5-100.8c3.8-2.9 3.8-8.5 0.2-11.4z" p-id="1747"></path></svg>');r(this,"isFullWidth")}async onload(){await this.load(),console.log(this.enableMobile,c.getFrontend()),this.updateWysiwygPadding(),this.observer=new MutationObserver(()=>{var l;((l=this.wysiwyg)==null?void 0:l.deref())&&this.updateWysiwygPadding()}),this.onLoadProtyle=(({detail:t})=>{var o;((o=this.wysiwyg)==null?void 0:o.deref())&&this.observer.disconnect(),this.wysiwyg=new WeakRef(t.wysiwyg.element),this.updateWysiwygPadding(),this.observer.observe(t.wysiwyg.element,{childList:!1,attributes:!0,characterData:!1,subtree:!1})}).bind(this),this.eventBus.on("loaded-protyle",this.onLoadProtyle);let e=!this.enableMobile&&c.getFrontend()==="mobile";e||V("plugin-width",E),document.documentElement.style.setProperty("--centerWidth",`${this.width}%`),this.iconEle=this.addTopBar({icon:this.icon,title:this.i18n.title,position:"left",callback:()=>{if(e){c.showMessage(this.i18n.disableOnMobile,2e3,"info");return}let t=this.checkFullWidth();if(!(t===null&&this.isFullWidth===void 0)){if(this.isFullWidth&&(t=this.isFullWidth),this.isFullWidth=t,t){c.confirm(this.i18n.title,this.i18n.fullWidth);return}new P(this)}}}),_(this,"i18n/changelog.md").then(({Dialog:t})=>{t&&(t.setFont("1rem"),t.setSize({width:"40%",height:"25rem"}))}).catch(t=>{console.error(t)})}updateWysiwygPadding(){var t;let e=(t=this.wysiwyg)==null?void 0:t.deref();if(e){let o=e.parentElement.clientWidth*(1-this.width/100)/2;e.style.setProperty("padding-left",`${o}px`),e.style.setProperty("padding-right",`${o}px`)}}async load(){let e=await this.loadData("config");console.log("Load config",e),e?(this.data.config=e,this.width=e.width,this.enableMobile=e.enableMobile):(this.width=70,this.enableMobile=!1,this.save())}async save(){this.data.config={width:this.width,enableMobile:this.enableMobile},await this.saveData("config",this.data.config),console.log("Save config",this.data.config)}checkFullWidth(){let e=document.querySelector("div.protyle-content");return e?e.getAttribute("data-fullwidth")==="true"?(this.isFullWidth=!0,!0):(this.isFullWidth=!1,!1):null}onunload(){D("plugin-width"),this.wysiwyg=null,this.eventBus.off("loaded-protyle",this.onLoadProtyle),this.observer.disconnect()}}module.exports=z;
