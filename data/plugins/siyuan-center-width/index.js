"use strict";var p=Object.defineProperty;var w=(o,n,t)=>n in o?p(o,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[n]=t;var s=(o,n,t)=>(w(o,typeof n!="symbol"?n+"":n,t),t);const y=require("siyuan"),u=`:root{--centerWidth: 70%;--lrwidth: calc((100% - var(--centerWidth)) / 2);--refcountRight: -16px}#layouts>div>div.fn__flex-1.fn__flex div.protyle-content:not([data-fullwidth="true"])>div.protyle-title{margin-left:var(--lrwidth)!important;margin-right:var(--lrwidth)!important}#layouts>div>div.fn__flex-1.fn__flex div.protyle-content:not([data-fullwidth="true"])>div.protyle-wysiwyg{padding-left:var(--lrwidth)!important;padding-right:var(--lrwidth)!important}#layouts>div>div.fn__flex-1.fn__flex div.protyle-content:not([data-fullwidth="true"])>div.protyle-background>div.protyle-background__iconw{left:var(--lrwidth)!important}#layouts>div>div.fn__flex-1.fn__flex div.protyle-content div.protyle-attr--refcount{right:var(--refcountRight)!important}
`;function g(o,n=500){let t=0;return function(){let e=Date.now(),i=this,l=[...arguments];e-t>n&&(o.apply(i,l),t=e)}}class b extends y.Dialog{constructor(t){let e=`
        <div id="plugin-width__setting">
            <div style="padding-bottom: 1rem">
                40%
                <input
                    class="b3-slider fn__size200 b3-tooltips b3-tooltips__s"
                    max="100" min="40" step="1" type="range" value="${t.width}"
                    aria-label="${t.width}%" id=""
                />
                100%
            </div>
            <label class="fn__flex">
                <div class="fn__flex-1">${t.i18n.setEnableMobile}</div> 
                <span class="fn__space"></span>
                <input class="b3-switch fn__flex-center" type="checkbox">
            </label>
        </div>
        `;super({title:`${t.i18n.title}: ${t.width}%`,content:e,destroyCallback:()=>{t.save(),t.updateAllPadding(),console.log("Write width",t.width)}});s(this,"value");let i=this.element.querySelector(".b3-dialog__header"),l=this.element.querySelector(".b3-dialog__body");l.style.padding="1rem",i.style.textAlign="center";const r=this.element.querySelector("input.b3-slider");r.addEventListener("input",h=>{t.width=parseInt(h.target.value),i.innerText=`${t.i18n.title}: ${t.width}%`,r.setAttribute("aria-label",`${t.width}%`),document.documentElement.style.setProperty("--centerWidth",`${t.width}%`)});const d=this.element.querySelector("input.b3-switch");d.checked=t.enableMobile,d.addEventListener("change",h=>{t.enableMobile=h.target.checked})}}function f(o,n){let t=document.createElement("style");t.id=o,t.innerHTML=n,document.head.appendChild(t)}function v(o){let n=document.getElementById(o);n&&n.remove()}const m=()=>document.querySelector("body").classList.contains("body--window");class M extends y.Plugin{constructor(){super(...arguments);s(this,"width");s(this,"enableMobile");s(this,"iconEle");s(this,"wysiwygMap",new Map);s(this,"observer");s(this,"updateAllPaddingThrottled");s(this,"onLoadProtyle");s(this,"onDestroyProtyle");s(this,"icon",'<svg t="1684328935774" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1746" width="32" height="32"><path d="M180 176h-60c-4.4 0-8 3.6-8 8v656c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V184c0-4.4-3.6-8-8-8z m724 0h-60c-4.4 0-8 3.6-8 8v656c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V184c0-4.4-3.6-8-8-8zM785.3 504.3L657.7 403.6c-4.7-3.7-11.7-0.4-11.7 5.7V476H378v-62.8c0-6-7-9.4-11.7-5.7L238.7 508.3c-3.7 2.9-3.7 8.5 0 11.3l127.5 100.8c4.7 3.7 11.7 0.4 11.7-5.7V548h268v62.8c0 6 7 9.4 11.7 5.7l127.5-100.8c3.8-2.9 3.8-8.5 0.2-11.4z" p-id="1747"></path></svg>');s(this,"isFullWidth")}async onload(){try{await this.init()}catch(t){console.error(t)}}async init(){await this.load(),console.debug(this.enableMobile,y.getFrontend());let t=!this.enableMobile&&y.getFrontend()==="mobile";if(!t){if(m()){f("plugin-width",u),document.documentElement.style.setProperty("--centerWidth","94%");return}this.wysiwygMap=new Map,this.updateAllPaddingThrottled=g(this.updateAllPadding.bind(this),2e3),this.observer=new MutationObserver(()=>{this.updateAllPaddingThrottled()}),this.onLoadProtyle=(({detail:e})=>{var a,c;console.debug("onLoadProtyle",e);const i=e==null?void 0:e.protyle;let l=i.element.parentElement;if(!l.classList.contains("layout-tab-container")){console.debug("Not a tab document");return}const r=(c=(a=l==null?void 0:l.parentElement)==null?void 0:a.parentElement)==null?void 0:c.parentElement;if(r===void 0||!r.classList.contains("layout__center")){console.debug("Not center layout");return}let d=i==null?void 0:i.id;if(!d||(console.debug(`Load Protyle with ID = ${d}`),this.wysiwygMap.has(d)))return;let h=new WeakRef(i.wysiwyg.element);this.wysiwygMap.set(d,h),console.debug("Current WysiwygMap",this.wysiwygMap),this.updateWysiwygPadding(h),this.observer.observe(i.wysiwyg.element,{childList:!1,attributes:!0,characterData:!1,subtree:!1})}).bind(this),this.onDestroyProtyle=(({detail:e})=>{var l;console.debug("onDestroyProtyle",e);let i=(l=e==null?void 0:e.protyle)==null?void 0:l.id;console.debug("Destroy Protyle ID = ",i),this.wysiwygMap.has(i)&&(this.wysiwygMap.delete(i),console.debug("Current WysiwygMap",this.wysiwygMap))}).bind(this),this.eventBus.on("loaded-protyle-static",this.onLoadProtyle),this.eventBus.on("destroy-protyle",this.onDestroyProtyle),f("plugin-width",u),document.documentElement.style.setProperty("--centerWidth",`${this.width}%`),this.iconEle=this.addTopBar({icon:this.icon,title:this.i18n.title,position:"left",callback:()=>{if(t){y.showMessage(this.i18n.disableOnMobile,2e3,"info");return}let e=this.checkFullWidth();if(!(e===null&&this.isFullWidth===void 0)){if(this.isFullWidth&&(e=this.isFullWidth),this.isFullWidth=e,e){y.confirm(this.i18n.title,this.i18n.fullWidth);return}new b(this)}}}),window.addEventListener("beforeunload",()=>{var e,i,l;(e=this.observer)==null||e.disconnect(),(i=this.eventBus)==null||i.off("loaded-protyle-static",this.onLoadProtyle),(l=this.eventBus)==null||l.off("destroy-protyle",this.onDestroyProtyle),this.wysiwygMap.clear()})}}onLayoutReady(){console.groupCollapsed("Width Plugin: ListenInitialProtyles");let t=document.querySelectorAll("#layouts div.layout-tab-container > div.protyle");for(let e of t){let i=e.getAttribute("data-id");if(!i)continue;if(this.wysiwygMap.has(i)){console.log("Already has",i);continue}let l=e.querySelector("div.protyle-wysiwyg"),r=new WeakRef(l);this.wysiwygMap.set(i,r),console.log("Add",i,r)}this.updateAllPadding(),console.groupEnd()}updateAllPadding(){let t=[];for(let[e,i]of this.wysiwygMap)this.updateWysiwygPadding(i)||t.push(e);for(let e of t)this.wysiwygMap.delete(e)}updateWysiwygPadding(t){var i,l,r;let e=t==null?void 0:t.deref();if(e){let d=e.parentElement;if(!d||d.getAttribute("data-fullwidth")==="true")return;let a=e.parentElement.clientWidth;if(a===0){if(a=(r=(l=(i=e==null?void 0:e.parentElement)==null?void 0:i.parentElement)==null?void 0:l.parentElement)==null?void 0:r.clientWidth,!a)return;a-=10}let c=a*(1-this.width/100)/2;return e.style.setProperty("padding-left",`${c}px`),e.style.setProperty("padding-right",`${c}px`),c<16?document.documentElement.style.setProperty("--refcountRight",`-${c}px`):document.documentElement.style.setProperty("--refcountRight","-16px"),!0}return!1}async load(){let t=await this.loadData("config");console.log("Load config",t),t?(this.data.config=t,this.width=t.width,this.enableMobile=t.enableMobile):(this.width=70,this.enableMobile=!1,this.save())}async save(){this.data.config={width:this.width,enableMobile:this.enableMobile},await this.saveData("config",this.data.config),console.debug("Save config",this.data.config)}checkFullWidth(){let t=document.querySelector("div.protyle-content");return t?t.getAttribute("data-fullwidth")==="true"?(this.isFullWidth=!0,!0):(this.isFullWidth=!1,!1):null}onunload(){var t;v("plugin-width"),this.wysiwygMap=null,this.eventBus.off("loaded-protyle-static",this.onLoadProtyle),(t=this.eventBus)==null||t.off("destroy-protyle",this.onDestroyProtyle),this.observer.disconnect()}}module.exports=M;
