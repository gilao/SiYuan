{"ID":"20240527000521-5wca7zv","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f324-fe0f","id":"20240527000521-5wca7zv","title":"goctl docker","type":"doc","updated":"20240527000546"},"Children":[{"ID":"20240527000546-pg7yk2o","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240527000546-pg7yk2o","updated":"20240527000546"},"Children":[{"Type":"NodeText","Data":"概述"}]},{"ID":"20240527000546-yxss3bz","Type":"NodeParagraph","Properties":{"id":"20240527000546-yxss3bz","updated":"20240527000547"},"Children":[{"Type":"NodeText","Data":"goctl docker 命令用于生成 Dockerfile 文件，用于构建 Docker 镜像。"}]},{"ID":"20240527000546-tdxmkxg","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240527000546-tdxmkxg","updated":"20240527000546"},"Children":[{"Type":"NodeText","Data":"goctl docker 指令"}]},{"ID":"20240527000546-m965sht","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240527000546-m965sht","updated":"20240527000547"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"YmFzaA=="},{"Type":"NodeCodeBlockCode","Data":"$ goctl docker --help\nGenerate Dockerfile\n\nUsage:\n  goctl docker [flags]\n\nFlags:\n      --base string      The base image to build the docker image, default scratch (default \"scratch\")\n      --branch string    The branch of the remote repo, it does work with --remote\n      --exe string       The executable name in the built image\n      --go string        The file that contains main function\n  -h, --help             help for docker\n      --home string      The goctl home path of the template, --home and --remote cannot be set at the same time, if they are, --remote has higher priority\n      --port int         The port to expose, default none\n      --remote string    The remote git repo of the template, --home and --remote cannot be set at the same time, if they are, --remote has higher priority\n                         The git repo directory must be consistent with the https://github.com/zeromicro/go-zero-template directory structure\n      --tz string        The timezone of the container (default \"Asia/Shanghai\")\n      --version string   The goctl builder golang image version\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240527000546-hll5pjc","Type":"NodeParagraph","Properties":{"id":"20240527000546-hll5pjc","updated":"20240527000547"},"Children":[{"Type":"NodeText","Data":"Copy"}]},{"ID":"20240527000546-2hyn4l6","Type":"NodeTable","TableAligns":[0,0,0,0,0],"Properties":{"colgroup":"||||","id":"20240527000546-2hyn4l6","updated":"20240527000547"},"Children":[{"Type":"NodeTableHead","Data":"thead","Children":[{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"参数字段"}]},{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"参数类型"}]},{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"是否必填"}]},{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"默认值"}]},{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"参数说明"}]}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"base"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"string"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"NO"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"scratch"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"基础镜像"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"branch"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"string"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"NO"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"空字符串"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"远程模板所在 git 分支名称，仅当 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"remote"},{"Type":"NodeText","Data":"​ 有值时使用"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"exe"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"string"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"NO"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"主函数文件名"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"输出的可执行文件名称"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"go"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"string"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"YES"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"空字符串"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"主函数文件名称"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"home"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"string"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"NO"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"${HOME}/.goctl"},{"Type":"NodeText","Data":"​"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"本地模板文件目录"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"port"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"int"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"NO"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"0"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"需要暴露的端口号，如果没传或者传0，则不暴露端口号"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"remote"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"string"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"NO"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"空字符串"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"远程模板所在 git 仓库地址，当此字段传值时，优先级高于 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"home"},{"Type":"NodeText","Data":"​ 字段值"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"tz"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"string"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"NO"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Asia/Shanghai"},{"Type":"NodeText","Data":"​"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"时区设置"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"version"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"string"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"YES"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"空字符串"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"Golang 镜像版本号"}]}]}]},{"ID":"20240527000546-n3rxhfr","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240527000546-n3rxhfr","updated":"20240527000546"},"Children":[{"Type":"NodeText","Data":"使用示例"}]},{"ID":"20240527000546-icgdtu2","Type":"NodeParagraph","Properties":{"id":"20240527000546-icgdtu2","updated":"20240527000547"},"Children":[{"Type":"NodeText","Data":"我们用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"goctl api new hello"},{"Type":"NodeText","Data":"​ 命令创建一个 Demo 项目，然后进入项目目录，执行 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"goctl docker"},{"Type":"NodeText","Data":"​ 命令，生成 Dockerfile 文件。"}]},{"ID":"20240527000546-sw2nhjd","Type":"NodeParagraph","Properties":{"id":"20240527000546-sw2nhjd","updated":"20240527000547"},"Children":[{"Type":"NodeText","Data":"以下通过终端指令演示如何从零开始创建一个 goctl 项目，然后生成 Dockerfile 文件，到最后构建 Docker 镜像，最后运行 Docker 容器的过程。"}]},{"ID":"20240527000546-b2ohdyi","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240527000546-b2ohdyi","updated":"20240527000547"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"YmFzaA=="},{"Type":"NodeCodeBlockCode","Data":"# 进入到个人 home 目录\n$ cd ~\n\n# 创建一个 hello 项目\n$ goctl api new hello\nDone.\n\n# 进入到 hello 项目目录\n$ cd hello\n\n# 查看目录结构\n$ tree\n.\n├── etc\n│   └── hello-api.yaml\n├── go.mod\n├── hello.api\n├── hello.go\n└── internal\n    ├── config\n    │   └── config.go\n    ├── handler\n    │   ├── hellohandler.go\n    │   └── routes.go\n    ├── logic\n    │   └── hellologic.go\n    ├── svc\n    │   └── servicecontext.go\n    └── types\n        └── types.go\n\n7 directories, 10 files\n\n# 生成 Dockerfile 文件\n$ goctl docker --go hello.go --exe hello\nHint: run \"docker build ...\" command in dir:\n    /Users/keson/hello\nDone.\n\n# 查看 Dockerfile 文件\n$ cat Dockerfile\nFROM golang:alpine AS builder\n\nLABEL stage=gobuilder\n\nENV CGO_ENABLED 0\nENV GOPROXY https://goproxy.cn,direct\nRUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories\n\nRUN apk update --no-cache \u0026\u0026 apk add --no-cache tzdata\n\nWORKDIR /build\n\nADD go.mod .\nADD go.sum .\nRUN go mod download\nCOPY . .\nCOPY ./etc /app/etc\nRUN go build -ldflags=\"-s -w\" -o /app/hello hello.go\n\n\nFROM scratch\n\nCOPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt\nCOPY --from=builder /usr/share/zoneinfo/Asia/Shanghai /usr/share/zoneinfo/Asia/Shanghai\nENV TZ Asia/Shanghai\n\nWORKDIR /app\nCOPY --from=builder /app/hello /app/hello\nCOPY --from=builder /app/etc /app/etc\n\nCMD [\"./hello\", \"-f\", \"etc/hello-api.yaml\"]\n\n# 拉取 go 依赖\n$ go mod tidy\ngo: finding module for package github.com/zeromicro/go-zero/core/conf\ngo: finding module for package github.com/zeromicro/go-zero/core/logx\ngo: finding module for package github.com/zeromicro/go-zero/rest\ngo: finding module for package github.com/zeromicro/go-zero/rest/httpx\ngo: found github.com/zeromicro/go-zero/core/conf in github.com/zeromicro/go-zero v1.4.3\ngo: found github.com/zeromicro/go-zero/rest in github.com/zeromicro/go-zero v1.4.3\ngo: found github.com/zeromicro/go-zero/rest/httpx in github.com/zeromicro/go-zero v1.4.3\ngo: found github.com/zeromicro/go-zero/core/logx in github.com/zeromicro/go-zero v1.4.3\n\n# 在 hello 项目目录下，执行 docker build 命令，生成镜像\n$ docker build -t hello:v1 .\n[+] Building 72.5s (20/20) FINISHED\n =\u003e [internal] load build definition from Dockerfile                                                     0.0s\n =\u003e =\u003e transferring dockerfile: 37B                                                                      0.0s\n =\u003e [internal] load .dockerignore                                                                        0.0s\n =\u003e =\u003e transferring context: 2B                                                                          0.0s\n =\u003e [internal] load metadata for docker.io/library/golang:alpine                                         1.0s\n =\u003e [internal] load build context                                                                        0.2s\n =\u003e =\u003e transferring context: 142.47kB                                                                    0.1s\n =\u003e [builder  1/10] FROM docker.io/library/golang:alpine@sha256:a9b24b67dc83b3383d22a14941c2b2b2ca6a10  25.5s\n =\u003e =\u003e resolve docker.io/library/golang:alpine@sha256:a9b24b67dc83b3383d22a14941c2b2b2ca6a103d805cac682  0.0s\n =\u003e =\u003e sha256:7f1d6579712341e8062db43195deb2d84f63b0f2d1ed7c3d2074891085ea1b56 116.88MB / 116.88MB      19.9s\n =\u003e =\u003e sha256:a9b24b67dc83b3383d22a14941c2b2b2ca6a103d805cac6820fd1355943beaf1 1.65kB / 1.65kB           0.0s\n =\u003e =\u003e sha256:d34d005738c897bad9671117acf4a27fe7d5ab80e129bf2aba2fa7c344c416e4 1.16kB / 1.16kB           0.0s\n =\u003e =\u003e sha256:3b877c93f9b7d6e7c07329c02d3a29d306b35bbe06d1c79d00d54d6ce2e5a360 5.13kB / 5.13kB           0.0s\n =\u003e =\u003e sha256:261da4162673b93e5c0e7700a3718d40bcc086dbf24b1ec9b54bca0b82300626 3.26MB / 3.26MB           2.7s\n =\u003e =\u003e sha256:bc729abf26b5aade3c4426d388b5ea6907fe357dec915ac323bb2fa592d6288f 286.22kB / 286.22kB       1.8s\n =\u003e =\u003e sha256:652874aefa1343799c619d092ab9280b25f96d97939d5d796437e7288f5599c9 156B / 156B               2.3s\n =\u003e =\u003e extracting sha256:261da4162673b93e5c0e7700a3718d40bcc086dbf24b1ec9b54bca0b82300626                0.2s\n =\u003e =\u003e extracting sha256:bc729abf26b5aade3c4426d388b5ea6907fe357dec915ac323bb2fa592d6288f                0.1s\n =\u003e =\u003e extracting sha256:7f1d6579712341e8062db43195deb2d84f63b0f2d1ed7c3d2074891085ea1b56                5.2s\n =\u003e =\u003e extracting sha256:652874aefa1343799c619d092ab9280b25f96d97939d5d796437e7288f5599c9                0.0s\n =\u003e [builder  2/10] RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories     0.6s\n =\u003e [builder  3/10] RUN apk update --no-cache \u0026\u0026 apk add --no-cache tzdata                              24.6s\n =\u003e [builder  4/10] WORKDIR /build                                                                       0.0s\n =\u003e [builder  5/10] ADD go.mod .                                                                         0.0s\n =\u003e [builder  6/10] ADD go.sum .                                                                         0.0s\n =\u003e [builder  7/10] RUN go mod download                                                                 11.3s\n =\u003e [builder  8/10] COPY . .                                                                             0.0s\n =\u003e [builder  9/10] COPY ./etc /app/etc                                                                  0.0s\n =\u003e [builder 10/10] RUN go build -ldflags=\"-s -w\" -o /app/hello hello.go                                 9.1s\n =\u003e [stage-1 1/5] COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates  0.0s\n =\u003e [stage-1 2/5] COPY --from=builder /usr/share/zoneinfo/Asia/Shanghai /usr/share/zoneinfo/Asia/Shangh  0.0s\n =\u003e [stage-1 3/5] WORKDIR /app                                                                           0.0s\n =\u003e [stage-1 4/5] COPY --from=builder /app/hello /app/hello                                              0.0s\n =\u003e [stage-1 5/5] COPY --from=builder /app/etc /app/etc                                                  0.0s\n =\u003e exporting to image                                                                                   0.1s\n =\u003e =\u003e exporting layers                                                                                  0.1s\n =\u003e =\u003e writing image sha256:586fe3aab42d3d27ad73118334be072577801de18c22694b380161f00656dd7a             0.0s\n =\u003e =\u003e naming to docker.io/library/hello:v1                                                              0.0s\n\nUse 'docker scan' to run Snyk tests against images to find vulnerabilities and learn how to fix them\n\n# 启动服务\n$ docker run --rm -it -p 8888:8888 hello:v1\nStarting server at 0.0.0.0:8888...\n\n# 单开一个终端 curl 测试\n$ curl -i http://localhost:8888/from/you\ncurl -i http://localhost:8888/from/you\nHTTP/1.1 200 OK\nContent-Type: application/json; charset=utf-8\nTraceparent: 00-7950f2af01228e73c5adcf1670e309d2-2d8262ef5bd4f5a2-00\nDate: Fri, 06 Jan 2023 06:41:34 GMT\nContent-Length: 4\n\nnull%\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240527000521-xlahe6t","Type":"NodeParagraph","Properties":{"id":"20240527000521-xlahe6t","updated":"20240527000547"}}]}