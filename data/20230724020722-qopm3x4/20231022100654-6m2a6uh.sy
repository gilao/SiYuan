{"ID":"20231022100654-6m2a6uh","Spec":"1","Type":"NodeDocument","Properties":{"icon":"231b","id":"20231022100654-6m2a6uh","scroll":"\u0026#123;\u0026quot;rootId\u0026quot;:\u0026quot;20231022100654-6m2a6uh\u0026quot;,\u0026quot;startId\u0026quot;:\u0026quot;20231022100655-x2ji4ab\u0026quot;,\u0026quot;endId\u0026quot;:\u0026quot;20231023092700-nm60djl\u0026quot;,\u0026quot;scrollTop\u0026quot;:0,\u0026quot;focusId\u0026quot;:\u0026quot;20231023092700-nm60djl\u0026quot;,\u0026quot;focusStart\u0026quot;:0,\u0026quot;focusEnd\u0026quot;:0\u0026#125;","tags":"公众号-熊猫云原生Go,Dockerfile,shell脚本","title":"Dockerfile 支持内置Shell脚本， 从此告别 \u0026amp;\u0026amp; 链接符号","updated":"20231023092700"},"Children":[{"ID":"20231022100655-x2ji4ab","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20231022100655-x2ji4ab","updated":"20231022101245"},"Children":[{"Type":"NodeText","Data":"Dockerfile Here-Document Syntax 语法"}]},{"ID":"20231022101245-4c8ub00","Type":"NodeParagraph","Properties":{"id":"20231022101245-4c8ub00","updated":"20231022101305"},"Children":[{"Type":"NodeText","Data":"首先， 按照官网文档将 docker engine 版本升到最新。 以 "},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://docs.docker.com/engine/install/ubuntu/","TextMarkTextContent":"ubuntu - docker"},{"Type":"NodeText","Data":" 为例"}]},{"ID":"20231022101306-g06l9me","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231022101306-g06l9me","updated":"20231022101313"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"c2hlbGw="},{"Type":"NodeCodeBlockCode","Data":"sudo apt-get install docker-ce docker-ce-cli containerd.io \\\n    docker-buildx-plugin docker-compose-plugin\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231022101331-j8j8exs","Type":"NodeParagraph","Properties":{"id":"20231022101331-j8j8exs","updated":"20231022101352"},"Children":[{"Type":"NodeText","Data":"其次， 在 Docker Hub 上找到对应的 redis 官方 dockerfile"}]},{"ID":"20231022101331-b8q1txm","Type":"NodeParagraph","Properties":{"id":"20231022101331-b8q1txm","updated":"20231022101331"},"Children":[{"Type":"NodeText","Data":"可以看到， "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RUN"},{"Type":"NodeText","Data":"​ 内容虽然没有通过 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026amp;\u0026amp;"},{"Type":"NodeText","Data":"​ 链接， 但是都是使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"; 和 \\"},{"Type":"NodeText","Data":"​ 进行 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"分段，换行"},{"Type":"NodeText","Data":" 管理的， 还是有一定不便。"}]},{"ID":"20231022101404-5n8gzcq","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231022101404-5n8gzcq","updated":"20231022101942"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"ZG9ja2VyZmlsZQ=="},{"Type":"NodeCodeBlockCode","Data":"RUN set -eux; \\\n    \\\n    savedAptMark=\"$(apt-mark showmanual)\"; \\\n    apt-get update; \\\n    apt-get install -y --no-install-recommends \\\n        cat-certificates \\\n        wget \\\n        \\\n        dpkg-dev \\\n        gcc \\\n        libc6-dev \\\n        libssl-dev \\\n        make \\\n; \\\nrm -rf /var/lib/apt/lists/*; \\\n\\\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231022101433-88v52el","Type":"NodeParagraph","Properties":{"id":"20231022101433-88v52el","updated":"20231022102017"},"Children":[{"Type":"NodeText","Data":"稍微改造一下， (1) 删除所有 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"链接作用"},{"Type":"NodeText","Data":" 的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"; 和 \\"},{"Type":"NodeText","Data":"​， (2) 取消 RUN 的所有缩进。 这就是 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"一个Shell脚本"},{"Type":"NodeText","Data":" 了"}]},{"ID":"20231022202956-8d6li8i","Type":"NodeParagraph","Properties":{"id":"20231022202956-8d6li8i","updated":"20231022203025"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"划重点："},{"Type":"NodeText","Data":"这就是 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"一个Shell脚本"},{"Type":"NodeText","Data":" 了。 换句话说， "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"在本地测试完成之后， 可以直接复制到  Dockerfile 中了"},{"Type":"NodeText","Data":"。而之前， 还需要使用 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"\u0026amp;\u0026amp;"},{"Type":"NodeText","Data":" 链接整理命令。"}]},{"ID":"20231022102018-04okwe0","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231022102018-04okwe0","updated":"20231022204905"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"ZG9ja2VyZmlsZQ=="},{"Type":"NodeCodeBlockCode","Data":"RUN \u003c\u003cEOT\n#!/bin/bash\nset -eux;\nsavedAptMark=\"$(apt-mark showmanual)\";\napt-get update \napt-get install -y --no-install-recommends ca-certificates gnupg wget;\nrm -rf /var/lib/apt/lists/*;\ndpkgArch=\"$(dpkg --print-architecture | awk -F- '{ print $NF }')\"; \\\nwget -O /usr/loca/bin/gosu \"https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu_$dpkgArch\"; \\\nexport GNUPGHOME=\"$(mktemp -d)\";\ngpg --batch --keyserver hkps://keys.openpgp.org --recv-keys B$@  f6819007F00F88E364FD436A9C25BF357DD4;\ngpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu;\ngpgconf --kill all;\nEOT;\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231022204907-25o3o55","Type":"NodeBlockquote","Properties":{"id":"20231022204907-25o3o55","updated":"20231022204927"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20231022204924-8r1klwz","Type":"NodeParagraph","Properties":{"id":"20231022204924-8r1klwz","updated":"20231022204927"},"Children":[{"Type":"NodeText","Data":"注意: 这里必须使用以下格式， 否则 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"局部变量向下无法传递"},{"Type":"NodeText","Data":"。"}]}]},{"ID":"20231022204927-0zl8him","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231022204927-0zl8him","updated":"20231022204954"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"ZG9ja2VyZmlsZQ=="},{"Type":"NodeCodeBlockCode","Data":"RUN \u003c\u003c EOT\n#!/bin/bash\n# statment\nEOT\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231022204959-pk8b696","Type":"NodeParagraph","Properties":{"id":"20231022204959-pk8b696","updated":"20231022205101"},"Children":[{"Type":"NodeText","Data":"直接使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"docker build"},{"Type":"NodeText","Data":"​命令构建镜像，看看执行结果"}]},{"ID":"20231022205103-w0r4p9z","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231022205103-w0r4p9z","updated":"20231022205136"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"YmFzaA=="},{"Type":"NodeCodeBlockCode","Data":"docker build -t example.com/redis:7.0-here -f redis.Dockerfile .\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231022205143-195ft9t","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20231022205143-195ft9t","updated":"20231022205231"},"Children":[{"Type":"NodeText","Data":"Troubleshooting"}]},{"ID":"20231022205231-zmpwoh4","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20231022205231-zmpwoh4","updated":"20231022205249"},"Children":[{"Type":"NodeText","Data":"变量传递问题"}]},{"ID":"20231022205252-gkutkfk","Type":"NodeBlockquote","Properties":{"id":"20231022205252-gkutkfk","updated":"20231022205305"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20231022205254-gd18sb8","Type":"NodeParagraph","Properties":{"id":"20231022205254-gd18sb8","updated":"20231022205305"},"Children":[{"Type":"NodeText","Data":"关于以下两种模式， 官网文档并没有说明为什么。仅从对比实验效果上推测， 具体实现还没有研究。"}]}]},{"ID":"20231022205305-1b6nfek","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20231022205305-1b6nfek","updated":"20231022205327"},"Children":[{"Type":"NodeText","Data":"模式一：bash 直接跟在 EOT后面"}]},{"ID":"20231023091116-y2dmeuu","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231023091116-y2dmeuu","updated":"20231023091503"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"ZG9ja2VyZmlsZQ=="},{"Type":"NodeCodeBlockCode","Data":"RUN \u003c\u003cEOT bash\ndist=$(uname -s)\nwget -o example.com/app-$(dist) app-$(dist)\nEOT\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231023091511-0hpxy6q","Type":"NodeParagraph","Properties":{"id":"20231023091511-0hpxy6q","updated":"20231023091526"},"Children":[{"Type":"NodeText","Data":"这种模式下，"},{"Type":"NodeTextMark","Properties":{"style":"background-color: var(--b3-card-error-background); color: var(--b3-card-error-color);"},"TextMarkType":"text","TextMarkTextContent":" 第一行的变量 dist 在第二行 wget 中无法使用"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"background-color: var(--b3-card-error-background); color: var(--b3-card-error-color);\"}"},{"Type":"NodeText","Data":"。因此 wget 实际解析出来的命令为"}]},{"ID":"20231023091530-wytiblf","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231023091530-wytiblf","updated":"20231023091546"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"ZG9ja2VyZmlsZQ=="},{"Type":"NodeCodeBlockCode","Data":"wget -o example.com/app- app-\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231023091527-i2ejpzc","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20231023091527-i2ejpzc","updated":"20231023091601"},"Children":[{"Type":"NodeText","Data":"模式二：在多行内容中 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"首行"},{"Type":"NodeText","Data":" 指定解释器 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"#!/bin/bash"},{"Type":"NodeText","Data":"​， 则所有内容整体被看作一个 Shell 脚本。"}]},{"ID":"20231023091602-wpbkgu0","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231023091602-wpbkgu0","updated":"20231023091653"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"ZG9ja2VyZmlsZQ=="},{"Type":"NodeCodeBlockCode","Data":"RUN \u003c\u003cEOT \n#!/bin/bash\ndist-$(uname -s)\nwget -o example.com/app-$(dist) app-$(dist)\nEOT\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231023091659-9aesu3j","Type":"NodeParagraph","Properties":{"id":"20231023091659-9aesu3j","updated":"20231023091659"},"Children":[{"Type":"NodeText","Data":"这种模式下， wget 实际解析出来的命令为"}]},{"ID":"20231023091701-pharw6k","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231023091701-pharw6k","updated":"20231023091708"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"ZG9ja2VyZmlsZQ=="},{"Type":"NodeCodeBlockCode","Data":"wget -O example.com/app-Linux app-Linux\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231023091709-htycixq","Type":"NodeParagraph","Properties":{"id":"20231023091709-htycixq","updated":"20231023091715"},"Children":[{"Type":"NodeText","Data":"符合预期"}]},{"ID":"20231023091716-xh8ypgm","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20231023091716-xh8ypgm","updated":"20231023091729"},"Children":[{"Type":"NodeText","Data":"没有buildkit 配置文件"}]},{"ID":"20231023091729-goaeibl","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231023091729-goaeibl","updated":"20231023092253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"ZG9ja2VyZmlsZQ=="},{"Type":"NodeCodeBlockCode","Data":"ls: cannot access '/root/.docker/buildx/instances/default': No such file or directory\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231023092253-lmktpjq","Type":"NodeParagraph","Properties":{"id":"20231023092253-lmktpjq","updated":"20231023092258"},"Children":[{"Type":"NodeText","Data":"找不到默认的 buildx 配置， 使用如下即可。"}]},{"ID":"20231023092259-kbyu50f","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231023092259-kbyu50f","updated":"20231023092658"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"ZG9ja2VyZmlsZQ=="},{"Type":"NodeCodeBlockCode","Data":"{\n    \"Name\": \"localbuilder\",\n    \"Driver\": \"docker-container\",\n    \"Nodes\": [\n        {\n            \"Name\": \"localbuilder0\",\n            \"Endpoint\": \"unix:///var/run/docker.sock\",\n            \"Platforms\": [\n                {\n                    \"architecture\": \"amd64\",\n                    \"os\": \"linux\"\n                },\n                {\n                    \"architecture\": \"arm64\",\n                    \"os\": \"linux\"\n                }\n            ],\n            \"Flags\": null,\n            \"ConfigFile\": \"\",\n            \"DriverOpts\": {}\n        }\n    ],\n    \"Dynamic\": false\n}"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231023092700-nm60djl","Type":"NodeParagraph","Properties":{"id":"20231023092700-nm60djl"}}]}