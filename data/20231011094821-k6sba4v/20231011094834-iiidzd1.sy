{"ID":"20231011094834-iiidzd1","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f964","id":"20231011094834-iiidzd1","scroll":"\u0026#123;\u0026quot;rootId\u0026quot;:\u0026quot;20231011094834-iiidzd1\u0026quot;,\u0026quot;startId\u0026quot;:\u0026quot;20231011094834-qwl7t0b\u0026quot;,\u0026quot;endId\u0026quot;:\u0026quot;20231011094908-4on7zna\u0026quot;,\u0026quot;scrollTop\u0026quot;:0,\u0026quot;focusId\u0026quot;:\u0026quot;20231011094908-4on7zna\u0026quot;,\u0026quot;focusStart\u0026quot;:0,\u0026quot;focusEnd\u0026quot;:0\u0026#125;","tags":"未完成","title":"数据库和缓存双向数据库一致性问题","updated":"20240219164924"},"Children":[{"ID":"20231011094834-qwl7t0b","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20231011094834-qwl7t0b","updated":"20240219153359"},"Children":[{"Type":"NodeText","Data":"前言"}]},{"ID":"20240219153411-6qd1jbd","Type":"NodeParagraph","Properties":{"id":"20240219153411-6qd1jbd","updated":"20240219153411"},"Children":[{"Type":"NodeText","Data":"数据库和缓存（比如：redis）双写数据一致性问题，是一个跟开发语言无关的公共问题。尤其在高并发的场景下，这个问题变得更加严重。"}]},{"ID":"20240219153411-1fbwmzp","Type":"NodeParagraph","Properties":{"id":"20240219153411-1fbwmzp","updated":"20240219153411"},"Children":[{"Type":"NodeText","Data":"我很负责的告诉大家，该问题无论在面试，还是工作中遇到的概率非常大，所以非常有必要跟大家一起探讨一下。"}]},{"ID":"20240219153411-441tmh2","Type":"NodeParagraph","Properties":{"id":"20240219153411-441tmh2","updated":"20240219153411"},"Children":[{"Type":"NodeText","Data":"今天这篇文章我会从浅入深，跟大家一起聊聊，数据库和缓存双写数据一致性问题常见的解决方案，这些方案中可能存在的坑，以及最优方案是什么。"}]},{"ID":"20240219153412-txjbbha","Type":"NodeParagraph","Properties":{"id":"20240219153412-txjbbha","updated":"20240219153412"}},{"ID":"20240219153412-kn43x55","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240219153412-kn43x55","updated":"20240219153835"},"Children":[{"Type":"NodeText","Data":"一、常见方案"}]},{"ID":"20240219153427-tycncgg","Type":"NodeParagraph","Properties":{"id":"20240219153427-tycncgg","updated":"20240219153835"},"Children":[{"Type":"NodeText","Data":"通常情况下，我们使用缓存的主要目的是为了提升查询的性能。大多数情况下，我们是这样使用缓存的："}]},{"ID":"20240219153447-aesrid2","Type":"NodeParagraph","Properties":{"id":"20240219153447-aesrid2","updated":"20240219153835"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240219153447-7y6ggbk.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240219153457-whh0yjl","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219153457-whh0yjl","updated":"20240219153835"},"Children":[{"ID":"20240219153457-sgr6dvz","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219153457-sgr6dvz","updated":"20240219153457"},"Children":[{"ID":"20240219153457-f7mvlxe","Type":"NodeParagraph","Properties":{"id":"20240219153457-f7mvlxe","updated":"20240219153457"},"Children":[{"Type":"NodeText","Data":"用户请求过来之后，先查缓存有没有数据，如果有则直接返回。"}]}]},{"ID":"20240219153457-0rtnwce","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219153457-0rtnwce","updated":"20240219153457"},"Children":[{"ID":"20240219153457-d3a3pz1","Type":"NodeParagraph","Properties":{"id":"20240219153457-d3a3pz1","updated":"20240219153457"},"Children":[{"Type":"NodeText","Data":"如果缓存没数据，再继续查数据库。"}]}]},{"ID":"20240219153457-qxv0edf","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240219153457-qxv0edf","updated":"20240219153457"},"Children":[{"ID":"20240219153457-ku9zyyf","Type":"NodeParagraph","Properties":{"id":"20240219153457-ku9zyyf","updated":"20240219153457"},"Children":[{"Type":"NodeText","Data":"如果数据库有数据，则将查询出来的数据，放入缓存中，然后返回该数据。"}]}]},{"ID":"20240219153457-1llcult","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20240219153457-1llcult","updated":"20240219153457"},"Children":[{"ID":"20240219153457-bkd24rs","Type":"NodeParagraph","Properties":{"id":"20240219153457-bkd24rs","updated":"20240219153457"},"Children":[{"Type":"NodeText","Data":"如果数据库也没数据，则直接返回空。"}]}]}]},{"ID":"20240219153512-vuhkuns","Type":"NodeParagraph","Properties":{"id":"20240219153512-vuhkuns","updated":"20240219153835"},"Children":[{"Type":"NodeText","Data":"这是缓存非常常见的用法。一眼看上去，好像没有啥问题。"}]},{"ID":"20240219153512-b4f6qfl","Type":"NodeParagraph","Properties":{"id":"20240219153512-b4f6qfl","updated":"20240219153835"},"Children":[{"Type":"NodeText","Data":"但你忽略了一个非常重要的细节："},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"如果数据库中的某条数据，放入缓存之后，又立马被更新了，那么该如何更新缓存呢？"}]},{"ID":"20240219153514-fzerfqu","Type":"NodeParagraph","Properties":{"id":"20240219153514-fzerfqu","updated":"20240219153835"}},{"ID":"20240219153600-8ba53yp","Type":"NodeParagraph","Properties":{"id":"20240219153600-8ba53yp","style":"color: var(--b3-font-color10);","updated":"20240219153835"},"Children":[{"Type":"NodeText","Data":"不更新缓存行不行？"}]},{"ID":"20240219153600-00rxhvt","Type":"NodeParagraph","Properties":{"id":"20240219153600-00rxhvt","style":"color: var(--b3-font-color10);","updated":"20240219153835"},"Children":[{"Type":"NodeText","Data":"答：当然不行，如果不更新缓存，在很长的一段时间内（决定于缓存的过期时间），用户请求从缓存中获取到的都可能是旧值，而非数据库的最新值。这不是有数据不一致的问题？"}]},{"ID":"20240219153658-3mz8cdj","Type":"NodeParagraph","Properties":{"id":"20240219153658-3mz8cdj","updated":"20240219153835"}},{"ID":"20240219153708-ra9ev8c","Type":"NodeParagraph","Properties":{"id":"20240219153708-ra9ev8c","updated":"20240219153835"},"Children":[{"Type":"NodeText","Data":"那么，我们该如何更新缓存呢？"}]},{"ID":"20240219153708-903ic75","Type":"NodeParagraph","Properties":{"id":"20240219153708-903ic75","updated":"20240219153835"},"Children":[{"Type":"NodeText","Data":"目前有以下4种方案："}]},{"ID":"20240219153708-lzf1tfs","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219153708-lzf1tfs","updated":"20240219153835"},"Children":[{"ID":"20240219153708-7qjouva","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219153708-7qjouva","updated":"20240219153708"},"Children":[{"ID":"20240219153708-kfatt3v","Type":"NodeParagraph","Properties":{"id":"20240219153708-kfatt3v","updated":"20240219153708"},"Children":[{"Type":"NodeText","Data":"先写缓存，再写数据库"}]}]},{"ID":"20240219153708-b3w9vig","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219153708-b3w9vig","updated":"20240219153708"},"Children":[{"ID":"20240219153708-5o6h4ag","Type":"NodeParagraph","Properties":{"id":"20240219153708-5o6h4ag","updated":"20240219153708"},"Children":[{"Type":"NodeText","Data":"先写数据库，再写缓存"}]}]},{"ID":"20240219153708-nf583bx","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240219153708-nf583bx","updated":"20240219153708"},"Children":[{"ID":"20240219153708-euennyz","Type":"NodeParagraph","Properties":{"id":"20240219153708-euennyz","updated":"20240219153708"},"Children":[{"Type":"NodeText","Data":"先删缓存，再写数据库"}]}]},{"ID":"20240219153708-t1o36q4","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20240219153708-t1o36q4","updated":"20240219153708"},"Children":[{"ID":"20240219153708-89cnkfv","Type":"NodeParagraph","Properties":{"id":"20240219153708-89cnkfv","updated":"20240219153708"},"Children":[{"Type":"NodeText","Data":"先写数据库，再删缓存"}]}]}]},{"ID":"20240219153708-bgcaibz","Type":"NodeParagraph","Properties":{"id":"20240219153708-bgcaibz","updated":"20240219153835"},"Children":[{"Type":"NodeText","Data":"接下来，我们详细说说这4种方案。"}]},{"ID":"20240219153710-jhixik1","Type":"NodeParagraph","Properties":{"id":"20240219153710-jhixik1","updated":"20240219153710"}},{"ID":"20240219153843-mf5xta5","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240219153843-mf5xta5","updated":"20240219153908"},"Children":[{"Type":"NodeText","Data":"1. 先写缓存，再写数据库"}]},{"ID":"20240219153916-e9fjlw4","Type":"NodeParagraph","Properties":{"id":"20240219153916-e9fjlw4","updated":"20240219153916"},"Children":[{"Type":"NodeText","Data":"对于更新缓存的方案，很多人第一个想到的可能是在写操作中直接更新缓存（写缓存），更直接明了。"}]},{"ID":"20240219153916-ebnb8i0","Type":"NodeParagraph","Properties":{"id":"20240219153916-ebnb8i0","updated":"20240219153916"},"Children":[{"Type":"NodeText","Data":"那么，问题来了：在写操作中，到底是先写缓存，还是先写数据库呢？"}]},{"ID":"20240219153916-7ws4z7z","Type":"NodeParagraph","Properties":{"id":"20240219153916-7ws4z7z","updated":"20240219153916"},"Children":[{"Type":"NodeText","Data":"我们在这里先聊聊先写缓存，再写数据库的情况，因为它的问题最严重。"}]},{"ID":"20240219153930-nyc5fqu","Type":"NodeParagraph","Properties":{"id":"20240219153930-nyc5fqu","updated":"20240219153935"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240219153930-rt6dfoj.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240219153936-0qmgyff","Type":"NodeParagraph","Properties":{"id":"20240219153936-0qmgyff","updated":"20240219153940"},"Children":[{"Type":"NodeText","Data":"某一个用户的每一次写操作，如果刚写完缓存，突然网络出现了异常，导致写数据库失败了。"}]},{"ID":"20240219153956-qzm9hgy","Type":"NodeParagraph","Properties":{"id":"20240219153956-qzm9hgy","updated":"20240219154000"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240219153956-24fqb4q.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240219154002-n7fes3r","Type":"NodeParagraph","Properties":{"id":"20240219154002-n7fes3r","updated":"20240219154025"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"其结果是缓存更新成了最新数据，但数据库没有，这样缓存中的数据不就变成脏数据了？如果此时该用户的查询请求，正好读取到该数据，就会出现问题，因为该数据在数据库中根本不存在，这个问题非常严重。"}]},{"ID":"20240219154029-ipv6azx","Type":"NodeParagraph","Properties":{"id":"20240219154029-ipv6azx","updated":"20240219154029"}},{"ID":"20240219154039-kdb7dl4","Type":"NodeParagraph","Properties":{"id":"20240219154039-kdb7dl4","updated":"20240219154039"},"Children":[{"Type":"NodeText","Data":"我们都知道，缓存的主要目的是把数据库的数据临时保存在内存，便于后续的查询，提升查询速度。"}]},{"ID":"20240219154039-uyd4dos","Type":"NodeParagraph","Properties":{"id":"20240219154039-uyd4dos","updated":"20240219154039"},"Children":[{"Type":"NodeText","Data":"但如果某条数据，在数据库中都不存在，你缓存这种“"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"假数据"},{"Type":"NodeText","Data":"​”又有啥意义呢？"}]},{"ID":"20240219154039-vavw44q","Type":"NodeParagraph","Properties":{"id":"20240219154039-vavw44q","updated":"20240219154039"},"Children":[{"Type":"NodeText","Data":"因此，先写缓存，再写数据库的方案是不可取的，在实际工作中用得不多。"}]},{"ID":"20240219154048-9urqxwe","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240219154048-9urqxwe","updated":"20240219154108"},"Children":[{"Type":"NodeText","Data":"2. 先写数据库，再写缓存"}]},{"ID":"20240219154109-znae7x9","Type":"NodeParagraph","Properties":{"id":"20240219154109-znae7x9","updated":"20240219154114"},"Children":[{"Type":"NodeText","Data":"既然上面的方案行不通，接下来，聊聊先写数据库，再写缓存的方案，该方案在低并发编程中有人在用（我猜的）。"}]},{"ID":"20240219154123-tav3hx7","Type":"NodeParagraph","Properties":{"id":"20240219154123-tav3hx7","updated":"20240219154128"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240219154123-ci9rui1.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240219154136-er3gzpp","Type":"NodeParagraph","Properties":{"id":"20240219154136-er3gzpp","updated":"20240219154136"},"Children":[{"Type":"NodeText","Data":"用户的写操作，先写数据库，再写缓存，可以避免之前“假数据”的问题。但它却带来了新的问题。"}]},{"ID":"20240219154136-4tffiup","Type":"NodeParagraph","Properties":{"id":"20240219154136-4tffiup","updated":"20240219154136"},"Children":[{"Type":"NodeText","Data":"什么问题呢？"}]},{"ID":"20240219154136-2frde2a","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240219154136-2frde2a","updated":"20240219154153"},"Children":[{"Type":"NodeText","Data":"2.1 写缓存失败了"}]},{"ID":"20240219154156-cmrj1z4","Type":"NodeParagraph","Properties":{"id":"20240219154156-cmrj1z4","updated":"20240219154202"},"Children":[{"Type":"NodeText","Data":"如果把写数据库和写缓存操作，放在同一个事务当中，当写缓存失败了，我们可以把写入数据库的数据进行回滚。"}]},{"ID":"20240219154214-hi5367g","Type":"NodeParagraph","Properties":{"id":"20240219154214-hi5367g","updated":"20240219154223"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240219154214-993nnba.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240219154238-v7zbd70","Type":"NodeParagraph","Properties":{"id":"20240219154238-v7zbd70","updated":"20240219154238"},"Children":[{"Type":"NodeText","Data":"如果是并发量比较小，对接口性能要求不太高的系统，可以这么玩。"}]},{"ID":"20240219154238-q2eszcf","Type":"NodeParagraph","Properties":{"id":"20240219154238-q2eszcf","updated":"20240219154238"},"Children":[{"Type":"NodeText","Data":"但如果在高并发的业务场景中，写数据库和写缓存，都属于远程操作。为了防止出现大事务，造成的死锁问题，通常建议写数据库和写缓存不要放在同一个事务中。"}]},{"ID":"20240219154238-20zl43h","Type":"NodeParagraph","Properties":{"id":"20240219154238-20zl43h","updated":"20240219154238"},"Children":[{"Type":"NodeText","Data":"也就是说在该方案中，如果写数据库成功了，但写缓存失败了，数据库中已写入的数据不会回滚。"}]},{"ID":"20240219154238-99nbgcb","Type":"NodeParagraph","Properties":{"id":"20240219154238-99nbgcb","updated":"20240219154238"},"Children":[{"Type":"NodeText","Data":"这就会出现：数据库是"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"新数据"},{"Type":"NodeText","Data":"​，而缓存是"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"旧数据"},{"Type":"NodeText","Data":"​，两边"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"数据不一致"},{"Type":"NodeText","Data":"​的情况。"}]},{"ID":"20240219154247-kp5za0r","Type":"NodeParagraph","Properties":{"id":"20240219154247-kp5za0r","updated":"20240219154247"}},{"ID":"20240219154259-wuv5d7e","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240219154259-wuv5d7e","updated":"20240219154326"},"Children":[{"Type":"NodeText","Data":"2.2 高并发下的问题"}]},{"ID":"20240219154334-ue4x6rm","Type":"NodeParagraph","Properties":{"id":"20240219154334-ue4x6rm","updated":"20240219154334"},"Children":[{"Type":"NodeText","Data":"假设在高并发的场景中，针对同一个用户的同一条数据，有两个写数据请求：a和b，它们同时请求到业务系统。"}]},{"ID":"20240219154334-iquz9ch","Type":"NodeParagraph","Properties":{"id":"20240219154334-iquz9ch","updated":"20240219154334"},"Children":[{"Type":"NodeText","Data":"其中请求a获取的是旧数据，而请求b获取的是新数据，如下图所示："}]},{"ID":"20240219154348-wd9wucw","Type":"NodeParagraph","Properties":{"id":"20240219154348-wd9wucw","updated":"20240219154348"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240219154348-iukr9c1.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240219154400-5gqidr3","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219154400-5gqidr3","updated":"20240219154400"},"Children":[{"ID":"20240219154400-tuixwho","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219154400-tuixwho","updated":"20240219154400"},"Children":[{"ID":"20240219154400-472e0nx","Type":"NodeParagraph","Properties":{"id":"20240219154400-472e0nx","updated":"20240219154400"},"Children":[{"Type":"NodeText","Data":"请求a先过来，刚写完了数据库。但由于网络原因，卡顿了一下，还没来得及写缓存。"}]}]},{"ID":"20240219154400-r1lm01p","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219154400-r1lm01p","updated":"20240219154400"},"Children":[{"ID":"20240219154400-6q2mr32","Type":"NodeParagraph","Properties":{"id":"20240219154400-6q2mr32","updated":"20240219154400"},"Children":[{"Type":"NodeText","Data":"这时候请求b过来了，先写了数据库。"}]}]},{"ID":"20240219154400-onkoqei","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240219154400-onkoqei","updated":"20240219154400"},"Children":[{"ID":"20240219154400-51pawkd","Type":"NodeParagraph","Properties":{"id":"20240219154400-51pawkd","updated":"20240219154400"},"Children":[{"Type":"NodeText","Data":"接下来，请求b顺利写了缓存。"}]}]},{"ID":"20240219154400-9df7rm1","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20240219154400-9df7rm1","updated":"20240219154400"},"Children":[{"ID":"20240219154400-9b4jdsl","Type":"NodeParagraph","Properties":{"id":"20240219154400-9b4jdsl","updated":"20240219154400"},"Children":[{"Type":"NodeText","Data":"此时，请求a卡顿结束，也写了缓存。"}]}]}]},{"ID":"20240219154400-5vmfc0u","Type":"NodeParagraph","Properties":{"id":"20240219154400-5vmfc0u","updated":"20240219154400"},"Children":[{"Type":"NodeText","Data":"很显然，在这个过程当中，请求b在缓存中的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"新数据"},{"Type":"NodeText","Data":"​，被请求a的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"旧数据"},{"Type":"NodeText","Data":"​覆盖了。"}]},{"ID":"20240219154400-mjhhrk6","Type":"NodeParagraph","Properties":{"id":"20240219154400-mjhhrk6","updated":"20240219154404"},"Children":[{"Type":"NodeText","Data":"也就是说："},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"在高并发场景中，如果多个线程同时执行先写数据库，再写缓存的操作，可能会出现数据库是新值，而缓存中是旧值，两边数据不一致的情况。"}]},{"ID":"20240219154407-ymce5ho","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240219154407-ymce5ho","updated":"20240219154427"},"Children":[{"Type":"NodeText","Data":"2.3 浪费系统资源"}]},{"ID":"20240219155202-n5gflen","Type":"NodeParagraph","Properties":{"id":"20240219155202-n5gflen","updated":"20240219155202"},"Children":[{"Type":"NodeText","Data":"该方案还有一个比较大的问题就是：每个写操作，写完数据库，会马上写缓存，比较"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"浪费系统资源"},{"Type":"NodeText","Data":"​。"}]},{"ID":"20240219155202-io5nbc2","Type":"NodeParagraph","Properties":{"id":"20240219155202-io5nbc2","updated":"20240219155202"},"Children":[{"Type":"NodeText","Data":"为什么这么说呢？"}]},{"ID":"20240219155202-14qexht","Type":"NodeParagraph","Properties":{"id":"20240219155202-14qexht","updated":"20240219155202"},"Children":[{"Type":"NodeText","Data":"你可以试想一下，如果写的缓存，并不是简单的数据内容，而是要经过非常复杂的计算得出的最终结果。这样每写一次缓存，都需要经过一次非常复杂的计算，不是非常浪费系统资源吗？"}]},{"ID":"20240219155215-uw5vqiz","Type":"NodeParagraph","Properties":{"id":"20240219155215-uw5vqiz","updated":"20240219155215"},"Children":[{"Type":"NodeText","Data":"尤其是"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"cpu"},{"Type":"NodeText","Data":"​和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"内存"},{"Type":"NodeText","Data":"​资源。"}]},{"ID":"20240219155215-u1vj40r","Type":"NodeParagraph","Properties":{"id":"20240219155215-u1vj40r","updated":"20240219155215"},"Children":[{"Type":"NodeText","Data":"还有些业务场景比较特殊："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"写多读少"},{"Type":"NodeText","Data":"​。"}]},{"ID":"20240219155215-7a0sy7j","Type":"NodeParagraph","Properties":{"id":"20240219155215-7a0sy7j","updated":"20240219155215"},"Children":[{"Type":"NodeText","Data":"如果在这类业务场景中，每个用的写操作，都需要写一次缓存，有点得不偿失。"}]},{"ID":"20240219155215-mp8dqem","Type":"NodeParagraph","Properties":{"id":"20240219155215-mp8dqem","updated":"20240219155215"},"Children":[{"Type":"NodeText","Data":"由此可见，在高并发的场景中，先写数据库，再写缓存，这套方案问题挺多的，也不太建议使用。"}]},{"ID":"20240219155217-270c78q","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240219155217-270c78q","updated":"20240219160243"},"Children":[{"Type":"NodeText","Data":"3. 先删缓存，再写数据库"}]},{"ID":"20240219155253-fa1mhq1","Type":"NodeParagraph","Properties":{"id":"20240219155253-fa1mhq1","updated":"20240219160243"},"Children":[{"Type":"NodeText","Data":"通过上面的内容我们得知，如果直接更新缓存的问题很多。"}]},{"ID":"20240219155253-kl2czcl","Type":"NodeParagraph","Properties":{"id":"20240219155253-kl2czcl","updated":"20240219160243"},"Children":[{"Type":"NodeText","Data":"那么，为何我们不能换一种思路：不去直接"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"更新缓存"},{"Type":"NodeText","Data":"​，而改为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"删除缓存"},{"Type":"NodeText","Data":"​呢？"}]},{"ID":"20240219155253-xyu65es","Type":"NodeParagraph","Properties":{"id":"20240219155253-xyu65es","updated":"20240219160243"},"Children":[{"Type":"NodeText","Data":"删除缓存方案，同样有两种："}]},{"ID":"20240219155253-lf77djh","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219155253-lf77djh","updated":"20240219160243"},"Children":[{"ID":"20240219155253-hpdel9r","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219155253-hpdel9r","updated":"20240219155253"},"Children":[{"ID":"20240219155253-eqza891","Type":"NodeParagraph","Properties":{"id":"20240219155253-eqza891","updated":"20240219155253"},"Children":[{"Type":"NodeText","Data":"先删缓存，再写数据库"}]}]},{"ID":"20240219155253-szlakz2","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219155253-szlakz2","updated":"20240219155253"},"Children":[{"ID":"20240219155253-n3sx7i5","Type":"NodeParagraph","Properties":{"id":"20240219155253-n3sx7i5","updated":"20240219155253"},"Children":[{"Type":"NodeText","Data":"先写数据库，再删缓存"}]}]}]},{"ID":"20240219155253-h5iv4ct","Type":"NodeParagraph","Properties":{"id":"20240219155253-h5iv4ct","updated":"20240219160243"},"Children":[{"Type":"NodeText","Data":"我们一起先看看：先删缓存，再写数据库的情况。"}]},{"ID":"20240219155304-899kqwb","Type":"NodeParagraph","Properties":{"id":"20240219155304-899kqwb","updated":"20240219160243"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240219155304-742pdou.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240219155315-a4tvw86","Type":"NodeParagraph","Properties":{"id":"20240219155315-a4tvw86","updated":"20240219160243"},"Children":[{"Type":"NodeText","Data":"说白了，在用户的写操作中，先执行删除缓存操作，再去写数据库。这套方案，可以是可以，但也会有一样问题。"}]},{"ID":"20240219160244-sq777mq","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240219160244-sq777mq","updated":"20240219160300"},"Children":[{"Type":"NodeText","Data":"3.1 高并发下的问题"}]},{"ID":"20240219160255-qs1w7s1","Type":"NodeParagraph","Properties":{"id":"20240219160255-qs1w7s1","updated":"20240219160315"},"Children":[{"Type":"NodeText","Data":"假设在高并发的场景中，同一个用户的同一条数据，有一个读数据请求c，还有另一个写数据请求d（一个更新操作），同时请求到业务系统。如下图所示："}]},{"ID":"20240219161621-o9244bm","Type":"NodeParagraph","Properties":{"id":"20240219161621-o9244bm","updated":"20240219161626"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240219161618-pcxwlmi.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240219160413-n7ek03k","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219160413-n7ek03k","updated":"20240219160413"},"Children":[{"ID":"20240219160413-0mjd50m","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219160413-0mjd50m","updated":"20240219160413"},"Children":[{"ID":"20240219160413-7t275kn","Type":"NodeParagraph","Properties":{"id":"20240219160413-7t275kn","updated":"20240219160413"},"Children":[{"Type":"NodeText","Data":"请求d先过来，把缓存删除了。但由于网络原因，卡顿了一下，还没来得及写数据库。"}]}]},{"ID":"20240219160413-wilkzcf","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219160413-wilkzcf","updated":"20240219160413"},"Children":[{"ID":"20240219160413-u5uzvl5","Type":"NodeParagraph","Properties":{"id":"20240219160413-u5uzvl5","updated":"20240219160413"},"Children":[{"Type":"NodeText","Data":"这时请求c过来了，先查缓存发现没数据，再查数据库，有数据，但是旧值。"}]}]},{"ID":"20240219160413-3j9oppj","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240219160413-3j9oppj","updated":"20240219160413"},"Children":[{"ID":"20240219160413-z5rnxtl","Type":"NodeParagraph","Properties":{"id":"20240219160413-z5rnxtl","updated":"20240219160413"},"Children":[{"Type":"NodeText","Data":"请求c将数据库中的旧值，更新到缓存中。"}]}]},{"ID":"20240219160413-2dwpx8v","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20240219160413-2dwpx8v","updated":"20240219160413"},"Children":[{"ID":"20240219160413-3x4csia","Type":"NodeParagraph","Properties":{"id":"20240219160413-3x4csia","updated":"20240219160413"},"Children":[{"Type":"NodeText","Data":"此时，请求d卡顿结束，把新值写入数据库。"}]}]}]},{"ID":"20240219160440-xbee6ab","Type":"NodeParagraph","Properties":{"id":"20240219160440-xbee6ab","updated":"20240219160440"},"Children":[{"Type":"NodeText","Data":"在这个过程当中，请求d的新值并没有被请求c写入缓存，同样会导致缓存和数据库的数据不一致的情况。更正：图中步骤7写入旧值，步骤9要删掉。"}]},{"ID":"20240219160440-waunjdx","Type":"NodeParagraph","Properties":{"id":"20240219160440-waunjdx","updated":"20240219160440"},"Children":[{"Type":"NodeText","Data":"那么，这种场景的数据不一致问题，能否解决呢？"}]},{"ID":"20240219161619-voheezx","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240219161619-voheezx","updated":"20240219162036"},"Children":[{"Type":"NodeText","Data":"3.2 缓存双删"}]},{"ID":"20240219162044-6mpw3r4","Type":"NodeParagraph","Properties":{"id":"20240219162044-6mpw3r4","updated":"20240219162044"},"Children":[{"Type":"NodeText","Data":"在上面的业务场景中，一个读数据请求，一个写数据请求。当写数据请求把缓存删了之后，读数据请求，可能把当时从数据库查询出来的旧值，写入缓存当中。"}]},{"ID":"20240219162044-t72kg19","Type":"NodeParagraph","Properties":{"id":"20240219162044-t72kg19","updated":"20240219162044"},"Children":[{"Type":"NodeText","Data":"有人说还不好办，请求d在写完数据库之后，把缓存重新删一次不就行了？"}]},{"ID":"20240219162119-xfxmz7m","Type":"NodeParagraph","Properties":{"id":"20240219162119-xfxmz7m","updated":"20240219162121"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240219162119-jai3jis.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240219162104-fy4jfk1","Type":"NodeParagraph","Properties":{"id":"20240219162104-fy4jfk1","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"这就是我们所说的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"缓存双删"},{"Type":"NodeText","Data":"​，即在写数据库之前删除一次，写完数据库后，再删除一次。"}]},{"ID":"20240219162104-v8ws7tl","Type":"NodeParagraph","Properties":{"id":"20240219162104-v8ws7tl","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"该方案有个非常关键的地方是：第二次删除缓存，并非立马就删，而是要在一定的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"时间间隔"},{"Type":"NodeText","Data":"​之后。"}]},{"ID":"20240219162104-twp83tk","Type":"NodeParagraph","Properties":{"id":"20240219162104-twp83tk","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"我们再重新回顾一下，高并发下一个读数据请求，一个写数据请求导致数据不一致的产生过程："}]},{"ID":"20240219162104-pi5fawc","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219162104-pi5fawc","updated":"20240219162104"},"Children":[{"ID":"20240219162104-eoywv6n","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219162104-eoywv6n","updated":"20240219162104"},"Children":[{"ID":"20240219162104-eyp4dp6","Type":"NodeParagraph","Properties":{"id":"20240219162104-eyp4dp6","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"请求d先过来，把缓存删除了。但由于网络原因，卡顿了一下，还没来得及写数据库。"}]}]},{"ID":"20240219162104-zsih8ms","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219162104-zsih8ms","updated":"20240219162104"},"Children":[{"ID":"20240219162104-ttaz600","Type":"NodeParagraph","Properties":{"id":"20240219162104-ttaz600","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"这时请求c过来了，先查缓存发现没数据，再查数据库，有数据，但是旧值。"}]}]},{"ID":"20240219162104-fdkrdy3","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240219162104-fdkrdy3","updated":"20240219162104"},"Children":[{"ID":"20240219162104-rcwea75","Type":"NodeParagraph","Properties":{"id":"20240219162104-rcwea75","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"请求c将数据库中的旧值，更新到缓存中。"}]}]},{"ID":"20240219162104-fwqu0lg","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20240219162104-fwqu0lg","updated":"20240219162104"},"Children":[{"ID":"20240219162104-7a6c73e","Type":"NodeParagraph","Properties":{"id":"20240219162104-7a6c73e","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"此时，请求d卡顿结束，把新值写入数据库。"}]}]},{"ID":"20240219162104-kbmb3r3","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20240219162104-kbmb3r3","updated":"20240219162104"},"Children":[{"ID":"20240219162104-mt6ee73","Type":"NodeParagraph","Properties":{"id":"20240219162104-mt6ee73","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"一段时间之后，比如：500ms，请求d将缓存删除。"}]}]}]},{"ID":"20240219162104-bt4i2ru","Type":"NodeParagraph","Properties":{"id":"20240219162104-bt4i2ru","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"这样来看确实可以解决缓存不一致问题。"}]},{"ID":"20240219162104-gdie3ep","Type":"NodeParagraph","Properties":{"id":"20240219162104-gdie3ep","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"那么，为什么一定要间隔一段时间之后，才能删除缓存呢？"}]},{"ID":"20240219162104-ca64gcq","Type":"NodeParagraph","Properties":{"id":"20240219162104-ca64gcq","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"请求d卡顿结束，把新值写入数据库后，请求c将数据库中的旧值，更新到缓存中。"}]},{"ID":"20240219162104-1x1t2ji","Type":"NodeParagraph","Properties":{"id":"20240219162104-1x1t2ji","updated":"20240219162154"},"Children":[{"Type":"NodeText","Data":"此时，"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"如果请求d删除太快，在请求c将数据库中的旧值更新到缓存之前，就已经把缓存删除了，这次删除就没任何意义。必须要在请求c更新缓存之后，再删除缓存，才能把旧值及时删除了。"}]},{"ID":"20240219162104-kk5x51n","Type":"NodeParagraph","Properties":{"id":"20240219162104-kk5x51n","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"所以需要在请求d中加一个时间间隔，确保请求c，或者类似于请求c的其他请求，如果在缓存中设置了旧值，最终都能够被请求d删除掉。"}]},{"ID":"20240219162104-cfo0423","Type":"NodeParagraph","Properties":{"id":"20240219162104-cfo0423","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"接下来，还有一个问题：如果第二次删除缓存时，删除失败了该怎么办？"}]},{"ID":"20240219162104-wc1hw7i","Type":"NodeParagraph","Properties":{"id":"20240219162104-wc1hw7i","updated":"20240219162104"},"Children":[{"Type":"NodeText","Data":"这里先留点悬念，后面会详细说。"}]},{"ID":"20240219162208-eo1asyd","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240219162208-eo1asyd","updated":"20240219162244"},"Children":[{"Type":"NodeText","Data":"4. 先写数据库，再删缓存"}]},{"ID":"20240219163331-g39mm4z","Type":"NodeParagraph","Properties":{"id":"20240219163331-g39mm4z","updated":"20240219163331"},"Children":[{"Type":"NodeText","Data":"从前面得知，先删缓存，再写数据库，在并发的情况下，也可能会出现缓存和数据库的数据不一致的情况。"}]},{"ID":"20240219163331-0ya00jn","Type":"NodeParagraph","Properties":{"id":"20240219163331-0ya00jn","updated":"20240219163331"},"Children":[{"Type":"NodeText","Data":"那么，我们只能寄希望于最后的方案了。"}]},{"ID":"20240219163331-p5p7bvz","Type":"NodeParagraph","Properties":{"id":"20240219163331-p5p7bvz","updated":"20240219163331"},"Children":[{"Type":"NodeText","Data":"接下来，我们重点看看先写数据库，再删缓存的方案。"}]},{"ID":"20240219163342-ljz1ke8","Type":"NodeParagraph","Properties":{"id":"20240219163342-ljz1ke8","updated":"20240219163343"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240219163342-5jvmjz2.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240219163351-7cqt0g2","Type":"NodeParagraph","Properties":{"id":"20240219163351-7cqt0g2","updated":"20240219163351"},"Children":[{"Type":"NodeText","Data":"在高并发的场景中，有一个读数据请求，有一个写数据请求，更新过程如下："}]},{"ID":"20240219163351-3x6bay9","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219163351-3x6bay9","updated":"20240219163351"},"Children":[{"ID":"20240219163351-xb323ex","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219163351-xb323ex","updated":"20240219163351"},"Children":[{"ID":"20240219163351-rb32io6","Type":"NodeParagraph","Properties":{"id":"20240219163351-rb32io6","updated":"20240219163351"},"Children":[{"Type":"NodeText","Data":"请求e先写数据库，由于网络原因卡顿了一下，没有来得及删除缓存。"}]}]},{"ID":"20240219163351-25cfhu7","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219163351-25cfhu7","updated":"20240219163351"},"Children":[{"ID":"20240219163351-b1zthh4","Type":"NodeParagraph","Properties":{"id":"20240219163351-b1zthh4","updated":"20240219163351"},"Children":[{"Type":"NodeText","Data":"请求f查询缓存，发现缓存中有数据，直接返回该数据。"}]}]},{"ID":"20240219163351-4jidobc","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240219163351-4jidobc","updated":"20240219163351"},"Children":[{"ID":"20240219163351-xlranpx","Type":"NodeParagraph","Properties":{"id":"20240219163351-xlranpx","updated":"20240219163351"},"Children":[{"Type":"NodeText","Data":"请求e删除缓存。"}]}]}]},{"ID":"20240219163351-oblx0o0","Type":"NodeParagraph","Properties":{"id":"20240219163351-oblx0o0","updated":"20240219163351"},"Children":[{"Type":"NodeText","Data":"在这个过程中，只有请求f读了一次旧数据，后来旧数据被请求e及时删除了，看起来问题不大。"}]},{"ID":"20240219163351-zs5fxlj","Type":"NodeParagraph","Properties":{"id":"20240219163351-zs5fxlj","updated":"20240219163351"},"Children":[{"Type":"NodeText","Data":"但如果是读数据请求先过来呢？"}]},{"ID":"20240219163351-d751yjg","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219163351-d751yjg","updated":"20240219163351"},"Children":[{"ID":"20240219163351-hemg1yh","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219163351-hemg1yh","updated":"20240219163351"},"Children":[{"ID":"20240219163351-rernnnq","Type":"NodeParagraph","Properties":{"id":"20240219163351-rernnnq","updated":"20240219163351"},"Children":[{"Type":"NodeText","Data":"请求f查询缓存，发现缓存中有数据，直接返回该数据。"}]}]},{"ID":"20240219163351-aosxhc1","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219163351-aosxhc1","updated":"20240219163351"},"Children":[{"ID":"20240219163351-k8fr9k5","Type":"NodeParagraph","Properties":{"id":"20240219163351-k8fr9k5","updated":"20240219163351"},"Children":[{"Type":"NodeText","Data":"请求e先写数据库。"}]}]},{"ID":"20240219163351-fn6t0fz","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240219163351-fn6t0fz","updated":"20240219163351"},"Children":[{"ID":"20240219163351-b5vd0p4","Type":"NodeParagraph","Properties":{"id":"20240219163351-b5vd0p4","updated":"20240219163351"},"Children":[{"Type":"NodeText","Data":"请求e删除缓存。"}]}]}]},{"ID":"20240219163351-77l5ice","Type":"NodeParagraph","Properties":{"id":"20240219163351-77l5ice","updated":"20240219163351"},"Children":[{"Type":"NodeText","Data":"这种情况看起来也没问题呀？"}]},{"ID":"20240219163351-1vcrstv","Type":"NodeParagraph","Properties":{"id":"20240219163351-1vcrstv","updated":"20240219163351"},"Children":[{"Type":"NodeText","Data":"答：对的。"}]},{"ID":"20240219163351-83ml0or","Type":"NodeParagraph","Properties":{"id":"20240219163351-83ml0or","updated":"20240219163351"},"Children":[{"Type":"NodeText","Data":"但就怕出现下面这种情况，即缓存自己失效了。如下图所示："}]},{"ID":"20240219163409-8psbxd5","Type":"NodeParagraph","Properties":{"id":"20240219163409-8psbxd5","updated":"20240219163409"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240219163409-vlt7nuh.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240219164144-81as0f8","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219164144-81as0f8","updated":"20240219164144"},"Children":[{"ID":"20240219164144-m5k2cxh","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219164144-m5k2cxh","updated":"20240219164144"},"Children":[{"ID":"20240219164144-uqmynra","Type":"NodeParagraph","Properties":{"id":"20240219164144-uqmynra","updated":"20240219164144"},"Children":[{"Type":"NodeText","Data":"缓存过期时间到了，自动失效。"}]}]},{"ID":"20240219164144-lbbnnkt","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219164144-lbbnnkt","updated":"20240219164144"},"Children":[{"ID":"20240219164144-rvmners","Type":"NodeParagraph","Properties":{"id":"20240219164144-rvmners","updated":"20240219164144"},"Children":[{"Type":"NodeText","Data":"请求f查询缓存，发缓存中没有数据，查询数据库的旧值，但由于网络原因卡顿了，没有来得及更新缓存。"}]}]},{"ID":"20240219164144-jdvrtk3","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240219164144-jdvrtk3","updated":"20240219164144"},"Children":[{"ID":"20240219164144-odtnxce","Type":"NodeParagraph","Properties":{"id":"20240219164144-odtnxce","updated":"20240219164144"},"Children":[{"Type":"NodeText","Data":"请求e先写数据库，接着删除了缓存。"}]}]},{"ID":"20240219164144-dly7xp1","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20240219164144-dly7xp1","updated":"20240219164144"},"Children":[{"ID":"20240219164144-sx8ejp7","Type":"NodeParagraph","Properties":{"id":"20240219164144-sx8ejp7","updated":"20240219164144"},"Children":[{"Type":"NodeText","Data":"请求f更新旧值到缓存中。"}]}]}]},{"ID":"20240219164144-svp3ll6","Type":"NodeParagraph","Properties":{"id":"20240219164144-svp3ll6","updated":"20240219164144"},"Children":[{"Type":"NodeText","Data":"这时，缓存和数据库的数据同样出现不一致的情况了。"}]},{"ID":"20240219164144-q1v9t09","Type":"NodeParagraph","Properties":{"id":"20240219164144-q1v9t09","updated":"20240219164144"},"Children":[{"Type":"NodeText","Data":"但这种情况还是比较少的，需要同时满足以下条件才可以："}]},{"ID":"20240219164144-8stqiol","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219164144-8stqiol","updated":"20240219164144"},"Children":[{"ID":"20240219164144-96rskab","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219164144-96rskab","updated":"20240219164144"},"Children":[{"ID":"20240219164144-n98vy2l","Type":"NodeParagraph","Properties":{"id":"20240219164144-n98vy2l","updated":"20240219164144"},"Children":[{"Type":"NodeText","Data":"缓存刚好自动失效。"}]}]},{"ID":"20240219164144-rucmex7","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219164144-rucmex7","updated":"20240219164144"},"Children":[{"ID":"20240219164144-6qlwx9i","Type":"NodeParagraph","Properties":{"id":"20240219164144-6qlwx9i","updated":"20240219164144"},"Children":[{"Type":"NodeText","Data":"请求f从数据库查出旧值，更新缓存的耗时，比请求e写数据库，并且删除缓存的还长。"}]}]}]},{"ID":"20240219164144-cdfl7wg","Type":"NodeParagraph","Properties":{"id":"20240219164144-cdfl7wg","updated":"20240219164144"},"Children":[{"Type":"NodeText","Data":"我们都知道查询数据库的速度，一般比写数据库要快，更何况写完数据库，还要删除缓存。所以绝大多数情况下，写数据请求比读数据情况耗时更长。"}]},{"ID":"20240219164144-h7iulgq","Type":"NodeParagraph","Properties":{"id":"20240219164144-h7iulgq","updated":"20240219164144"},"Children":[{"Type":"NodeText","Data":"由此可见，系统同时满足上述两个条件的概率非常小。"}]},{"ID":"20240219164144-cm6gbz8","Type":"NodeBlockquote","Properties":{"id":"20240219164144-cm6gbz8","updated":"20240219164144"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20240219164144-yz7z1j7","Type":"NodeParagraph","Properties":{"id":"20240219164144-yz7z1j7","updated":"20240219164144"},"Children":[{"Type":"NodeText","Data":"推荐大家使用先写数据库，再删缓存的方案，虽说不能100%避免数据不一致问题，但出现该问题的概率，相对于其他方案来说是最小的。"}]}]},{"ID":"20240219164144-mn5oae9","Type":"NodeParagraph","Properties":{"id":"20240219164144-mn5oae9","updated":"20240219164144"},"Children":[{"Type":"NodeText","Data":"但在该方案中，如果删除缓存失败了该怎么办呢？"}]},{"ID":"20240219164146-ut6yowf","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240219164146-ut6yowf","updated":"20240219164216"},"Children":[{"Type":"NodeText","Data":"4.1 删除缓存失败怎么办"}]},{"ID":"20240219164224-5rgevhb","Type":"NodeParagraph","Properties":{"id":"20240219164224-5rgevhb","updated":"20240219164224"},"Children":[{"Type":"NodeText","Data":"其实先写数据库，再删缓存的方案，跟缓存双删的方案一样，有一个共同的风险点，即：如果缓存删除失败了，也会导致缓存和数据库的数据不一致。"}]},{"ID":"20240219164224-uv9jw4j","Type":"NodeParagraph","Properties":{"id":"20240219164224-uv9jw4j","updated":"20240219164631"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"那么，删除缓存失败怎么办呢？"}]},{"ID":"20240219164224-udmz1v0","Type":"NodeParagraph","Properties":{"id":"20240219164224-udmz1v0","updated":"20240219164635"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"答：需要加"},{"Type":"NodeTextMark","TextMarkType":"code strong","TextMarkTextContent":"重试机制"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"。"}]},{"ID":"20240219164224-pstr4q0","Type":"NodeParagraph","Properties":{"id":"20240219164224-pstr4q0","updated":"20240219164224"},"Children":[{"Type":"NodeText","Data":"在接口中如果更新了数据库成功了，但更新缓存失败了，可以立刻重试3次。如果其中有任何一次成功，则直接返回成功。如果3次都失败了，则写入数据库，准备后续再处理。"}]},{"ID":"20240219164224-lk615ld","Type":"NodeParagraph","Properties":{"id":"20240219164224-lk615ld","updated":"20240219164224"},"Children":[{"Type":"NodeText","Data":"当然，如果你在接口中直接"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"同步重试"},{"Type":"NodeText","Data":"​，该接口并发量比较高的时候，可能有点影响接口性能。"}]},{"ID":"20240219164224-wquqyz3","Type":"NodeParagraph","Properties":{"id":"20240219164224-wquqyz3","updated":"20240219164224"},"Children":[{"Type":"NodeText","Data":"这时，就需要改成"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"异步重试"},{"Type":"NodeText","Data":"​了。"}]},{"ID":"20240219164224-pn18yfn","Type":"NodeParagraph","Properties":{"id":"20240219164224-pn18yfn","updated":"20240219164224"},"Children":[{"Type":"NodeText","Data":"异步重试方式有很多种，比如："}]},{"ID":"20240219164224-ybyhtvg","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219164224-ybyhtvg","updated":"20240219164224"},"Children":[{"ID":"20240219164224-1bibw2y","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219164224-1bibw2y","updated":"20240219164224"},"Children":[{"ID":"20240219164224-4szlfhb","Type":"NodeParagraph","Properties":{"id":"20240219164224-4szlfhb","updated":"20240219164224"},"Children":[{"Type":"NodeText","Data":"每次都单独起一个线程，该线程专门做重试的工作。但如果在高并发的场景下，可能会创建太多的线程，导致系统OOM问题，不太建议使用。"}]}]},{"ID":"20240219164224-8shw6mg","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219164224-8shw6mg","updated":"20240219164224"},"Children":[{"ID":"20240219164224-kqomkqj","Type":"NodeParagraph","Properties":{"id":"20240219164224-kqomkqj","updated":"20240219164224"},"Children":[{"Type":"NodeText","Data":"将重试的任务交给线程池处理，但如果服务器重启，部分数据可能会丢失。"}]}]},{"ID":"20240219164224-cd08fq5","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240219164224-cd08fq5","updated":"20240219164224"},"Children":[{"ID":"20240219164224-5cskdii","Type":"NodeParagraph","Properties":{"id":"20240219164224-5cskdii","updated":"20240219164224"},"Children":[{"Type":"NodeText","Data":"将重试数据写表，然后使用elastic-job等定时任务进行重试。"}]}]},{"ID":"20240219164224-lkqsqnp","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20240219164224-lkqsqnp","updated":"20240219164224"},"Children":[{"ID":"20240219164224-1ieyosz","Type":"NodeParagraph","Properties":{"id":"20240219164224-1ieyosz","updated":"20240219164224"},"Children":[{"Type":"NodeText","Data":"将重试的请求写入mq等消息中间件中，在mq的consumer中处理。"}]}]},{"ID":"20240219164224-w5qov6f","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20240219164224-w5qov6f","updated":"20240219164224"},"Children":[{"ID":"20240219164224-clwc4yf","Type":"NodeParagraph","Properties":{"id":"20240219164224-clwc4yf","updated":"20240219164224"},"Children":[{"Type":"NodeText","Data":"订阅mysql的binlog，在订阅者中，如果发现了更新数据请求，则删除相应的缓存。"}]}]}]},{"ID":"20240219164714-mb2u8o9","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240219164714-mb2u8o9","updated":"20240219164731"},"Children":[{"Type":"NodeText","Data":"5. 定时任务"}]},{"ID":"20240219164735-jvjuo9f","Type":"NodeParagraph","Properties":{"id":"20240219164735-jvjuo9f","updated":"20240219164735"},"Children":[{"Type":"NodeText","Data":"使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"定时任务重试"},{"Type":"NodeText","Data":"​的具体方案如下："}]},{"ID":"20240219164735-pu72kem","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219164735-pu72kem","updated":"20240219164735"},"Children":[{"ID":"20240219164735-lh0j3st","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219164735-lh0j3st","updated":"20240219164735"},"Children":[{"ID":"20240219164735-undlt5q","Type":"NodeParagraph","Properties":{"id":"20240219164735-undlt5q","updated":"20240219164735"},"Children":[{"Type":"NodeText","Data":"当用户操作写完数据库，但删除缓存失败了，需要将用户数据写入重试表中。如下图所示："}]}]}]},{"ID":"20240219164748-vmeztvm","Type":"NodeParagraph","Properties":{"id":"20240219164748-vmeztvm","updated":"20240219164752"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240219164748-fd866q1.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240219164753-jq2nhp5","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219164753-jq2nhp5","updated":"20240219164802"},"Children":[{"ID":"20240219164802-x7qua1b","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219164802-x7qua1b","updated":"20240219164802"},"Children":[{"ID":"20240219164802-3q5mlbr","Type":"NodeParagraph","Properties":{"id":"20240219164802-3q5mlbr","updated":"20240219164802"},"Children":[{"Type":"NodeText","Data":"在定时任务中，异步读取重试表中的用户数据。重试表需要记录一个重试次数字段，初始值为0。然后重试5次，不断删除缓存，每重试一次该字段值+1。如果其中有任意一次成功了，则返回成功。如果重试了5次，还是失败，则我们需要在重试表中记录一个失败的状态，等待后续进一步处理。"}]}]}]},{"ID":"20240219164837-ix9bjtz","Type":"NodeParagraph","Properties":{"id":"20240219164837-ix9bjtz","updated":"20240219164840"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240219164837-x9mh3af.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240219164841-sqhsxtn","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219164841-sqhsxtn","updated":"20240219164858"},"Children":[{"ID":"20240219164858-sfd8owk","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240219164858-sfd8owk","updated":"20240219164858"},"Children":[{"ID":"20240219164858-dit0gy7","Type":"NodeParagraph","Properties":{"id":"20240219164858-dit0gy7","updated":"20240219164858"},"Children":[{"Type":"NodeText","Data":"在高并发场景中，定时任务推荐使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"elastic-job"},{"Type":"NodeText","Data":"​。相对于xxl-job等定时任务，它可以分片处理，提升处理速度。同时每片的间隔可以设置成：1,2,3,5,7秒等"}]}]}]},{"ID":"20240219164924-p11x66h","Type":"NodeParagraph","Properties":{"id":"20240219164924-p11x66h","updated":"20240219164924"},"Children":[{"Type":"NodeText","Data":"如果大家对定时任务比较感兴趣的话，可以看看我的另一篇文章《"},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==\u0026amp;mid=2247490314\u0026amp;idx=1\u0026amp;sn=29ddf0c1e99675b86cdfc082556a69a9\u0026amp;chksm=c0ebc3e2f79c4af43cf8582d41b0bc3ede57986cc6c115b103b586a2c7bddb4475555e919b20\u0026amp;token=751314179\u0026amp;lang=zh_CN\u0026amp;scene=21#wechat_redirect","TextMarkTextContent":"学会这10种定时任务，我有点飘了"},{"Type":"NodeText","Data":"》，里面列出了目前最主流的定时任务。"}]},{"ID":"20240219164924-aw0rzd6","Type":"NodeParagraph","Properties":{"id":"20240219164924-aw0rzd6","updated":"20240219164924"},"Children":[{"Type":"NodeText","Data":"使用定时任务重试的话，有个缺点就是实时性没那么高，对于实时性要求特别高的业务场景，该方案不太适用。但是对于一般场景，还是可以用一用的。"}]},{"ID":"20240219164924-8mxtk74","Type":"NodeParagraph","Properties":{"id":"20240219164924-8mxtk74","updated":"20240219164924"},"Children":[{"Type":"NodeText","Data":"但它有一个很大的优点，即数据是落库的，不会丢数据。"}]},{"ID":"20240219164924-lx6wvi5","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240219164924-lx6wvi5","updated":"20240219164924"},"Children":[{"Type":"NodeText","Data":"8. mq"}]},{"ID":"20240219164924-3mndm5w","Type":"NodeParagraph","Properties":{"id":"20240219164924-3mndm5w","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"在高并发的业务场景中，mq（消息队列）是必不可少的技术之一。它不仅可以异步解耦，还能削峰填谷。对保证系统的稳定性是非常有意义的。"}]},{"ID":"20240219164924-3thx73k","Type":"NodeParagraph","Properties":{"id":"20240219164924-3thx73k","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"对mq有兴趣的朋友可以看看我的另一篇文章《"},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==\u0026amp;mid=2247490326\u0026amp;idx=1\u0026amp;sn=8acb7c030591932e4ddce5502fbc1382\u0026amp;scene=21#wechat_redirect","TextMarkTextContent":"mq的那些破事儿"},{"Type":"NodeText","Data":"》。"}]},{"ID":"20240219164924-i2uoi8g","Type":"NodeParagraph","Properties":{"id":"20240219164924-i2uoi8g","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"mq的生产者，生产了消息之后，通过指定的topic发送到mq服务器。然后mq的消费者，订阅该topic的消息，读取消息数据之后，做业务逻辑处理。"}]},{"ID":"20240219164924-1mp173k","Type":"NodeParagraph","Properties":{"id":"20240219164924-1mp173k","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"mq重试"},{"Type":"NodeText","Data":"​的具体方案如下："},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/mmbiz_png/ibJZVicC7nz5iaFlHablJUNLAYyUSMPpOkqyxKU9Blqku1eXticeC00zpziag3Qwg477lKRPrBZXbw7SEnJhJm6XqyQ/640?wx_fmt=png\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240219164924-u6scohf","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219164924-u6scohf","updated":"20240219164925"},"Children":[{"ID":"20240219164924-wvbl8c5","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219164924-wvbl8c5","updated":"20240219164924"},"Children":[{"ID":"20240219164924-1tkf9eb","Type":"NodeParagraph","Properties":{"id":"20240219164924-1tkf9eb","updated":"20240219164924"},"Children":[{"Type":"NodeText","Data":"当用户操作写完数据库，但删除缓存失败了，产生一条mq消息，发送给mq服务器。"}]}]},{"ID":"20240219164924-0ighzlm","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219164924-0ighzlm","updated":"20240219164924"},"Children":[{"ID":"20240219164924-wh7jun8","Type":"NodeParagraph","Properties":{"id":"20240219164924-wh7jun8","updated":"20240219164924"},"Children":[{"Type":"NodeText","Data":"mq消费者读取mq消息，重试5次删除缓存。如果其中有任意一次成功了，则返回成功。如果重试了5次，还是失败，则写入"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"死信队列"},{"Type":"NodeText","Data":"​中。"}]}]},{"ID":"20240219164924-pla2rrw","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240219164924-pla2rrw","updated":"20240219164924"},"Children":[{"ID":"20240219164924-3qwcsmp","Type":"NodeParagraph","Properties":{"id":"20240219164924-3qwcsmp","updated":"20240219164924"},"Children":[{"Type":"NodeText","Data":"推荐mq使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"rocketmq"},{"Type":"NodeText","Data":"​，重试机制和死信队列默认是支持的。使用起来非常方便，而且还支持顺序消息，延迟消息和事务消息等多种业务场景。"}]}]}]},{"ID":"20240219164924-bl7dnpo","Type":"NodeParagraph","Properties":{"id":"20240219164924-bl7dnpo","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"当然在该方案中，删除缓存可以完全走异步。即用户的写操作，在写完数据库之后，不用立刻删除一次缓存。而直接发送mq消息，到mq服务器，然后有mq消费者全权负责删除缓存的任务。"}]},{"ID":"20240219164924-lqulk2u","Type":"NodeParagraph","Properties":{"id":"20240219164924-lqulk2u","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"因为mq的实时性还是比较高的，因此改良后的方案也是一种不错的选择。"}]},{"ID":"20240219164924-vc4sed1","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240219164924-vc4sed1","updated":"20240219164924"},"Children":[{"Type":"NodeText","Data":"9. binlog"}]},{"ID":"20240219164924-2gmey4e","Type":"NodeParagraph","Properties":{"id":"20240219164924-2gmey4e","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"前面我们聊过的，无论是定时任务，还是mq（消息队列），做重试机制，对业务都有一定的侵入性。"}]},{"ID":"20240219164924-i8cusui","Type":"NodeParagraph","Properties":{"id":"20240219164924-i8cusui","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"在使用定时任务的方案中，需要在业务代码中增加额外逻辑，如果删除缓存失败，需要将数据写入重试表。"}]},{"ID":"20240219164924-bhlbjbd","Type":"NodeParagraph","Properties":{"id":"20240219164924-bhlbjbd","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"而使用mq的方案中，如果删除缓存失败了，需要在业务代码中发送mq消息到mq服务器。"}]},{"ID":"20240219164924-wqav4oz","Type":"NodeParagraph","Properties":{"id":"20240219164924-wqav4oz","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"其实，还有一种更优雅的实现，即"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"监听binlog"},{"Type":"NodeText","Data":"​，比如使用："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"canal"},{"Type":"NodeText","Data":"​等中间件。"}]},{"ID":"20240219164924-dpy05q7","Type":"NodeParagraph","Properties":{"id":"20240219164924-dpy05q7","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"具体方案如下："},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/mmbiz_png/ibJZVicC7nz5iaFlHablJUNLAYyUSMPpOkqOqIXJl1cpPib0iasQ7PoZhdwCUr4Z4e3hibOvPNLcHgd4OL8k8ASr08fg/640?wx_fmt=png\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240219164924-7nophtj","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240219164924-7nophtj","updated":"20240219164925"},"Children":[{"ID":"20240219164924-2emdu0p","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240219164924-2emdu0p","updated":"20240219164924"},"Children":[{"ID":"20240219164924-b391vt6","Type":"NodeParagraph","Properties":{"id":"20240219164924-b391vt6","updated":"20240219164924"},"Children":[{"Type":"NodeText","Data":"在业务接口中写数据库之后，就不管了，直接返回成功。"}]}]},{"ID":"20240219164924-5ls27d1","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240219164924-5ls27d1","updated":"20240219164924"},"Children":[{"ID":"20240219164924-tjv38ko","Type":"NodeParagraph","Properties":{"id":"20240219164924-tjv38ko","updated":"20240219164924"},"Children":[{"Type":"NodeText","Data":"mysql服务器会自动把变更的数据写入binlog中。"}]}]},{"ID":"20240219164924-sllg4bf","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240219164924-sllg4bf","updated":"20240219164924"},"Children":[{"ID":"20240219164924-oiv5y69","Type":"NodeParagraph","Properties":{"id":"20240219164924-oiv5y69","updated":"20240219164924"},"Children":[{"Type":"NodeText","Data":"binlog订阅者获取变更的数据，然后删除缓存。"}]}]}]},{"ID":"20240219164924-8sxx8d7","Type":"NodeParagraph","Properties":{"id":"20240219164924-8sxx8d7","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"这套方案中业务接口确实简化了一些流程，只用关心数据库操作即可，而在binlog订阅者中做缓存删除工作。"}]},{"ID":"20240219164924-fn01hlk","Type":"NodeParagraph","Properties":{"id":"20240219164924-fn01hlk","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"但如果只是按照图中的方案进行删除缓存，只删除了一次，也可能会失败。"}]},{"ID":"20240219164924-zl52ww5","Type":"NodeParagraph","Properties":{"id":"20240219164924-zl52ww5","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"如何解决这个问题呢？"}]},{"ID":"20240219164924-4ev1zkf","Type":"NodeParagraph","Properties":{"id":"20240219164924-4ev1zkf","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"答：这就需要加上前面聊过的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"重试机制"},{"Type":"NodeText","Data":"​了。如果删除缓存失败，写入重试表，使用定时任务重试。或者写入mq，让mq自动重试。"}]},{"ID":"20240219164924-onubhmz","Type":"NodeParagraph","Properties":{"id":"20240219164924-onubhmz","updated":"20240219164925"},"Children":[{"Type":"NodeText","Data":"在这里推荐使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"mq自动重试机制"},{"Type":"NodeText","Data":"​。"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/mmbiz_png/ibJZVicC7nz5iaFlHablJUNLAYyUSMPpOkqfcqKNlHYa06tLaicFiaxMibfDHLQjqJicRsbtTt50CAaiasTLqYghAxDxiaQ/640?wx_fmt=png\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"在binlog订阅者中如果删除缓存失败，则发送一条mq消息到mq服务器，在mq消费者中自动重试5次。如果有任意一次成功，则直接返回成功。如果重试5次后还是失败，则该消息自动被放入死信队列，后面可能需要人工介入。"}]}]}