{"ID":"20231219002144-sqbsely","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f54a","id":"20231219002144-sqbsely","tags":"公众号-Golang语言开发栈,Go-Viper库","title":"Go 配置管理库 Viper 怎么读取结构体嵌套的配置信息？","updated":"20231219002836"},"Children":[{"ID":"20231219002442-h3bidry","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20231219002442-h3bidry","updated":"20231219002507"},"Children":[{"Type":"NodeText","Data":"介绍"}]},{"ID":"20231219002517-t6dffu3","Type":"NodeParagraph","Properties":{"id":"20231219002517-t6dffu3","updated":"20231219002517"},"Children":[{"Type":"NodeText","Data":"Golang 配置信息管理库 Viper"},{"Type":"NodeTextMark","TextMarkType":"sup","TextMarkTextContent":"[1]"},{"Type":"NodeText","Data":"，它提供一套完整的管理配置信息的解决方案。"}]},{"ID":"20231219002517-qdptlsg","Type":"NodeParagraph","Properties":{"id":"20231219002517-qdptlsg","updated":"20231219002517"},"Children":[{"Type":"NodeText","Data":"Go 语言中很多知名开源项目也都选择使用 Viper，它功能非常强大，本文介绍 Viper 读取结构体嵌套配置信息的使用方式。"}]},{"ID":"20231219002144-xk182es","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20231219002144-xk182es","updated":"20231219002534"},"Children":[{"Type":"NodeText","Data":"读取结构体嵌套配置信息"}]},{"ID":"20231219002535-y9gieas","Type":"NodeParagraph","Properties":{"id":"20231219002535-y9gieas","updated":"20231219002541"},"Children":[{"Type":"NodeText","Data":"在实际项目开发中，我们经常会遇到一些比较复杂的配置信息，比如多层嵌套的配置信息，在结构体中嵌套结构体和切片。"}]},{"ID":"20231219002542-c2087vw","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231219002542-c2087vw","updated":"20231219002550"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"user_data:\n  uid: 10000\n  uname: \"frank\"\n  other_info:\n    email: \"gopher@email.cn\"\n    address: \"Beijing China\"\n  language:\n    - name: \"go\"\n      score: 90\n    - name: \"php\"\n      score: 95\n    - name: \"JavaScript\"\n      score: 80\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231219002604-tcmoocn","Type":"NodeParagraph","Properties":{"id":"20231219002604-tcmoocn","updated":"20231219002604"},"Children":[{"Type":"NodeText","Data":"阅读上面 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"yaml"},{"Type":"NodeText","Data":"​ 文件，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"user_data"},{"Type":"NodeText","Data":"​ 是一个多层嵌套的配置信息。"}]},{"ID":"20231219002604-2vte9k0","Type":"NodeParagraph","Properties":{"id":"20231219002604-2vte9k0","updated":"20231219002604"},"Children":[{"Type":"NodeText","Data":"读取该多层嵌套配置信息，如果我们使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"GetXXX"},{"Type":"NodeText","Data":"​ 函数获取值，代码会非常繁琐。"}]},{"ID":"20231219002604-ii2zcia","Type":"NodeParagraph","Properties":{"id":"20231219002604-ii2zcia","updated":"20231219002836"},"Children":[{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color1);"},"TextMarkType":"strong text","TextMarkTextContent":"Viper 提供了 2 个解析函数，"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color1);\"}"},{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color1);"},"TextMarkType":"code strong text","TextMarkTextContent":"Unmarshal"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color1);\"}"},{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color1);"},"TextMarkType":"strong text","TextMarkTextContent":" 和 "},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color1);\"}"},{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color1);"},"TextMarkType":"code strong text","TextMarkTextContent":"UnmarshalKey"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color1);\"}"},{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color1);"},"TextMarkType":"strong text","TextMarkTextContent":"，我们可以使用它们非常方便地读取多层嵌套配置信息，可以将所有或指定配置信息解析到 "},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color1);\"}"},{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color1);"},"TextMarkType":"code strong text","TextMarkTextContent":"struct"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color1);\"}"},{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color1);"},"TextMarkType":"strong text","TextMarkTextContent":"、"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color1);\"}"},{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color1);"},"TextMarkType":"code strong text","TextMarkTextContent":"map"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color1);\"}"},{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color1);"},"TextMarkType":"strong text","TextMarkTextContent":" 等数据结构中。"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color1);\"}"}]},{"ID":"20231219002604-02qabel","Type":"NodeParagraph","Properties":{"id":"20231219002604-02qabel","updated":"20231219002604"},"Children":[{"Type":"NodeText","Data":"我们通过示例代码，介绍它们的使用方式。"}]},{"ID":"20231219002640-t4t4gm3","Type":"NodeParagraph","Properties":{"id":"20231219002640-t4t4gm3","updated":"20231219002646"},"Children":[{"Type":"NodeText","Data":"目录："}]},{"ID":"20231219002647-716oq3x","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231219002647-716oq3x","updated":"20231219002653"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"├── configs\n│   ├── default.yaml\n│   └── test.yaml\n├── go.mod\n├── go.sum\n└── main.go\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231219002654-53lrrjg","Type":"NodeParagraph","Properties":{"id":"20231219002654-53lrrjg","updated":"20231219002704"},"Children":[{"Type":"NodeText","Data":"示例代码："}]},{"ID":"20231219002704-dmfe9f0","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231219002704-dmfe9f0","updated":"20231219002714"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"package main\n\nimport (\n \"fmt\"\n \"github.com/spf13/viper\"\n)\n\nfunc main() {\n v := viper.New()\n //v.SetConfigFile(\"./configs/test.yaml\")\n v.SetConfigFile(\"./configs/default.yaml\")\n err := v.ReadInConfig()\n if err != nil {\n  fmt.Println(err)\n  return\n }\n //err = v.Unmarshal(\u0026userData)\n err = v.UnmarshalKey(\"user_data\", \u0026userData)\n if err != nil {\n  fmt.Println(err)\n  return\n }\n fmt.Printf(\"userData=%+v\\n\", userData)\n}\n\ntype UserData struct {\n Uid       int        `json:\"uid\"`\n Uname     string     `json:\"uname\"`\n OtherInfo OtherInfo  `json:\"other_info\" mapstructure:\"other_info\"`\n Language  []Language `json:\"language\" mapstructure:\"language\"`\n}\n\ntype OtherInfo struct {\n Email   string\n Address string\n}\n\ntype Language struct {\n Name  string\n Score int\n}\n\nvar userData UserData\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231219002717-pbh8f3c","Type":"NodeParagraph","Properties":{"id":"20231219002717-pbh8f3c","updated":"20231219002723"},"Children":[{"Type":"NodeText","Data":"输出结果："}]},{"ID":"20231219002723-mp01gao","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231219002723-mp01gao","updated":"20231219002739"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"userData={Uid:10000 Uname:frank OtherInfo:{Email:gopher@email.cn Address:Beijing China} Language:[{Name:go Score:90} {Name:php Score:95} {Name:JavaScript Score:80}]}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231219002745-3hkfzcc","Type":"NodeParagraph","Properties":{"id":"20231219002745-3hkfzcc","updated":"20231219002745"},"Children":[{"Type":"NodeText","Data":"阅读上面这段代码，结构体 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UserData"},{"Type":"NodeText","Data":"​ 中嵌套结构体 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"OtherInfo"},{"Type":"NodeText","Data":"​ 和切片 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Language"},{"Type":"NodeText","Data":"​，我们使用 Viper 提供的 tag 标签 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"mapstructure"},{"Type":"NodeText","Data":"​，将读取到的配置信息解析到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"struct"},{"Type":"NodeText","Data":"​ 中。"}]},{"ID":"20231219002745-4ztgd1o","Type":"NodeParagraph","Properties":{"id":"20231219002745-4ztgd1o","updated":"20231219002745"},"Children":[{"Type":"NodeText","Data":"需要注意的是，解析指定配置信息使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UnmarshalKey"},{"Type":"NodeText","Data":"​ 函数，解析全部配置信息使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Unmarshal"},{"Type":"NodeText","Data":"​，二者的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"yaml"},{"Type":"NodeText","Data":"​ "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"文件格式也不一样"},{"Type":"NodeText","Data":"，读者朋友们小心踩“坑”。"}]},{"ID":"20231219002749-o8gk9e6","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20231219002749-o8gk9e6","updated":"20231219002755"},"Children":[{"Type":"NodeText","Data":"总结"}]},{"ID":"20231219002802-5iq7txa","Type":"NodeParagraph","Properties":{"id":"20231219002802-5iq7txa","updated":"20231219002802"},"Children":[{"Type":"NodeText","Data":"本文我们通过示例代码，介绍怎么使用 Viper 读取嵌套配置信息，它提供两个函数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Unmarshal"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UnmarshalKey"},{"Type":"NodeText","Data":"​，分别用于解析全部配置信息，和解析指定配置信息。"}]},{"ID":"20231219002802-8o76x9r","Type":"NodeParagraph","Properties":{"id":"20231219002802-8o76x9r","updated":"20231219002802"},"Children":[{"Type":"NodeText","Data":"需要注意的是，针对结构体中的嵌套结构体类型或切片类型的字段，我们需要使用 Viper 提供的 tag 标签 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"mapstructure"},{"Type":"NodeText","Data":"​，否则将无法读取到配置信息的内容。"}]},{"ID":"20231219002802-iz2kn3b","Type":"NodeParagraph","Properties":{"id":"20231219002802-iz2kn3b","updated":"20231219002802"},"Children":[{"Type":"NodeText","Data":"此外，yaml 格式也需要熟练掌握，尽量不要因为 yaml 格式不对，导致解析不出配置信息中的内容。"}]}]}