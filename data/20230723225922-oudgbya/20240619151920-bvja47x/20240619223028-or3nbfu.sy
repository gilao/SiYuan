{"ID":"20240619223028-or3nbfu","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f3cd-fe0f","id":"20240619223028-or3nbfu","tags":"Go-ants,Go-goroutine","title":"ants: 强大的高性能与低成本 Go协程池","type":"doc","updated":"20240619223059"},"Children":[{"ID":"20240619223059-xkqzf0g","Type":"NodeParagraph","Properties":{"id":"20240619223059-xkqzf0g","updated":"20240619223059"},"Children":[{"Type":"NodeText","Data":"在开发高并发程序时，管理并发的能力至关重要。在 Golang 中，虽然可以使用 Go 内置的 goroutines 来处理并发任务，但没有调度和控制的 goroutine 很容易导致系统资源耗尽。为了解决这个问题，"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"ants"},{"Type":"NodeText","Data":" 是一个高性能且低成本的 Go 协程池库，可以更高效地管理和使用 goroutine。"}]},{"ID":"20240619223059-fi3cl08","Type":"NodeParagraph","Properties":{"id":"20240619223059-fi3cl08","updated":"20240619223059"},"Children":[{"Type":"NodeText","Data":"本文将详细介绍如何使用 ants 作为 goroutine 池来优化 Go 应用程序，包括如何安装 ants、创建池、提交任务、调整参数等，并通过几个示例演示其实际应用。"}]},{"ID":"20240619223359-3sipuka","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240619223359-3sipuka","updated":"20240619223359"},"Children":[{"Type":"NodeText","Data":"安装 ants"}]},{"ID":"20240619223359-napejld","Type":"NodeParagraph","Properties":{"id":"20240619223359-napejld","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"首先，我们需要在项目中安装 ants。这可以通过以下命令完成："}]},{"ID":"20240619223359-t82hhcg","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240619223359-t82hhcg","updated":"20240619223400"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"go get -u github.com/panjf2000/ants/v2\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240619223359-9o0sosy","Type":"NodeParagraph","Properties":{"id":"20240619223359-9o0sosy","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"安装完成后，就可以在代码中引用 ants 了。"}]},{"ID":"20240619223359-9h7lkbm","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240619223359-9h7lkbm","updated":"20240619223359"},"Children":[{"Type":"NodeText","Data":"基本使用方法"}]},{"ID":"20240619223359-w6zjj4z","Type":"NodeParagraph","Properties":{"id":"20240619223359-w6zjj4z","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"基本的使用 ants 非常简单。我们可以创建一个 goroutine 池，在池中提交任务，然后关闭池。以下是一个简单的示例："}]},{"ID":"20240619223359-prmhqon","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240619223359-prmhqon","updated":"20240619223400"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"package main\n\nimport (\n    \"fmt\"\n    \"time\"\n    \"github.com/panjf2000/ants/v2\"\n)\n\nfunc main() {\n    runTask := func(i interface{}) {\n        fmt.Printf(\"Running task: %d\\n\", i.(int))\n        time.Sleep(1 * time.Second) // 模拟任务处理\n    }\n\n    // 创建一个具有 10 个 goroutines 的池\n    p, _ := ants.NewPoolWithFunc(10, func(i interface{}) {\n        runTask(i)\n    })\n    defer p.Release()\n\n    // 提交任务\n    for i := 0; i \u003c 30; i++ {\n        _ = p.Invoke(i)\n    }\n\n    // 等待所有任务完成\n    p.Wait()\n    fmt.Println(\"All tasks completed\")\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240619223359-l12juqm","Type":"NodeParagraph","Properties":{"id":"20240619223359-l12juqm","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"在这个示例中，我们创建了一个包含 10 个 goroutines 的池，并提交了 30 个任务。ants 会自动调度这些任务，确保并发数不会超过池的大小。"}]},{"ID":"20240619223359-3b07eqw","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240619223359-3b07eqw","updated":"20240619223359"},"Children":[{"Type":"NodeText","Data":"调整参数"}]},{"ID":"20240619223359-ig75xke","Type":"NodeParagraph","Properties":{"id":"20240619223359-ig75xke","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"ants 提供了多种参数来优化池的行为。例如，可以调整池的大小、设置非阻塞模式、以及设置空闲的超时时间等。"}]},{"ID":"20240619223359-9q4o3h4","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240619223359-9q4o3h4","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"设置池大小"}]},{"ID":"20240619223359-zhccj33","Type":"NodeParagraph","Properties":{"id":"20240619223359-zhccj33","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"我们可以创建一个不同大小的池，通过 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"NewPoolWithFunc"},{"Type":"NodeText","Data":"​ 来指定池大小："}]},{"ID":"20240619223359-bctcoxa","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240619223359-bctcoxa","updated":"20240619223400"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"p, _ := ants.NewPoolWithFunc(20, func(i interface{}) {\n    runTask(i)\n})\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240619223359-5zsid1d","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240619223359-5zsid1d","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"设置非阻塞模式"}]},{"ID":"20240619223359-nndn6t0","Type":"NodeParagraph","Properties":{"id":"20240619223359-nndn6t0","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"默认情况下，如果池已满，新任务会阻塞直到有空闲 goroutine 可用。我们可以通过设置非阻塞模式来改变这一行为："}]},{"ID":"20240619223359-cw1zi37","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240619223359-cw1zi37","updated":"20240619223400"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"p, _ := ants.NewPoolWithFunc(10, func(i interface{}) {\n    runTask(i)\n}, ants.WithNonblocking(true))\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240619223359-c0db59b","Type":"NodeParagraph","Properties":{"id":"20240619223359-c0db59b","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"在非阻塞模式下，如果池已满，新任务会立即返回错误，而不是等待。"}]},{"ID":"20240619223359-91gt2j4","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240619223359-91gt2j4","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"设置任务超时"}]},{"ID":"20240619223359-51kpayl","Type":"NodeParagraph","Properties":{"id":"20240619223359-51kpayl","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"我们还可以设置池中任务的超时时间，以避免某些任务耗时过长："}]},{"ID":"20240619223359-xair79v","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240619223359-xair79v","updated":"20240619223400"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"p, _ := ants.NewPoolWithFunc(10, func(i interface{}) {\n    runTask(i)\n}, ants.WithExpireDuration(5 * time.Second))\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240619223359-jrtumnq","Type":"NodeParagraph","Properties":{"id":"20240619223359-jrtumnq","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"在这个示例中，每个任务最多只能运行 5 秒钟，超过这个时间，任务将被自动终止。"}]},{"ID":"20240619223359-y422xjp","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240619223359-y422xjp","updated":"20240619223359"},"Children":[{"Type":"NodeText","Data":"示例：网络爬虫"}]},{"ID":"20240619223359-w1mj3k5","Type":"NodeParagraph","Properties":{"id":"20240619223359-w1mj3k5","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"假设我们正在编写一个网络爬虫，需要并发访问多个网页。可以使用 ants 来管理并发连接："}]},{"ID":"20240619223359-p935xga","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240619223359-p935xga","updated":"20240619223400"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"package main\n\nimport (\n    \"fmt\"\n    \"net/http\"\n    \"io/ioutil\"\n    \"github.com/panjf2000/ants/v2\"\n)\n\nfunc main() {\n    urls := []string{\n        \"http://example.com\",\n        \"http://example.org\",\n        \"http://example.net\",\n    }\n\n    fetchURL := func(url string) {\n        resp, err := http.Get(url)\n        if err != nil {\n            fmt.Printf(\"Failed to fetch %s: %s\\n\", url, err)\n            return\n        }\n        defer resp.Body.Close()\n        body, _ := ioutil.ReadAll(resp.Body)\n        fmt.Printf(\"Fetched from %s: %d bytes\\n\", url, len(body))\n    }\n\n    p, _ := ants.NewPoolWithFunc(5, func(i interface{}) {\n        fetchURL(i.(string))\n    })\n    defer p.Release()\n\n    for _, url := range urls {\n        _ = p.Invoke(url)\n    }\n\n    p.Wait()\n    fmt.Println(\"All URLs fetched\")\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240619223359-bbbdiht","Type":"NodeParagraph","Properties":{"id":"20240619223359-bbbdiht","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"在这个示例中，我们创建了一个网络爬虫，使用 ants 来并发地访问多个网页。爬虫只使用 5 个 goroutines，并发访问多个 URL。"}]},{"ID":"20240619223359-orawkvc","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240619223359-orawkvc","updated":"20240619223359"},"Children":[{"Type":"NodeText","Data":"扩展思路"}]},{"ID":"20240619223359-5e6lewf","Type":"NodeParagraph","Properties":{"id":"20240619223359-5e6lewf","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"除了基本的任务提交和参数调整，还有许多高级用法。下面列举几个："}]},{"ID":"20240619223359-9la278x","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240619223359-9la278x","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"动态调整池大小"}]},{"ID":"20240619223359-zfcmp10","Type":"NodeParagraph","Properties":{"id":"20240619223359-zfcmp10","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"有时候，我们需要根据运行时环境动态调整池的大小。ants 支持在运行时调整池大小："}]},{"ID":"20240619223359-anrj0ai","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240619223359-anrj0ai","updated":"20240619223400"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"pool.Tune(20)\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240619223359-2ktgju9","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240619223359-2ktgju9","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"性能监控"}]},{"ID":"20240619223359-brpb3se","Type":"NodeParagraph","Properties":{"id":"20240619223359-brpb3se","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"ants 内置了一些性能监控功能，可以用来观察池的运行状态："}]},{"ID":"20240619223359-vgivpq8","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240619223359-vgivpq8","updated":"20240619223400"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"fmt.Printf(\"Running goroutines: %d\\n\", pool.Running())\nfmt.Printf(\"Free goroutines: %d\\n\", pool.Free())\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240619223359-z8vollj","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240619223359-z8vollj","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"异常处理"}]},{"ID":"20240619223359-gqhua7j","Type":"NodeParagraph","Properties":{"id":"20240619223359-gqhua7j","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"可以为每个任务设置异常处理机制，确保 goroutine 不会因为 panic 而崩溃："}]},{"ID":"20240619223359-a6hr5sh","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240619223359-a6hr5sh","updated":"20240619223400"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"p, _ := ants.NewPoolWithFunc(10, func(i interface{}) {\n    defer func() {\n        if r := recover(); r != nil {\n            fmt.Println(\"Recovered from panic\", r)\n        }\n    }()\n    runTask(i)\n})\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240619223359-cc92jnl","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240619223359-cc92jnl","updated":"20240619223359"},"Children":[{"Type":"NodeText","Data":"总结"}]},{"ID":"20240619223359-ah0slpp","Type":"NodeParagraph","Properties":{"id":"20240619223359-ah0slpp","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"使用 ants 可以显著提高 Go 应用程序的并发能力，使得 goroutines 的管理更加高效和可靠。通过调整参数，我们可以更灵活地控制池的行为，以满足不同的应用场景需求。无论是简单的并发任务，还是复杂的并发控制，ants 都提供了强大的支持。"}]},{"ID":"20240619223359-f4wr5dr","Type":"NodeParagraph","Properties":{"id":"20240619223359-f4wr5dr","updated":"20240619223400"},"Children":[{"Type":"NodeText","Data":"希望通过本文，你能够对 ants 有一个全面的理解，并能在实际项目中灵活运用。🔧🚀"}]}]}