{"ID":"20240507231851-08cgjwl","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f356","id":"20240507231851-08cgjwl","tags":"Go-sql 库","title":"Golang sql 标准库源码解析","updated":"20240507232750"},"Children":[{"ID":"20240507232300-x4fu8dw","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240507232300-x4fu8dw","updated":"20240507232313"},"Children":[{"Type":"NodeText","Data":"前言"}]},{"ID":"20240507232313-804v0qi","Type":"NodeParagraph","Properties":{"id":"20240507232313-804v0qi","updated":"20240507232416"},"Children":[{"Type":"NodeText","Data":"近期和大家一起探讨 go 语言中关系型数据库有关的话题.\n本系列会拆分为多个篇章：\n• database/sql 库研究： 研究 go 语言 sql 标准库下对数据库连接池的实现细节，以及对数据库驱动模块的接口定义规范\n• mysql driver 库研究： 研究 go 语言下 mysql 数据库驱动的底层实现细节，对应开源地址：https://github.com/go-sql-driver/mysql\n• orm 框架 gorm 库研究： 研究 go 语言最流行的 orm 框架——gorm 的实现原理，对应开源地址：https://github.com/go-gorm/gorm"}]},{"ID":"20240507232430-ysbd7yg","Type":"NodeParagraph","Properties":{"id":"20240507232430-ysbd7yg","updated":"20240507232430"},"Children":[{"Type":"NodeText","Data":"本文是其中的第一篇，走读的 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"database/sql 源码统一为 go v1.19 版本"},{"Type":"NodeText","Data":"."}]},{"ID":"20240507232430-66capfw","Type":"NodeParagraph","Properties":{"id":"20240507232430-66capfw","updated":"20240507232430"},"Children":[{"Type":"NodeText","Data":"有关 database/sql 库的使用教程可以参见：http://go-database-sql.org/index.html"}]},{"ID":"20240507232430-wlukn7g","Type":"NodeParagraph","Properties":{"id":"20240507232430-wlukn7g","updated":"20240507232430"},"Children":[{"Type":"NodeText","Data":"涉及到的源码文件目录为："}]},{"ID":"20240507232430-27upiba","Type":"NodeTable","TableAligns":[0,0],"Properties":{"colgroup":"|","id":"20240507232430-27upiba","updated":"20240507232430"},"Children":[{"Type":"NodeTableHead","Data":"thead","Children":[{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"内容"}]},{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"文件"}]}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"sql 库主流程"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"database/sql/sql.go"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"数据库驱动相关"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"database/sql/driver/driver.go"}]}]}]},{"ID":"20240507232430-6pzsnvq","Type":"NodeParagraph","Properties":{"id":"20240507232430-6pzsnvq","updated":"20240507232430"},"Children":[{"Type":"NodeText","Data":"本文分享大纲如下："}]},{"ID":"20240507232430-frcd3ky","Type":"NodeParagraph","Properties":{"id":"20240507232430-frcd3ky","updated":"20240507232441"},"Children":[{"Type":"NodeText","Data":"​​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"92276bb44eb7abc1b16cdea2cee39f8c"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/92276bb44eb7abc1b16cdea2cee39f8c-20240507232026-u8pazbk.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​​"}]},{"ID":"20240507231851-9gmvj6t","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240507231851-9gmvj6t","updated":"20240507231959"},"Children":[{"Type":"NodeText","Data":"前言"}]},{"ID":"20240507232006-y2n8pw9","Type":"NodeParagraph","Properties":{"id":"20240507232006-y2n8pw9","updated":"20240507232006"},"Children":[{"Type":"NodeText","Data":"近期和大家一起探讨 go 语言中关系型数据库有关的话题."}]},{"ID":"20240507232006-4eulrlr","Type":"NodeParagraph","Properties":{"id":"20240507232006-4eulrlr","updated":"20240507232006"},"Children":[{"Type":"NodeText","Data":"本系列会拆分为多个篇章："}]},{"ID":"20240507232006-r9zi9h0","Type":"NodeList","ListData":{},"Properties":{"id":"20240507232006-r9zi9h0","updated":"20240507232006"},"Children":[{"ID":"20240507232006-samnjen","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240507232006-samnjen","updated":"20240507232006"},"Children":[{"ID":"20240507232006-qf3xpg7","Type":"NodeParagraph","Properties":{"id":"20240507232006-qf3xpg7","updated":"20240507232006"},"Children":[{"Type":"NodeText","Data":" "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"database/sql 库研究："},{"Type":"NodeText","Data":" 研究 go 语言 sql 标准库下对数据库连接池的实现细节，以及对数据库驱动模块的接口定义规范"}]}]},{"ID":"20240507232006-p8ndw95","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240507232006-p8ndw95","updated":"20240507232006"},"Children":[{"ID":"20240507232006-3cci3ql","Type":"NodeParagraph","Properties":{"id":"20240507232006-3cci3ql","updated":"20240507232006"},"Children":[{"Type":"NodeText","Data":" "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"mysql driver 库研究："},{"Type":"NodeText","Data":" 研究 go 语言下 mysql 数据库驱动的底层实现细节，对应开源地址：https://github.com/go-sql-driver/mysql"}]}]},{"ID":"20240507232006-uvae4sb","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240507232006-uvae4sb","updated":"20240507232006"},"Children":[{"ID":"20240507232006-ohaza9k","Type":"NodeParagraph","Properties":{"id":"20240507232006-ohaza9k","updated":"20240507232006"},"Children":[{"Type":"NodeText","Data":" "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"orm 框架 gorm 库研究："},{"Type":"NodeText","Data":" 研究 go 语言最流行的 orm 框架——gorm 的实现原理，对应开源地址：https://github.com/go-gorm/gorm"}]}]}]},{"ID":"20240507232006-vpcw39a","Type":"NodeParagraph","Properties":{"id":"20240507232006-vpcw39a","updated":"20240507232006"},"Children":[{"Type":"NodeText","Data":"本文是其中的第一篇，走读的 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"database/sql 源码统一为 go v1.19 版本"},{"Type":"NodeText","Data":"."}]},{"ID":"20240507232006-h3e5183","Type":"NodeParagraph","Properties":{"id":"20240507232006-h3e5183","updated":"20240507232006"},"Children":[{"Type":"NodeText","Data":"有关 database/sql 库的使用教程可以参见：http://go-database-sql.org/index.html"}]},{"ID":"20240507232006-nr4e8e2","Type":"NodeParagraph","Properties":{"id":"20240507232006-nr4e8e2","updated":"20240507232006"},"Children":[{"Type":"NodeText","Data":"涉及到的源码文件目录为："}]},{"ID":"20240507232006-p4fv2z3","Type":"NodeTable","TableAligns":[0,0],"Properties":{"colgroup":"|","id":"20240507232006-p4fv2z3","updated":"20240507232006"},"Children":[{"Type":"NodeTableHead","Data":"thead","Children":[{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"内容"}]},{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"文件"}]}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"sql 库主流程"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"database/sql/sql.go"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"数据库驱动相关"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"database/sql/driver/driver.go"}]}]}]},{"ID":"20240507232008-af6disa","Type":"NodeParagraph","Properties":{"id":"20240507232008-af6disa","updated":"20240507232020"},"Children":[{"Type":"NodeText","Data":"本文大纲如下："}]},{"ID":"20240507232026-n82bueo","Type":"NodeParagraph","Properties":{"id":"20240507232026-n82bueo","updated":"20240507232026"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"92276bb44eb7abc1b16cdea2cee39f8c"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/92276bb44eb7abc1b16cdea2cee39f8c-20240507232026-u8pazbk.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240507232033-9tcr6i8","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240507232033-9tcr6i8","updated":"20240507232052"},"Children":[{"Type":"NodeText","Data":"简易教程"}]},{"ID":"20240507232052-x8y01kv","Type":"NodeParagraph","Properties":{"id":"20240507232052-x8y01kv","updated":"20240507232108"},"Children":[{"Type":"NodeText","Data":"首先通过一个简单的交互场景，向大家展示一下如何基于标准库 database/sql 完成一笔关系型数据库的查询操作，场景如下："}]},{"ID":"20240507232533-23qq0rf","Type":"NodeList","ListData":{},"Properties":{"id":"20240507232533-23qq0rf","updated":"20240507232543"},"Children":[{"ID":"20240507232533-yqj5aaj","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240507232533-yqj5aaj","updated":"20240507232533"},"Children":[{"ID":"20240507232533-78st5nk","Type":"NodeParagraph","Properties":{"id":"20240507232533-78st5nk","updated":"20240507232535"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"注册数据库驱动："},{"Type":"NodeText","Data":" 使用数据库类型为 mysql，通过匿名导入 package:github.com/go-sql-driver/mysql，在该 pkg 的 init 函数中完成驱动的注册操作（这部分内容将在下期展开）"}]}]},{"ID":"20240507232533-6mdzrk7","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240507232533-6mdzrk7","updated":"20240507232539"},"Children":[{"ID":"20240507232533-jn4rz7k","Type":"NodeParagraph","Properties":{"id":"20240507232533-jn4rz7k","updated":"20240507232539"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"定义数据模型："},{"Type":"NodeText","Data":" 创建一个 user 表，里面包含一个 int64 类型的 userID 字段"}]}]},{"ID":"20240507232533-1eeq0bv","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240507232533-1eeq0bv","updated":"20240507232540"},"Children":[{"ID":"20240507232533-0296x10","Type":"NodeParagraph","Properties":{"id":"20240507232533-0296x10","updated":"20240507232540"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"创建数据库实例："},{"Type":"NodeText","Data":" 调用 database/sql 库的 Open 方法，填入 mysql 的 dsn（包含用户名、密码、ip、端口、数据库名等信息），完成数据库实例创建 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"（注意：sql.Open 方法只创建db 实例，还未执行任何连接操作，如需测试网络、鉴权等信息，可以调用 ping 方法）"}]}]},{"ID":"20240507232533-bsl2ei6","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240507232533-bsl2ei6","updated":"20240507232542"},"Children":[{"ID":"20240507232533-ce0wr6q","Type":"NodeParagraph","Properties":{"id":"20240507232533-ce0wr6q","updated":"20240507232542"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"执行查询 sql："},{"Type":"NodeText","Data":" 调用 db.QueryRowContext，执行 sql，并通过 row 返回结果"}]}]},{"ID":"20240507232533-jy9mpf9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240507232533-jy9mpf9","updated":"20240507232543"},"Children":[{"ID":"20240507232533-eu70wbg","Type":"NodeParagraph","Properties":{"id":"20240507232533-eu70wbg","updated":"20240507232543"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"解析查询结果："},{"Type":"NodeText","Data":" 调用 row.Scan 方法，解析查询结果赋值给 user 实例"}]}]}]},{"ID":"20240507232543-tr4cxak","Type":"NodeParagraph","Properties":{"id":"20240507232543-tr4cxak","updated":"20240507232623"},"Children":[{"Type":"NodeText","Data":"对应流程的代码展示如下："}]},{"ID":"20240507232623-bdcin1e","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240507232623-bdcin1e","updated":"20240507232715"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"package main\n\nimport (\n\t\"context\"\n\t\"database/sql\"\n\t\"testing\"\n\n\n\t// 注册 mysql 数据库驱动\n\t_ \"github.com/go-sql-driver/mysql\"\n)\n\n\ntype user struct {\n\tUserID int64\n}\n\n\nfunc Test_sql(t *testing.T) {\n\t// 创建 db 实例\n\tdb, err := sql.Open(\"mysql\", \"username:passpord@(ip:port)/database\")\n\tif err != nil {\n\t\tt.Error(err)\n\t\treturn\n\t}\n\n\t// 执行 sql\n\tctx := context.Background()\n\trow := db.QueryRowContext(ctx, \"SELECT user_id FROM user WHERE ORDER BY created_at DESC limit 1\")\n\tif row.Err() != nil {\n\t\tt.Error(err)\n\t\treturn\n\t}\n\n\n\t// 解析结果\n\tvar u user\n\tif err = row.Scan(\u0026u.UserID); err != nil {\n\t\tt.Error(err)\n\t\treturn\n\t}\n\tt.Log(u.UserID)\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240507232720-6oavmc7","Type":"NodeParagraph","Properties":{"id":"20240507232720-6oavmc7","updated":"20240507232725"},"Children":[{"Type":"NodeText","Data":"下面我们以这个使用示例的代码作为源码走读的入口，深入到 database/sql 标准库的底层实现细节当中."}]},{"ID":"20240507232726-3f3oxt9","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240507232726-3f3oxt9","updated":"20240507232732"},"Children":[{"Type":"NodeText","Data":"核心类定义"}]},{"ID":"20240507232739-9ct0s61","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240507232739-9ct0s61","updated":"20240507232745"},"Children":[{"Type":"NodeText","Data":"抽象接口定义"}]},{"ID":"20240507232745-t5okpiv","Type":"NodeParagraph","Properties":{"id":"20240507232745-t5okpiv","updated":"20240507232750"},"Children":[{"Type":"NodeText","Data":"标准库 database/sql 定义了 go 语言通用的结构化查询流程框架，其对接的数据库类型是灵活多变的，如 mysql、sqlite、oracle 等. 因此"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"在 database/sql 中，与具体数据库交互的细节内容统一托付给一个抽象的数据库驱动模块，在其中声明好一套适用于各类关系型数据库的统一规范，将各个关键节点定义成抽象的 interface，由具体类型的数据库完成数据库驱动模块的实现"},{"Type":"NodeText","Data":"，然后将其注入到 database/sql 的大框架之中."}]},{"ID":"20240507232736-aey09ce","Type":"NodeParagraph","Properties":{"id":"20240507232736-aey09ce","updated":"20240507232745"}}]}