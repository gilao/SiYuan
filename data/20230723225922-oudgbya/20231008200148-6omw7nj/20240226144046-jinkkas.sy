{"ID":"20240226144046-jinkkas","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f36f","id":"20240226144046-jinkkas","title":"Go Context 到底放第一个参数传，还是放结构体里","updated":"20240226152525"},"Children":[{"ID":"20240226144131-lkn0f1j","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226144131-lkn0f1j","updated":"20240226144131"},"Children":[{"Type":"NodeText","Data":"快速介绍"}]},{"ID":"20240226144131-8ub6aoo","Type":"NodeParagraph","Properties":{"id":"20240226144131-8ub6aoo","updated":"20240226144131"},"Children":[{"Type":"NodeText","Data":"上下文（Context）是 Go 语言中非常有特色的一个特性，其主要的作用是在 goroutine 中进行上下文的传递，而在传递信息中又包含了 goroutine 的运行控制、上下文信息传递等功能。"}]},{"ID":"20240226144131-1jhwdhb","Type":"NodeParagraph","Properties":{"id":"20240226144131-1jhwdhb","updated":"20240226144131"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/KVl0giak5ib4ia8TQicd4oXMsxEghML0ZYZG0iak7iajxNa9iaiaWH7NYfwEfAzicUHLOj7c9AJBicOJn3V7RpmEot1uoKgw/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226144638-w8q9wwb","Type":"NodeParagraph","Properties":{"id":"20240226144638-w8q9wwb","updated":"20240226144639"},"Children":[{"Type":"NodeText","Data":"以下是一个简单 Demo："}]},{"ID":"20240226144640-9cisz7t","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240226144640-9cisz7t","updated":"20240226144648"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"func main() {\n parentCtx := context.Background()\n ctx, cancel := context.WithTimeout(parentCtx, 1*time.Millisecond)\n defer cancel()\n\n select {\n case \u003c-time.After(1 * time.Second):\n  f1(ctx)\n case \u003c-ctx.Done():\n  f2(ctx)\n }\n}\n\nfunc f1(ctx context.Context) {\n fmt.Println(\"脑子进煎鱼了\", ctx.Err())\n}\n\nfunc f2(ctx context.Context) {\n fmt.Println(\"煎鱼进脑子了\", ctx.Err())\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240226144654-nlb9o5v","Type":"NodeParagraph","Properties":{"id":"20240226144654-nlb9o5v","updated":"20240226144659"},"Children":[{"Type":"NodeText","Data":"输出结果："}]},{"ID":"20240226144700-lz8q1qa","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240226144700-lz8q1qa","updated":"20240226144710"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"煎鱼进脑子了 context deadline exceeded\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240226152525-n0wptac","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226152525-n0wptac","updated":"20240226152525"},"Children":[{"Type":"NodeText","Data":"Go context 放哪好的争议点"}]},{"ID":"20240226152525-m983jfm","Type":"NodeParagraph","Properties":{"id":"20240226152525-m983jfm","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"根据上面的 Demo，有争议的点在哪？就是这个函数里 context，到底怎么传。放函数第一个参数，还是放结构体？"}]},{"ID":"20240226152525-0kf98al","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240226152525-0kf98al","updated":"20240226152526"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"// 第一种方式\nfunc f1(ctx context.Context) {...}\n\n// 第二种方式\ntype T struct {\n  Ctx context\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240226152525-x5h98qh","Type":"NodeList","ListData":{},"Properties":{"id":"20240226152525-x5h98qh","updated":"20240226152526"},"Children":[{"ID":"20240226152525-prbony6","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226152525-prbony6","updated":"20240226152525"},"Children":[{"ID":"20240226152525-k7nb0si","Type":"NodeParagraph","Properties":{"id":"20240226152525-k7nb0si","updated":"20240226152525"},"Children":[{"Type":"NodeText","Data":"放在函数第一个参数 context 中的话，那每个方法都需要进行传递，用起来就像被 ”污染“ 了一样。每个函数都要层层递进的传下去。非常的显性。"}]}]},{"ID":"20240226152525-den2mdr","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226152525-den2mdr","updated":"20240226152525"},"Children":[{"ID":"20240226152525-ljpto49","Type":"NodeParagraph","Properties":{"id":"20240226152525-ljpto49","updated":"20240226152525"},"Children":[{"Type":"NodeText","Data":"放在结构体中的话，按理说 context 是基本对标请求的，每次请求都是不同的 context。这样可能会导致每次都要 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"NewT()"},{"Type":"NodeText","Data":"​ 或是 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"WithContext"},{"Type":"NodeText","Data":"​。一旦忘了，就很容易埋下隐患。"}]}]}]},{"ID":"20240226152525-1bvf0gi","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226152525-1bvf0gi","updated":"20240226152525"},"Children":[{"Type":"NodeText","Data":"Go 官方建议"}]},{"ID":"20240226152525-gelii7s","Type":"NodeParagraph","Properties":{"id":"20240226152525-gelii7s","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"Go 官方建议中是怎么说的？在 context 标准库的文档中有提到。使用上下文的程序应遵循以下规则，以保持跨包的接口一致："}]},{"ID":"20240226152525-v2zedfx","Type":"NodeParagraph","Properties":{"id":"20240226152525-v2zedfx","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/KVl0giak5ib4ia8TQicd4oXMsxEghML0ZYZGKV46gbvlFmHEKicCibE5mMbJ7feDZGNBgYqbaicwqZamdV9r6kgfeffvg/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226152525-1xndvmd","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240226152525-1xndvmd","updated":"20240226152526"},"Children":[{"ID":"20240226152525-vqz8559","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240226152525-vqz8559","updated":"20240226152525"},"Children":[{"ID":"20240226152525-danmbd6","Type":"NodeParagraph","Properties":{"id":"20240226152525-danmbd6","updated":"20240226152525"},"Children":[{"Type":"NodeText","Data":"不要将 context 存储在结构体中。"}]}]},{"ID":"20240226152525-vswpk2q","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240226152525-vswpk2q","updated":"20240226152525"},"Children":[{"ID":"20240226152525-tb6727n","Type":"NodeParagraph","Properties":{"id":"20240226152525-tb6727n","updated":"20240226152525"},"Children":[{"Type":"NodeText","Data":"应该将 context 显式传递给每个需要它的函数，其应该是第一个参数，通常将参数命名为 ctx。"}]}]},{"ID":"20240226152525-1drb190","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240226152525-1drb190","updated":"20240226152525"},"Children":[{"ID":"20240226152525-7ob1g3p","Type":"NodeParagraph","Properties":{"id":"20240226152525-7ob1g3p","updated":"20240226152525"},"Children":[{"Type":"NodeText","Data":"不要传递 nil context。如果您不确定要使用哪个 context，请传递 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"context.TODO"},{"Type":"NodeText","Data":"​。"}]}]}]},{"ID":"20240226152525-mfv3lmb","Type":"NodeParagraph","Properties":{"id":"20240226152525-mfv3lmb","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"对应的示例代码："}]},{"ID":"20240226152525-bv3h8xd","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240226152525-bv3h8xd","updated":"20240226152526"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"func DoSomething(ctx context.Context, arg Arg) error {\n // ... use ctx ...\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240226152525-pxmebv4","Type":"NodeParagraph","Properties":{"id":"20240226152525-pxmebv4","updated":"20240226152526"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"划重点：官方建议在函数首位参数传递 context，不建议使用结构体传递。"}]},{"ID":"20240226152525-as524ao","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226152525-as524ao","updated":"20240226152525"},"Children":[{"Type":"NodeText","Data":"一些讨论"}]},{"ID":"20240226152525-w55kevf","Type":"NodeParagraph","Properties":{"id":"20240226152525-w55kevf","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"虽然官方是这么建议了。但看起来没头没尾，不认可的人也有不少。"}]},{"ID":"20240226152525-nox2no5","Type":"NodeParagraph","Properties":{"id":"20240226152525-nox2no5","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"包括前 Go 核心团队的 @Brad Fitzpatrick 也表达了反对的意见，并给出进一步的诠释："}]},{"ID":"20240226152525-hdbycim","Type":"NodeBlockquote","Properties":{"id":"20240226152525-hdbycim","updated":"20240226152526"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20240226152525-0sntcdg","Type":"NodeParagraph","Properties":{"id":"20240226152525-0sntcdg","updated":"20240226152525"},"Children":[{"Type":"NodeText","Data":"While we've told people not to add contexts to structs, I think that guidance is over-aggressive. The real advice is not to store contexts. They should be passed along like parameters. But if the struct is essentially just a parameter, it's okay. I think this concern can be addressed with package-level documentation and examples."}]}]},{"ID":"20240226152525-5l3pczv","Type":"NodeParagraph","Properties":{"id":"20240226152525-5l3pczv","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"大概意思：我们曾告诉人们不要在结构体中添加上下文，但我认为这种指导过于激进。"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"真正的建议是不要存储上下文。它们应该像参数一样传递"},{"Type":"NodeText","Data":"。但如果结构体本质上只是一个参数，那就没有问题。我认为可以通过包级文档和示例来解决这个问题。"}]},{"ID":"20240226152525-hbrwcnd","Type":"NodeParagraph","Properties":{"id":"20240226152525-hbrwcnd","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"可能有同学想说，那是不是 Go 官方就可以放宽 context 的使用建议了？"}]},{"ID":"20240226152525-njhxiti","Type":"NodeParagraph","Properties":{"id":"20240226152525-njhxiti","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"想太多了...早在 2017 年就有 @Caleb Spare 提出《context: relax recommendation against putting Contexts in structs"},{"Type":"NodeTextMark","TextMarkType":"sup","TextMarkTextContent":"[1]"},{"Type":"NodeText","Data":"》，希望 Go 官方放宽对于 context 放入结构体中的建议。"}]},{"ID":"20240226152525-9ixo0ej","Type":"NodeParagraph","Properties":{"id":"20240226152525-9ixo0ej","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"但还是处于长期的阻塞状态，没有进一步的相关信息。@"},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkTextContent":"Russ Cox"},{"Type":"NodeText","Data":" 被 @ 了也并没有出来说任何的建议。"}]},{"ID":"20240226152525-zajcpag","Type":"NodeParagraph","Properties":{"id":"20240226152525-zajcpag","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/KVl0giak5ib4ia8TQicd4oXMsxEghML0ZYZGerFTSxq72tz1D2q32TsQtV3D7TqSpJPDDibiaer5Y1diaaCGQicMEkjXiaQ/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226152525-909wk5u","Type":"NodeParagraph","Properties":{"id":"20240226152525-909wk5u","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"可以认为官方文档上的态度没有什么变化。"}]},{"ID":"20240226152525-a9kvq0w","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226152525-a9kvq0w","updated":"20240226152525"},"Children":[{"Type":"NodeText","Data":"总结"}]},{"ID":"20240226152525-j1f1pox","Type":"NodeParagraph","Properties":{"id":"20240226152525-j1f1pox","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"Context 在 Go 中是一个非常重要的特性，基本覆盖编程的方方面面，只要和 “控制” 相关的，都有他的存在。"}]},{"ID":"20240226152525-dif1e2u","Type":"NodeParagraph","Properties":{"id":"20240226152525-dif1e2u","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"在官方的建议中，是不推荐使用结构体存储 context 的，更推荐使用函数第一个参数传递 context 并命名为 ctx。进一步诠释的话，指的是不希望存储 context。"}]},{"ID":"20240226152525-9xkbrq0","Type":"NodeParagraph","Properties":{"id":"20240226152525-9xkbrq0","updated":"20240226152526"},"Children":[{"Type":"NodeText","Data":"大家在 context 实践中又是使用哪种方式呢？欢迎分享。"}]}]}