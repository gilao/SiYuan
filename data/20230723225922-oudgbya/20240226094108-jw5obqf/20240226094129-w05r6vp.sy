{"ID":"20240226094129-w05r6vp","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f506","id":"20240226094129-w05r6vp","tags":"Go-go-zero","title":"微服务该如何应对过量请求？","updated":"20240226110516"},"Children":[{"ID":"20240226094145-h798nmi","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240226094145-h798nmi","updated":"20240226094206"},"Children":[{"Type":"NodeText","Data":"1. go-zero 稳定性能力概览"}]},{"ID":"20240226094206-5zpik9e","Type":"NodeParagraph","Properties":{"id":"20240226094206-5zpik9e","updated":"20240226094249"},"Children":[{"Type":"NodeText","Data":"经过这么多年大流量服务端架构设计的沉淀，go-zero 在保护服务的稳定性上下足了功夫，不管是 CPU 密集型还是 IO 密集型服务，go-zero 都能很好的保护服务在如下场景不被拖垮或卡死："}]},{"ID":"20240226094250-l9igwe5","Type":"NodeList","ListData":{},"Properties":{"id":"20240226094250-l9igwe5","updated":"20240226094252"},"Children":[{"ID":"20240226094252-ahhuuer","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226094252-ahhuuer","updated":"20240226094252"},"Children":[{"ID":"20240226094252-2qnbwlu","Type":"NodeParagraph","Properties":{"id":"20240226094252-2qnbwlu","updated":"20240226094309"},"Children":[{"Type":"NodeText","Data":"远超服务容量的突发大流量"}]}]},{"ID":"20240226094309-5c41l1n","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226094309-5c41l1n"},"Children":[{"ID":"20240226094309-1ql3cpe","Type":"NodeParagraph","Properties":{"id":"20240226094309-1ql3cpe","updated":"20240226094313"},"Children":[{"Type":"NodeText","Data":"CPU打满"}]}]},{"ID":"20240226094313-ubur2xp","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226094313-ubur2xp"},"Children":[{"ID":"20240226094313-bdbjqy0","Type":"NodeParagraph","Properties":{"id":"20240226094313-bdbjqy0","updated":"20240226094322"},"Children":[{"Type":"NodeText","Data":"上下游故障或延时"}]}]},{"ID":"20240226094322-sx3rudv","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226094322-sx3rudv"},"Children":[{"ID":"20240226094322-uyvv1hw","Type":"NodeParagraph","Properties":{"id":"20240226094322-uyvv1hw","updated":"20240226094400"},"Children":[{"Type":"NodeText","Data":"MySQL、MongoDB、Redis 等中间件故障或者超负载：典型的是CPU飙高"}]}]}]},{"ID":"20240226094413-i1t8l7f","Type":"NodeParagraph","Properties":{"id":"20240226094413-i1t8l7f","updated":"20240226094417"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"488736c27deec8f38f9212885d3ce323"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/488736c27deec8f38f9212885d3ce323-20240226094413-6zx0ccx.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240226094129-ko6qimw","Type":"NodeParagraph","Properties":{"id":"20240226094129-ko6qimw","updated":"20240226094449"},"Children":[{"Type":"NodeText","Data":"如图，我们从三个方面来保护系统的稳定性："}]},{"ID":"20240226094450-hmdk45f","Type":"NodeList","ListData":{},"Properties":{"id":"20240226094450-hmdk45f","updated":"20240226094450"},"Children":[{"ID":"20240226094450-ws6ybjq","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226094450-ws6ybjq","updated":"20240226094450"},"Children":[{"ID":"20240226094450-h8qz5a1","Type":"NodeParagraph","Properties":{"id":"20240226094450-h8qz5a1","updated":"20240226094503"},"Children":[{"Type":"NodeText","Data":"服务端自适应过载保护"}]}]},{"ID":"20240226094504-namzit5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226094504-namzit5"},"Children":[{"ID":"20240226094504-5qofcqe","Type":"NodeParagraph","Properties":{"id":"20240226094504-5qofcqe","updated":"20240226094511"},"Children":[{"Type":"NodeText","Data":"服务端自适应熔断"}]}]},{"ID":"20240226094512-8l18uwq","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226094512-8l18uwq"},"Children":[{"ID":"20240226094512-loyaqrc","Type":"NodeParagraph","Properties":{"id":"20240226094512-loyaqrc","updated":"20240226094520"},"Children":[{"Type":"NodeText","Data":"客户端自适应熔断"}]}]}]},{"ID":"20240226094521-q80siz1","Type":"NodeParagraph","Properties":{"id":"20240226094521-q80siz1","updated":"20240226094533"},"Children":[{"Type":"NodeText","Data":"当然，"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"我们还有自动适配后端服务能力的负载均衡算法，对稳定性进一步保驾护航。本文主要讲解自适应过载保护的原理、场景和表现。"}]},{"ID":"20240226094535-qa8jfd1","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240226094535-qa8jfd1","updated":"20240226094547"},"Children":[{"Type":"NodeText","Data":"2. 自适应过载保护压测"}]},{"ID":"20240226094529-ddvemp2","Type":"NodeParagraph","Properties":{"id":"20240226094529-ddvemp2","updated":"20240226094547"},"Children":[{"Type":"NodeText","Data":"用过 Windows 的同学对这个界面应该都不陌生，这就是典型 CPU 打满服务不可用的表现。此时，我们一般都是心里默默骂一句，然后点左边那个按钮，对吧？"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7Iv7v3opk4HfPGydk6pUj4kzZ7SRhP15QkCusyMoXvmAR102KuPSMicW1Q/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226094602-xnm451s","Type":"NodeParagraph","Properties":{"id":"20240226094602-xnm451s","updated":"20240226094603"},"Children":[{"Type":"NodeText","Data":"那我们想想，如果我们的服务 CPU 被打满了，是不是后面所有的请求也都被卡住了？等服务处理完请求的时候，用户那里可能已经超时离开了，结果服务器很忙，但都是做的无用功。如果这里不能理解，停下来好好思考一番，如果还不懂的话，可以来 go-zero 群里讨论讨论。。。"}]},{"ID":"20240226094608-y44hfro","Type":"NodeParagraph","Properties":{"id":"20240226094608-y44hfro","updated":"20240226094608"}},{"ID":"20240226094609-58jbh3d","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226094609-58jbh3d","updated":"20240226094915"},"Children":[{"Type":"NodeText","Data":"2.1 模拟CPU密集性服务"}]},{"ID":"20240226094916-obveveo","Type":"NodeParagraph","Properties":{"id":"20240226094916-obveveo","updated":"20240226095930"},"Children":[{"Type":"NodeText","Data":"有人可能会问 CPU 密集型服务怎么定义？你的服务 CPU 会打满吗？处理请求会包含复杂的计算逻辑吗？你经常需要通过 cpu profiling 来优化性能吗？可以理解为服务的 IO 比较快，或者比较少，瓶颈是在 CPU 消耗上。"}]},{"ID":"20240226095932-27emgjc","Type":"NodeParagraph","Properties":{"id":"20240226095932-27emgjc","updated":"20240226095938"},"Children":[{"Type":"NodeText","Data":"你可以直接用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"goctl quickstart -t mono"},{"Type":"NodeText","Data":"​ 命令生成一个 HTTP 服务，然后在 logic 代码里加上模拟 CPU 负载的请求处理代码。"}]},{"ID":"20240226100003-j37268e","Type":"NodeParagraph","Properties":{"id":"20240226100003-j37268e","updated":"20240226100004"},"Children":[{"Type":"NodeText","Data":"模拟 CPU 计算的代码：https://gist.github.com/kevwan/ccfaf45aa190ac44003d93c094a12c3f"}]},{"ID":"20240226095942-emaky7j","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240226095942-emaky7j","updated":"20240226100047"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"func CpuBounded(times int) []int {\n        // Keeps it to a 32 bit int\n        num := 40\n        var r []int\n        for i := 0; i \u003c times; i++ {\n                d := bubble(expand(reversePrime(fib(num))))\n                r = append(r, d[len(d)-1])\n        }\n        return r\n}\n\nfunc fib(n int) []int {\n        s := []int{1}\n        c := 1\n        p := 0\n        i := n - 1\n        for i \u003e= 1 {\n                c += p\n                p = c - p\n                s = append(s, c)\n                i--\n        }\n        return s\n}\n\nfunc prime(n int) bool {\n        if n%1 != 0 {\n                return false\n        } else if n \u003c= 1 {\n                return false\n        } else if n \u003c= 3 {\n                return true\n        } else if n%2 == 0 {\n                return false\n        }\n        dl := int(math.Sqrt(float64(n)))\n        for d := 3; d \u003c= dl; d += 2 {\n                if n%d == 0 {\n                        return false\n                }\n        }\n        return true\n}\n\nfunc reversePrime(slice []int) []int {\n        l := len(slice) - 1\n        var r []int\n        for l \u003e= 0 {\n                if prime(slice[l]) {\n                        r = append(r, slice[l])\n                }\n                l--\n        }\n        return r\n}\n\nfunc expand(slice []int) []int {\n        ol := len(slice)\n        oc := 0\n        l := ol * 10\n        var r []int\n        for i := 0; i \u003c l; i++ {\n                r = append(r, (slice[oc] + (i * 100)))\n                if oc \u003c ol-1 {\n                        oc++\n                } else {\n                        oc = 0\n                }\n        }\n        return r\n}\n\nfunc bubble(slice []int) []int {\n        for i := 0; i \u003c len(slice); i++ {\n                for y := 0; y \u003c len(slice)-1; y++ {\n                        if slice[y+1] \u003c slice[y] {\n                                t := slice[y]\n                                slice[y] = slice[y+1]\n                                slice[y+1] = t\n                        }\n                }\n        }\n        return slice\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240226100112-xvmh15w","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240226100112-xvmh15w","updated":"20240226100113"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"benchmarkCPU-10          330    3600743 ns/op\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240226100120-obgnzz2","Type":"NodeParagraph","Properties":{"id":"20240226100120-obgnzz2","updated":"20240226100120"},"Children":[{"Type":"NodeText","Data":"从 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"benchmark"},{"Type":"NodeText","Data":"​ 结果可以看出单个请求的逻辑处理需要 3.6ms CPU资源（不包括服务端中间件处理消耗）。对于两核的容器来说，qps 上限约为 550（2000/3.6）。但是我们是一个 HTTP server，肯定还有接受请求、处理请求等逻辑处理的开销，实际上是达不到 550qps 的。"}]},{"ID":"20240226100120-pa4jz1v","Type":"NodeParagraph","Properties":{"id":"20240226100120-pa4jz1v","updated":"20240226100120"},"Children":[{"Type":"NodeText","Data":"这个模拟 CPU 的代码本身不重要，就不做介绍了。"}]},{"ID":"20240226100634-9fqdan0","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226100634-9fqdan0","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"2.2 压测场景"}]},{"ID":"20240226100634-37poi90","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240226100634-37poi90","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"2.2.1 场景一（不开启过载保护）"}]},{"ID":"20240226100634-34gbb87","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240226100634-34gbb87","updated":"20240226100634"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"Timeout: 1000\nMiddlewares:\n  Breaker: false\n  Shedding: false\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240226100634-botxzw7","Type":"NodeList","ListData":{},"Properties":{"id":"20240226100634-botxzw7","updated":"20240226100634"},"Children":[{"ID":"20240226100634-tip5jks","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-tip5jks","updated":"20240226100634"},"Children":[{"ID":"20240226100634-zo6hmh0","Type":"NodeParagraph","Properties":{"id":"20240226100634-zo6hmh0","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"服务跑在两核的容器内"}]}]},{"ID":"20240226100634-j9q8i7w","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-j9q8i7w","updated":"20240226100634"},"Children":[{"ID":"20240226100634-0i3p2we","Type":"NodeParagraph","Properties":{"id":"20240226100634-0i3p2we","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"不开启过载保护"}]}]},{"ID":"20240226100634-7ltapy0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-7ltapy0","updated":"20240226100634"},"Children":[{"ID":"20240226100634-tzg2oq2","Type":"NodeParagraph","Properties":{"id":"20240226100634-tzg2oq2","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"超时 1s"}]}]},{"ID":"20240226100634-sljkvxy","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-sljkvxy","updated":"20240226100634"},"Children":[{"ID":"20240226100634-lzvanjh","Type":"NodeParagraph","Properties":{"id":"20240226100634-lzvanjh","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"loops 2 hey -c 200 -z 60m \u0026quot;http://localhost:8888/ping\u0026quot;"},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226100634-ppynm2h","Type":"NodeList","ListData":{},"Properties":{"id":"20240226100634-ppynm2h","updated":"20240226100634"},"Children":[{"ID":"20240226100634-3hws7ck","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-3hws7ck","updated":"20240226100634"},"Children":[{"ID":"20240226100634-lb8t5ke","Type":"NodeParagraph","Properties":{"id":"20240226100634-lb8t5ke","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"loops"},{"Type":"NodeText","Data":"​ 是我的一个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"alias"},{"Type":"NodeText","Data":"​："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"loops='fs() {for i in {1..{@:2} \u0026amp; done; wait}; fs'"},{"Type":"NodeText","Data":"​，用来并行执行给定命令指定的次数"}]}]}]}]}]},{"ID":"20240226100634-0f06yno","Type":"NodeParagraph","Properties":{"id":"20240226100634-0f06yno","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvViaSIGSMdX3gDCibyrMXh1SsvZglF3yhibadETpQGSEHRgX9MvEW4icd0g/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226100634-6s7lgdl","Type":"NodeList","ListData":{},"Properties":{"id":"20240226100634-6s7lgdl","updated":"20240226100634"},"Children":[{"ID":"20240226100634-3i5znli","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-3i5znli","updated":"20240226100634"},"Children":[{"ID":"20240226100634-u0fo3e9","Type":"NodeParagraph","Properties":{"id":"20240226100634-u0fo3e9","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"可以看到系统总共只处理了大概 500qps 的请求，其中 400qps 多一点是成功的，近 100qps 是超时的（返回了 503 状态码）"}]}]}]},{"ID":"20240226100634-so88dtw","Type":"NodeParagraph","Properties":{"id":"20240226100634-so88dtw","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvlI4PLKbKBgMhNQ92oxLE1Fk7xSkMfJqibw8oV5aaYBKUGLQDmg7npTA/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226100634-kahbsy1","Type":"NodeList","ListData":{},"Properties":{"id":"20240226100634-kahbsy1","updated":"20240226100634"},"Children":[{"ID":"20240226100634-c0o60f5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-c0o60f5","updated":"20240226100634"},"Children":[{"ID":"20240226100634-4frpdpk","Type":"NodeParagraph","Properties":{"id":"20240226100634-4frpdpk","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"随着请求的堆积，很快就会大量请求都超时了，并且p99，甚至p90都已经超过 1s 了"}]}]},{"ID":"20240226100634-oj652s6","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-oj652s6","updated":"20240226100634"},"Children":[{"ID":"20240226100634-sdutzjr","Type":"NodeParagraph","Properties":{"id":"20240226100634-sdutzjr","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"这里进一步解释一下，超时的请求意味着对系统资源的浪费，比如接受到一个请求，花了不少cpu时间处理完了，然后返回结果时，发现请求已经超时了，用户已经收到了类似“服务器繁忙，请稍后再试！”的提示。这里可能有用户会说，go不是有超时控制吗？这里有两点："}]},{"ID":"20240226100634-iteud9f","Type":"NodeList","ListData":{},"Properties":{"id":"20240226100634-iteud9f","updated":"20240226100634"},"Children":[{"ID":"20240226100634-fm5bjv9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-fm5bjv9","updated":"20240226100634"},"Children":[{"ID":"20240226100634-0fsr3cx","Type":"NodeParagraph","Properties":{"id":"20240226100634-0fsr3cx","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"超时不是在代码的每个指令处都能先判断是否超时再执行，比如我们有一个for循环，不会每次都先判断ctx是否超时，然后再执行下一次迭代，如果你真的这样写了，性能可能需要特别关注，得看你每次循环的计算和判断超时的开销对比"}]}]},{"ID":"20240226100634-ez10qwn","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-ez10qwn","updated":"20240226100634"},"Children":[{"ID":"20240226100634-ci3vu5d","Type":"NodeParagraph","Properties":{"id":"20240226100634-ci3vu5d","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"即使能够比较好的判断超时，在侦测到超时之前也已经白费了一些系统资源处理请求了"}]}]}]}]}]},{"ID":"20240226100634-vpduoyo","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240226100634-vpduoyo","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"2.2.2 场景二（开启过载保护）"}]},{"ID":"20240226100634-o5u9l47","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240226100634-o5u9l47","updated":"20240226100634"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"Timeout: 1000\nMiddlewares:\n  Breaker: false\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240226100634-avr5cd8","Type":"NodeList","ListData":{},"Properties":{"id":"20240226100634-avr5cd8","updated":"20240226100634"},"Children":[{"ID":"20240226100634-h1q1k9l","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-h1q1k9l","updated":"20240226100634"},"Children":[{"ID":"20240226100634-mtdydlj","Type":"NodeParagraph","Properties":{"id":"20240226100634-mtdydlj","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"开启过载保护（默认）"}]}]},{"ID":"20240226100634-f8lfnvc","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-f8lfnvc","updated":"20240226100634"},"Children":[{"ID":"20240226100634-zpqb7ci","Type":"NodeParagraph","Properties":{"id":"20240226100634-zpqb7ci","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"超时 1s"}]}]},{"ID":"20240226100634-291cq8l","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-291cq8l","updated":"20240226100634"},"Children":[{"ID":"20240226100634-pq94m3f","Type":"NodeParagraph","Properties":{"id":"20240226100634-pq94m3f","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"loops 2 hey -c 200 -z 60m \u0026quot;http://localhost:8888/ping\u0026quot;"},{"Type":"NodeText","Data":"​"}]}]}]},{"ID":"20240226100634-sw016y8","Type":"NodeParagraph","Properties":{"id":"20240226100634-sw016y8","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvUF0A45Dae874sADrribPDxq8mQyurt6NErnPT1XAT8l2tvWs8YeuGRA/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226100634-dmva4qa","Type":"NodeList","ListData":{},"Properties":{"id":"20240226100634-dmva4qa","updated":"20240226100634"},"Children":[{"ID":"20240226100634-3bh8dty","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-3bh8dty","updated":"20240226100634"},"Children":[{"ID":"20240226100634-3vqck1c","Type":"NodeParagraph","Properties":{"id":"20240226100634-3vqck1c","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"总 qps 大概在 10000 左右，流量大约是系统容量的 20 倍"}]}]},{"ID":"20240226100634-sd0nwse","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-sd0nwse","updated":"20240226100634"},"Children":[{"ID":"20240226100634-fgthsnh","Type":"NodeParagraph","Properties":{"id":"20240226100634-fgthsnh","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"拒绝了约 95% 的过载请求"}]}]}]},{"ID":"20240226100634-l83opaa","Type":"NodeParagraph","Properties":{"id":"20240226100634-l83opaa","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7Iv341gDmsn11HXH4s9vGR7RczAEeWkTZNjCqqicPEj3eSF0qibG0tFwvIA/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226100634-9b3qg1a","Type":"NodeList","ListData":{},"Properties":{"id":"20240226100634-9b3qg1a","updated":"20240226100634"},"Children":[{"ID":"20240226100634-1qsuyq3","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-1qsuyq3","updated":"20240226100634"},"Children":[{"ID":"20240226100634-y3aib01","Type":"NodeParagraph","Properties":{"id":"20240226100634-y3aib01","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"成功处理请求在 360-400 qps，大概损失了 10% 的 qps，被拒绝的近 1000qps 请求也需要消耗少量系统资源（从接受请求到被拒绝）"}]}]}]},{"ID":"20240226100634-5rdvs7w","Type":"NodeParagraph","Properties":{"id":"20240226100634-5rdvs7w","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7Ivl0wdXPOZoyJPuyS9OPXWWowd7lh1OTpPINKVysbjeHicsDITWibeibialw/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226100634-gqdn3tc","Type":"NodeList","ListData":{},"Properties":{"id":"20240226100634-gqdn3tc","updated":"20240226100634"},"Children":[{"ID":"20240226100634-iz0n0gb","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-iz0n0gb","updated":"20240226100634"},"Children":[{"ID":"20240226100634-ztuii6i","Type":"NodeParagraph","Properties":{"id":"20240226100634-ztuii6i","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"处理时延 p99 不到 700ms"}]}]}]},{"ID":"20240226100634-g43qbhq","Type":"NodeParagraph","Properties":{"id":"20240226100634-g43qbhq","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvuGwGZzSwHuticIjnOwlfZJ4211R59V1arcvic4ia8yPyFYicTeXfFM8k4g/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226100634-aqgaw4v","Type":"NodeList","ListData":{},"Properties":{"id":"20240226100634-aqgaw4v","updated":"20240226100634"},"Children":[{"ID":"20240226100634-uipkqsf","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-uipkqsf","updated":"20240226100634"},"Children":[{"ID":"20240226100634-gzpm77x","Type":"NodeParagraph","Properties":{"id":"20240226100634-gzpm77x","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"处理时延 p90 不到 25ms"}]}]}]},{"ID":"20240226100634-u38wqxm","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226100634-u38wqxm","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"2.3 压测结论："}]},{"ID":"20240226100634-tbl8x1m","Type":"NodeList","ListData":{},"Properties":{"id":"20240226100634-tbl8x1m","updated":"20240226100634"},"Children":[{"ID":"20240226100634-vzecg1l","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-vzecg1l","updated":"20240226100634"},"Children":[{"ID":"20240226100634-75iffcn","Type":"NodeParagraph","Properties":{"id":"20240226100634-75iffcn","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"流量未知的情况下，保障系统不卡死（无过载保护情况下，CPU 满载一般表现为大量请求超时），且保证了系统容量的 400 qps 没有大幅下降"}]}]},{"ID":"20240226100634-s0ilpox","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226100634-s0ilpox","updated":"20240226100634"},"Children":[{"ID":"20240226100634-6p34k1d","Type":"NodeParagraph","Properties":{"id":"20240226100634-6p34k1d","updated":"20240226100634"},"Children":[{"Type":"NodeText","Data":"自动拒绝了过量的请求，避免过量请求浪费系统资源（即使处理，系统最后返回给用户的也是不可用错误、超时错误等）"}]}]}]},{"ID":"20240226100708-5rxvls4","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240226100708-5rxvls4","updated":"20240226100748"},"Children":[{"Type":"NodeText","Data":"3. 自适应过载保护原理"}]},{"ID":"20240226100748-fzbkp9v","Type":"NodeParagraph","Properties":{"id":"20240226100748-fzbkp9v","updated":"20240226100751"},"Children":[{"Type":"NodeText","Data":"先上一张总的设计图，从整体上说明了自适应过载保护的设计思路，也可以看完下面原理解析再回头来看这张图。"}]},{"ID":"20240226101411-6eo8050","Type":"NodeParagraph","Properties":{"id":"20240226101411-6eo8050","updated":"20240226101411"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"d3ccf2ae28d2cb8ed78d265f8212c047"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/d3ccf2ae28d2cb8ed78d265f8212c047-20240226101411-qxfm6wa.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226102835-ee6q42w","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226102835-ee6q42w","updated":"20240226102844"},"Children":[{"Type":"NodeText","Data":"3.1 CPU使用率"}]},{"ID":"20240226103105-s5ongc1","Type":"NodeParagraph","Properties":{"id":"20240226103105-s5ongc1","updated":"20240226103105"},"Children":[{"Type":"NodeText","Data":"CPU 使用率计算是第一个难点，很难算准，依赖于系统繁忙程度，是否能够及时调度到读取 CPU 使用率相关文件的执行。"}]},{"ID":"20240226103105-0zmy23i","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240226103105-0zmy23i","updated":"20240226103105"},"Children":[{"Type":"NodeText","Data":"3.1.1 CPU 检测场景"}]},{"ID":"20240226103105-h003df0","Type":"NodeParagraph","Properties":{"id":"20240226103105-h003df0","updated":"20240226103105"},"Children":[{"Type":"NodeText","Data":"过载保护的一个触发条件就是当系统的 CPU 高于一个阈值时，go-zero 会自动触发过载保护，那么我们怎么检测 CPU 使用率呢？"}]},{"ID":"20240226103105-l12lqut","Type":"NodeParagraph","Properties":{"id":"20240226103105-l12lqut","updated":"20240226103105"},"Children":[{"Type":"NodeText","Data":"首先，我们要明确需要覆盖的场景，当前无外乎虚机和容器两大类了。而容器里又分为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"cgroup v1"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"cgroup v2"},{"Type":"NodeText","Data":"​，所以总的有三类需要处理："}]},{"ID":"20240226103105-n10g0ay","Type":"NodeList","ListData":{},"Properties":{"id":"20240226103105-n10g0ay","updated":"20240226103105"},"Children":[{"ID":"20240226103105-m4q33c7","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226103105-m4q33c7","updated":"20240226103105"},"Children":[{"ID":"20240226103105-wej23rt","Type":"NodeParagraph","Properties":{"id":"20240226103105-wej23rt","updated":"20240226103105"},"Children":[{"Type":"NodeText","Data":"虚机（不同云厂商有不同的叫法，比如 ECS, EC2 等）"}]}]},{"ID":"20240226103105-69xp2gc","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226103105-69xp2gc","updated":"20240226103105"},"Children":[{"ID":"20240226103105-9f6nawa","Type":"NodeParagraph","Properties":{"id":"20240226103105-9f6nawa","updated":"20240226103105"},"Children":[{"Type":"NodeText","Data":"容器 cgroup v1"}]}]},{"ID":"20240226103105-hmdflsr","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226103105-hmdflsr","updated":"20240226103105"},"Children":[{"ID":"20240226103105-y8zxgoa","Type":"NodeParagraph","Properties":{"id":"20240226103105-y8zxgoa","updated":"20240226103105"},"Children":[{"Type":"NodeText","Data":"容器 cgroup v2"}]}]}]},{"ID":"20240226103105-y3mflzi","Type":"NodeParagraph","Properties":{"id":"20240226103105-y3mflzi","updated":"20240226103105"},"Children":[{"Type":"NodeText","Data":"这里有个特别需要关注的点是：容器是否设置了 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"cpu limit"},{"Type":"NodeText","Data":"​，如果没设，就只能用可以调度的 cpu 个数来计算，比如 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"cgroup v2"},{"Type":"NodeText","Data":"​ 里可以读取 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/sys/fs/cgroup/cpuset.cpus.effective"},{"Type":"NodeText","Data":"​ 文件。"}]},{"ID":"20240226103105-eos5aqr","Type":"NodeParagraph","Properties":{"id":"20240226103105-eos5aqr","updated":"20240226103105"},"Children":[{"Type":"NodeText","Data":"这里详细读取 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"cgroup"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/proc"},{"Type":"NodeText","Data":"​ 下文件的方法我就不细述了，详见 go-zero 代码。"}]},{"ID":"20240226104102-2l30uz5","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240226104102-2l30uz5","updated":"20240226104129"},"Children":[{"Type":"NodeText","Data":"3.1.2 CPU 使用率计算方法 以 cgroup v2 为例"}]},{"ID":"20240226104812-z56v7mn","Type":"NodeHeading","HeadingLevel":5,"Properties":{"id":"20240226104812-z56v7mn","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"3.1.2.1 实时 CPU 使用率的计算"}]},{"ID":"20240226104812-nhvcnsd","Type":"NodeList","ListData":{},"Properties":{"id":"20240226104812-nhvcnsd","updated":"20240226104813"},"Children":[{"ID":"20240226104812-v1ndjvn","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-v1ndjvn","updated":"20240226104812"},"Children":[{"ID":"20240226104812-xhso6tx","Type":"NodeParagraph","Properties":{"id":"20240226104812-xhso6tx","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"方法一"}]},{"ID":"20240226104812-97thoy8","Type":"NodeParagraph","Properties":{"id":"20240226104812-97thoy8","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvQC4bgfyMacvLZkCIL6kjTtDgmknpobiaXotPdQjuMqQwIwtN1j1Qs7Q/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226104812-1fjb0qm","Type":"NodeList","ListData":{},"Properties":{"id":"20240226104812-1fjb0qm","updated":"20240226104812"},"Children":[{"ID":"20240226104812-zejewuo","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-zejewuo","updated":"20240226104812"},"Children":[{"ID":"20240226104812-fdlqvfh","Type":"NodeParagraph","Properties":{"id":"20240226104812-fdlqvfh","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/sys/fs/cgroup/cpu.max"},{"Type":"NodeText","Data":"​ 里面第一个值"}]}]},{"ID":"20240226104812-vm9986w","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-vm9986w","updated":"20240226104812"},"Children":[{"ID":"20240226104812-fjiars0","Type":"NodeParagraph","Properties":{"id":"20240226104812-fjiars0","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"可能是 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"max"},{"Type":"NodeText","Data":"​，表示无限制，那此时总的限额就是 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/sys/fs/cgroup/cpuset.cpus.effective"},{"Type":"NodeText","Data":"​里的 CPU 个数乘以 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/sys/fs/cgroup/cpu.max"},{"Type":"NodeText","Data":"​ 里面第二个值 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"period"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240226104812-b8nleba","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-b8nleba","updated":"20240226104812"},"Children":[{"ID":"20240226104812-10nv72f","Type":"NodeParagraph","Properties":{"id":"20240226104812-10nv72f","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"还有一种情况是"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/sys/fs/cgroup/cpuset.cpus.effective"},{"Type":"NodeText","Data":"​里的 CPU 个数 \u003c "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/sys/fs/cgroup/cpu.max"},{"Type":"NodeText","Data":"​ 里的第一个值 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"$max"},{"Type":"NodeText","Data":"​ / 第二个值 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"$period"},{"Type":"NodeText","Data":"​，此时需要用 CPU 个数乘以 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"$period"},{"Type":"NodeText","Data":"​ 作为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"quota"},{"Type":"NodeText","Data":"​ 值"}]}]},{"ID":"20240226104812-syacyn8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-syacyn8","updated":"20240226104812"},"Children":[{"ID":"20240226104812-4zxomwu","Type":"NodeParagraph","Properties":{"id":"20240226104812-4zxomwu","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/proc/stat"},{"Type":"NodeText","Data":"​ 文件里第一行的内容，计算方法参考 go-zero 实现"}]}]},{"ID":"20240226104812-put2l33","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-put2l33","updated":"20240226104812"},"Children":[{"ID":"20240226104812-bfs4tz6","Type":"NodeParagraph","Properties":{"id":"20240226104812-bfs4tz6","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/sys/fs/cgroup/cpu.stat"},{"Type":"NodeText","Data":"​ 里第一行 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"usage_usec"},{"Type":"NodeText","Data":"​ 后面的值用来计算两次的差值"}]}]},{"ID":"20240226104812-2hrsqkk","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-2hrsqkk","updated":"20240226104812"},"Children":[{"ID":"20240226104812-876ijcw","Type":"NodeParagraph","Properties":{"id":"20240226104812-876ijcw","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"cpu 使用率"},{"Type":"NodeText","Data":"​ 单位为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"millicpu"},{"Type":"NodeText","Data":"​ （也称之为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"millicores"},{"Type":"NodeText","Data":"​）"}]}]},{"ID":"20240226104812-yuvdqhe","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-yuvdqhe","updated":"20240226104812"},"Children":[{"ID":"20240226104812-x4ovqz3","Type":"NodeParagraph","Properties":{"id":"20240226104812-x4ovqz3","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"∆usage"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240226104812-0dpejpr","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-0dpejpr","updated":"20240226104812"},"Children":[{"ID":"20240226104812-qisgp4p","Type":"NodeParagraph","Properties":{"id":"20240226104812-qisgp4p","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"∆system"}]}]},{"ID":"20240226104812-lqvtg8p","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-lqvtg8p","updated":"20240226104812"},"Children":[{"ID":"20240226104812-rptqrq1","Type":"NodeParagraph","Properties":{"id":"20240226104812-rptqrq1","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"quota"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240226104812-9wx186a","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-9wx186a","updated":"20240226104812"},"Children":[{"ID":"20240226104812-gyjk0rn","Type":"NodeParagraph","Properties":{"id":"20240226104812-gyjk0rn","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"这里为啥要乘以 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"cores"},{"Type":"NodeText","Data":"​ 并除以 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"quota"},{"Type":"NodeText","Data":"​ 呢？举个例子，16 核（cores）的机器上，容器的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"cpu limit"},{"Type":"NodeText","Data":"​ 是 4 核（quota），但是从 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/proc/stat"},{"Type":"NodeText","Data":"​ 里看到的是 16 核的 cpu 总量。如果不做这一步的操作，那么容器内 cpu 使用率最多只会算到 25%，其实对于容器来说，已经是 cpu 使用率 100% 了，这不操作就是做了一个缩放。"}]}]},{"ID":"20240226104812-tnl4ztc","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-tnl4ztc","updated":"20240226104812"},"Children":[{"ID":"20240226104812-m66xodm","Type":"NodeParagraph","Properties":{"id":"20240226104812-m66xodm","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"再补充一点帮助理解：对于 go-zero 的 250ms 的检测周期来说，如果系统时钟和调度都是严格控制在 250ms 的话，那么对于 16 核的机器来说，∆system（系统 cpu 总量）就应该是 4 秒（250ms * 16）。但是受系统调度的影响，250ms 的周期不会完全准，并且读取两个文件本身不是一个原子操作，go-zero 里针对这种情况做了容差处理。"}]}]}]}]},{"ID":"20240226104812-uol08uw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-uol08uw","updated":"20240226104812"},"Children":[{"ID":"20240226104812-2h01bmg","Type":"NodeParagraph","Properties":{"id":"20240226104812-2h01bmg","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"方法二"}]},{"ID":"20240226104812-sd3w4ys","Type":"NodeParagraph","Properties":{"id":"20240226104812-sd3w4ys","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvvHfMXwH9HepLTJicC00M1koV9t8UyxYYy0iasE9wMFovGRgMjxAlE3dw/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226104812-o5ktmif","Type":"NodeList","ListData":{},"Properties":{"id":"20240226104812-o5ktmif","updated":"20240226104812"},"Children":[{"ID":"20240226104812-sows0tv","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-sows0tv","updated":"20240226104812"},"Children":[{"ID":"20240226104812-9q98zrf","Type":"NodeParagraph","Properties":{"id":"20240226104812-9q98zrf","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/sys/fs/cgroup/cpu.stat"},{"Type":"NodeText","Data":"​ 里第四行 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"nr_periods"},{"Type":"NodeText","Data":"​ 后面的值用来计算两次的差值"}]}]},{"ID":"20240226104812-ra6036e","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-ra6036e","updated":"20240226104812"},"Children":[{"ID":"20240226104812-axgsstk","Type":"NodeParagraph","Properties":{"id":"20240226104812-axgsstk","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"∆periods"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240226104812-1tqivgd","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226104812-1tqivgd","updated":"20240226104812"},"Children":[{"ID":"20240226104812-dujo27p","Type":"NodeParagraph","Properties":{"id":"20240226104812-dujo27p","updated":"20240226104812"},"Children":[{"Type":"NodeText","Data":"其它内容解释见方法一"}]}]}]}]}]},{"ID":"20240226104812-ep5145e","Type":"NodeParagraph","Properties":{"id":"20240226104812-ep5145e","updated":"20240226104813"},"Children":[{"Type":"NodeText","Data":"go-zero使用了方法一，因为我考虑到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"periods"},{"Type":"NodeText","Data":"​ 更新间隔是 100ms，而 go-zero 检测窗口期是 250ms，这样两次检测的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"∆periods"},{"Type":"NodeText","Data":"​ 就有时是 2 有时是 3，对计算结果造成非常可见的影响。"}]},{"ID":"20240226105714-wrr922m","Type":"NodeHeading","HeadingLevel":5,"Properties":{"id":"20240226105714-wrr922m","updated":"20240226105714"},"Children":[{"Type":"NodeText","Data":"3.1.2.2 防止 CPU 使用率毛刺"}]},{"ID":"20240226105714-5hbq7fg","Type":"NodeParagraph","Properties":{"id":"20240226105714-5hbq7fg","updated":"20240226105715"},"Children":[{"Type":"NodeText","Data":"go-zero 里使用了滑动平均算法（Moving Average）来避免 CPU 的毛刺。比如我们看股票价格曲线时，都会有 MA 线，如图，MA 线在价格波动较大时能够反应较长时间段内的价格变化趋势。对于我们的场景来说，刚好可以反应 CPU 变化趋势的同时也消除了 CPU 毛刺，避免一次小的抖动触发了过载保护。简单的理解滑动平均就是取之前的 N 个值的平均值。"}]},{"ID":"20240226105714-crnz59o","Type":"NodeParagraph","Properties":{"id":"20240226105714-crnz59o","updated":"20240226105715"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvJ3MaRg0e74C4RibZQl0Fu75ibCGIspCuxiakkUF2VJtCBWA15zze2NjzQ/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226105714-mj10wdh","Type":"NodeParagraph","Properties":{"id":"20240226105714-mj10wdh","updated":"20240226105715"},"Children":[{"Type":"NodeText","Data":"go-zero 里对于滑动平均的超参 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"beta"},{"Type":"NodeText","Data":"​ 取值 0.95，相当于最后 20 个值（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"1 / (1-0.95) = 20"},{"Type":"NodeText","Data":"​）的均值，所以 CPU 达到 90% 后约 5 秒会触发过载保护。"}]},{"ID":"20240226105727-dtwz2lb","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226105727-dtwz2lb","updated":"20240226105736"},"Children":[{"Type":"NodeText","Data":"3.2 系统容量计算"}]},{"ID":"20240226110334-h5jkc02","Type":"NodeParagraph","Properties":{"id":"20240226110334-h5jkc02","updated":"20240226110334"},"Children":[{"Type":"NodeText","Data":"容量计算是第二个难点，怎么动态评估系统当前容量是算法的关键点之一。计算公式如下："}]},{"ID":"20240226110334-ltd2bdj","Type":"NodeParagraph","Properties":{"id":"20240226110334-ltd2bdj","updated":"20240226110334"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvLE6u19piacbx0TffhRYRgnhibicz72cQQkicsBMyibvo2ACYR1Gic7btNIFg/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110334-dd6l6kl","Type":"NodeParagraph","Properties":{"id":"20240226110334-dd6l6kl","updated":"20240226110334"},"Children":[{"Type":"NodeText","Data":"先解释一下各个参数的含义："}]},{"ID":"20240226110334-6nzfhdh","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110334-6nzfhdh","updated":"20240226110334"},"Children":[{"ID":"20240226110334-qhpk0vo","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110334-qhpk0vo","updated":"20240226110334"},"Children":[{"ID":"20240226110334-4m8wz8o","Type":"NodeParagraph","Properties":{"id":"20240226110334-4m8wz8o","updated":"20240226110334"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"maxPass"},{"Type":"NodeText","Data":"​ 是当前记录的所有窗口里面最大的成功处理的请求数，go-zero 是 100ms 一个窗口，记录了 50 个窗口，这里就是算过去 50 个窗口里最多成功处理请求的一个窗口里的请求数"}]}]},{"ID":"20240226110334-e9vrhl8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110334-e9vrhl8","updated":"20240226110334"},"Children":[{"ID":"20240226110334-8hdq5ih","Type":"NodeParagraph","Properties":{"id":"20240226110334-8hdq5ih","updated":"20240226110334"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"minRt"},{"Type":"NodeText","Data":"​ 是指以窗口为单位的最小平均请求耗时，单位毫秒，比如某个窗口里的 RT 是 50ms，且是所有窗口里最小的，那么这个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"minRt"},{"Type":"NodeText","Data":"​ 就是 50"}]}]},{"ID":"20240226110334-fujxiv7","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110334-fujxiv7","updated":"20240226110334"},"Children":[{"ID":"20240226110334-55clmsn","Type":"NodeParagraph","Properties":{"id":"20240226110334-55clmsn","updated":"20240226110334"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"windows"},{"Type":"NodeText","Data":"​ 是指每秒有多少个窗口"}]}]}]},{"ID":"20240226110334-lqe7wu9","Type":"NodeParagraph","Properties":{"id":"20240226110334-lqe7wu9","updated":"20240226110334"},"Children":[{"Type":"NodeText","Data":"我来一步一步推导一下这个公式怎么来的。"}]},{"ID":"20240226110334-xa8c0bv","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110334-xa8c0bv","updated":"20240226110334"},"Children":[{"ID":"20240226110334-fcbw31e","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110334-fcbw31e","updated":"20240226110334"},"Children":[{"ID":"20240226110334-t4jk14g","Type":"NodeParagraph","Properties":{"id":"20240226110334-t4jk14g","updated":"20240226110334"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"maxPass * windows"},{"Type":"NodeText","Data":"​ 就是每秒系统能成功处理的请求数"}]}]},{"ID":"20240226110334-uybf0ox","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110334-uybf0ox","updated":"20240226110334"},"Children":[{"ID":"20240226110334-g0pgksw","Type":"NodeParagraph","Properties":{"id":"20240226110334-g0pgksw","updated":"20240226110334"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"minRt / 1000"},{"Type":"NodeText","Data":"​ 是个缩放系数，用来把每秒能处理的请求数缩放到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"minRt"},{"Type":"NodeText","Data":"​ 时间长度上系统能处理的请求数"}]}]},{"ID":"20240226110334-ey7cqht","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110334-ey7cqht","updated":"20240226110334"},"Children":[{"ID":"20240226110334-1v4klth","Type":"NodeParagraph","Properties":{"id":"20240226110334-1v4klth","updated":"20240226110334"},"Children":[{"Type":"NodeText","Data":"一个请求的处理时长保守估算为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"minRt"},{"Type":"NodeText","Data":"​，所以 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"maxPass * windows * minRt / 1000"},{"Type":"NodeText","Data":"​ 代表着系统能处理的保守并发数。这里相对比较难理解，可以想想一个请求的时间跨度为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"minRt"},{"Type":"NodeText","Data":"​，那么把每秒的请求数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"maxPass * windows"},{"Type":"NodeText","Data":"​ 平铺到 1s 的时间线上，是不是任意点的并发请求数可以估算为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"QPS * minRt / 1000"},{"Type":"NodeText","Data":"​。从概率的角度可以理解为均匀分布的区间积分，即 1 秒内均匀分布的 n 个请求，在 minRt 区间上的请求数量。"}]}]}]},{"ID":"20240226110334-m1tab8i","Type":"NodeParagraph","Properties":{"id":"20240226110334-m1tab8i","updated":"20240226110334"},"Children":[{"Type":"NodeText","Data":"如果当前并发请求数大于这里算出的系统容量，那么就会拒绝请求，所以这里估算系统容量是关键所在，也是整个算法最难理解的部分。"}]},{"ID":"20240226110334-ghvqkuv","Type":"NodeParagraph","Properties":{"id":"20240226110334-ghvqkuv","updated":"20240226110334"},"Children":[{"Type":"NodeText","Data":"附一个图来说明怎么计算任一时间点的并发请求数的，假设 QPS 是 1000，每个请求的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"minRt"},{"Type":"NodeText","Data":"​ 是 10ms。"}]},{"ID":"20240226110334-txb6fgv","Type":"NodeParagraph","Properties":{"id":"20240226110334-txb6fgv","updated":"20240226110334"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvF8lRBbSPA1kGseVzX9JyGUtlicFlQjFPicja5R7NIiaj2thkEryhXIAlg/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-t71vmc0","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226110425-t71vmc0","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"3.3 CPU 负载反馈因子"}]},{"ID":"20240226110425-l0iaser","Type":"NodeParagraph","Properties":{"id":"20240226110425-l0iaser","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"当 CPU 负载超过了设置的阈值时，我们期望 CPU 越高，对请求的拒绝比例越高，否则 CPU 依然有可能越来越靠近 100%。"}]},{"ID":"20240226110425-eaicjq3","Type":"NodeParagraph","Properties":{"id":"20240226110425-eaicjq3","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"反馈因子计算公式如下："}]},{"ID":"20240226110425-j7sa7pf","Type":"NodeParagraph","Properties":{"id":"20240226110425-j7sa7pf","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvICquPTQeup6THFmAzEAiaqQic7Cozic3Q0ibqMSfvTrRxFQrlUmBuK849w/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-wznin5x","Type":"NodeParagraph","Properties":{"id":"20240226110425-wznin5x","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"反馈因子的效果类似于神经网络中的 ReLU 激活函数。其中 0.1（兜底的经验值）是用来保证不管负载多高，至少放过估算出来的系统容量的 10% 的请求，否则整个服务就完全不可用了。CPU 负载反馈因子随着 CPU 负载的变化如下图："}]},{"ID":"20240226110425-mcy29gt","Type":"NodeParagraph","Properties":{"id":"20240226110425-mcy29gt","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvXicu1rmcAiaa3Kes0Fvx08zREkbfWiaOeLzuvlyU6YxZc45zJUNn5pDBg/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-kryju7w","Type":"NodeParagraph","Properties":{"id":"20240226110425-kryju7w","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"对比有无 CPU 反馈因子的实际表现："}]},{"ID":"20240226110425-41hgnzt","Type":"NodeParagraph","Properties":{"id":"20240226110425-41hgnzt","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvLibB2RaicemyTXibKFCy9E9ZQRcCz99wm30UO3knl1YRTM9A7jDKPXr2w/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-o426m8w","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110425-o426m8w","updated":"20240226110425"},"Children":[{"ID":"20240226110425-d27krpg","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-d27krpg","updated":"20240226110425"},"Children":[{"ID":"20240226110425-crhp1g5","Type":"NodeParagraph","Properties":{"id":"20240226110425-crhp1g5","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"加了反馈因子后能接受更多请求，从不到 3000qps 上升到了 5000qps 左右，上图是拒绝的请求"}]}]}]},{"ID":"20240226110425-oxqpmcf","Type":"NodeParagraph","Properties":{"id":"20240226110425-oxqpmcf","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvMgk1X9kTF6QRC2CvJFiaP9CXEqqr9zgmOpVhAfjDibvWhAosnM0noGZg/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-6gvmw07","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110425-6gvmw07","updated":"20240226110425"},"Children":[{"ID":"20240226110425-disxwnj","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-disxwnj","updated":"20240226110425"},"Children":[{"ID":"20240226110425-y01yzf0","Type":"NodeParagraph","Properties":{"id":"20240226110425-y01yzf0","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"成功处理的请求数有略微下降，因为进来的请求变多了，拒绝请求消耗了少量资源"}]}]}]},{"ID":"20240226110425-n2c3irw","Type":"NodeParagraph","Properties":{"id":"20240226110425-n2c3irw","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvQwK0Ghb6h9HkyfYrj2p10gdRLItTpMiaubCd1zwha4BaoDErVeQGqibA/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-1au5o7g","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110425-1au5o7g","updated":"20240226110425"},"Children":[{"ID":"20240226110425-lrw4e2n","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-lrw4e2n","updated":"20240226110425"},"Children":[{"ID":"20240226110425-ddjns7r","Type":"NodeParagraph","Properties":{"id":"20240226110425-ddjns7r","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"加了反馈因子 P99 时延从 900ms 左右，降低到 700ms 左右"}]}]}]},{"ID":"20240226110425-owkxbe3","Type":"NodeParagraph","Properties":{"id":"20240226110425-owkxbe3","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvSXt0jFbEDuIvAyKiaNJ9G9XghyS5vuZ0ERxzbmBNjPW60p1Jc93YrjA/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-yye6ymc","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110425-yye6ymc","updated":"20240226110425"},"Children":[{"ID":"20240226110425-3kq85jd","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-3kq85jd","updated":"20240226110425"},"Children":[{"ID":"20240226110425-fswi6hk","Type":"NodeParagraph","Properties":{"id":"20240226110425-fswi6hk","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"加了反馈因子 P90 从 250ms 降到了 50ms"}]}]}]},{"ID":"20240226110425-6wauuzz","Type":"NodeParagraph","Properties":{"id":"20240226110425-6wauuzz","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"由此可见，CPU 负载反馈因子的作用还是很明显的。"}]},{"ID":"20240226110425-rbhohoz","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226110425-rbhohoz","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"3.4 过载保护计算公式"}]},{"ID":"20240226110425-du6imrj","Type":"NodeParagraph","Properties":{"id":"20240226110425-du6imrj","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"把上面所有算法细节和逻辑归总到计算公式里，如下图："}]},{"ID":"20240226110425-cv6irjz","Type":"NodeParagraph","Properties":{"id":"20240226110425-cv6irjz","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvAfhxeSX0uxRDEBqwDMPM3zkyC025TreRc9OX6NFGQ60Coiazsciauo7A/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-ap5duvl","Type":"NodeParagraph","Properties":{"id":"20240226110425-ap5duvl","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"这就是计算当前系统允许的最大并发请求数，超过这个值就会拒绝请求。"}]},{"ID":"20240226110425-qp8qsyx","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226110425-qp8qsyx","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"3.5 如何判断是否拒绝请求"}]},{"ID":"20240226110425-ki2k0h1","Type":"NodeParagraph","Properties":{"id":"20240226110425-ki2k0h1","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"对于一个请求是否需要拒绝。判断逻辑如下："}]},{"ID":"20240226110425-eq4bgwo","Type":"NodeParagraph","Properties":{"id":"20240226110425-eq4bgwo","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvC4MLJXgRAqJm6W1kO3QnwTB9lsYziaD7AhZdONCpsicnMtoSicdronCFQ/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-udrqsw8","Type":"NodeParagraph","Properties":{"id":"20240226110425-udrqsw8","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"有以下情况之一，计算是否超过系统容量，如超过，则拒绝该请求"}]},{"ID":"20240226110425-p1hby31","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110425-p1hby31","updated":"20240226110425"},"Children":[{"ID":"20240226110425-5kc5z2c","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-5kc5z2c","updated":"20240226110425"},"Children":[{"ID":"20240226110425-d11xufm","Type":"NodeParagraph","Properties":{"id":"20240226110425-d11xufm","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"首先判断 CPU 是否超标（默认 90%）"}]}]},{"ID":"20240226110425-7xryar8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-7xryar8","updated":"20240226110425"},"Children":[{"ID":"20240226110425-qmb5prn","Type":"NodeParagraph","Properties":{"id":"20240226110425-qmb5prn","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"再判断是否在冷却期（1s）"}]}]},{"ID":"20240226110425-8okzvfa","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-8okzvfa","updated":"20240226110425"},"Children":[{"ID":"20240226110425-19zmz12","Type":"NodeParagraph","Properties":{"id":"20240226110425-19zmz12","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"两者有其一，则计算是否拒绝"}]},{"ID":"20240226110425-4kndv7n","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110425-4kndv7n","updated":"20240226110425"},"Children":[{"ID":"20240226110425-cf44v9l","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-cf44v9l","updated":"20240226110425"},"Children":[{"ID":"20240226110425-36icznj","Type":"NodeParagraph","Properties":{"id":"20240226110425-36icznj","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"计算当前系统容量  "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"maxPass * windows * minRt / 1000"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240226110425-kn16cu2","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-kn16cu2","updated":"20240226110425"},"Children":[{"ID":"20240226110425-oacq32y","Type":"NodeParagraph","Properties":{"id":"20240226110425-oacq32y","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"并发请求数是否大于当前系统容量，如是则拒绝请求"}]}]}]}]}]},{"ID":"20240226110425-nx0zyz0","Type":"NodeParagraph","Properties":{"id":"20240226110425-nx0zyz0","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"至此，原理基本讲完了，还有一些实现细节和技巧你可以翻看 go-zero 源码。"}]},{"ID":"20240226110425-mkogd8w","Type":"NodeParagraph","Properties":{"id":"20240226110425-mkogd8w","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"我们再来看一下系统容量 10 倍流量的场景下整体表现："}]},{"ID":"20240226110425-b8lfoir","Type":"NodeParagraph","Properties":{"id":"20240226110425-b8lfoir","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvfscaR2X5ewiaTS8HlHV8iaOlEJMkgUbaG8m9Wmgn74VTYLcNtYe3QFaQ/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-gch7abi","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110425-gch7abi","updated":"20240226110425"},"Children":[{"ID":"20240226110425-4h0i9v3","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-4h0i9v3","updated":"20240226110425"},"Children":[{"ID":"20240226110425-m6uns2s","Type":"NodeParagraph","Properties":{"id":"20240226110425-m6uns2s","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"成功处理的 qps 在 400 左右"}]}]}]},{"ID":"20240226110425-wkjujh4","Type":"NodeParagraph","Properties":{"id":"20240226110425-wkjujh4","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7Iv2Hbm752BAiaCw2jaXeW4vXicXQ96wCCqKqr9KYzkrnyzECAeh6LCQTrQ/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-m8gslp4","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110425-m8gslp4","updated":"20240226110425"},"Children":[{"ID":"20240226110425-mrs2obv","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-mrs2obv","updated":"20240226110425"},"Children":[{"ID":"20240226110425-9o347gu","Type":"NodeParagraph","Properties":{"id":"20240226110425-9o347gu","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"拒绝了大概 90% 的请求"}]}]}]},{"ID":"20240226110425-b5441z6","Type":"NodeParagraph","Properties":{"id":"20240226110425-b5441z6","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7Iv0icG0qwumQISiaKeJ6GuEYOf5JAellEz25mdBRXCVFiauPacr8nPwUOBA/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-3k46h7f","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110425-3k46h7f","updated":"20240226110425"},"Children":[{"ID":"20240226110425-kq7hh2s","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-kq7hh2s","updated":"20240226110425"},"Children":[{"ID":"20240226110425-qft7qjb","Type":"NodeParagraph","Properties":{"id":"20240226110425-qft7qjb","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"P99 时延控制在 20-24ms 之间"}]}]}]},{"ID":"20240226110425-p6hdguo","Type":"NodeParagraph","Properties":{"id":"20240226110425-p6hdguo","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvNWqQM303rszwHd0AfABBFjeb2chVme3QCuabLUcHOicFRJibQpwAOB3Q/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-65oe9pf","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110425-65oe9pf","updated":"20240226110425"},"Children":[{"ID":"20240226110425-um29exd","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-um29exd","updated":"20240226110425"},"Children":[{"ID":"20240226110425-phduh71","Type":"NodeParagraph","Properties":{"id":"20240226110425-phduh71","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"P90 时延在 5ms 以下"}]}]}]},{"ID":"20240226110425-am6fbsy","Type":"NodeParagraph","Properties":{"id":"20240226110425-am6fbsy","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"图片"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://mmbiz.qpic.cn/sz_mmbiz_png/UyIojWicPOg2icC9ZCJiaibw1BY4dc7uh7IvQeIqMM1ZGJXOftoK8EU0NCkLpn82Pkiaib34iaPRibNL5lIFNHo2GJt0Ig/640?wx_fmt=png\u0026from=appmsg\u0026wxfrom=5\u0026wx_lazy=1\u0026wx_co=1"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240226110425-2fjtiln","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110425-2fjtiln","updated":"20240226110425"},"Children":[{"ID":"20240226110425-l9nfxy2","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110425-l9nfxy2","updated":"20240226110425"},"Children":[{"ID":"20240226110425-cxr4qz8","Type":"NodeParagraph","Properties":{"id":"20240226110425-cxr4qz8","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"CPU 峰值控制在 95% 以下"}]}]}]},{"ID":"20240226110425-ogfmozo","Type":"NodeParagraph","Properties":{"id":"20240226110425-ogfmozo","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"如文档开始的压测数据，如果不是过载保护，在不到 600 qps 的情况下，P99 甚至 P90 都已经到了 1s 的超时阈值了，服务基本已经开始不可用了。"}]},{"ID":"20240226110425-2sfi6gi","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240226110425-2sfi6gi","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"3.6 跟 Kubernetes HPA 的协同"}]},{"ID":"20240226110425-hhod39u","Type":"NodeParagraph","Properties":{"id":"20240226110425-hhod39u","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"当我们在使用 Kubernetes 并设置了 HPA 根据 CPU 使用率自动伸缩的时候，Kubernetes 默认会在 4 个连续的 15 秒探测周期探测到 CPU 使用率超标（有 0.9 - 1.1 的容忍幅度）时，启动增加 pod 来应对系统容量不足，但这需要分钟级扩容，且当系统资源不够或者 pod 数达到最大设置时不生效。此时，过载保护可以在 Kubernetes 未来得及扩容或者集群容量不足时保护我们的系统不被打到卡死。"}]},{"ID":"20240226110425-ph227ap","Type":"NodeParagraph","Properties":{"id":"20240226110425-ph227ap","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"但这里有个点需要注意，go-zero 默认设置的过载保护触发的 CPU 阈值是 90%，Kubernetes HPA 自动扩容默认 CPU 阈值是 80%，当你在设置这两个参数的时候，不要让 HPA 的 CPU 阈值大于 go-zero 的过载保护 CPU 阈值，否则可能会抑制 HPA 的生效。"}]},{"ID":"20240226110425-pyttwx1","Type":"NodeParagraph","Properties":{"id":"20240226110425-pyttwx1","updated":"20240226110425"},"Children":[{"Type":"NodeText","Data":"当然整个系统并不是链路上所有服务和中间件都可以自动或及时扩容的，这里就牵出另一个稳定性能力 - "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"自适应熔断"},{"Type":"NodeText","Data":"了。有了自适应过载保护和自适应熔断的双重加持，流量再大（上限是所有 CPU 都用在降载熔断等能力上），服务也不会挂。后续文章我会深度分析自适应熔断的场景压测和实现原理。"}]},{"ID":"20240226110452-8tqfcw4","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240226110452-8tqfcw4","updated":"20240226110507"},"Children":[{"Type":"NodeText","Data":"4. 总结"}]},{"ID":"20240226110516-sq798u1","Type":"NodeParagraph","Properties":{"id":"20240226110516-sq798u1","updated":"20240226110516"},"Children":[{"Type":"NodeText","Data":"自适应过载保护的算法有如下要点："}]},{"ID":"20240226110516-5qmhqum","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110516-5qmhqum","updated":"20240226110516"},"Children":[{"ID":"20240226110516-2jgco67","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110516-2jgco67","updated":"20240226110516"},"Children":[{"ID":"20240226110516-atzen8b","Type":"NodeParagraph","Properties":{"id":"20240226110516-atzen8b","updated":"20240226110516"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"CPU 使用率检测"},{"Type":"NodeText","Data":"。要在各种不同环境尽可能保证检测结果准确。这里要防止检测周期受系统调度影响出现较大偏差，需要消除异常值，且通过滑动平均的方式来避免毛刺对算法的影响。"}]}]},{"ID":"20240226110516-pvj194g","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110516-pvj194g","updated":"20240226110516"},"Children":[{"ID":"20240226110516-k5jr5jk","Type":"NodeParagraph","Properties":{"id":"20240226110516-k5jr5jk","updated":"20240226110516"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"系统容量评估"},{"Type":"NodeText","Data":"。类似于 BBR 算法里检测"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"带宽"},{"Type":"NodeText","Data":"和 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"RTT"},{"Type":"NodeText","Data":"，我们需要探测的是 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"系统能承载的 QPS"},{"Type":"NodeText","Data":" 和 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"minRT"},{"Type":"NodeText","Data":"（最小处理时间），不同于 BBR 的不能同时探测，我们是可以同时探测的，所以我们不需要有复杂的状态机，只需要通过滑动窗口来记录过去一段周期内的请求状况即可。"}]}]},{"ID":"20240226110516-ji98bt0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110516-ji98bt0","updated":"20240226110516"},"Children":[{"ID":"20240226110516-jnbkpom","Type":"NodeParagraph","Properties":{"id":"20240226110516-jnbkpom","updated":"20240226110516"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"CPU 负载反馈因子"},{"Type":"NodeText","Data":"。类似于神经网络中的激活函数，基于 CPU 负载对系统容量做调节。"}]}]},{"ID":"20240226110516-insgrg3","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110516-insgrg3","updated":"20240226110516"},"Children":[{"ID":"20240226110516-k3azc6d","Type":"NodeParagraph","Properties":{"id":"20240226110516-k3azc6d","updated":"20240226110516"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"过载保护冷却时间"},{"Type":"NodeText","Data":"。用于避免过载保护在 CPU 临界值周边来回启停，有利于大流量下的请求抑制效果。"}]}]},{"ID":"20240226110516-heiyb7i","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110516-heiyb7i","updated":"20240226110516"},"Children":[{"ID":"20240226110516-7tqjykg","Type":"NodeParagraph","Properties":{"id":"20240226110516-7tqjykg","updated":"20240226110516"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"跟 HPA 的协同"},{"Type":"NodeText","Data":"。一定要避免 HPA 的 CPU 扩容配置低于过载保护设置的阈值，否则过载保护会抑制 HPA 的生效。但一般不太会发生，HPA 默认值是 80%，过载保护默认值是 90%，不建议把 HPA 的配置往上调。"}]}]}]},{"ID":"20240226110516-rakh1mb","Type":"NodeParagraph","Properties":{"id":"20240226110516-rakh1mb","updated":"20240226110516"},"Children":[{"Type":"NodeText","Data":"go-zero 的三类服务都已经默认集成了自适应过载保护："}]},{"ID":"20240226110516-vfcnpez","Type":"NodeList","ListData":{},"Properties":{"id":"20240226110516-vfcnpez","updated":"20240226110516"},"Children":[{"ID":"20240226110516-7t6krof","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110516-7t6krof","updated":"20240226110516"},"Children":[{"ID":"20240226110516-b5xn111","Type":"NodeParagraph","Properties":{"id":"20240226110516-b5xn111","updated":"20240226110516"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Restful service"}]}]},{"ID":"20240226110516-8z684p8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110516-8z684p8","updated":"20240226110516"},"Children":[{"ID":"20240226110516-l8vn9me","Type":"NodeParagraph","Properties":{"id":"20240226110516-l8vn9me","updated":"20240226110516"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"gRPC service"}]}]},{"ID":"20240226110516-bo39h6p","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240226110516-bo39h6p","updated":"20240226110516"},"Children":[{"ID":"20240226110516-lw9f52s","Type":"NodeParagraph","Properties":{"id":"20240226110516-lw9f52s","updated":"20240226110516"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Gateway service"}]}]}]},{"ID":"20240226110516-3lfnoyg","Type":"NodeParagraph","Properties":{"id":"20240226110516-3lfnoyg","updated":"20240226110516"},"Children":[{"Type":"NodeText","Data":"确保你在使用 go-zero 的时候，无需额外代码和配置，服务默认都是有自适应过载保护的。这也秉承了 go-zero 一贯追求最简原则，不给用户带来额外的心智负担。"}]},{"ID":"20240226110516-dc2db5v","Type":"NodeParagraph","Properties":{"id":"20240226110516-dc2db5v","updated":"20240226110516"},"Children":[{"Type":"NodeText","Data":"这篇文章花了我春节不少时间，既要讲原理，又要写代码给出压测数据，但依然感觉不是那么容易懂，不过好在所有算法细节和知识点都已经集成在 go-zero 源码里了，如果想了解实现细节，可以阅读源码。"}]}]}