{"ID":"20240325092423-fy3uv9m","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f6c1","id":"20240325092423-fy3uv9m","title":"vLLM框架：从顶层概览到深入解析","updated":"20240325095420"},"Children":[{"ID":"20240325092443-2nkzbgm","Type":"NodeParagraph","Properties":{"id":"20240325092443-2nkzbgm"}},{"ID":"20240325092423-wn0t63r","Type":"NodeParagraph","Properties":{"id":"20240325092423-wn0t63r","updated":"20240325092932"},"Children":[{"Type":"NodeText","Data":"vLLM框架是一个基于python+cuda 实现的强大系统，被广泛应用于自然语言处理和机器学习领域。"}]},{"ID":"20240325092935-5b1uybs","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240325092935-5b1uybs","updated":"20240325092953"},"Children":[{"Type":"NodeText","Data":"vLLM框架的顶层概览"}]},{"ID":"20240325092953-2ovwz22","Type":"NodeParagraph","Properties":{"id":"20240325092953-2ovwz22","updated":"20240325093209"},"Children":[{"Type":"NodeText","Data":"首先，让我们了解vLLM框架的整体结构。"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"vLLM的核心模块包括LLMEngine、Scheduler、BlockSpaceManager、Worker和CacheEngine。"}]},{"ID":"20240325093215-7zokkcr","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240325093215-7zokkcr","updated":"20240325093217"},"Children":[{"ID":"20240325093217-ih0vc8g","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240325093217-ih0vc8g","updated":"20240325093217"},"Children":[{"ID":"20240325093217-lo9635a","Type":"NodeParagraph","Properties":{"id":"20240325093217-lo9635a","updated":"20240325093217"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"LLMEngine是整个系统的入口，负责处理输入请求并进行推理。"}]}]},{"ID":"20240325093220-enghwpp","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240325093220-enghwpp"},"Children":[{"ID":"20240325093220-oi3218a","Type":"NodeParagraph","Properties":{"id":"20240325093220-oi3218a","updated":"20240325093240"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Scheduler 负责调度和管理待处理的SequenceGroup"}]}]},{"ID":"20240325093418-kd9zvnw","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240325093418-kd9zvnw"},"Children":[{"ID":"20240325093418-ehii025","Type":"NodeParagraph","Properties":{"id":"20240325093418-ehii025","updated":"20240325093518"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"BlockSpaceManager 负责维护GPU显存和CPU内存的使用情况，以及Sequence 对应的Cache的BlockTable 信息。"}]}]},{"ID":"20240325093518-xrceaw1","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20240325093518-xrceaw1"},"Children":[{"ID":"20240325093518-ah0pbif","Type":"NodeParagraph","Properties":{"id":"20240325093518-ah0pbif","updated":"20240325094440"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Worker 负责缓存更新和LLM推理的执行。"},{"Type":"NodeText","Data":" "}]}]},{"ID":"20240325094625-wfcggdc","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20240325094625-wfcggdc"},"Children":[{"ID":"20240325094625-gmfkfn2","Type":"NodeParagraph","Properties":{"id":"20240325094625-gmfkfn2"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"CacheEngine则负责执行相关的GPU和CPU内存操作。"}]}]}]},{"ID":"20240325094712-0r0b8ct","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240325094712-0r0b8ct","updated":"20240325094755"},"Children":[{"Type":"NodeText","Data":"vLLM框架的深入解析"}]},{"ID":"20240325094756-ro36eld","Type":"NodeList","ListData":{},"Properties":{"id":"20240325094756-ro36eld","updated":"20240325095420"},"Children":[{"ID":"20240325094805-qrr891p","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325094805-qrr891p","updated":"20240325094805"},"Children":[{"ID":"20240325094805-5umjivn","Type":"NodeParagraph","Properties":{"id":"20240325094805-5umjivn","updated":"20240325101516"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"LLMEngine 是整个系统的入口，它接收输入请求并执行推理过程。"}]},{"ID":"20240325095230-7ejmds2","Type":"NodeList","ListData":{},"Properties":{"id":"20240325095230-7ejmds2","updated":"20240325095233"},"Children":[{"ID":"20240325095233-nv425u8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325095233-nv425u8","updated":"20240325095233"},"Children":[{"ID":"20240325095233-8g2aoxt","Type":"NodeParagraph","Properties":{"id":"20240325095233-8g2aoxt","updated":"20240325095244"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"在初始化阶段，LLMEngine 会调用Worker中的CacheEngine来初始化GPU和CPU内存，并计算可用的block数量。"}]}]},{"ID":"20240325095237-91d5q3r","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325095237-91d5q3r"},"Children":[{"ID":"20240325095237-o0xsqz9","Type":"NodeParagraph","Properties":{"id":"20240325095237-o0xsqz9","updated":"20240325095246"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"每个输入请求会构造一个SequenceGroup，并将其保存到Scheduler中进行进一步的调度和处理。"}]}]},{"ID":"20240325095249-zpsquh6","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325095249-zpsquh6"},"Children":[{"ID":"20240325095249-gy5w0rr","Type":"NodeParagraph","Properties":{"id":"20240325095249-gy5w0rr","updated":"20240325095253"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"通过多次执行step操作，LLMEngine 会完成所有输入请求对应的SequenceGroup的生成。"}]}]}]}]},{"ID":"20240325095256-xb7j8ww","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"fold":"0","id":"20240325095256-xb7j8ww","updated":"20240325095420"},"Children":[{"ID":"20240325095256-e31ui6b","Type":"NodeParagraph","Properties":{"id":"20240325095256-e31ui6b","updated":"20240325095348"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Scheduler 负责调度和管理待处理的SequenceGroup。它维护着三个队列：waiting、running和swapped。"}]},{"ID":"20240325095354-a45qle0","Type":"NodeList","ListData":{},"Properties":{"id":"20240325095354-a45qle0","updated":"20240325095420"},"Children":[{"ID":"20240325095359-rpaesg2","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325095359-rpaesg2","updated":"20240325095420"},"Children":[{"ID":"20240325095359-kd929hf","Type":"NodeParagraph","Properties":{"id":"20240325095359-kd929hf","updated":"20240325100036"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"当一个SequenceGroup被添加到系统中时，它会被放入waiting队列中。"}]}]},{"ID":"20240325100047-3v7m08n","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325100047-3v7m08n"},"Children":[{"ID":"20240325100047-h3ri1wx","Type":"NodeParagraph","Properties":{"id":"20240325100047-h3ri1wx","updated":"20240325100053"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Scheduler会根据调度策略从不同队列中选择SequenceGroup进行处理，并维护队列之间的状态。"}]}]},{"ID":"20240325100054-zmu2yon","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325100054-zmu2yon"},"Children":[{"ID":"20240325100054-slx09ve","Type":"NodeParagraph","Properties":{"id":"20240325100054-slx09ve","updated":"20240325100411"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"当一个SequenceGroup的推理过程新增了token时，Scheduler会更新该SequenceGroup的状态。"}]}]}]}]},{"ID":"20240325100514-3fgqgaw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325100514-3fgqgaw"},"Children":[{"ID":"20240325100514-4sqxkny","Type":"NodeParagraph","Properties":{"id":"20240325100514-4sqxkny","updated":"20240325100622"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"BlockSpaceManager 负责维护Cahce block和GPU/CPU 内存之间的映射关系。它记录了每个Cache block 在GPU显存或CPU内存中的物理地址。"}]},{"ID":"20240325100624-dz9dquk","Type":"NodeList","ListData":{},"Properties":{"id":"20240325100624-dz9dquk","updated":"20240325100627"},"Children":[{"ID":"20240325100627-bzzda9d","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325100627-bzzda9d","updated":"20240325100627"},"Children":[{"ID":"20240325100627-f42iezu","Type":"NodeParagraph","Properties":{"id":"20240325100627-f42iezu","updated":"20240325100935"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"当一个SequenceGroup 被加入Scheduler时，并没有分配具体的Cache block空间。"}]}]},{"ID":"20240325100935-1zrpa68","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325100935-1zrpa68"},"Children":[{"ID":"20240325100935-mznjg6m","Type":"NodeParagraph","Properties":{"id":"20240325100935-mznjg6m"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"在首次进入running阶段时，SequenceGroup 会向BlockSpaceManager申请可用的block空间，并进行相关的分配和管理。"}]}]}]}]},{"ID":"20240325100942-p5aiu1v","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325100942-p5aiu1v"},"Children":[{"ID":"20240325100942-j33pjq7","Type":"NodeParagraph","Properties":{"id":"20240325100942-j33pjq7","updated":"20240325101226"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Worker 负责缓存更新和LLM推理的执行。"}]},{"ID":"20240325102249-5jo2alv","Type":"NodeList","ListData":{},"Properties":{"id":"20240325102249-5jo2alv","updated":"20240325102250"},"Children":[{"ID":"20240325102250-pg2gyb8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325102250-pg2gyb8","updated":"20240325102250"},"Children":[{"ID":"20240325102250-dclbzx5","Type":"NodeParagraph","Properties":{"id":"20240325102250-dclbzx5","updated":"20240325102250"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"它首先执行缓存更新操作，然后准备输入token序列。"}]}]},{"ID":"20240325102258-nrjpfkm","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325102258-nrjpfkm"},"Children":[{"ID":"20240325102258-3z9d7nd","Type":"NodeParagraph","Properties":{"id":"20240325102258-3z9d7nd"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"通过调用LLM模型进行推理，Worker 会生成新的token，并将其输出结果更新到对应的SequenceGroup 中。"}]}]},{"ID":"20240325102302-nwbw2f9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325102302-nwbw2f9"},"Children":[{"ID":"20240325102302-w7ehyk0","Type":"NodeParagraph","Properties":{"id":"20240325102302-w7ehyk0"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"最后，多次执行step操作，直到所有输入请求对应的 SequenceGroup都完成生成。"}]}]}]}]},{"ID":"20240325102309-qrte70d","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325102309-qrte70d"},"Children":[{"ID":"20240325102309-zp0o0dl","Type":"NodeParagraph","Properties":{"id":"20240325102309-zp0o0dl","updated":"20240325102435"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"CacheEngine 作为Worker的一部分，负责具体的缓存操作。"}]},{"ID":"20240325102437-jmkjouo","Type":"NodeList","ListData":{},"Properties":{"id":"20240325102437-jmkjouo","updated":"20240325102438"},"Children":[{"ID":"20240325102438-mb3ycfu","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240325102438-mb3ycfu","updated":"20240325102438"},"Children":[{"ID":"20240325102438-cg31atk","Type":"NodeParagraph","Properties":{"id":"20240325102438-cg31atk","updated":"20240325102533"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"它执行缓存的换入、换出、拷贝等操作，并与BlockSpaceManager协同工作，管理GPU和CPU内存之间的数据传输"}]}]}]}]}]},{"ID":"20240325102545-lg0gnd9","Type":"NodeParagraph","Properties":{"id":"20240325102545-lg0gnd9","updated":"20240325102550"}},{"ID":"20240325102303-gkms2tg","Type":"NodeParagraph","Properties":{"id":"20240325102303-gkms2tg"}}]}