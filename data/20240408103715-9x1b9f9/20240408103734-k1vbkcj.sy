{"ID":"20240408103734-k1vbkcj","Spec":"1","Type":"NodeDocument","Properties":{"icon":"2600-fe0f","id":"20240408103734-k1vbkcj","tags":"需要仔细看,大模型推理加速","title":"迈向100倍加速：全栈Transformer 推理优化","updated":"20240408150909"},"Children":[{"ID":"20240408103802-dlmzf1l","Type":"NodeParagraph","Properties":{"id":"20240408103802-dlmzf1l","updated":"20240408103830"},"Children":[{"Type":"NodeText","Data":"本文讨论了全栈Transformer推理优化，从A100内存层次结构等硬件规格，到FlashAttention和vLLM等MLSys方法，再到专家混合等模型架构，以及推测性解码（Speculative Decoding）及其变体等解码算法。我们确定了一个最基本的事实："},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Transformer推理受限于内存，且大部分优化（无论来自MLSys还是建模）都基于/利用了这一事实。"},{"Type":"NodeText","Data":"就像在角色扮演游戏中添加buff一样，可以看到Transformer推理是如何逐步扩展和加速的。"}]},{"ID":"20240408103852-xr5l16v","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240408103852-xr5l16v","updated":"20240408103905"},"Children":[{"Type":"NodeText","Data":"硬件：GPU上的推理"}]},{"ID":"20240408103905-oyrs6v1","Type":"NodeParagraph","Properties":{"id":"20240408103905-oyrs6v1","updated":"20240408104626"},"Children":[{"Type":"NodeText","Data":"首先，我们将探讨 GPU架构，特别是其内存层次结构。我们确定了两个重要模式：计算限制 ( compute bound) 和内存限制 ( memory bound)，并讨论了大规模Transformer 推理受内存限制的原因。大部分优化都基于Transformer推理受内存限制这一基本事实，例如只要我们提高FLOP利用率，就能提高效率。"}]},{"ID":"20240408104626-u3i59ry","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408104626-u3i59ry","updated":"20240408104637"},"Children":[{"Type":"NodeText","Data":"初步推理"}]},{"ID":"20240408104637-p9ydosj","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408104637-p9ydosj","updated":"20240408104642"},"Children":[{"Type":"NodeText","Data":"GPU架构"}]},{"ID":"20240408104642-5ce77sk","Type":"NodeParagraph","Properties":{"id":"20240408104642-5ce77sk","updated":"20240408104701"},"Children":[{"Type":"NodeText","Data":"GPU架构总体如下图所示："}]},{"ID":"20240408104707-r284lmu","Type":"NodeParagraph","Properties":{"id":"20240408104707-r284lmu","updated":"20240408104715"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408104707-zfajogs.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408104715-l1075yr","Type":"NodeList","ListData":{},"Properties":{"id":"20240408104715-l1075yr","updated":"20240408104717"},"Children":[{"ID":"20240408104717-ymfizh9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408104717-ymfizh9","updated":"20240408104717"},"Children":[{"ID":"20240408104717-yw9mgk7","Type":"NodeParagraph","Properties":{"id":"20240408104717-yw9mgk7","updated":"20240408104752"},"Children":[{"Type":"NodeText","Data":"基础部分：DRAM（动态随机存取存储器）、L2缓存和SM（流处理器单元）"}]}]},{"ID":"20240408104754-pmts3m6","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408104754-pmts3m6"},"Children":[{"ID":"20240408104754-5c2iij2","Type":"NodeParagraph","Properties":{"id":"20240408104754-5c2iij2","updated":"20240408104800"},"Children":[{"Type":"NodeText","Data":"与CPU对比"}]}]},{"ID":"20240408104800-1l7ws9h","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408104800-1l7ws9h"},"Children":[{"ID":"20240408104800-gigjak9","Type":"NodeList","ListData":{},"Properties":{"id":"20240408104800-gigjak9","updated":"20240408104835"},"Children":[{"ID":"20240408104835-dv40mw1","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408104835-dv40mw1","updated":"20240408104835"},"Children":[{"ID":"20240408104835-sphdaky","Type":"NodeParagraph","Properties":{"id":"20240408104835-sphdaky","updated":"20240408104900"},"Children":[{"Type":"NodeText","Data":"SM 类似于CPU核心，但具有更高级的并行性"}]}]},{"ID":"20240408104900-pggvr9o","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408104900-pggvr9o"},"Children":[{"ID":"20240408104900-vhcvs3r","Type":"NodeParagraph","Properties":{"id":"20240408104900-vhcvs3r","updated":"20240408104926"},"Children":[{"Type":"NodeText","Data":"L2缓存和DRAM类似于CPU的L2缓存和DRAM"}]}]},{"ID":"20240408104933-5bjwuou","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408104933-5bjwuou"},"Children":[{"ID":"20240408104933-5bxxrgh","Type":"NodeParagraph","Properties":{"id":"20240408104933-5bxxrgh","updated":"20240408105008"},"Children":[{"Type":"NodeText","Data":"在 Flash Attention 论文中，L2缓存被称为SRAM（静态随机存取存储器）"}]}]}]}]},{"ID":"20240408105010-bmeoxtu","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105010-bmeoxtu"},"Children":[{"ID":"20240408105010-ta28l6y","Type":"NodeParagraph","Properties":{"id":"20240408105010-ta28l6y","updated":"20240408105018"},"Children":[{"Type":"NodeText","Data":"A 100 80G SXM"}]}]},{"ID":"20240408105018-qel0cb8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105018-qel0cb8"},"Children":[{"ID":"20240408105018-7hoacxp","Type":"NodeList","ListData":{},"Properties":{"id":"20240408105018-7hoacxp","updated":"20240408105021"},"Children":[{"ID":"20240408105021-epzu6gm","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105021-epzu6gm","updated":"20240408105021"},"Children":[{"ID":"20240408105021-bp52vp2","Type":"NodeParagraph","Properties":{"id":"20240408105021-bp52vp2","updated":"20240408105046"},"Children":[{"Type":"NodeText","Data":"108个SM，DRAM容量为80GB，有40M L2 缓存"}]}]}]}]}]},{"ID":"20240408105050-usbmzyq","Type":"NodeParagraph","Properties":{"id":"20240408105050-usbmzyq","updated":"20240408105101"},"Children":[{"Type":"NodeText","Data":"SM 内部包含什么？"}]},{"ID":"20240408105117-3xtv1jd","Type":"NodeParagraph","Properties":{"id":"20240408105117-3xtv1jd","updated":"20240408105117"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408105117-1qdmlfb.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408105123-mptgrgr","Type":"NodeList","ListData":{},"Properties":{"id":"20240408105123-mptgrgr","updated":"20240408105126"},"Children":[{"ID":"20240408105126-4el34f0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105126-4el34f0","updated":"20240408105126"},"Children":[{"ID":"20240408105126-aspgie8","Type":"NodeParagraph","Properties":{"id":"20240408105126-aspgie8","updated":"20240408105133"},"Children":[{"Type":"NodeText","Data":"L1 缓存：指令和数据"}]}]},{"ID":"20240408105134-zeieoin","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105134-zeieoin"},"Children":[{"ID":"20240408105134-sp6l95x","Type":"NodeParagraph","Properties":{"id":"20240408105134-sp6l95x","updated":"20240408105223"},"Children":[{"Type":"NodeText","Data":"张量核心：进行矩阵乘法运算的地方。回想一下，神经网络计算基本上就是巨大批量的矩阵算法。"}]}]}]},{"ID":"20240408105447-cte1m0f","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408105447-cte1m0f","updated":"20240408105455"},"Children":[{"Type":"NodeText","Data":"GPU编程基础"}]},{"ID":"20240408105455-lg9lr72","Type":"NodeParagraph","Properties":{"id":"20240408105455-lg9lr72","updated":"20240408105520"},"Children":[{"Type":"NodeText","Data":"在执行model.generate(prompt) 时，我们进行以下操作："}]},{"ID":"20240408105520-2j5qemr","Type":"NodeList","ListData":{},"Properties":{"id":"20240408105520-2j5qemr","updated":"20240408105521"},"Children":[{"ID":"20240408105521-yfm1ieq","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105521-yfm1ieq","updated":"20240408105521"},"Children":[{"ID":"20240408105521-leojpe8","Type":"NodeParagraph","Properties":{"id":"20240408105521-leojpe8","updated":"20240408105525"},"Children":[{"Type":"NodeText","Data":"内存访问："}]}]},{"ID":"20240408105525-ampshl7","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105525-ampshl7"},"Children":[{"ID":"20240408105525-4ttfxhe","Type":"NodeList","ListData":{},"Properties":{"id":"20240408105525-4ttfxhe","updated":"20240408105526"},"Children":[{"ID":"20240408105526-hwv8h0e","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105526-hwv8h0e","updated":"20240408105526"},"Children":[{"ID":"20240408105526-tttisay","Type":"NodeParagraph","Properties":{"id":"20240408105526-tttisay","updated":"20240408105605"},"Children":[{"Type":"NodeText","Data":"从高带宽内存（HBM）加载模型权重到L2缓存，然后传输到SM（流处理器单元）"}]}]}]}]},{"ID":"20240408105606-1p1c5nx","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105606-1p1c5nx"},"Children":[{"ID":"20240408105606-yj70zov","Type":"NodeParagraph","Properties":{"id":"20240408105606-yj70zov","updated":"20240408105610"},"Children":[{"Type":"NodeText","Data":"计算："}]}]},{"ID":"20240408105610-ol2v5kg","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105610-ol2v5kg"},"Children":[{"ID":"20240408105610-cfpjt41","Type":"NodeList","ListData":{},"Properties":{"id":"20240408105610-cfpjt41","updated":"20240408105612"},"Children":[{"ID":"20240408105612-d146ty2","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105612-d146ty2","updated":"20240408105612"},"Children":[{"ID":"20240408105612-0eh5dwl","Type":"NodeParagraph","Properties":{"id":"20240408105612-0eh5dwl","updated":"20240408105633"},"Children":[{"Type":"NodeText","Data":"在SM中执行矩阵乘法，SM请求张量核心执行计算。"}]}]}]}]},{"ID":"20240408105634-kxy97du","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105634-kxy97du"},"Children":[{"ID":"20240408105634-v3gl1dg","Type":"NodeParagraph","Properties":{"id":"20240408105634-v3gl1dg","updated":"20240408105642"},"Children":[{"Type":"NodeText","Data":"A100："}]}]},{"ID":"20240408105644-slj1i7e","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105644-slj1i7e"},"Children":[{"ID":"20240408105644-dvd343s","Type":"NodeList","ListData":{},"Properties":{"id":"20240408105644-dvd343s","updated":"20240408105647"},"Children":[{"ID":"20240408105647-2zxa8ce","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105647-2zxa8ce","updated":"20240408105647"},"Children":[{"ID":"20240408105647-aj92j5d","Type":"NodeParagraph","Properties":{"id":"20240408105647-aj92j5d","updated":"20240408105707"},"Children":[{"Type":"NodeText","Data":"108 个SM，DRAM 容量为80G，40M L2 缓存"}]}]},{"ID":"20240408105717-2b7qoq2","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105717-2b7qoq2"},"Children":[{"ID":"20240408105717-g1w7n9w","Type":"NodeParagraph","Properties":{"id":"20240408105717-g1w7n9w","updated":"20240408105751"},"Children":[{"Type":"NodeText","Data":"bf16张量核心：每秒312万亿浮点运算（TFLOPS）"}]}]},{"ID":"20240408105752-19cz8r7","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105752-19cz8r7"},"Children":[{"ID":"20240408105752-c95lrd4","Type":"NodeParagraph","Properties":{"id":"20240408105752-c95lrd4","updated":"20240408105825"},"Children":[{"Type":"NodeText","Data":"DRAM 内存带宽为2039GB/秒 = 2.039T/秒"}]}]}]}]},{"ID":"20240408105825-jonpi87","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105825-jonpi87"},"Children":[{"ID":"20240408105825-w7cv7ka","Type":"NodeParagraph","Properties":{"id":"20240408105825-w7cv7ka","updated":"20240408105909"},"Children":[{"Type":"NodeText","Data":"如果模型很大，我们将其分割到多个GPU上，比如两个由NVLink连接的GPU"}]}]},{"ID":"20240408105910-i5vhvqs","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105910-i5vhvqs"},"Children":[{"ID":"20240408105910-ynt0zbq","Type":"NodeList","ListData":{},"Properties":{"id":"20240408105910-ynt0zbq","updated":"20240408105912"},"Children":[{"ID":"20240408105912-5q1pdi5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105912-5q1pdi5","updated":"20240408105912"},"Children":[{"ID":"20240408105912-5868vs6","Type":"NodeParagraph","Properties":{"id":"20240408105912-5868vs6","updated":"20240408105939"},"Children":[{"Type":"NodeText","Data":"NVLink 300GB/秒 = 0.3T/秒"}]}]},{"ID":"20240408105939-7jffnc4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408105939-7jffnc4"},"Children":[{"ID":"20240408105939-scphm8z","Type":"NodeParagraph","Properties":{"id":"20240408105939-scphm8z","updated":"20240408110035"},"Children":[{"Type":"NodeText","Data":"我们大致观察了速度层次结构。尽管不能直接比较，但它们的数量级差异是我们需要优化的主要方面:"}]}]},{"ID":"20240408110035-9q5n7ic","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408110035-9q5n7ic"},"Children":[{"ID":"20240408110035-qu9zpww","Type":"NodeParagraph","Properties":{"id":"20240408110035-qu9zpww","updated":"20240408110143"},"Children":[{"Type":"NodeText","Data":"312T （SM计算） \u003e 2.03T (DRAM内存访问）\u003e 0.3T = 300G (NVLink 跨设备通信）\u003e 60 G (PCle 跨设备通信）"}]}]}]}]},{"ID":"20240408110144-jgfsyo5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408110144-jgfsyo5"},"Children":[{"ID":"20240408110144-jb1vyka","Type":"NodeParagraph","Properties":{"id":"20240408110144-jb1vyka","updated":"20240408110210"},"Children":[{"Type":"NodeText","Data":"这意味着，如果我们希望速度更快，我们应该尽力："}]}]},{"ID":"20240408110210-gol4t3u","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408110210-gol4t3u"},"Children":[{"ID":"20240408110210-tkh2d4a","Type":"NodeList","ListData":{},"Properties":{"id":"20240408110210-tkh2d4a","updated":"20240408110212"},"Children":[{"ID":"20240408110212-v5ftmz6","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408110212-v5ftmz6","updated":"20240408110212"},"Children":[{"ID":"20240408110212-suqlz1l","Type":"NodeParagraph","Properties":{"id":"20240408110212-suqlz1l","updated":"20240408110219"},"Children":[{"Type":"NodeText","Data":"充分利用SM"}]}]},{"ID":"20240408110219-fl8utt5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408110219-fl8utt5"},"Children":[{"ID":"20240408110219-hb55kmw","Type":"NodeParagraph","Properties":{"id":"20240408110219-hb55kmw","updated":"20240408110252"},"Children":[{"Type":"NodeText","Data":"减少单个GPU的内存访问（因为它比计算慢的多）"}]}]},{"ID":"20240408110301-ywjgihb","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408110301-ywjgihb","updated":"20240408110301"},"Children":[{"ID":"20240408110301-ynmuf0j","Type":"NodeParagraph","Properties":{"id":"20240408110301-ynmuf0j","updated":"20240408110336"},"Children":[{"Type":"NodeText","Data":"减少GPU之间的通信（因为它甚至比内存访问还要慢）"}]}]}]}]}]},{"ID":"20240408110353-1w518lt","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408110353-1w518lt","updated":"20240408110406"},"Children":[{"Type":"NodeText","Data":"计算限制与内存限制"}]},{"ID":"20240408110407-5bkzodm","Type":"NodeParagraph","Properties":{"id":"20240408110407-5bkzodm","updated":"20240408110544"},"Children":[{"Type":"NodeText","Data":"如何确定我们是否充分利用了SM呢？我们通过以下方式检查是否计算或内存限制："}]},{"ID":"20240408110544-vp6apl1","Type":"NodeList","ListData":{},"Properties":{"id":"20240408110544-vp6apl1","updated":"20240408110546"},"Children":[{"ID":"20240408110546-f1vieyf","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408110546-f1vieyf","updated":"20240408110546"},"Children":[{"ID":"20240408110546-ytqhxpe","Type":"NodeParagraph","Properties":{"id":"20240408110546-ytqhxpe","updated":"20240408111307"},"Children":[{"Type":"NodeText","Data":"定义"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"每字节GPU操作 = flop/内存带宽"}]}]},{"ID":"20240408111308-grcj6w1","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408111308-grcj6w1"},"Children":[{"ID":"20240408111308-0rpqj5n","Type":"NodeList","ListData":{},"Properties":{"id":"20240408111308-0rpqj5n","updated":"20240408111313"},"Children":[{"ID":"20240408111313-jee8rrw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408111313-jee8rrw","updated":"20240408111313"},"Children":[{"ID":"20240408111313-0jrfdpa","Type":"NodeParagraph","Properties":{"id":"20240408111313-0jrfdpa","updated":"20240408111323"},"Children":[{"Type":"NodeText","Data":"A100 = 312/2.039"}]}]}]}]},{"ID":"20240408111324-7bqgupy","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408111324-7bqgupy"},"Children":[{"ID":"20240408111324-tzdu1c2","Type":"NodeParagraph","Properties":{"id":"20240408111324-tzdu1c2","updated":"20240408111342"},"Children":[{"Type":"NodeText","Data":"定义 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"计算强度="},{"Type":"NodeText","Data":" 计算/内存访问"}]}]},{"ID":"20240408111343-w3wg72r","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408111343-w3wg72r"},"Children":[{"ID":"20240408111343-finae7z","Type":"NodeParagraph","Properties":{"id":"20240408111343-finae7z","updated":"20240408111428"},"Children":[{"Type":"NodeText","Data":"如果计算强度大，说明程序更会受到计算限制，如果计算强度较小，则更受内存限制。"}]}]}]},{"ID":"20240408111436-s1rqze4","Type":"NodeParagraph","Properties":{"id":"20240408111436-s1rqze4","updated":"20240408111436"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408111436-vjhlz3o.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408111437-dzgz7of","Type":"NodeList","ListData":{},"Properties":{"id":"20240408111437-dzgz7of","updated":"20240408111439"},"Children":[{"ID":"20240408111439-z6x6hjg","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408111439-z6x6hjg","updated":"20240408111439"},"Children":[{"ID":"20240408111439-e98vyb5","Type":"NodeParagraph","Properties":{"id":"20240408111439-e98vyb5","updated":"20240408111503"},"Children":[{"Type":"NodeText","Data":"增加批次大小会将行为从内存限制变为计算限制。"}]}]},{"ID":"20240408111503-bhmpwod","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408111503-bhmpwod"},"Children":[{"ID":"20240408111503-5ln71o4","Type":"NodeParagraph","Properties":{"id":"20240408111503-5ln71o4","updated":"20240408111531"},"Children":[{"Type":"NodeText","Data":"内核融合：减少了内存访问操作，因为我们将都多个操作合并为一个操作"}]}]}]},{"ID":"20240408111556-kjzbzat","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408111556-kjzbzat","updated":"20240408111612"},"Children":[{"Type":"NodeText","Data":"Transformer 推理基础"}]},{"ID":"20240408111613-mbmazkk","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408111613-mbmazkk","updated":"20240408111626"},"Children":[{"Type":"NodeText","Data":"预填充和解码"}]},{"ID":"20240408111657-4z2cqhd","Type":"NodeParagraph","Properties":{"id":"20240408111657-4z2cqhd","updated":"20240408111749"},"Children":[{"Type":"NodeText","Data":"调用 model.generate(prompt) 时有两个步骤："}]},{"ID":"20240408111749-li1yzzm","Type":"NodeList","ListData":{},"Properties":{"id":"20240408111749-li1yzzm","updated":"20240408111751"},"Children":[{"ID":"20240408111751-aghbvk0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408111751-aghbvk0","updated":"20240408111751"},"Children":[{"ID":"20240408111751-jgwxzpn","Type":"NodeParagraph","Properties":{"id":"20240408111751-jgwxzpn","updated":"20240408111755"},"Children":[{"Type":"NodeText","Data":"预填充："}]},{"ID":"20240408111756-aahrq0i","Type":"NodeList","ListData":{},"Properties":{"id":"20240408111756-aahrq0i","updated":"20240408111758"},"Children":[{"ID":"20240408111758-cxte07m","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408111758-cxte07m","updated":"20240408111758"},"Children":[{"ID":"20240408111758-xu6bcve","Type":"NodeParagraph","Properties":{"id":"20240408111758-xu6bcve","updated":"20240408111814"},"Children":[{"Type":"NodeText","Data":"为提示计算键值 （kv）缓存"}]}]},{"ID":"20240408111814-ud2f7vo","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408111814-ud2f7vo"},"Children":[{"ID":"20240408111814-luwigj9","Type":"NodeParagraph","Properties":{"id":"20240408111814-luwigj9","updated":"20240408111839"},"Children":[{"Type":"NodeText","Data":"这一步骤受计算限制，因为我们并行计算了一系列词元。"}]}]}]}]},{"ID":"20240408111839-yor950h","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408111839-yor950h"},"Children":[{"ID":"20240408111839-zaak1h6","Type":"NodeParagraph","Properties":{"id":"20240408111839-zaak1h6","updated":"20240408111843"},"Children":[{"Type":"NodeText","Data":"解码："}]},{"ID":"20240408111843-9znhobi","Type":"NodeList","ListData":{},"Properties":{"id":"20240408111843-9znhobi","updated":"20240408111845"},"Children":[{"ID":"20240408111845-szm8to8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408111845-szm8to8","updated":"20240408111845"},"Children":[{"ID":"20240408111845-wq5g1lb","Type":"NodeParagraph","Properties":{"id":"20240408111845-wq5g1lb","updated":"20240408111857"},"Children":[{"Type":"NodeText","Data":"自回归采样下一个词元"}]}]},{"ID":"20240408111857-qqd37nn","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408111857-qqd37nn"},"Children":[{"ID":"20240408111857-f26mplw","Type":"NodeParagraph","Properties":{"id":"20240408111857-f26mplw","updated":"20240408111931"},"Children":[{"Type":"NodeText","Data":"这一步骤受内存限制，因为我们仅计算一个词元，未充分利用SM"}]}]}]}]}]},{"ID":"20240408111932-pqt89co","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408111932-pqt89co","updated":"20240408111957"},"Children":[{"Type":"NodeText","Data":"Transformer 推理受内存限制"}]},{"ID":"20240408111958-abbibh4","Type":"NodeParagraph","Properties":{"id":"20240408111958-abbibh4","updated":"20240408112100"},"Children":[{"Type":"NodeText","Data":"增加批处理大小可以将模式从内存限制变为计算限制，正如Kipply 博客《大型语言模型的推理演算》中的下图所示。"}]},{"ID":"20240408113031-u1uqm1s","Type":"NodeParagraph","Properties":{"id":"20240408113031-u1uqm1s","updated":"20240408113031"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408113031-399pq72.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408111627-xy79e0g","Type":"NodeList","ListData":{},"Properties":{"id":"20240408111627-xy79e0g","updated":"20240408113034"},"Children":[{"ID":"20240408113034-9mp7kjv","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113034-9mp7kjv","updated":"20240408113034"},"Children":[{"ID":"20240408113034-ybu956u","Type":"NodeParagraph","Properties":{"id":"20240408113034-ybu956u","updated":"20240408113053"},"Children":[{"Type":"NodeText","Data":"因为解码每次只采样一个词元。"}]}]},{"ID":"20240408113055-v7fow4i","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113055-v7fow4i"},"Children":[{"ID":"20240408113055-oxjopxr","Type":"NodeParagraph","Properties":{"id":"20240408113055-oxjopxr","updated":"20240408113111"},"Children":[{"Type":"NodeText","Data":"增加批次大小提高了硬件效率"}]}]},{"ID":"20240408113112-2d9sfgv","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113112-2d9sfgv"},"Children":[{"ID":"20240408113112-soptztg","Type":"NodeList","ListData":{},"Properties":{"id":"20240408113112-soptztg","updated":"20240408113113"},"Children":[{"ID":"20240408113113-abttsqx","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113113-abttsqx","updated":"20240408113113"},"Children":[{"ID":"20240408113113-ceklcou","Type":"NodeParagraph","Properties":{"id":"20240408113113-ceklcou","updated":"20240408113125"},"Children":[{"Type":"NodeText","Data":"因为我们同时计算多个词元"}]}]},{"ID":"20240408113126-xpsxzc0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113126-xpsxzc0"},"Children":[{"ID":"20240408113126-k7hofyi","Type":"NodeParagraph","Properties":{"id":"20240408113126-k7hofyi","updated":"20240408113141"},"Children":[{"Type":"NodeText","Data":"大型批次从内存限制变为计算限制"}]}]}]}]},{"ID":"20240408113141-sgk07ep","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113141-sgk07ep"},"Children":[{"ID":"20240408113141-uzhlssm","Type":"NodeParagraph","Properties":{"id":"20240408113141-uzhlssm","updated":"20240408113223"},"Children":[{"Type":"NodeText","Data":"然而，我们可能无法使用太大型的批次大小，因为GPU内存有限，目前最大为80GB"}]}]}]},{"ID":"20240408113235-dmf6jft","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408113235-dmf6jft","updated":"20240408113240"},"Children":[{"Type":"NodeText","Data":"内存布局"}]},{"ID":"20240408113245-bmjbshr","Type":"NodeParagraph","Properties":{"id":"20240408113245-bmjbshr","updated":"20240408113245"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408113245-y1cna58.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408113253-ib6l216","Type":"NodeParagraph","Properties":{"id":"20240408113253-ib6l216","updated":"20240408113253"},"Children":[{"Type":"NodeText","Data":"正如我们所看到的，为了在bf16格式下运行一个13B模型，我们大约只有10GB的内存来存储kv缓存。这意味着："}]},{"ID":"20240408113253-htb58fa","Type":"NodeList","ListData":{},"Properties":{"id":"20240408113253-htb58fa","updated":"20240408113253"},"Children":[{"ID":"20240408113253-mlb4zg8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113253-mlb4zg8","updated":"20240408113253"},"Children":[{"ID":"20240408113253-2bt15er","Type":"NodeParagraph","Properties":{"id":"20240408113253-2bt15er","updated":"20240408113253"},"Children":[{"Type":"NodeText","Data":"不能使用太大型的批次（尽管我们希望使用更大的批次大小以提高效率）"}]}]},{"ID":"20240408113253-8o3pmgo","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113253-8o3pmgo","updated":"20240408113253"},"Children":[{"ID":"20240408113253-4pz4fhz","Type":"NodeParagraph","Properties":{"id":"20240408113253-4pz4fhz","updated":"20240408113253"},"Children":[{"Type":"NodeText","Data":"也不能处理太长的序列，尽管我们确实希望能够处理长度为100k的序列。"}]}]}]},{"ID":"20240408113255-2v7zgsk","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408113255-2v7zgsk","updated":"20240408113315"},"Children":[{"Type":"NodeText","Data":"在线与离线推理，吞吐量vs 时延"}]},{"ID":"20240408113316-sbnj9bz","Type":"NodeList","ListData":{},"Properties":{"id":"20240408113316-sbnj9bz","updated":"20240408113319"},"Children":[{"ID":"20240408113319-xbqodbz","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113319-xbqodbz","updated":"20240408113319"},"Children":[{"ID":"20240408113319-q4p8b20","Type":"NodeParagraph","Properties":{"id":"20240408113319-q4p8b20","updated":"20240408113328"},"Children":[{"Type":"NodeText","Data":"离线：吞吐量优化"}]}]},{"ID":"20240408113328-554fkkx","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113328-554fkkx"},"Children":[{"ID":"20240408113344-ablo1vd","Type":"NodeList","ListData":{},"Properties":{"id":"20240408113344-ablo1vd","updated":"20240408113344"},"Children":[{"ID":"20240408113344-d0zt0fk","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113344-d0zt0fk","updated":"20240408113344"},"Children":[{"ID":"20240408113344-4d9bx46","Type":"NodeParagraph","Properties":{"id":"20240408113344-4d9bx46","updated":"20240408113344"},"Children":[{"Type":"NodeText","Data":"我们关注这种情况，因为希望能够离线评估模型，例如，在100个基准测试上运行一个中间的预训练检查点（checkpoint），用于验证预训练是否情况良好。"}]}]},{"ID":"20240408113344-v6n01q4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113344-v6n01q4","updated":"20240408113344"},"Children":[{"ID":"20240408113344-qzp316g","Type":"NodeParagraph","Properties":{"id":"20240408113344-qzp316g","updated":"20240408113344"},"Children":[{"Type":"NodeText","Data":"增加批次大小是有帮助的，但需要记住当前单个设备的最大内存为80GB。"}]}]}]}]},{"ID":"20240408113346-o7utjnr","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113346-o7utjnr"},"Children":[{"ID":"20240408113346-rncdod9","Type":"NodeParagraph","Properties":{"id":"20240408113346-rncdod9","updated":"20240408113359"},"Children":[{"Type":"NodeText","Data":"在线：时延和吞吐量权衡"}]}]},{"ID":"20240408113400-db3py8q","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113400-db3py8q"},"Children":[{"ID":"20240408113414-tlr1si5","Type":"NodeList","ListData":{},"Properties":{"id":"20240408113414-tlr1si5","updated":"20240408113414"},"Children":[{"ID":"20240408113414-b96uq4e","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113414-b96uq4e","updated":"20240408113414"},"Children":[{"ID":"20240408113414-1gb308c","Type":"NodeParagraph","Properties":{"id":"20240408113414-1gb308c","updated":"20240408113414"},"Children":[{"Type":"NodeText","Data":"当批次大小较大型时（假设仍然适配内存），会受到计算吸纳之，随后时延会相应增加。"}]}]},{"ID":"20240408113414-k9c8gbo","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113414-k9c8gbo","updated":"20240408113414"},"Children":[{"ID":"20240408113414-n2j569b","Type":"NodeParagraph","Properties":{"id":"20240408113414-n2j569b","updated":"20240408113414"},"Children":[{"Type":"NodeText","Data":"时延不应慢于人类的阅读速度，否则用户会抱怨，或者转而使用竞争对手的模型。"}]}]},{"ID":"20240408113414-j9iurr5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113414-j9iurr5","updated":"20240408113414"},"Children":[{"ID":"20240408113414-7ndi9ep","Type":"NodeParagraph","Properties":{"id":"20240408113414-7ndi9ep","updated":"20240408113414"},"Children":[{"Type":"NodeText","Data":"但再次强调，我们确实希望使用更大的批次大小以提高效率。"}]}]}]}]}]},{"ID":"20240408113432-zitl8ji","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408113432-zitl8ji","updated":"20240408113443"},"Children":[{"Type":"NodeText","Data":"上下文长度扩展"}]},{"ID":"20240408113443-ehy98i4","Type":"NodeParagraph","Properties":{"id":"20240408113443-ehy98i4","updated":"20240408113607"},"Children":[{"Type":"NodeText","Data":"到目前为止，我们的假设都是基于提示不长（低于4k）的情况。接下来，我们将考虑提示超过100k的情况，希望模型阅读多个PDF文件，然后进行文档问答。"}]},{"ID":"20240408113607-96cgf9o","Type":"NodeList","ListData":{},"Properties":{"id":"20240408113607-96cgf9o","updated":"20240408113609"},"Children":[{"ID":"20240408113609-ntxwx78","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113609-ntxwx78","updated":"20240408113609"},"Children":[{"ID":"20240408113609-knqflho","Type":"NodeParagraph","Properties":{"id":"20240408113609-knqflho","updated":"20240408113611"},"Children":[{"Type":"NodeText","Data":"预填充"}]}]},{"ID":"20240408113611-3u80kxj","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113611-3u80kxj"},"Children":[{"ID":"20240408113611-jd2dxlu","Type":"NodeParagraph","Properties":{"id":"20240408113611-jd2dxlu","updated":"20240408113630"},"Children":[{"Type":"NodeText","Data":"这一次，预填充需要花费更长时间，因为输入长度很长"}]}]},{"ID":"20240408113631-q94bxfq","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113631-q94bxfq"},"Children":[{"ID":"20240408113631-wk4e0mb","Type":"NodeParagraph","Properties":{"id":"20240408113631-wk4e0mb","updated":"20240408113722"},"Children":[{"Type":"NodeText","Data":"这种情况下，生成首个词元的时延很重要，因为用户希望在10秒内看到模型生成的响应。"}]}]},{"ID":"20240408113722-qwbbs0b","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113722-qwbbs0b"},"Children":[{"ID":"20240408113722-bpqv5s8","Type":"NodeParagraph","Properties":{"id":"20240408113722-bpqv5s8","updated":"20240408113728"},"Children":[{"Type":"NodeText","Data":"大型kv缓存"}]}]},{"ID":"20240408113729-2498e5o","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113729-2498e5o"},"Children":[{"ID":"20240408113729-kvabk5g","Type":"NodeList","ListData":{},"Properties":{"id":"20240408113729-kvabk5g","updated":"20240408113730"},"Children":[{"ID":"20240408113730-xowak1y","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113730-xowak1y","updated":"20240408113730"},"Children":[{"ID":"20240408113730-4v4iamk","Type":"NodeParagraph","Properties":{"id":"20240408113730-4v4iamk","updated":"20240408113754"},"Children":[{"Type":"NodeText","Data":"由于上下文长度很长，我们需要一个大型的键值（KV）缓存"}]}]}]}]},{"ID":"20240408113756-5r7q4fb","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408113756-5r7q4fb"},"Children":[{"ID":"20240408113756-viihht7","Type":"NodeParagraph","Properties":{"id":"20240408113756-viihht7","updated":"20240408113823"},"Children":[{"Type":"NodeText","Data":"目前就改进这方面的推理而言，人们做的工作似乎并不多"}]}]}]},{"ID":"20240408113824-zmb9i0j","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240408113824-zmb9i0j","updated":"20240408113847"},"Children":[{"Type":"NodeText","Data":"MLSys：Flash Attention 和vLLM"}]},{"ID":"20240408113407-r9ofpcm","Type":"NodeParagraph","Properties":{"id":"20240408113407-r9ofpcm","updated":"20240408113906"},"Children":[{"Type":"NodeText","Data":"本节讨论了如何充分利用GPU内存层次结构。vLLM提供了一种进行GPU内存管理的方法，就像在操作系统中管理CPU虚拟内存一样；Flash Attention展示了如何通过在SM上执行大部分操作来有效减少内存IO，从而显著减少内存访问计算开销。"}]},{"ID":"20240408113910-udd6hkj","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408113910-udd6hkj","updated":"20240408113924"},"Children":[{"Type":"NodeText","Data":"vLLM 和 Paged Attention"}]},{"ID":"20240408113924-02bd20h","Type":"NodeParagraph","Properties":{"id":"20240408113924-02bd20h","updated":"20240408114115"},"Children":[{"Type":"NodeText","Data":"由于GPU内存有限，我们希望合理使用它来存储键值（kv）缓存。然而，GPU或PyTorch 本身并不会自动提供将KV 缓存置入内存的最佳方式，而其默认策略实际上相当糟糕。这激发了vLLM中用于GPU内存管理的Paged Attention："}]},{"ID":"20240408114226-1eurojw","Type":"NodeParagraph","Properties":{"id":"20240408114226-1eurojw","updated":"20240408114226"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408114226-vuadnee.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408114230-bct2cpe","Type":"NodeList","ListData":{},"Properties":{"id":"20240408114230-bct2cpe","updated":"20240408122048"},"Children":[{"ID":"20240408114231-gms0qga","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408114231-gms0qga","updated":"20240408122048"},"Children":[{"ID":"20240408114231-tolvve2","Type":"NodeParagraph","Properties":{"id":"20240408114231-tolvve2","updated":"20240408122048"},"Children":[{"Type":"NodeText","Data":"Paged Attention 基本构建了一个类似CPU内存管理的内存管理系统， 以减少内存碎片并充分利用内存吞吐量                                                                                                                                                                                                                                                                                             "}]}]}]},{"ID":"20240408114428-bd1x4hb","Type":"NodeList","ListData":{},"Properties":{"id":"20240408114428-bd1x4hb","updated":"20240408114428"},"Children":[{"ID":"20240408114428-kr1pyfn","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408114428-kr1pyfn","updated":"20240408114428"},"Children":[{"ID":"20240408114428-rw5z4sb","Type":"NodeParagraph","Properties":{"id":"20240408114428-rw5z4sb","updated":"20240408114428"},"Children":[{"Type":"NodeText","Data":"现在这成为了Transformer推理的首要选择"}]}]}]},{"ID":"20240408123522-ktb4ji0","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408123522-ktb4ji0","updated":"20240408141907"},"Children":[{"Type":"NodeText","Data":"Flash attention"}]},{"ID":"20240408141907-uybsmgh","Type":"NodeParagraph","Properties":{"id":"20240408141907-uybsmgh","updated":"20240408141936"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"对每位从业者来说都是必备的，请简单记住完整的算法。"}]},{"ID":"20240408141943-hyp23n3","Type":"NodeParagraph","Properties":{"id":"20240408141943-hyp23n3","updated":"20240408141943"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408141943-xommhmr.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408141945-li0mx72","Type":"NodeParagraph","Properties":{"id":"20240408141945-li0mx72","updated":"20240408142019"},"Children":[{"Type":"NodeText","Data":"要点："}]},{"ID":"20240408142020-47m4jgg","Type":"NodeList","ListData":{},"Properties":{"id":"20240408142020-47m4jgg","updated":"20240408142021"},"Children":[{"ID":"20240408142021-h2p4teh","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408142021-h2p4teh","updated":"20240408142021"},"Children":[{"ID":"20240408142021-p0wn2su","Type":"NodeParagraph","Properties":{"id":"20240408142021-p0wn2su","updated":"20240408142131"},"Children":[{"Type":"NodeText","Data":"不要将完整的注意力矩阵存储在HBM中，而是对点积进行分块计算（blockwise computation）， 以便所有计算都在L2高速缓存中执行。"}]}]}]},{"ID":"20240408142134-h0v61ae","Type":"NodeParagraph","Properties":{"id":"20240408142134-h0v61ae","updated":"20240408142140"},"Children":[{"Type":"NodeText","Data":"主要优势："}]},{"ID":"20240408142140-653zppb","Type":"NodeList","ListData":{},"Properties":{"id":"20240408142140-653zppb","updated":"20240408142142"},"Children":[{"ID":"20240408142142-xxwv4c5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408142142-xxwv4c5","updated":"20240408142142"},"Children":[{"ID":"20240408142142-kc5qk9f","Type":"NodeParagraph","Properties":{"id":"20240408142142-kc5qk9f","updated":"20240408142221"},"Children":[{"Type":"NodeText","Data":"大幅减少内存使用，可以使用蛮力法（即“brutal force”，通过穷举所有可能性来解决问题）处理包含100k上下文长度的情况——没错，并没有使用复杂算法来处理100k上下文长度，而是采用了蛮力法。、"}]}]},{"ID":"20240408142221-qjdgo14","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408142221-qjdgo14"},"Children":[{"ID":"20240408142221-xiw2nfg","Type":"NodeList","ListData":{},"Properties":{"id":"20240408142221-xiw2nfg","updated":"20240408142222"},"Children":[{"ID":"20240408142222-yka2i2w","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408142222-yka2i2w","updated":"20240408142222"},"Children":[{"ID":"20240408142222-k1kwqts","Type":"NodeParagraph","Properties":{"id":"20240408142222-k1kwqts","updated":"20240408142301"},"Children":[{"Type":"NodeText","Data":"在原始论文中，作者们最多只测试了16k，但其实完全可以处理100k的上下文长度"}]}]}]}]},{"ID":"20240408142302-0rjhpf0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408142302-0rjhpf0"},"Children":[{"ID":"20240408142302-aaapct3","Type":"NodeParagraph","Properties":{"id":"20240408142302-aaapct3","updated":"20240408142344"},"Children":[{"Type":"NodeText","Data":"大幅提高吞吐量，尤其是对于小模型，其中大部分浮点运算用于点积操作。"}]}]}]},{"ID":"20240408142345-sj49gn9","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408142345-sj49gn9","updated":"20240408142352"},"Children":[{"Type":"NodeText","Data":"Flash 解码"}]},{"ID":"20240408142359-g2bsv8l","Type":"NodeParagraph","Properties":{"id":"20240408142359-g2bsv8l","updated":"20240408142359"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408142359-fevkbho.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408142401-p0zj4as","Type":"NodeParagraph","Properties":{"id":"20240408142401-p0zj4as","updated":"20240408142408"},"Children":[{"Type":"NodeText","Data":"要点：不再使用一个查询来扫描整个KV缓存，而是复制查询，以便可以并行扫描KV缓存的不同块（chunk）。"}]},{"ID":"20240408142411-4ppve9b","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240408142411-4ppve9b","updated":"20240408142422"},"Children":[{"Type":"NodeText","Data":"建模：架构与解码算法"}]},{"ID":"20240408142422-n6toybi","Type":"NodeParagraph","Properties":{"id":"20240408142422-n6toybi","updated":"20240408142553"},"Children":[{"Type":"NodeText","Data":"现在我们进入一个大家更熟悉的领域。我们将从蒸馏（distillation）和量化（quantization)等标准且广为人知的技术开始，然后深入探讨专家混合（MoE)和推测性解码（speculative decoding） 等进阶主题。"}]},{"ID":"20240408142553-lhjqvdd","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408142553-lhjqvdd","updated":"20240408142558"},"Children":[{"Type":"NodeText","Data":"经典方法"}]},{"ID":"20240408142559-inf6r0x","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408142559-inf6r0x","updated":"20240408142614"},"Children":[{"Type":"NodeText","Data":"蒸馏和稀疏注意力"}]},{"ID":"20240408142614-vaw19wa","Type":"NodeList","ListData":{},"Properties":{"id":"20240408142614-vaw19wa","updated":"20240408142632"},"Children":[{"ID":"20240408142632-rahtetm","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408142632-rahtetm","updated":"20240408142632"},"Children":[{"ID":"20240408142632-9bw52vt","Type":"NodeParagraph","Properties":{"id":"20240408142632-9bw52vt","updated":"20240408142700"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"蒸馏"},{"Type":"NodeText","Data":" ：利用较大模型的输出/logits对小模型进行微调"}]}]},{"ID":"20240408142701-4a7u3g2","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408142701-4a7u3g2"},"Children":[{"ID":"20240408142701-hpwxa23","Type":"NodeList","ListData":{},"Properties":{"id":"20240408142701-hpwxa23","updated":"20240408142703"},"Children":[{"ID":"20240408142703-2ug2nzu","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408142703-2ug2nzu","updated":"20240408142703"},"Children":[{"ID":"20240408142703-8l6wcrq","Type":"NodeParagraph","Properties":{"id":"20240408142703-8l6wcrq","updated":"20240408142743"},"Children":[{"Type":"NodeText","Data":"对输出进行微调：如今大家都很擅长从GPT进行蒸馏，所以这部分略过"}]}]},{"ID":"20240408142745-8nl9snk","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408142745-8nl9snk"},"Children":[{"ID":"20240408142745-o8dxyh9","Type":"NodeParagraph","Properties":{"id":"20240408142745-o8dxyh9","updated":"20240408142827"},"Children":[{"Type":"NodeText","Data":"对 logits/分布进行微调的探索较少，一些结果表明，通过这种方法收敛速度更快，质量更好"}]}]}]}]},{"ID":"20240408142829-vppg0gr","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408142829-vppg0gr"},"Children":[{"ID":"20240408142829-ls5wx0b","Type":"NodeParagraph","Properties":{"id":"20240408142829-ls5wx0b","updated":"20240408142856"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"稀疏和局部注意力，"},{"Type":"NodeText","Data":"尤其使用于长上下文"}]}]},{"ID":"20240408142857-871w5ek","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408142857-871w5ek"},"Children":[{"ID":"20240408142857-6so3pja","Type":"NodeList","ListData":{},"Properties":{"id":"20240408142857-6so3pja","updated":"20240408142858"},"Children":[{"ID":"20240408142858-a1gbhty","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408142858-a1gbhty","updated":"20240408142858"},"Children":[{"ID":"20240408142858-yaxm4z2","Type":"NodeParagraph","Properties":{"id":"20240408142858-yaxm4z2","updated":"20240408142938"},"Children":[{"Type":"NodeText","Data":"在小模型时代，这一领域得到了深入研究，但不确定这些结果是否适用于更大规模的模型"}]}]},{"ID":"20240408142939-k9fy7pe","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408142939-k9fy7pe"},"Children":[{"ID":"20240408142939-021bdms","Type":"NodeParagraph","Properties":{"id":"20240408142939-021bdms","updated":"20240408143019"},"Children":[{"Type":"NodeText","Data":"在大模型时代，除了Mistral 的滑动窗口注意力，这一领域几乎没有相关研究"}]}]}]}]}]},{"ID":"20240408143020-glkrft1","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408143020-glkrft1","updated":"20240408143028"},"Children":[{"Type":"NodeText","Data":"量化"}]},{"ID":"20240408143029-vd8gujk","Type":"NodeParagraph","Properties":{"id":"20240408143029-vd8gujk","updated":"20240408143128"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://github.com/TimDettmers/bitsandbytes","TextMarkTextContent":"github.com/TimDettmers/b..."}]},{"ID":"20240408143127-2lloqc8","Type":"NodeList","ListData":{},"Properties":{"id":"20240408143127-2lloqc8","updated":"20240408144421"},"Children":[{"ID":"20240408144421-c7wq5gc","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408144421-c7wq5gc","updated":"20240408144421"},"Children":[{"ID":"20240408144421-rdu81it","Type":"NodeParagraph","Properties":{"id":"20240408144421-rdu81it","updated":"20240408144445"},"Children":[{"Type":"NodeText","Data":"最基本的方法，将模型权重量化为int 8。"}]}]},{"ID":"20240408144446-bc5g2vt","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408144446-bc5g2vt"},"Children":[{"ID":"20240408144446-gmna1xv","Type":"NodeParagraph","Properties":{"id":"20240408144446-gmna1xv","updated":"20240408144527"},"Children":[{"Type":"NodeText","Data":"量化如今是部署大模型的必备步骤。好消息是，它实际上并不会对性能造成实质损害。"}]}]}]},{"ID":"20240408144535-zv5sj3n","Type":"NodeParagraph","Properties":{"id":"20240408144535-zv5sj3n","updated":"20240408144535"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408144535-112ob11.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408144539-1213amw","Type":"NodeList","ListData":{},"Properties":{"id":"20240408144539-1213amw","updated":"20240408144738"},"Children":[{"ID":"20240408144541-ksh8w4d","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408144541-ksh8w4d","updated":"20240408144541"},"Children":[{"ID":"20240408144541-x3074pu","Type":"NodeParagraph","Properties":{"id":"20240408144541-x3074pu","updated":"20240408144618"},"Children":[{"Type":"NodeText","Data":"Yi-34B 聊天模型的4位量化仅需17G内存，而基准测试的性能几乎相同。"}]}]},{"ID":"20240408144619-ah46oa9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408144619-ah46oa9","updated":"20240408144738"},"Children":[{"ID":"20240408144619-xmfja7g","Type":"NodeParagraph","Properties":{"id":"20240408144619-xmfja7g","updated":"20240408144738"},"Children":[{"Type":"NodeText","Data":"实际上它的速度相当快，你可以在Hugging Face "},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://huggingface.co/spaces/01-ai/Yi-34B-Chat","TextMarkTextContent":"huggingface.co/spaces/01..."},{"Type":"NodeText","Data":"上尝试。"}]}]}]},{"ID":"20240408144703-9915dq7","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408144703-9915dq7","updated":"20240408144718"},"Children":[{"Type":"NodeText","Data":"多查询注意力和组查询注意力"}]},{"ID":"20240408144723-v51rioe","Type":"NodeParagraph","Properties":{"id":"20240408144723-v51rioe","updated":"20240408144727"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408144723-4z3lo8g.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240408144748-olqnfb6","Type":"NodeList","ListData":{},"Properties":{"id":"20240408144748-olqnfb6","updated":"20240408144748"},"Children":[{"ID":"20240408144748-7hjws11","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408144748-7hjws11","updated":"20240408144748"},"Children":[{"ID":"20240408144748-1idus4t","Type":"NodeParagraph","Properties":{"id":"20240408144748-1idus4t","updated":"20240408144748"},"Children":[{"Type":"NodeText","Data":"通常情况下，多查询注意力通过同时减少内存和计算，显著加快了训练和推理速度。"}]}]},{"ID":"20240408144748-f3vfipd","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408144748-f3vfipd","updated":"20240408144748"},"Children":[{"ID":"20240408144748-1ahc6x7","Type":"NodeParagraph","Properties":{"id":"20240408144748-1ahc6x7","updated":"20240408144748"},"Children":[{"Type":"NodeText","Data":"多查询注意力也是一个很好的例子，小模型与大模型在此方面的差异并不明显：对于7B这样的小模型，多查询注意力不如全注意力，但当模型达到70B时，多查询注意力的性能基本上与全注意力相同。LLaMA2 7B使用全注意力，而70B使用组查询注意力。"}]}]},{"ID":"20240408144748-ctj09mn","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408144748-ctj09mn","updated":"20240408144748"},"Children":[{"ID":"20240408144748-jwdexqx","Type":"NodeParagraph","Properties":{"id":"20240408144748-jwdexqx","updated":"20240408144748"},"Children":[{"Type":"NodeText","Data":"现有的顶尖大模型默认使用多查询注意力。"}]}]}]},{"ID":"20240408144756-duhsu4b","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408144756-duhsu4b","updated":"20240408144801"},"Children":[{"Type":"NodeText","Data":"进阶技术"}]},{"ID":"20240408144801-g1tn2yx","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408144801-g1tn2yx","updated":"20240408144811"},"Children":[{"Type":"NodeText","Data":"专家混合模型"}]},{"ID":"20240408144812-d1gky1w","Type":"NodeParagraph","Properties":{"id":"20240408144812-d1gky1w","updated":"20240408144826"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"从头开始预训练"}]},{"ID":"20240408144842-zp1vc3m","Type":"NodeList","ListData":{},"Properties":{"id":"20240408144842-zp1vc3m","updated":"20240408144842"},"Children":[{"ID":"20240408144842-w2x1370","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408144842-w2x1370","updated":"20240408144842"},"Children":[{"ID":"20240408144842-ezxjxfr","Type":"NodeParagraph","Properties":{"id":"20240408144842-ezxjxfr","updated":"20240408144842"},"Children":[{"Type":"NodeText","Data":"假设我们有7B激活单元，总共34B参数。"}]}]},{"ID":"20240408144842-fj8ekvr","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408144842-fj8ekvr","updated":"20240408144842"},"Children":[{"ID":"20240408144842-gtgejye","Type":"NodeParagraph","Properties":{"id":"20240408144842-gtgejye","updated":"20240408144842"},"Children":[{"Type":"NodeText","Data":"能否实现以下目标？"}]}]},{"ID":"20240408144842-fltk58g","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408144842-fltk58g","updated":"20240408144842"},"Children":[{"ID":"20240408144842-yjjvyzz","Type":"NodeList","ListData":{},"Properties":{"id":"20240408144842-yjjvyzz","updated":"20240408144842"},"Children":[{"ID":"20240408144842-tvpgohe","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408144842-tvpgohe","updated":"20240408144842"},"Children":[{"ID":"20240408144842-kyreeb6","Type":"NodeParagraph","Properties":{"id":"20240408144842-kyreeb6","updated":"20240408144842"},"Children":[{"Type":"NodeText","Data":"与34B相似的性能"}]}]},{"ID":"20240408144842-84ot8wm","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408144842-84ot8wm","updated":"20240408144842"},"Children":[{"ID":"20240408144842-7nme198","Type":"NodeParagraph","Properties":{"id":"20240408144842-7nme198","updated":"20240408144842"},"Children":[{"Type":"NodeText","Data":"优于34B的吞吐量"}]}]},{"ID":"20240408144842-k4cydpj","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408144842-k4cydpj","updated":"20240408144842"},"Children":[{"ID":"20240408144842-1lhswv6","Type":"NodeParagraph","Properties":{"id":"20240408144842-1lhswv6","updated":"20240408144842"},"Children":[{"Type":"NodeText","Data":"与7B相似的时延 最近发布的Mistral MoE使上述目标成为了可能，详见推特上的讨论（"},{"Type":"NodeTextMark","TextMarkType":"em a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Ftwitter.com%2FFrancis_YAO_%2Fstatus%2F1733686003687112983","TextMarkATitle":"https://twitter.com/Francis_YAO_/status/1733686003687112983","TextMarkTextContent":"twitter.com/Francis_YAO…"},{"Type":"NodeText","Data":" ）"}]}]}]}]}]},{"ID":"20240408145108-c1s115w","Type":"NodeParagraph","Properties":{"id":"20240408145108-c1s115w","updated":"20240408145108"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image.png"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dd7b375ac0c5474b89d7a605fbc01161~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1080\u0026h=453\u0026s=215046\u0026e=png\u0026b=ffffff"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408145108-fgyxt9q","Type":"NodeParagraph","Properties":{"id":"20240408145108-fgyxt9q","updated":"20240408145108"},"Children":[{"Type":"NodeText","Data":"如上表所示："}]},{"ID":"20240408145108-ns0vh2v","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145108-ns0vh2v","updated":"20240408145108"},"Children":[{"ID":"20240408145108-0fzd4hx","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145108-0fzd4hx","updated":"20240408145108"},"Children":[{"ID":"20240408145108-1q8ulg8","Type":"NodeParagraph","Properties":{"id":"20240408145108-1q8ulg8","updated":"20240408145108"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"性能"},{"Type":"NodeText","Data":"：50B的MoE Mistral模型，其7B的密集部分在性能上接近于34B的Yi模型和67B的DeepSeek模型"}]}]},{"ID":"20240408145108-ncvhyco","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145108-ncvhyco","updated":"20240408145108"},"Children":[{"ID":"20240408145108-vntqlj8","Type":"NodeParagraph","Properties":{"id":"20240408145108-vntqlj8","updated":"20240408145108"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"推理效率"},{"Type":"NodeText","Data":"：MoE的密集部分为7B，其中包含前2的激活单元"}]}]}]},{"ID":"20240408145108-1i2kw3a","Type":"NodeParagraph","Properties":{"id":"20240408145108-1i2kw3a","updated":"20240408145108"},"Children":[{"Type":"NodeText","Data":"Mistral MoE展示了降低更小模型成本的同时，取得与更大模型相当的性能的可能性。"}]},{"ID":"20240408145118-iwoduqj","Type":"NodeParagraph","Properties":{"id":"20240408145118-iwoduqj","updated":"20240408145121"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408145118-ff8pgii.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240408145133-ipcgayo","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145133-ipcgayo","updated":"20240408145133"},"Children":[{"ID":"20240408145133-u0o06ae","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145133-u0o06ae","updated":"20240408145133"},"Children":[{"ID":"20240408145133-qh9anoq","Type":"NodeParagraph","Properties":{"id":"20240408145133-qh9anoq","updated":"20240408145133"},"Children":[{"Type":"NodeText","Data":"参考文献："}]}]},{"ID":"20240408145133-87omxme","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145133-87omxme","updated":"20240408145133"},"Children":[{"ID":"20240408145133-ebuauhx","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145133-ebuauhx","updated":"20240408145133"},"Children":[{"ID":"20240408145133-fjsyvwn","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145133-fjsyvwn","updated":"20240408145133"},"Children":[{"ID":"20240408145133-dv2an0f","Type":"NodeParagraph","Properties":{"id":"20240408145133-dv2an0f","updated":"20240408145133"},"Children":[{"Type":"NodeText","Data":"Zhang等，2021年。"},{"Type":"NodeTextMark","TextMarkType":"em a","TextMarkAHref":"https://link.juejin.cn/?target=https%3A%2F%2Farxiv.org%2Fabs%2F2110.01786","TextMarkATitle":"https://arxiv.org/abs/2110.01786","TextMarkTextContent":"arxiv.org/abs/2110.01…"}]}]},{"ID":"20240408145133-q0nszva","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145133-q0nszva","updated":"20240408145133"},"Children":[{"ID":"20240408145133-tgtwpe3","Type":"NodeParagraph","Properties":{"id":"20240408145133-tgtwpe3","updated":"20240408145133"},"Children":[{"Type":"NodeText","Data":"Zhang等，2023年。"},{"Type":"NodeTextMark","TextMarkType":"em a","TextMarkAHref":"https://link.juejin.cn/?target=https%3A%2F%2Farxiv.org%2Fabs%2F2305.18390","TextMarkATitle":"https://arxiv.org/abs/2305.18390","TextMarkTextContent":"arxiv.org/abs/2305.18…"}]}]}]}]}]},{"ID":"20240408145154-48vvxil","Type":"NodeParagraph","Properties":{"id":"20240408145154-48vvxil"}},{"ID":"20240408145155-bkq1lps","Type":"NodeParagraph","Properties":{"id":"20240408145155-bkq1lps","updated":"20240408145155"},"Children":[{"Type":"NodeText","Data":"由Dmytro的Twitter帖子中的图表可知："}]},{"ID":"20240408145155-lbfo69f","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145155-lbfo69f","updated":"20240408145155"},"Children":[{"ID":"20240408145155-ow6vkiw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145155-ow6vkiw","updated":"20240408145155"},"Children":[{"ID":"20240408145155-js8afg2","Type":"NodeParagraph","Properties":{"id":"20240408145155-js8afg2","updated":"20240408145155"},"Children":[{"Type":"NodeText","Data":"当并发性较低时，大部分时间都用于将两个激活的专家模型加载到内存中，这比密集层小，因此需要的内存访问时间更少，从而降低了时延。"}]}]}]},{"ID":"20240408145155-hrdzop6","Type":"NodeParagraph","Properties":{"id":"20240408145155-hrdzop6","updated":"20240408145155"},"Children":[{"Type":"NodeText","Data":"换句话说，对于单个查询，MoE的时延低于密集层，因为我们需要从内存中读取的参数更少。"}]},{"ID":"20240408145155-hcu2iqy","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145155-hcu2iqy","updated":"20240408145155"},"Children":[{"ID":"20240408145155-z7p7bfw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145155-z7p7bfw","updated":"20240408145155"},"Children":[{"ID":"20240408145155-w8eg3zm","Type":"NodeParagraph","Properties":{"id":"20240408145155-w8eg3zm","updated":"20240408145155"},"Children":[{"Type":"NodeText","Data":"当并发性较高时，我们进入了flop限制的状态，但由于MoE的激活少于密集层，因此吞吐量更高。"}]}]}]},{"ID":"20240408145155-c5prfs7","Type":"NodeParagraph","Properties":{"id":"20240408145155-c5prfs7","updated":"20240408145155"},"Children":[{"Type":"NodeText","Data":"换句话说，对于许多并发查询，MoE具有更高的吞吐量，因为："}]},{"ID":"20240408145210-svh11l8","Type":"NodeParagraph","Properties":{"id":"20240408145210-svh11l8","updated":"20240408145210"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408145210-ku8ochd.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408145955-60mhayj","Type":"NodeParagraph","Properties":{"id":"20240408145955-60mhayj","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"随之而来的一个问题是，假如我已经训练了一个大型密集模型，是否可以将其"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"转换为MoE模型"},{"Type":"NodeText","Data":"？"}]},{"ID":"20240408145955-5fcrepw","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-5fcrepw","updated":"20240408145955"},"Children":[{"ID":"20240408145955-ne095ed","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-ne095ed","updated":"20240408145955"},"Children":[{"ID":"20240408145955-z6ud1jl","Type":"NodeParagraph","Properties":{"id":"20240408145955-z6ud1jl","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"MoE化（MoEfication）：将一个密集模型分解为MoE模型，使其"}]}]},{"ID":"20240408145955-nbspy4h","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-nbspy4h","updated":"20240408145955"},"Children":[{"ID":"20240408145955-ai3o9h5","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-ai3o9h5","updated":"20240408145955"},"Children":[{"ID":"20240408145955-gd0x6we","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-gd0x6we","updated":"20240408145955"},"Children":[{"ID":"20240408145955-fbygma5","Type":"NodeParagraph","Properties":{"id":"20240408145955-fbygma5","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"具有小型模型的高效"}]}]},{"ID":"20240408145955-7jk38o7","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-7jk38o7","updated":"20240408145955"},"Children":[{"ID":"20240408145955-e2jnjq6","Type":"NodeParagraph","Properties":{"id":"20240408145955-e2jnjq6","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"同时拥有大型密集模型的强大性能。"}]}]}]}]},{"ID":"20240408145955-yy52q4x","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-yy52q4x","updated":"20240408145955"},"Children":[{"ID":"20240408145955-0idfmca","Type":"NodeParagraph","Properties":{"id":"20240408145955-0idfmca","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"参考文献："}]}]},{"ID":"20240408145955-ju4vclk","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-ju4vclk","updated":"20240408145955"},"Children":[{"ID":"20240408145955-52gzqn9","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-52gzqn9","updated":"20240408145955"},"Children":[{"ID":"20240408145955-ok64jpp","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-ok64jpp","updated":"20240408145955"},"Children":[{"ID":"20240408145955-bmno4cv","Type":"NodeParagraph","Properties":{"id":"20240408145955-bmno4cv","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"Zhang等，2021年。"},{"Type":"NodeTextMark","TextMarkType":"em a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2110.01786","TextMarkATitle":"https://arxiv.org/abs/2110.01786","TextMarkTextContent":"arxiv.org/abs/2110.01…"}]}]},{"ID":"20240408145955-uiztdjo","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-uiztdjo","updated":"20240408145955"},"Children":[{"ID":"20240408145955-jtqoauu","Type":"NodeParagraph","Properties":{"id":"20240408145955-jtqoauu","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"Zhang等，2023年。"},{"Type":"NodeTextMark","TextMarkType":"em a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2305.18390","TextMarkATitle":"https://arxiv.org/abs/2305.18390","TextMarkTextContent":"arxiv.org/abs/2305.18…"}]}]}]}]}]},{"ID":"20240408145955-aca6pdd","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408145955-aca6pdd","updated":"20240408150644"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"提前退出"}]},{"ID":"20240408145955-grhk44k","Type":"NodeParagraph","Properties":{"id":"20240408145955-grhk44k","updated":"20240408150644"},"Children":[{"Type":"NodeText","Data":"此处的要点是：对于简单词元，我们不需要计算所有的Transformer层，计算部分层就够了，因为它们是简单词元。"}]},{"ID":"20240408145955-fd2xpan","Type":"NodeParagraph","Properties":{"id":"20240408145955-fd2xpan","updated":"20240408150800"},"Children":[{"Type":"NodeText","Data":"​​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408150800-4ojqde4.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​​"}]},{"ID":"20240408145955-jk9kjvl","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-jk9kjvl","updated":"20240408150644"},"Children":[{"ID":"20240408145955-d1746aw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-d1746aw","updated":"20240408145955"},"Children":[{"ID":"20240408145955-6nvrfkc","Type":"NodeParagraph","Properties":{"id":"20240408145955-6nvrfkc","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"对于所有词元，使用一个门控（gate）来确定是否提前退出或继续计算"}]}]}]},{"ID":"20240408145955-0bt8zor","Type":"NodeParagraph","Properties":{"id":"20240408145955-0bt8zor","updated":"20240408150644"},"Children":[{"Type":"NodeText","Data":"参考文献："}]},{"ID":"20240408145955-4bcnx29","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-4bcnx29","updated":"20240408150644"},"Children":[{"ID":"20240408145955-grzqzuq","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-grzqzuq","updated":"20240408145955"},"Children":[{"ID":"20240408145955-am0pguu","Type":"NodeParagraph","Properties":{"id":"20240408145955-am0pguu","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"Schuster等，2022年。Confident Adaptive Language Modeling"}]}]},{"ID":"20240408145955-4dvc75b","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-4dvc75b","updated":"20240408145955"},"Children":[{"ID":"20240408145955-k6glr7h","Type":"NodeParagraph","Properties":{"id":"20240408145955-k6glr7h","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"Bae等，2023年。"},{"Type":"NodeTextMark","TextMarkType":"em a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2310.05424","TextMarkATitle":"https://arxiv.org/abs/2310.05424","TextMarkTextContent":"arxiv.org/abs/2310.05…"}]}]}]},{"ID":"20240408145955-iwpet3z","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408145955-iwpet3z","updated":"20240408150652"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"分块解码"}]},{"ID":"20240408145955-2cpukj7","Type":"NodeParagraph","Properties":{"id":"20240408145955-2cpukj7","updated":"20240408150652"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"推测性解码"}]},{"ID":"20240408145955-s0uosb9","Type":"NodeParagraph","Properties":{"id":"20240408145955-s0uosb9","updated":"20240408150652"},"Children":[{"Type":"NodeText","Data":"关键在于，逐词元解码不能充分利用SM的计算能力，因此我们希望能够一次解码多个词元。以下文章值得参考："}]},{"ID":"20240408145955-um4g9om","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-um4g9om","updated":"20240408150652"},"Children":[{"ID":"20240408145955-h20t7d7","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-h20t7d7","updated":"20240408145955"},"Children":[{"ID":"20240408145955-8tdob04","Type":"NodeParagraph","Properties":{"id":"20240408145955-8tdob04","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"em","TextMarkTextContent":"Leviathan et. al. 2022. Fast Inference from Transformers via Speculative Decoding"}]}]},{"ID":"20240408145955-5rvcj7j","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-5rvcj7j","updated":"20240408145955"},"Children":[{"ID":"20240408145955-malqjgp","Type":"NodeParagraph","Properties":{"id":"20240408145955-malqjgp","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"em","TextMarkTextContent":"Chen et. al. 2023. Accelerating Large Language Model Decoding with Speculative Sampling"}]}]},{"ID":"20240408145955-dycgvka","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-dycgvka","updated":"20240408145955"},"Children":[{"ID":"20240408145955-xh7dh8i","Type":"NodeParagraph","Properties":{"id":"20240408145955-xh7dh8i","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"em","TextMarkTextContent":"Liu et. al. 2023. Online Speculative Decoding"}]}]},{"ID":"20240408145955-08gn34u","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-08gn34u","updated":"20240408145955"},"Children":[{"ID":"20240408145955-bt2vsqg","Type":"NodeParagraph","Properties":{"id":"20240408145955-bt2vsqg","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"em","TextMarkTextContent":"Leviathan等，2022年。Fast Inference from Transformers via Speculative Decoding"}]}]},{"ID":"20240408145955-48i13at","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-48i13at","updated":"20240408145955"},"Children":[{"ID":"20240408145955-dbfr6s6","Type":"NodeParagraph","Properties":{"id":"20240408145955-dbfr6s6","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"em","TextMarkTextContent":"Chen等，2023年。Accelerating Large Language Model Decoding with Speculative Sampling"}]}]},{"ID":"20240408145955-4cw5ftd","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-4cw5ftd","updated":"20240408145955"},"Children":[{"ID":"20240408145955-e3nmssu","Type":"NodeParagraph","Properties":{"id":"20240408145955-e3nmssu","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"em","TextMarkTextContent":"Liu等，2023年。Online Speculative Decoding"}]}]}]},{"ID":"20240408145955-p9yh3ni","Type":"NodeParagraph","Properties":{"id":"20240408145955-p9yh3ni","updated":"20240408150909"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408150901-q1wks1c.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408145955-ogjabt3","Type":"NodeParagraph","Properties":{"id":"20240408145955-ogjabt3","updated":"20240408150652"},"Children":[{"Type":"NodeText","Data":"使用小型草稿模型（draft model）存在以下缺点："}]},{"ID":"20240408145955-cu1mgpq","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-cu1mgpq","updated":"20240408150652"},"Children":[{"ID":"20240408145955-gqwvlz3","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-gqwvlz3","updated":"20240408145955"},"Children":[{"ID":"20240408145955-8lvwygu","Type":"NodeParagraph","Properties":{"id":"20240408145955-8lvwygu","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"性能较弱，因此在一些具有挑战性的领域（如编码）中，拒绝率（rejection rate）可能较高。"}]}]},{"ID":"20240408145955-yommxxo","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-yommxxo","updated":"20240408145955"},"Children":[{"ID":"20240408145955-97w1s0h","Type":"NodeParagraph","Properties":{"id":"20240408145955-97w1s0h","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"我们需要在GPU中放入两个模型，但这已经耗尽了GPU内存。"}]}]}]},{"ID":"20240408145955-qvsl2mu","Type":"NodeParagraph","Properties":{"id":"20240408145955-qvsl2mu","updated":"20240408150652"},"Children":[{"Type":"NodeText","Data":"因此，我们希望将大模型作为自身的提案模型（proposal model），因为"}]},{"ID":"20240408145955-387sxjq","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-387sxjq","updated":"20240408150652"},"Children":[{"ID":"20240408145955-03onasc","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-03onasc","updated":"20240408145955"},"Children":[{"ID":"20240408145955-l2n3ebi","Type":"NodeParagraph","Properties":{"id":"20240408145955-l2n3ebi","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"性能较强，因此可以降低拒绝率。"}]}]},{"ID":"20240408145955-9ev63f6","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-9ev63f6","updated":"20240408145955"},"Children":[{"ID":"20240408145955-cr6h6s8","Type":"NodeParagraph","Properties":{"id":"20240408145955-cr6h6s8","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"只需在内存中保留一个模型。"}]}]}]},{"ID":"20240408145955-96jovjy","Type":"NodeParagraph","Properties":{"id":"20240408145955-96jovjy","updated":"20240408150652"},"Children":[{"Type":"NodeText","Data":"这就是我们推行"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Medusa"},{"Type":"NodeText","Data":"的原因："}]},{"ID":"20240408145955-f3wc7lm","Type":"NodeParagraph","Properties":{"id":"20240408145955-f3wc7lm","updated":"20240408150652"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image.png"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2cdde25cc5074e3cb3495cd4fae6a8c2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=554\u0026h=429\u0026s=90829\u0026e=png\u0026b=faf6f6"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408145955-b38ez2l","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-b38ez2l","updated":"20240408145955"},"Children":[{"ID":"20240408145955-bo7dsf9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-bo7dsf9","updated":"20240408145955"},"Children":[{"ID":"20240408145955-908rzxc","Type":"NodeParagraph","Properties":{"id":"20240408145955-908rzxc","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"使用多头同时解码多个词元"}]}]},{"ID":"20240408145955-5oiql49","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-5oiql49","updated":"20240408145955"},"Children":[{"ID":"20240408145955-7ddj52u","Type":"NodeParagraph","Properties":{"id":"20240408145955-7ddj52u","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"使用大模型本身作为草稿模型"}]}]}]},{"ID":"20240408145955-l1v8nj7","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240408145955-l1v8nj7","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"本文尚未涵盖的内容"}]},{"ID":"20240408145955-zx19ugz","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-zx19ugz","updated":"20240408145955"},"Children":[{"ID":"20240408145955-g3d0jo4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-g3d0jo4","updated":"20240408145955"},"Children":[{"ID":"20240408145955-1actucu","Type":"NodeParagraph","Properties":{"id":"20240408145955-1actucu","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"深水（Deep water）硬件和MLSys"}]}]},{"ID":"20240408145955-eshq2ry","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-eshq2ry","updated":"20240408145955"},"Children":[{"ID":"20240408145955-58q0ff3","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-58q0ff3","updated":"20240408145955"},"Children":[{"ID":"20240408145955-vwhvlpx","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-vwhvlpx","updated":"20240408145955"},"Children":[{"ID":"20240408145955-w32pxhb","Type":"NodeParagraph","Properties":{"id":"20240408145955-w32pxhb","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"我对MLSys还很陌生，因此不得不向朋友询问自己的理解是否正确。因此，尽管我尝试覆盖最重要的基础知识，但我对MLSys的理解仍然仅是皮毛。"}]}]},{"ID":"20240408145955-0y8na79","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-0y8na79","updated":"20240408145955"},"Children":[{"ID":"20240408145955-0t0rlox","Type":"NodeParagraph","Properties":{"id":"20240408145955-0t0rlox","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"还有许多涵盖硬件和MLSys的精彩文章，我将在文末添加相关参考文献"}]}]}]}]},{"ID":"20240408145955-0vjpok3","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-0vjpok3","updated":"20240408145955"},"Children":[{"ID":"20240408145955-2tfg6rs","Type":"NodeParagraph","Properties":{"id":"20240408145955-2tfg6rs","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"超大模型的"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"分布式推理"},{"Type":"NodeText","Data":"。参见Pope等人的Efficiently Scaling Transformer Inference（*"},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2211.05102*%25EF%25BC%2589","TextMarkATitle":"https://arxiv.org/abs/2211.05102*%EF%BC%89","TextMarkTextContent":"arxiv.org/abs/2211.05…"}]}]},{"ID":"20240408145955-wa5t56l","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-wa5t56l","updated":"20240408145955"},"Children":[{"ID":"20240408145955-6dg1n54","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-6dg1n54","updated":"20240408145955"},"Children":[{"ID":"20240408145955-ppg4xtz","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-ppg4xtz","updated":"20240408145955"},"Children":[{"ID":"20240408145955-4mzx9eq","Type":"NodeParagraph","Properties":{"id":"20240408145955-4mzx9eq","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"关键技术：模型分片（model sharding）、流水并行和张量并行"}]}]},{"ID":"20240408145955-eyya9pm","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-eyya9pm","updated":"20240408145955"},"Children":[{"ID":"20240408145955-8twigqq","Type":"NodeParagraph","Properties":{"id":"20240408145955-8twigqq","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"持续批处理"},{"Type":"NodeText","Data":"和类似的库DeepSpeed MII（*"},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2FDeepSpeed-MII*%25EF%25BC%2589","TextMarkATitle":"https://github.com/microsoft/DeepSpeed-MII*%EF%BC%89","TextMarkTextContent":"github.com/microsoft/D…"}]}]}]}]},{"ID":"20240408145955-b14thjl","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-b14thjl","updated":"20240408145955"},"Children":[{"ID":"20240408145955-6pnikzq","Type":"NodeParagraph","Properties":{"id":"20240408145955-6pnikzq","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"对蒸馏的详细讨论"}]}]},{"ID":"20240408145955-dswiohf","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-dswiohf","updated":"20240408145955"},"Children":[{"ID":"20240408145955-t2lnwdb","Type":"NodeParagraph","Properties":{"id":"20240408145955-t2lnwdb","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"更进阶的分块解码"}]}]},{"ID":"20240408145955-tldelot","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-tldelot","updated":"20240408145955"},"Children":[{"ID":"20240408145955-whlpjhr","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-whlpjhr","updated":"20240408145955"},"Children":[{"ID":"20240408145955-iivk4l2","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-iivk4l2","updated":"20240408145955"},"Children":[{"ID":"20240408145955-n8rq1vw","Type":"NodeParagraph","Properties":{"id":"20240408145955-n8rq1vw","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"前向解码（"},{"Type":"NodeTextMark","TextMarkType":"em","TextMarkTextContent":"lookahead decoding，"},{"Type":"NodeTextMark","TextMarkType":"em a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Flmsys.org%2Fblog%2F2023-11-21-lookahead-decoding%2F","TextMarkATitle":"https://lmsys.org/blog/2023-11-21-lookahead-decoding/","TextMarkTextContent":"lmsys.org/blog/2023-1…"},{"Type":"NodeText","Data":" ）"}]}]},{"ID":"20240408145955-3jt27yp","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-3jt27yp","updated":"20240408145955"},"Children":[{"ID":"20240408145955-bpc2ou8","Type":"NodeParagraph","Properties":{"id":"20240408145955-bpc2ou8","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"基于检索的推测性解码（*"},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFasterDecoding%2FREST*%25EF%25BC%2589","TextMarkATitle":"https://github.com/FasterDecoding/REST*%EF%BC%89","TextMarkTextContent":"github.com/FasterDecod…"}]}]},{"ID":"20240408145955-p6npkaw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-p6npkaw","updated":"20240408145955"},"Children":[{"ID":"20240408145955-hp5d2yb","Type":"NodeParagraph","Properties":{"id":"20240408145955-hp5d2yb","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"EAGLE（*"},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Fsites.google.com%2Fview%2Feagle-llm*%25EF%25BC%2589","TextMarkATitle":"https://sites.google.com/view/eagle-llm*%EF%BC%89","TextMarkTextContent":"sites.google.com/view/eagle-…"}]}]}]}]}]},{"ID":"20240408145955-7p3lozg","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240408145955-7p3lozg","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"个人选择"}]},{"ID":"20240408145955-gp4jb27","Type":"NodeParagraph","Properties":{"id":"20240408145955-gp4jb27","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"不幸的是，对于大部分模型架构论文而言，其收益和真正重要的工作大多来自MLSys，而非来自论文。"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"实际上，许多花哨的论文并不切合实际，它们无法兼容SOTA MLSys的最新进展，如模型并行和Flash Attention"},{"Type":"NodeText","Data":"。因此，亲爱的研究同行们，是时候动手实践，仔细研究真正的代码了。"}]},{"ID":"20240408145955-tcd666e","Type":"NodeParagraph","Properties":{"id":"20240408145955-tcd666e","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"然而，确实有一些来自建模方面的性能收益，以下是我最喜欢的技术，以备你的不时之需：​​"}]},{"ID":"20240408145955-ibu6z1u","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240408145955-ibu6z1u","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"结论"}]},{"ID":"20240408145955-fthdl1k","Type":"NodeParagraph","Properties":{"id":"20240408145955-fthdl1k","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"本文回顾了从GPU架构到MLsys方法，从模型架构到解码算法的全栈Transformer推理优化方法。可以看出，大部分性能提升都来自于一个原则的利用：Transformer推理受内存限制，因此我们可以释放额外的计算能力/flops。其次，优化要么来自于优化内存访问，比如Flash Attention和Paged Attention，要么来自于释放计算能力，比如Medusa和前向解码。"}]},{"ID":"20240408145955-81bmzje","Type":"NodeParagraph","Properties":{"id":"20240408145955-81bmzje","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"我们相信MLSys和建模仍有许多改进空间。在即将到来的2024年，随着模型变得更大、上下文变得更长以及随着更多开源MoE（混合专家模型）、更高内存带宽和更大内存容量的硬件，以及具有更大DRAM和专用计算引擎的移动设备的亮相，将出现更强大且人人可操作、可访问的AI。一个新时代即将到来。"}]},{"ID":"20240408145955-2wtrx0d","Type":"NodeParagraph","Properties":{"id":"20240408145955-2wtrx0d","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"参考文献"}]},{"ID":"20240408145955-fka0btp","Type":"NodeList","ListData":{},"Properties":{"id":"20240408145955-fka0btp","updated":"20240408145955"},"Children":[{"ID":"20240408145955-pw8iu3m","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-pw8iu3m","updated":"20240408145955"},"Children":[{"ID":"20240408145955-gh4u3mg","Type":"NodeParagraph","Properties":{"id":"20240408145955-gh4u3mg","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Fpytorch.org%2Fblog%2Faccelerating-generative-ai-2%2F","TextMarkATitle":"https://pytorch.org/blog/accelerating-generative-ai-2/","TextMarkTextContent":"pytorch.org/blog/accele…"}]}]},{"ID":"20240408145955-ac1mm6f","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-ac1mm6f","updated":"20240408145955"},"Children":[{"ID":"20240408145955-jmqrlmx","Type":"NodeParagraph","Properties":{"id":"20240408145955-jmqrlmx","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2302.14017","TextMarkATitle":"https://arxiv.org/abs/2302.14017","TextMarkTextContent":"arxiv.org/abs/2302.14…"}]}]},{"ID":"20240408145955-ivp7whe","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-ivp7whe","updated":"20240408145955"},"Children":[{"ID":"20240408145955-1u4yt41","Type":"NodeParagraph","Properties":{"id":"20240408145955-1u4yt41","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2211.05102","TextMarkATitle":"https://arxiv.org/abs/2211.05102","TextMarkTextContent":"arxiv.org/abs/2211.05…"}]}]},{"ID":"20240408145955-32m77b5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-32m77b5","updated":"20240408145955"},"Children":[{"ID":"20240408145955-esv193p","Type":"NodeParagraph","Properties":{"id":"20240408145955-esv193p","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Fkipp.ly%2Ftransformer-inference-arithmetic%2F","TextMarkATitle":"https://kipp.ly/transformer-inference-arithmetic/","TextMarkTextContent":"kipp.ly/transformer…"}]}]},{"ID":"20240408145955-fpm63c4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-fpm63c4","updated":"20240408145955"},"Children":[{"ID":"20240408145955-oqiqjbt","Type":"NodeParagraph","Properties":{"id":"20240408145955-oqiqjbt","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Fdocs.nvidia.com%2Fdeeplearning%2Fperformance%2Fdl-performance-gpu-background%2Findex.html","TextMarkATitle":"https://docs.nvidia.com/deeplearning/performance/dl-performance-gpu-background/index.html","TextMarkTextContent":"docs.nvidia.com/deeplearnin…"}]}]},{"ID":"20240408145955-roo07eu","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-roo07eu","updated":"20240408145955"},"Children":[{"ID":"20240408145955-wvyv57a","Type":"NodeParagraph","Properties":{"id":"20240408145955-wvyv57a","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Fwww.baseten.co%2Fblog%2Fllm-transformer-inference-guide%2F","TextMarkATitle":"https://www.baseten.co/blog/llm-transformer-inference-guide/","TextMarkTextContent":"www.baseten.co/blog/llm-tr…"}]}]},{"ID":"20240408145955-rqnsaq1","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-rqnsaq1","updated":"20240408145955"},"Children":[{"ID":"20240408145955-oejyo00","Type":"NodeParagraph","Properties":{"id":"20240408145955-oejyo00","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Fcursor.sh%2Fblog%2Fllama-inference","TextMarkATitle":"https://cursor.sh/blog/llama-inference","TextMarkTextContent":"cursor.sh/blog/llama-…"}]}]},{"ID":"20240408145955-bcmozxt","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-bcmozxt","updated":"20240408145955"},"Children":[{"ID":"20240408145955-mv8pdan","Type":"NodeParagraph","Properties":{"id":"20240408145955-mv8pdan","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Flilianweng.github.io%2Fposts%2F2023-01-10-inference-optimization%2F","TextMarkATitle":"https://lilianweng.github.io/posts/2023-01-10-inference-optimization/","TextMarkTextContent":"lilianweng.github.io/posts/2023-…"}]}]},{"ID":"20240408145955-b4tlhso","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408145955-b4tlhso","updated":"20240408145955"},"Children":[{"ID":"20240408145955-rgb13ve","Type":"NodeParagraph","Properties":{"id":"20240408145955-rgb13ve","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2311.03687","TextMarkATitle":"https://arxiv.org/abs/2311.03687","TextMarkTextContent":"arxiv.org/abs/2311.03…"}]}]}]},{"ID":"20240408145955-1d58air","Type":"NodeParagraph","Properties":{"id":"20240408145955-1d58air","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"欢迎 Star、试用 OneFlow 最新版本："}]},{"ID":"20240408145955-kpmm0z8","Type":"NodeParagraph","Properties":{"id":"20240408145955-kpmm0z8","updated":"20240408145955"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOneflow-Inc%2Foneflow%2F","TextMarkATitle":"https://github.com/Oneflow-Inc/oneflow/","TextMarkTextContent":"github.com/Oneflow-Inc…"}]},{"ID":"20240408145955-z1z92l6","Type":"NodeParagraph","Properties":{"id":"20240408145955-z1z92l6","updated":"20240408145955"},"Children":[{"Type":"NodeText","Data":"作者：OneFlow一流科技\n链接：https://juejin.cn/post/7316968330313138202\n来源：稀土掘金\n著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}]}]}