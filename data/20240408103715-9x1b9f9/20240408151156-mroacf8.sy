{"ID":"20240408151156-mroacf8","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f992","id":"20240408151156-mroacf8","title":"LLM基础知识备忘录","updated":"20240408165148"},"Children":[{"ID":"20240408151226-ej38clq","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240408151226-ej38clq","updated":"20240408151240"},"Children":[{"Type":"NodeText","Data":"预训练相关"}]},{"ID":"20240408151240-fxmmcuv","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408151240-fxmmcuv","updated":"20240408151303"},"Children":[{"Type":"NodeText","Data":"LearningRate 和 BatchSize 之间的关系"}]},{"ID":"20240408151156-lpdkang","Type":"NodeBlockquote","Properties":{"id":"20240408151156-lpdkang","updated":"20240408151318"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20240408151318-4kaz9es","Type":"NodeParagraph","Properties":{"id":"20240408151318-4kaz9es","updated":"20240408151318"},"Children":[{"Type":"NodeText","Data":"假设batch_size足够小，等于1，如果lr设的比较大则容易导致loss发散；假设batch_size足够大，等于全量的数据，如果这个时候lr设的小则收敛会很慢。所以理论上来说，batch_size和模型参数增大，较小的lr并不是说不收敛，而是可能需要更多的steps才能收敛，因此需要适当增大lr。"}]}]},{"ID":"20240408151412-7c2orwr","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408151412-7c2orwr","updated":"20240408151412"},"Children":[{"Type":"NodeText","Data":"关于位置编码"}]},{"ID":"20240408151412-to3p2pq","Type":"NodeList","ListData":{},"Properties":{"id":"20240408151412-to3p2pq","updated":"20240408151412"},"Children":[{"ID":"20240408151412-z09yg4t","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408151412-z09yg4t","updated":"20240408151518"},"Children":[{"ID":"20240408151412-e557vdj","Type":"NodeParagraph","Properties":{"id":"20240408151412-e557vdj","updated":"20240408151518"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"strong code","TextMarkTextContent":"sinusoidal"},{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"位置编码"}]}]}]},{"ID":"20240408151530-990w0l1","Type":"NodeParagraph","Properties":{"id":"20240408151530-990w0l1","updated":"20240408151412"},"Children":[{"Type":"NodeText","Data":"考虑两个位置 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"i"},{"Type":"NodeText","Data":" 和 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"j"},{"Type":"NodeText","Data":"，由于正弦和余弦函数的性质，位置编码的差值PE(i)−PE(j)将与"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"i"},{"Type":"NodeText","Data":"和"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"j"},{"Type":"NodeText","Data":"之间的差值有关。这意味着通过比较不同位置编码之间的差值，模型可以推断出它们之间的相对位置。"}]},{"ID":"20240408151426-rla3w3w","Type":"NodeParagraph","Properties":{"id":"20240408151426-rla3w3w","updated":"20240408151412"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408151426-t32y9dc.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408151412-rekq0o5","Type":"NodeList","ListData":{},"Properties":{"id":"20240408151412-rekq0o5","updated":"20240408151412"},"Children":[{"ID":"20240408151412-b7hnppu","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408151412-b7hnppu","updated":"20240408151412"},"Children":[{"ID":"20240408151412-sczizps","Type":"NodeParagraph","Properties":{"id":"20240408151412-sczizps","updated":"20240408151412"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"strong code","TextMarkTextContent":"ROPE"},{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"相对位置编码"}]}]}]},{"ID":"20240408151630-p3ll6p6","Type":"NodeParagraph","Properties":{"id":"20240408151630-p3ll6p6","updated":"20240408151412"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408151629-d1etjlp.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408151412-u2w4nhi","Type":"NodeList","ListData":{},"Properties":{"id":"20240408151412-u2w4nhi","updated":"20240408151412"},"Children":[{"ID":"20240408151412-vws2vl5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408151412-vws2vl5","updated":"20240408151412"},"Children":[{"ID":"20240408151412-i287ev5","Type":"NodeParagraph","Properties":{"id":"20240408151412-i287ev5","updated":"20240408151412"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"strong code","TextMarkTextContent":"ALiBi"},{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"位置编码"}]}]}]},{"ID":"20240408151649-0yzdq2n","Type":"NodeParagraph","Properties":{"id":"20240408151649-0yzdq2n","updated":"20240408151412"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408151649-qqaaylh.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408151412-7pzcrv1","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408151412-7pzcrv1","updated":"20240408151412"},"Children":[{"Type":"NodeText","Data":"Pre-Norm和Post-Norm的差异和优劣"}]},{"ID":"20240408151412-23i0isp","Type":"NodeList","ListData":{},"Properties":{"id":"20240408151412-23i0isp","updated":"20240408151412"},"Children":[{"ID":"20240408151412-954silj","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408151412-954silj","updated":"20240408151412"},"Children":[{"ID":"20240408151412-mepsbaf","Type":"NodeParagraph","Properties":{"id":"20240408151412-mepsbaf","updated":"20240408151412"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn/?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F662794447","TextMarkATitle":"https://zhuanlan.zhihu.com/p/662794447","TextMarkTextContent":"理解Pre-Norm和Post-Norm"}]}]},{"ID":"20240408151412-rh4gg33","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408151412-rh4gg33","updated":"20240408151412"},"Children":[{"ID":"20240408151412-rhjn1a9","Type":"NodeParagraph","Properties":{"id":"20240408151412-rhjn1a9","updated":"20240408151412"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn/?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F494661681","TextMarkATitle":"https://zhuanlan.zhihu.com/p/494661681","TextMarkTextContent":"为什么Pre-Norm不如Post-Norm"}]}]}]},{"ID":"20240408151652-3vfffey","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408151652-3vfffey","updated":"20240408151839"},"Children":[{"Type":"NodeText","Data":"DeepSeek 要点"}]},{"ID":"20240408151839-akzivyv","Type":"NodeList","ListData":{},"Properties":{"id":"20240408151839-akzivyv","updated":"20240408151839"},"Children":[{"ID":"20240408151841-jyimcnx","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408151841-jyimcnx","updated":"20240408151841"},"Children":[{"ID":"20240408151841-556donq","Type":"NodeParagraph","Properties":{"id":"20240408151841-556donq","updated":"20240408151854"},"Children":[{"Type":"NodeText","Data":"学习率细节：2000个warmup steps之后达到最大值，在80%的tokens之后学习率下降到最大值的31.6%，90%的tokens之后下降到最大值的10%。 最终模型表现上，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"multi-step scheduler"},{"Type":"NodeText","Data":"​和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"cosine scheduler"},{"Type":"NodeText","Data":"​基本保持一致；而"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"multi-step"},{"Type":"NodeText","Data":"​的优势是，在保持模型大小固定调整训练规模时，可以重用第一阶段训练的结果，这比较方便后续的 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"继续训练"},{"Type":"NodeText","Data":" 。"}]}]},{"ID":"20240408151856-m6b2ciy","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408151856-m6b2ciy"},"Children":[{"ID":"20240408151856-f71mpt1","Type":"NodeParagraph","Properties":{"id":"20240408151856-f71mpt1","updated":"20240408151908"},"Children":[{"Type":"NodeText","Data":"梯度的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"grad clip"},{"Type":"NodeText","Data":"​ 设为1.0"}]}]},{"ID":"20240408151911-z5oi0w0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408151911-z5oi0w0"},"Children":[{"ID":"20240408151911-h60c05u","Type":"NodeParagraph","Properties":{"id":"20240408151911-h60c05u","updated":"20240408151922"},"Children":[{"Type":"NodeText","Data":"分布式策略："}]},{"ID":"20240408151923-t93bhlq","Type":"NodeList","ListData":{},"Properties":{"id":"20240408151923-t93bhlq","updated":"20240408151925"},"Children":[{"ID":"20240408151925-amtzo9r","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408151925-amtzo9r","updated":"20240408151925"},"Children":[{"ID":"20240408151925-nhgatcx","Type":"NodeParagraph","Properties":{"id":"20240408151925-nhgatcx","updated":"20240408151953"},"Children":[{"Type":"NodeText","Data":"数据并行、张量并行、序列并行、1F1B的流水线并行"}]}]},{"ID":"20240408151953-o0h6wn1","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408151953-o0h6wn1"},"Children":[{"ID":"20240408151953-oepjt4o","Type":"NodeParagraph","Properties":{"id":"20240408151953-oepjt4o","updated":"20240408151959"},"Children":[{"Type":"NodeText","Data":"flash attention "}]}]},{"ID":"20240408152000-x7u2hg4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152000-x7u2hg4"},"Children":[{"ID":"20240408152000-yo56f1i","Type":"NodeParagraph","Properties":{"id":"20240408152000-yo56f1i","updated":"20240408152033"},"Children":[{"Type":"NodeText","Data":"ZeRO-1用于根据数据并行排列划分优化器状态"}]}]},{"ID":"20240408152034-5ds7mb9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152034-5ds7mb9"},"Children":[{"ID":"20240408152034-cjm8hrx","Type":"NodeParagraph","Properties":{"id":"20240408152034-cjm8hrx","updated":"20240408152056"},"Children":[{"Type":"NodeText","Data":"模型参数的精度为bf16，梯度的精度为 fp32"}]}]}]}]},{"ID":"20240408152057-gi5c4tw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152057-gi5c4tw"},"Children":[{"ID":"20240408152057-7cx3d87","Type":"NodeParagraph","Properties":{"id":"20240408152057-7cx3d87","updated":"20240408152131"},"Children":[{"Type":"NodeText","Data":"模型权重和优化器状态每5分钟同步，并且逐步清除之前保存的ckpt"}]}]},{"ID":"20240408152131-ias14wu","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152131-ias14wu"},"Children":[{"ID":"20240408152131-gr8tz5k","Type":"NodeParagraph","Properties":{"id":"20240408152131-gr8tz5k","updated":"20240408152142"},"Children":[{"Type":"NodeText","Data":"Scaling Law"}]},{"ID":"20240408152158-h94904z","Type":"NodeList","ListData":{},"Properties":{"id":"20240408152158-h94904z","updated":"20240408152158"},"Children":[{"ID":"20240408152158-x1mmksx","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152158-x1mmksx","updated":"20240408152158"},"Children":[{"ID":"20240408152158-9e92dqa","Type":"NodeParagraph","Properties":{"id":"20240408152158-9e92dqa","updated":"20240408152158"},"Children":[{"Type":"NodeText","Data":"数据质量越高，越可以将更多的计算预算分配给"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"模型规模"}]}]},{"ID":"20240408152158-ydb79cd","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152158-ydb79cd","updated":"20240408152158"},"Children":[{"ID":"20240408152158-y9q0ig5","Type":"NodeParagraph","Properties":{"id":"20240408152158-y9q0ig5","updated":"20240408152158"},"Children":[{"Type":"NodeText","Data":"随着模型计算量的增大（即模型规模增大），最优的batch_size也在增大，最优的learning_rate呈现减小的趋势"}]}]}]}]}]},{"ID":"20240408152218-ife7d0y","Type":"NodeList","ListData":{},"Properties":{"id":"20240408152218-ife7d0y","updated":"20240408151839"},"Children":[{"ID":"20240408152218-bl3t8m0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152218-bl3t8m0","updated":"20240408152218"},"Children":[{"ID":"20240408152218-0ficn7r","Type":"NodeParagraph","Properties":{"id":"20240408152218-0ficn7r","updated":"20240408152218"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Alignment"},{"Type":"NodeText","Data":"：收集了150w中英文instruction数据，其中helpful数据有120w，31.2%是通用语言任务，46.6%是数学问题，22.2%是代码问题；安全数据有300K条，包含不同的敏感话题"}]},{"ID":"20240408152218-te8akiu","Type":"NodeList","ListData":{},"Properties":{"id":"20240408152218-te8akiu","updated":"20240408152218"},"Children":[{"ID":"20240408152218-tui3dzy","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152218-tui3dzy","updated":"20240408152218"},"Children":[{"ID":"20240408152218-sclav1w","Type":"NodeParagraph","Properties":{"id":"20240408152218-sclav1w","updated":"20240408152218"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"有监督微调"},{"Type":"NodeTextMark","TextMarkType":"strong code","TextMarkTextContent":"SFT"},{"Type":"NodeText","Data":"​"}]},{"ID":"20240408152218-i7aaau5","Type":"NodeList","ListData":{},"Properties":{"id":"20240408152218-i7aaau5","updated":"20240408152218"},"Children":[{"ID":"20240408152218-iajk4fa","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152218-iajk4fa","updated":"20240408152218"},"Children":[{"ID":"20240408152218-jgf7ez0","Type":"NodeParagraph","Properties":{"id":"20240408152218-jgf7ez0","updated":"20240408152218"},"Children":[{"Type":"NodeText","Data":"7B模型微调了4个epoch，67B模型只微调2个epoch，学习率分别是"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"1e-5"},{"Type":"NodeText","Data":"​和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"5e-6"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240408152218-8rdmzg6","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152218-8rdmzg6","updated":"20240408152218"},"Children":[{"ID":"20240408152218-i6s60gb","Type":"NodeParagraph","Properties":{"id":"20240408152218-i6s60gb","updated":"20240408152218"},"Children":[{"Type":"NodeText","Data":"微调过程中，除了观察benchmark的准确率，还会评估chat模型的重复率，收集了3868条中英文prompts，观测生成回复没有终止或者无休止重复一段文本的比例。发现随着"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"数学SFT数据的增多"},{"Type":"NodeText","Data":"，重复的概率也倾向于增大；主要原因应该是数学SFT数据较少包含相似的推理模式，弱模型较难获取这样的推理模式，导致重复的回复，为此设计了两阶段微调和DPO，保持benchmark恩叔的同时大大降低重复"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"repetition"},{"Type":"NodeText","Data":"​。"}]}]}]}]},{"ID":"20240408152218-7h1dr67","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152218-7h1dr67","updated":"20240408152218"},"Children":[{"ID":"20240408152218-fbkbknz","Type":"NodeParagraph","Properties":{"id":"20240408152218-fbkbknz","updated":"20240408152218"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"DPO"},{"Type":"NodeText","Data":"：就helpfulness和harmlessness两方面构建训练DPO的偏好数据。对于helpfulness数据，收集多语言prompts，包含创新写作、问答、指令跟随等，使用DeepSeek Chat模型生成回复候选；对于harmlessness数据也进行相似的操作。"}]},{"ID":"20240408152218-g8eq2tq","Type":"NodeList","ListData":{},"Properties":{"id":"20240408152218-g8eq2tq","updated":"20240408152218"},"Children":[{"ID":"20240408152218-czefrhl","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152218-czefrhl","updated":"20240408152218"},"Children":[{"ID":"20240408152218-grah01p","Type":"NodeParagraph","Properties":{"id":"20240408152218-grah01p","updated":"20240408152218"},"Children":[{"Type":"NodeText","Data":"训练1个epoch、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"learning_rate=5e-6"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"batch_size=512"},{"Type":"NodeText","Data":"​，使用learning rate warmup和cosine learning rate scheduler"}]}]},{"ID":"20240408152218-4l5qp6n","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152218-4l5qp6n","updated":"20240408152218"},"Children":[{"ID":"20240408152218-0olkvle","Type":"NodeParagraph","Properties":{"id":"20240408152218-0olkvle","updated":"20240408152218"},"Children":[{"Type":"NodeText","Data":"我们发现DPO能够强化模型开发侧生成技能，而在标准benchmark的表现一般"}]}]}]}]}]}]}]},{"ID":"20240408152235-l06lj9d","Type":"NodeList","ListData":{},"Properties":{"id":"20240408152235-l06lj9d","updated":"20240408151839"},"Children":[{"ID":"20240408152250-u6d41ru","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152250-u6d41ru","updated":"20240408152407"},"Children":[{"ID":"20240408152251-pootf9q","Type":"NodeParagraph","Properties":{"id":"20240408152251-pootf9q","updated":"20240408152251"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"一些发现"}]},{"ID":"20240408152251-0rgddng","Type":"NodeList","ListData":{},"Properties":{"id":"20240408152251-0rgddng","updated":"20240408152407"},"Children":[{"ID":"20240408152251-nzxub8m","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152251-nzxub8m","updated":"20240408152251"},"Children":[{"ID":"20240408152251-phd3zv2","Type":"NodeParagraph","Properties":{"id":"20240408152251-phd3zv2","updated":"20240408152251"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Staged Fine-Tuning"},{"Type":"NodeText","Data":"：在数学和代码数据集上，下模型需要更长微调时间，但是会损害模型对话的能力（比如增加重复的概率）。因此本文采用了分阶段微调："}]},{"ID":"20240408152251-vgx84he","Type":"NodeList","ListData":{},"Properties":{"id":"20240408152251-vgx84he","updated":"20240408152251"},"Children":[{"ID":"20240408152251-pg4l8pz","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152251-pg4l8pz","updated":"20240408152251"},"Children":[{"ID":"20240408152251-5pfdvty","Type":"NodeParagraph","Properties":{"id":"20240408152251-5pfdvty","updated":"20240408152251"},"Children":[{"Type":"NodeText","Data":"第一阶段采用全量数据未提哦啊"}]}]},{"ID":"20240408152251-s12e6xm","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152251-s12e6xm","updated":"20240408152251"},"Children":[{"ID":"20240408152251-jm5jf6n","Type":"NodeParagraph","Properties":{"id":"20240408152251-jm5jf6n","updated":"20240408152251"},"Children":[{"Type":"NodeText","Data":"第二阶段主要关注在对话数据上微调"}]}]}]}]},{"ID":"20240408152251-a7pji1y","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152251-a7pji1y","updated":"20240408152251"},"Children":[{"ID":"20240408152251-lovgupu","Type":"NodeParagraph","Properties":{"id":"20240408152251-lovgupu","updated":"20240408152251"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"多项选择问题"},{"Type":"NodeText","Data":"：对齐阶段加入多项选择数据，能够改善在多项选择评估任务上的效果，但是对于其他生成式任务没有明显改善（也没有下降）。因此"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"在预训练和微调阶段，我们移除了MC数据"},{"Type":"NodeText","Data":"，因为这些数据容易导致模型过拟合，却不会强化模型的智能性"}]}]},{"ID":"20240408152251-t4tzvj6","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152251-t4tzvj6","updated":"20240408152251"},"Children":[{"ID":"20240408152251-3g163rs","Type":"NodeParagraph","Properties":{"id":"20240408152251-3g163rs","updated":"20240408152251"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"预训练中加入指令数据"},{"Type":"NodeText","Data":"：在预训练最后10%过程加入500w条多项选择的指令数据，表明确实能强化base模型在benchmark上的效果。但是实验发现，其实在SFT阶段加入同样的数据结果是一致的。因此，我们认为"},{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"模型整体的潜力并不会因为在预训练过程加入指令数据而得到强化"},{"Type":"NodeText","Data":"。不过，如果指令数据规模够大，确实可以考虑在预训练过程中加入。而本文选择预训练过程不加入指令数据。"}]}]},{"ID":"20240408152251-2vo2xii","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152251-2vo2xii","updated":"20240408152407"},"Children":[{"ID":"20240408152251-11d8ti5","Type":"NodeParagraph","Properties":{"id":"20240408152251-11d8ti5","updated":"20240408152251"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"System Prompt"},{"Type":"NodeText","Data":"：精心设计的system prompt能够有效指导模型生成helpful和respectful的结果。"}]},{"ID":"20240408152359-527qccu","Type":"NodeParagraph","Properties":{"id":"20240408152359-527qccu","updated":"20240408152407"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408152300-yjhw7yl.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240408152346-nl8kenb","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152346-nl8kenb"},"Children":[{"ID":"20240408152347-msme5oo","Type":"NodeList","ListData":{},"Properties":{"id":"20240408152347-msme5oo","updated":"20240408152347"},"Children":[{"ID":"20240408152347-oy2hjfg","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152347-oy2hjfg","updated":"20240408152347"},"Children":[{"ID":"20240408152347-5fh0s41","Type":"NodeParagraph","Properties":{"id":"20240408152347-5fh0s41","updated":"20240408152347"},"Children":[{"Type":"NodeText","Data":"当引入"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"system prompt"},{"Type":"NodeText","Data":"​时，7B LLM性能有一点下降，而67B的LLM性能有比较显著提升。我们认为更大的模型能够更好地理解system prompt的意图，从而更好地遵循指令、得到更好的回复。小模型很难充分掌握"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"system prompt"},{"Type":"NodeText","Data":"​，同时训练和测试的不一致对性能产生了负面影响。"}]}]}]}]}]}]}]},{"ID":"20240408152300-kw7qvoo","Type":"NodeParagraph","Properties":{"id":"20240408152300-kw7qvoo","updated":"20240408151839"}},{"ID":"20240408152319-145rh5q","Type":"NodeList","ListData":{},"Properties":{"id":"20240408152319-145rh5q","updated":"20240408151839"},"Children":[{"ID":"20240408152417-n4dlxgj","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152417-n4dlxgj","updated":"20240408152417"},"Children":[{"ID":"20240408152417-tisl952","Type":"NodeParagraph","Properties":{"id":"20240408152417-tisl952","updated":"20240408152422"},"Children":[{"Type":"NodeText","Data":"核心贡献"}]},{"ID":"20240408152423-3fs5pcp","Type":"NodeList","ListData":{},"Properties":{"id":"20240408152423-3fs5pcp","updated":"20240408152425"},"Children":[{"ID":"20240408152425-z7ycxfl","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152425-z7ycxfl","updated":"20240408152425"},"Children":[{"ID":"20240408152425-rwd6i7j","Type":"NodeParagraph","Properties":{"id":"20240408152425-rwd6i7j","updated":"20240408152505"},"Children":[{"Type":"NodeText","Data":"矫正了之前工作中scaling laws的问题，提供新的最优的模型-数据规模分配策略"}]}]},{"ID":"20240408152506-cfeow7y","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152506-cfeow7y"},"Children":[{"ID":"20240408152506-vnklu7f","Type":"NodeParagraph","Properties":{"id":"20240408152506-vnklu7f","updated":"20240408152600"},"Children":[{"Type":"NodeText","Data":"提出了一种新方法基于给定的预算 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"budget"},{"Type":"NodeText","Data":"​ 来预测接近最优的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"batch size"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"learning rate"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240408152602-6mvxrem","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152602-6mvxrem"},"Children":[{"ID":"20240408152602-zni1b0b","Type":"NodeParagraph","Properties":{"id":"20240408152602-zni1b0b","updated":"20240408152617"},"Children":[{"Type":"NodeText","Data":"总结了scaling laws 和数据质量的关系"}]}]}]}]}]},{"ID":"20240408152619-imaul18","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408152619-imaul18","updated":"20240408152626"},"Children":[{"Type":"NodeText","Data":"关于MoE"}]},{"ID":"20240408152626-blyvnp9","Type":"NodeParagraph","Properties":{"id":"20240408152626-blyvnp9","updated":"20240408152626"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Mixtral 要点"}]},{"ID":"20240408152638-xrf2vy5","Type":"NodeParagraph","Properties":{"id":"20240408152638-xrf2vy5","updated":"20240408152626"}},{"ID":"20240408152750-dafzlvd","Type":"NodeList","ListData":{},"Properties":{"id":"20240408152750-dafzlvd","updated":"20240408152626"},"Children":[{"ID":"20240408152750-l89xrtq","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152750-l89xrtq","updated":"20240408152750"},"Children":[{"ID":"20240408152750-77y34hl","Type":"NodeParagraph","Properties":{"id":"20240408152750-77y34hl","updated":"20240408152750"},"Children":[{"Type":"NodeText","Data":"Mixtral的每一层包含8个FFN块。对于每一层的每一个token，router网络选择两个experts处理当前状态，并将他们的输出进行组合。尽管每个token只使用了两个experts，但是每一个timestamp选择的expert是不同的，因此每一个token可以访问47B的参数，但是推理时只使用13B激活的参数。"}]}]},{"ID":"20240408152750-9usphh7","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408152750-9usphh7","updated":"20240408152843"},"Children":[{"ID":"20240408152750-8qwr82m","Type":"NodeParagraph","Properties":{"id":"20240408152750-8qwr82m","updated":"20240408152843"},"Children":[{"Type":"NodeText","Data":"对于给定的输入xx"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"x"},{"Type":"NodeText","Data":"，MoE模块的输出是expert网络输出的加权和，这里的权重是由门网络输出，假设有"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"n"},{"Type":"NodeText","Data":"个expert网路"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"{"},{"Type":"NodeText","Data":"E"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"0,"},{"Type":"NodeText","Data":"E"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"i,"},{"Type":"NodeText","Data":"⋯"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":","},{"Type":"NodeText","Data":"E"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"n"},{"Type":"NodeText","Data":"−"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"1}"},{"Type":"NodeText","Data":"，专家层的输出为："}]}]}]},{"ID":"20240408152815-felkzrd","Type":"NodeParagraph","Properties":{"id":"20240408152815-felkzrd","updated":"20240408152626"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408152815-xfzft93.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240408152817-iwspjbb","Type":"NodeParagraph","Properties":{"id":"20240408152817-iwspjbb","updated":"20240408152626"},"Children":[{"Type":"NodeText","Data":"这里门网络"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"G"},{"Type":"NodeText","Data":"("},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"x"},{"Type":"NodeText","Data":")有多种实现方式，一种简单且有效的方式就是记忆线性输出的Top-K的logits进行softmax"}]},{"ID":"20240408152915-7dkq2nz","Type":"NodeParagraph","Properties":{"id":"20240408152915-7dkq2nz","updated":"20240408152626"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408152915-1cd6dlz.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240408152925-0xuhldx","Type":"NodeParagraph","Properties":{"id":"20240408152925-0xuhldx","updated":"20240408152626"},"Children":[{"Type":"NodeText","Data":"这里，如果lil_i"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"l"},{"Type":"NodeText","Data":"i存在于logits的topK位置，则"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"("},{"Type":"NodeText","Data":"TopK"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"("},{"Type":"NodeText","Data":"l"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":")"},{"Type":"NodeText","Data":")"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"i:="},{"Type":"NodeText","Data":"l"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"i"},{"Type":"NodeText","Data":"，否则"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"("},{"Type":"NodeText","Data":"TopK"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"("},{"Type":"NodeText","Data":"l"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":")"},{"Type":"NodeText","Data":")"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"i="},{"Type":"NodeText","Data":"−"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"∞"},{"Type":"NodeText","Data":"。这里的"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"K"},{"Type":"NodeText","Data":"表示每个token使用的experts的数量，是一个可以自定义的超参数。"}]},{"ID":"20240408153022-epd5qyf","Type":"NodeList","ListData":{},"Properties":{"id":"20240408153022-epd5qyf","updated":"20240408152626"},"Children":[{"ID":"20240408153022-l8cagtf","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408153022-l8cagtf","updated":"20240408153035"},"Children":[{"ID":"20240408153022-0lriltq","Type":"NodeParagraph","Properties":{"id":"20240408153022-0lriltq","updated":"20240408153035"},"Children":[{"Type":"NodeText","Data":"如果增加专家的数量"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"n"},{"Type":"NodeText","Data":"同时保持"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"K"},{"Type":"NodeText","Data":"固定，则可以在增加模型参数的同时保持计算开销固定。模型的参数随着专家数"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"n"},{"Type":"NodeText","Data":"的增加而增加，处理一个单独token的参数数量随着"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"K"},{"Type":"NodeText","Data":"的增加而增加，最大为"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"n"}]}]},{"ID":"20240408153022-iypfjnq","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408153022-iypfjnq","updated":"20240408153022"},"Children":[{"ID":"20240408153022-2nk5pz4","Type":"NodeParagraph","Properties":{"id":"20240408153022-2nk5pz4","updated":"20240408153022"},"Children":[{"Type":"NodeText","Data":"MoE层在硬件上的前向："}]},{"ID":"20240408153022-xe82l9j","Type":"NodeList","ListData":{},"Properties":{"id":"20240408153022-xe82l9j","updated":"20240408153022"},"Children":[{"ID":"20240408153022-d038kr9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408153022-d038kr9","updated":"20240408153022"},"Children":[{"ID":"20240408153022-ur3ndnw","Type":"NodeParagraph","Properties":{"id":"20240408153022-ur3ndnw","updated":"20240408153022"},"Children":[{"Type":"NodeText","Data":"可以通过高性能专门的内核，在单个GPU上有效运行，如"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Megablocks"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20240408153022-jkgmlwb","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408153022-jkgmlwb","updated":"20240408153022"},"Children":[{"ID":"20240408153022-l4tpehw","Type":"NodeParagraph","Properties":{"id":"20240408153022-l4tpehw","updated":"20240408153022"},"Children":[{"Type":"NodeText","Data":"也可以通过"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Expert Parallelism"},{"Type":"NodeText","Data":"​（EP）策略分配到多个GPU上。当MoE层执行时，tokens通过一个路由到对应GPU的专家进行处理，然后专家的输出返回到原始的token位置。"}]}]}]}]}]},{"ID":"20240408153050-l33aj41","Type":"NodeParagraph","Properties":{"id":"20240408153050-l33aj41","updated":"20240408152626"},"Children":[{"Type":"NodeText","Data":"在Transformer模型中，MoE层在每一个token上单独应用，替换transformer block中的FFN子块。对于Mixtral我们使用相同的SwiGLU结构，对应专家函数为"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"E"},{"Type":"NodeText","Data":"i("},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"x"},{"Type":"NodeText","Data":")并设置"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"K"},{"Type":"NodeText","Data":"="},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"2"},{"Type":"NodeText","Data":"。这意味着每一个token路由到2个不同权重集合的SwiGLU子块，因此对于输入token "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"x"},{"Type":"NodeText","Data":"的输出"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"y"},{"Type":"NodeText","Data":"为："}]},{"ID":"20240408153123-giv9obz","Type":"NodeParagraph","Properties":{"id":"20240408153123-giv9obz","updated":"20240408152626"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408153123-fkiwrot.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240408153126-2ul76gr","Type":"NodeParagraph","Properties":{"id":"20240408153126-2ul76gr","updated":"20240408152626"},"Children":[{"Type":"NodeText","Data":"这个公式和GShard结构比较相似，只不过我们通过MoE层替换了所有FFN子块，而GShard替换了其他块，而且GShard对于每一个token的第二个专家采用了更加复杂的门控策略。"}]},{"ID":"20240408153708-cibyvm8","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408153708-cibyvm8","updated":"20240408153723"},"Children":[{"Type":"NodeText","Data":"DeepSeekMoE 要点"}]},{"ID":"20240408153723-f9bpjvo","Type":"NodeList","ListData":{},"Properties":{"id":"20240408153723-f9bpjvo","updated":"20240408153723"},"Children":[{"ID":"20240408153727-uf2c8pg","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408153727-uf2c8pg","updated":"20240408153727"},"Children":[{"ID":"20240408153727-jz8fye0","Type":"NodeParagraph","Properties":{"id":"20240408153727-jz8fye0","updated":"20240408153738"},"Children":[{"Type":"NodeText","Data":"两个核心原则："}]},{"ID":"20240408153738-wrdw104","Type":"NodeList","ListData":{},"Properties":{"id":"20240408153738-wrdw104","updated":"20240408153741"},"Children":[{"ID":"20240408153741-2mmjtgd","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408153741-2mmjtgd","updated":"20240408153741"},"Children":[{"ID":"20240408153741-3vetpce","Type":"NodeParagraph","Properties":{"id":"20240408153741-3vetpce","updated":"20240408153929"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Fine-grained Expert Segmentation"},{"Type":"NodeText","Data":"​ : 细地将专家划分为mN个，激活其中的mK个，实现激活的专家更灵活的组合"}]}]},{"ID":"20240408153931-hpnw0pw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408153931-hpnw0pw"},"Children":[{"ID":"20240408153931-qjdui1x","Type":"NodeParagraph","Properties":{"id":"20240408153931-qjdui1x","updated":"20240408154029"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"shared Expert Isolation"},{"Type":"NodeText","Data":"​：将Ks 单独看作共享专家，用于捕获常识以及缓解路由专家中的冗余知识"}]}]}]}]},{"ID":"20240408154030-t0mea2t","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408154030-t0mea2t"},"Children":[{"ID":"20240408154030-30gbqoz","Type":"NodeParagraph","Properties":{"id":"20240408154030-30gbqoz","updated":"20240408154051"},"Children":[{"Type":"NodeText","Data":"经典的将FFN替换为MoE层的方式如下："}]},{"ID":"20240408154051-fqisjsk","Type":"NodeList","ListData":{},"Properties":{"id":"20240408154051-fqisjsk","updated":"20240408154054"},"Children":[{"ID":"20240408154054-b2ov8ep","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408154054-b2ov8ep","updated":"20240408154054"},"Children":[{"ID":"20240408154054-80tekz2","Type":"NodeParagraph","Properties":{"id":"20240408154054-80tekz2","updated":"20240408154103"},"Children":[{"Type":"NodeText","Data":"N 表示专家的数量"}]}]},{"ID":"20240408154103-ltdt0en","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408154103-ltdt0en"},"Children":[{"ID":"20240408154103-ggr5n1n","Type":"NodeParagraph","Properties":{"id":"20240408154103-ggr5n1n","updated":"20240408154127"},"Children":[{"Type":"NodeText","Data":"FFNi（.）表示第i个专家FFN"}]}]},{"ID":"20240408154127-1p61xvg","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408154127-1p61xvg"},"Children":[{"ID":"20240408154127-9fplv8j","Type":"NodeParagraph","Properties":{"id":"20240408154127-9fplv8j","updated":"20240408154218"},"Children":[{"Type":"NodeText","Data":"gi,t 表示第i 个专家的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"gate value"},{"Type":"NodeText","Data":"​，Si，t 表示 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"token-to-expert"},{"Type":"NodeText","Data":"​ 亲进度"}]}]},{"ID":"20240408154220-g931sjn","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408154220-g931sjn"},"Children":[{"ID":"20240408154220-817zmag","Type":"NodeParagraph","Properties":{"id":"20240408154220-817zmag","updated":"20240408154302"},"Children":[{"Type":"NodeText","Data":"Topk(.,K) 表示第t个token和所有N个专家计算得到的K个最高的亲进度分数。"}]}]},{"ID":"20240408154302-0i8gtc9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408154302-0i8gtc9"},"Children":[{"ID":"20240408154302-esglkhl","Type":"NodeParagraph","Properties":{"id":"20240408154302-esglkhl","updated":"20240408154336"},"Children":[{"Type":"NodeText","Data":"el,i 表示第l层的第i个专家中心 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"centroid"},{"Type":"NodeText","Data":"​"}]}]}]}]}]},{"ID":"20240408154351-wymtbtr","Type":"NodeParagraph","Properties":{"id":"20240408154351-wymtbtr","updated":"20240408153723"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408154350-9i331gf.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240408154354-ktsru9n","Type":"NodeList","ListData":{},"Properties":{"id":"20240408154354-ktsru9n","updated":"20240408153723"},"Children":[{"ID":"20240408154356-6j067v1","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408154356-6j067v1","updated":"20240408154356"},"Children":[{"ID":"20240408154356-w2y1dbx","Type":"NodeParagraph","Properties":{"id":"20240408154356-w2y1dbx","updated":"20240408154406"},"Children":[{"Type":"NodeText","Data":"DeepSeekMoE 的结构"}]},{"ID":"20240408154406-4moatoc","Type":"NodeList","ListData":{},"Properties":{"id":"20240408154406-4moatoc","updated":"20240408154409"},"Children":[{"ID":"20240408154409-jqyu0d9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408154409-jqyu0d9","updated":"20240408154409"},"Children":[{"ID":"20240408154409-hqpidxr","Type":"NodeParagraph","Properties":{"id":"20240408154409-hqpidxr","updated":"20240408154517"},"Children":[{"Type":"NodeText","Data":"对于传统MoE 中每一个专家FFN，将FFN中间隐层维度降低到原大小的 1/m，将一个专家划分成m个更小的专家"}]}]},{"ID":"20240408154517-z3ncvuw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408154517-z3ncvuw"},"Children":[{"ID":"20240408154517-z68p5xh","Type":"NodeParagraph","Properties":{"id":"20240408154517-z68p5xh","updated":"20240408154612"},"Children":[{"Type":"NodeText","Data":"由于每一个专家变得更小了，相应地我们将激活的专家的数量增大到m倍来保持相同的计算开销"}]}]},{"ID":"20240408154613-2rkw4b7","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408154613-2rkw4b7"},"Children":[{"ID":"20240408154613-w5d319r","Type":"NodeParagraph","Properties":{"id":"20240408154613-w5d319r","updated":"20240408154749"},"Children":[{"Type":"NodeText","Data":"将专家Ks 看做共享专家独立看待，无论路由模块如何，每一个token会确定性地分配到这些共享的专家上。为了保持计算开销一致，其他路由专家的激活数量需要减去 Ks。"}]}]}]}]}]},{"ID":"20240408154756-23y0may","Type":"NodeParagraph","Properties":{"id":"20240408154756-23y0may","updated":"20240408153723"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408154756-pe6qh3l.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240408154804-ptxmofr","Type":"NodeParagraph","Properties":{"id":"20240408154804-ptxmofr","updated":"20240408153723"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408154804-vhzff2r.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240408154807-lxpp0rl","Type":"NodeList","ListData":{},"Properties":{"id":"20240408154807-lxpp0rl","updated":"20240408153723"},"Children":[{"ID":"20240408154812-wlbkz98","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408154812-wlbkz98","updated":"20240408154812"},"Children":[{"ID":"20240408154812-a515rzu","Type":"NodeParagraph","Properties":{"id":"20240408154812-a515rzu","updated":"20240408154926"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Load Balance Consideration"},{"Type":"NodeText","Data":"​: 训练时如果模型总是选择部分experts，其他experts就无法得到充分训练；如果专家分布在不同的devices上，负载不均衡就会称为计算瓶颈"}]},{"ID":"20240408154927-2xelysh","Type":"NodeList","ListData":{},"Properties":{"id":"20240408154927-2xelysh","updated":"20240408154929"},"Children":[{"ID":"20240408154929-js38wzh","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408154929-js38wzh","updated":"20240408154929"},"Children":[{"ID":"20240408154929-kzqnbjg","Type":"NodeParagraph","Properties":{"id":"20240408154929-kzqnbjg","updated":"20240408155022"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Expert-Level Balance Loss"},{"Type":"NodeText","Data":"​: 为了缓解路由崩溃的风险，我们采用了 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"expert-level balance loss"},{"Type":"NodeText","Data":"​"}]}]}]}]}]},{"ID":"20240408155031-6t6g8dh","Type":"NodeParagraph","Properties":{"id":"20240408155031-6t6g8dh","updated":"20240408153723"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408155031-jvl7roi.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240408155028-eswu76k","Type":"NodeList","ListData":{},"Properties":{"id":"20240408155028-eswu76k","updated":"20240408153723"},"Children":[{"ID":"20240408155040-4e857xm","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408155040-4e857xm","updated":"20240408155040"},"Children":[{"ID":"20240408155040-qtclas0","Type":"NodeList","ListData":{},"Properties":{"id":"20240408155040-qtclas0","updated":"20240408155042"},"Children":[{"ID":"20240408155042-g1aqfnk","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408155042-g1aqfnk","updated":"20240408155042"},"Children":[{"ID":"20240408155042-thogljy","Type":"NodeParagraph","Properties":{"id":"20240408155042-thogljy","updated":"20240408155212"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Device-Level Balance Loss"},{"Type":"NodeText","Data":"​: 我们的珠海要目标是保证不同设备均衡计算，如果我们将所有的路由专家分成D组"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"{"},{"Type":"NodeText","Data":"E"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"1,"},{"Type":"NodeText","Data":"E"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"2,"},{"Type":"NodeText","Data":"⋯"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":","},{"Type":"NodeText","Data":"E"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"D}"},{"Type":"NodeText","Data":"，将每一组部署到一个单独的device，那么device-level的均衡损失为："}]}]}]}]}]},{"ID":"20240408155225-wo3r4is","Type":"NodeParagraph","Properties":{"id":"20240408155225-wo3r4is","updated":"20240408153723"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20240408155225-pmscf71.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240408155227-pqx2ii6","Type":"NodeList","ListData":{},"Properties":{"id":"20240408155227-pqx2ii6","updated":"20240408153723"},"Children":[{"ID":"20240408155231-ij0v0h4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408155231-ij0v0h4","updated":"20240408155255"},"Children":[{"ID":"20240408155231-7aqprzz","Type":"NodeParagraph","Properties":{"id":"20240408155231-7aqprzz","updated":"20240408155237"},"Children":[{"Type":"NodeText","Data":"实验设置"}]},{"ID":"20240408155250-yw8f9cb","Type":"NodeList","ListData":{},"Properties":{"id":"20240408155250-yw8f9cb","updated":"20240408155250"},"Children":[{"ID":"20240408155250-4w7b16l","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408155250-4w7b16l","updated":"20240408155250"},"Children":[{"ID":"20240408155250-9v3l1kg","Type":"NodeParagraph","Properties":{"id":"20240408155250-9v3l1kg","updated":"20240408155250"},"Children":[{"Type":"NodeText","Data":"9层Transformer层，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"hidden_dim=1280, num_heads=10, head_dim=128"},{"Type":"NodeText","Data":"​。将所有FFN层替换为MoE层，保证专家参数总数等于标准FFN的16倍"}]}]},{"ID":"20240408155250-9fzhnj0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408155250-9fzhnj0","updated":"20240408155250"},"Children":[{"ID":"20240408155250-oh73ye8","Type":"NodeParagraph","Properties":{"id":"20240408155250-oh73ye8","updated":"20240408155250"},"Children":[{"Type":"NodeText","Data":"保证激活的专家参数，包括共享专家参数和激活的路由专家参数，是标准FFN的2倍"}]}]},{"ID":"20240408155250-46gci3o","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408155250-46gci3o","updated":"20240408155250"},"Children":[{"ID":"20240408155250-hk6h4xv","Type":"NodeParagraph","Properties":{"id":"20240408155250-hk6h4xv","updated":"20240408155250"},"Children":[{"Type":"NodeText","Data":"这样每个MoE模型总参数量为2B，激活的参数约为0.3B"}]}]}]},{"ID":"20240408155250-89s5rr4","Type":"NodeParagraph","Properties":{"id":"20240408155250-89s5rr4","updated":"20240408155255"}}]}]},{"ID":"20240408155357-tzy3x3t","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240408155357-tzy3x3t","updated":"20240408155401"},"Children":[{"Type":"NodeText","Data":"对齐"}]},{"ID":"20240408155401-z9maptm","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408155401-z9maptm","updated":"20240408155413"},"Children":[{"Type":"NodeText","Data":"Reward 模型的损失函数"}]},{"ID":"20240408155413-7zgnwzi","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240408155413-7zgnwzi","updated":"20240408155444"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"logits = 1 + torch.exp(rejected_reward - chosen_reward)\nloss = torch.log(logits).mean()\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240408155426-6nb46hj","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408155426-6nb46hj","updated":"20240408155500"},"Children":[{"Type":"NodeText","Data":"Reward 模型的输入和输出"}]},{"ID":"20240408155501-clnilyg","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240408155501-clnilyg","updated":"20240408155506"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"# \u003cs\u003e prompt response \u003c/s\u003e\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240408155510-uzhbgal","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240408155510-uzhbgal","updated":"20240408155514"},"Children":[{"Type":"NodeText","Data":"分布式相关"}]},{"ID":"20240408155514-73ng1ti","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408155514-73ng1ti","updated":"20240408155534"},"Children":[{"Type":"NodeText","Data":"DeepSpeed 和 Megatron 之间的差异"}]},{"ID":"20240408155542-prcje35","Type":"NodeList","ListData":{},"Properties":{"id":"20240408155542-prcje35","updated":"20240408155542"},"Children":[{"ID":"20240408155542-8kgfwfy","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408155542-8kgfwfy","updated":"20240408155542"},"Children":[{"ID":"20240408155542-ydz8xab","Type":"NodeParagraph","Properties":{"id":"20240408155542-ydz8xab","updated":"20240408155542"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn/?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F670958880","TextMarkATitle":"https://zhuanlan.zhihu.com/p/670958880","TextMarkTextContent":"模型并行训练：DeepSpeed和Megatron的差异"}]}]},{"ID":"20240408155542-ylx7erv","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408155542-ylx7erv","updated":"20240408155542"},"Children":[{"ID":"20240408155542-mgab8jz","Type":"NodeParagraph","Properties":{"id":"20240408155542-mgab8jz","updated":"20240408155542"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn/?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F624740065","TextMarkATitle":"https://zhuanlan.zhihu.com/p/624740065","TextMarkTextContent":"分析transformer模型的参数量/计算量/中间激活/kV Cache"}]}]},{"ID":"20240408155542-kz8h43t","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20240408155542-kz8h43t","updated":"20240408155542"},"Children":[{"ID":"20240408155542-lyre7u0","Type":"NodeParagraph","Properties":{"id":"20240408155542-lyre7u0","updated":"20240408155542"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn/?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F677870556","TextMarkATitle":"https://zhuanlan.zhihu.com/p/677870556","TextMarkTextContent":"LLM并行训练技术介绍"}]}]}]},{"ID":"20240408160040-l7zctxa","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240408160040-l7zctxa","updated":"20240408160045"},"Children":[{"Type":"NodeText","Data":"部署相关"}]},{"ID":"20240408160046-wgdyqgg","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240408160046-wgdyqgg","updated":"20240408160109"},"Children":[{"Type":"NodeText","Data":"常见的部署方式有哪些"}]},{"ID":"20240408160109-b8ai7iz","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408160109-b8ai7iz","updated":"20240408160112"},"Children":[{"Type":"NodeText","Data":"vLLM"}]},{"ID":"20240408160112-kkgv9yg","Type":"NodeParagraph","Properties":{"id":"20240408160112-kkgv9yg","updated":"20240408160112"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fvllm-project%2Fvllm","TextMarkATitle":"https://github.com/vllm-project/vllm","TextMarkTextContent":"github.com/vllm-projec…"}]},{"ID":"20240408160121-e5ts1tg","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240408160121-e5ts1tg","updated":"20240408160134"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"c2hlbGw="},{"Type":"NodeCodeBlockCode","Data":"python -m vllm.entrypoints.openai.api_server --served-model-name Qwen1.5-7B-Chat --model Qwen/Qwen1.5-7B-Chat \n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240408160135-uvw5qhc","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240408160135-uvw5qhc","updated":"20240408160144"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"c2hlbGw="},{"Type":"NodeCodeBlockCode","Data":"curl http://localhost:8000/v1/chat/completions \\\n-H \"Content-Type: application/json\" \\\n-d '{\n\"model\": \"Qwen1.5-7B-Chat\",\n\"messages\": [\n{\"role\": \"system\", \"content\": \"You are a helpful assistant.\"},\n{\"role\": \"user\", \"content\": \"Tell me something about large language models.\"}\n]\n}'\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240408160144-94bhlvq","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240408160144-94bhlvq","updated":"20240408160201"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"from openai import OpenAI\n# Set OpenAI's API key and API base to use vLLM's API server.\nopenai_api_key = \"EMPTY\"\nopenai_api_base = \"http://localhost:8000/v1\"\n\nclient = OpenAI(\napi_key=openai_api_key,\nbase_url=openai_api_base,\n)\n\nchat_response = client.chat.completions.create(\nmodel=\"Qwen1.5-7B-Chat\",\nmessages=[\n{\"role\": \"system\", \"content\": \"You are a helpful assistant.\"},\n{\"role\": \"user\", \"content\": \"Tell me something about large language models.\"},\n]\n)\nprint(\"Chat response:\", chat_response)\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240408160205-9601wat","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408160205-9601wat","updated":"20240408160216"},"Children":[{"Type":"NodeText","Data":"SGLang"}]},{"ID":"20240408160217-ejozxgf","Type":"NodeParagraph","Properties":{"id":"20240408160217-ejozxgf","updated":"20240408160251"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fsgl-project%2Fsglang","TextMarkATitle":"https://github.com/sgl-project/sglang","TextMarkTextContent":"github.com/sgl-project…"}]},{"ID":"20240408160243-3t468qh","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240408160243-3t468qh","updated":"20240408160245"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"python -m sglang.launch_server --model-path Qwen/Qwen1.5-7B-Chat --port 30000\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240408160251-m26qbuc","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240408160251-m26qbuc","updated":"20240408160257"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"from sglang import function, system, user, assistant, gen, set_default_backend, RuntimeEndpoint\n\n@function\ndef multi_turn_question(s, question_1, question_2):\ns += system(\"You are a helpful assistant.\")\ns += user(question_1)\ns += assistant(gen(\"answer_1\", max_tokens=256))\ns += user(question_2)\ns += assistant(gen(\"answer_2\", max_tokens=256))\n\nset_default_backend(RuntimeEndpoint(\"http://localhost:30000\"))\n\nstate = multi_turn_question.run(\nquestion_1=\"What is the capital of China?\",\nquestion_2=\"List two local attractions.\",\n)\n\nfor m in state.messages():\nprint(m[\"role\"], \":\", m[\"content\"])\n\nprint(state[\"answer_1\"])\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240408160301-pjrfbmz","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240408160301-pjrfbmz","updated":"20240408160308"},"Children":[{"Type":"NodeText","Data":"FastChat"}]},{"ID":"20240408160309-k8kq2h8","Type":"NodeParagraph","Properties":{"id":"20240408160309-k8kq2h8","updated":"20240408160314"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Flm-sys%2FFastChat","TextMarkATitle":"https://github.com/lm-sys/FastChat","TextMarkTextContent":"github.com/lm-sys/Fast…"}]},{"ID":"20240408160315-lkxn3o6","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240408160315-lkxn3o6","updated":"20240408160319"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"# For Chinese users, you can use models from www.modelscope.cn via specify the following environment variables.\n# export FASTCHAT_USE_MODELSCOPE=True\npython3 -m fastchat.serve.model_worker --model-path lmsys/vicuna-7b-v1.5\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240408165148-vgqjmcd","Type":"NodeParagraph","Properties":{"id":"20240408165148-vgqjmcd"}}]}