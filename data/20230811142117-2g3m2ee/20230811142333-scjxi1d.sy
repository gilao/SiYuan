{"ID":"20230811142333-scjxi1d","Spec":"1","Type":"NodeDocument","Properties":{"icon":"2615","id":"20230811142333-scjxi1d","scroll":"\u0026#123;\u0026quot;rootId\u0026quot;:\u0026quot;20230811142333-scjxi1d\u0026quot;,\u0026quot;startId\u0026quot;:\u0026quot;20230811142827-sfdkk83\u0026quot;,\u0026quot;endId\u0026quot;:\u0026quot;20230814160115-8xzinuq\u0026quot;,\u0026quot;scrollTop\u0026quot;:16761,\u0026quot;focusId\u0026quot;:\u0026quot;20230814160115-8xzinuq\u0026quot;,\u0026quot;focusStart\u0026quot;:34,\u0026quot;focusEnd\u0026quot;:34\u0026#125;","tags":"电力认知大模型,python","title":"大模型启动脚本","updated":"20230815161238"},"Children":[{"ID":"20230811142827-sfdkk83","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230811142827-sfdkk83","updated":"20230811142831"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"def update_source(sample, metedata):\n    metedatas[\"source\"] = sample[\"source\"]\n    return metedata\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230811142827-c4cj6gi","Type":"NodeParagraph","Properties":{"id":"20230811142827-c4cj6gi","updated":"20230811143810"},"Children":[{"Type":"NodeText","Data":"这段代码定义了一个函数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"update_source"},{"Type":"NodeText","Data":"​的函数，该函数接受两个参数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sample"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"metadata"},{"Type":"NodeText","Data":"​。函数的目的是将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sample"},{"Type":"NodeText","Data":"​ 中的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026quot;source\u0026quot;"},{"Type":"NodeText","Data":"​值更新到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"metadata"},{"Type":"NodeText","Data":"​ 中的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026quot;source\u0026quot;"},{"Type":"NodeText","Data":"​字段，并返回更新后的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"metadata"},{"Type":"NodeText","Data":"​。"}]},{"ID":"20230811142333-4of91kv","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230811142333-4of91kv","updated":"20230811143140"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"def load_file(filepath, sentence_size=SENTENCE_SIZE):\n        if filepath.lower().endswith(\".md\"):\n        loader = UnstructuredFileLoader(filepath, mode=\"elements\")\n        docs = loader.load()\n    elif filepath.lower().endswith(\".json\"):\n        loader = JSONLoader(filepath, jq_schema=\".[]\", content_key=\"knowledge\", metadata_func=update_source)\n        textsplitter = ChineseTextSplitter(pdf=False, sentence_size=sentence_size)\n        docs = loader.load_and_split(textsplitter)\n    elif filepath.lower().endswith(\".txt\"):\n        loader = TextLoader(filepath, autodetect_encoding=True)\n        textsplitter = ChineseTextSplitter(pdf=False, sentence_size=sentence_size)\n        docs = loader.load_and_split(textsplitter)\n    elif filepath.lower().endswith(\".pdf\"):\n        loader = UnstructuredPaddlePDFLoader(filepath)\n        textsplitter = ChineseTextSplitter(pdf=True, sentence_size=sentence_size)\n        docs = loader.load_and_split(textsplitter)\n    elif filepath.lower().endswith(\".jpg\") or filepath.lower().endswith(\".png\"):\n        loader = UnstructuredPaddleImageLoader(filepath, mode=\"elements\")\n        textsplitter = ChineseTextSplitter(pdf=False, sentence_size=sentence_size)\n        docs = loader.load_and_split(text_splitter=textsplitter)\n    else:\n        loader = UnstructuredFileLoader(filepath, mode=\"elements\")\n        textsplitter = ChineseTextSplitter(pdf=False, sentence_size=sentence_size)\n        docs = loader.load_and_split(text_splitter=textsplitter)\n    write_check_file(filepath, docs)\n    return docs\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230811142639-kgc2gmw","Type":"NodeParagraph","Properties":{"id":"20230811142639-kgc2gmw","updated":"20230811142639"},"Children":[{"Type":"NodeText","Data":"这段代码定义了一个函数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"load_file"},{"Type":"NodeText","Data":"​，它接受一个参数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"filepath"},{"Type":"NodeText","Data":"​ 和一个可选参数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sentence_size"},{"Type":"NodeText","Data":"​，并返回一个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"docs"},{"Type":"NodeText","Data":"​ 列表。"}]},{"ID":"20230811142639-yvf6uf8","Type":"NodeParagraph","Properties":{"id":"20230811142639-yvf6uf8","updated":"20230811142639"},"Children":[{"Type":"NodeText","Data":"该函数根据 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"filepath"},{"Type":"NodeText","Data":"​ 的扩展名来确定如何加载文件并创建适当的加载器。根据不同的扩展名，函数采用不同的加载器来处理文件。以下是对不同扩展名的处理逻辑："}]},{"ID":"20230811142639-cjcq9fj","Type":"NodeList","ListData":{},"Properties":{"id":"20230811142639-cjcq9fj","updated":"20230811142639"},"Children":[{"ID":"20230811142639-gsh3ml4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230811142639-gsh3ml4","updated":"20230811142639"},"Children":[{"ID":"20230811142639-ondr44u","Type":"NodeParagraph","Properties":{"id":"20230811142639-ondr44u","updated":"20230811142639"},"Children":[{"Type":"NodeText","Data":"如果文件扩展名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":".md"},{"Type":"NodeText","Data":"​，则使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UnstructuredFileLoader"},{"Type":"NodeText","Data":"​ 加载器以 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026quot;elements\u0026quot;"},{"Type":"NodeText","Data":"​ 模式加载文件，并将结果存储在 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"docs"},{"Type":"NodeText","Data":"​ 中。"}]}]},{"ID":"20230811142639-wro6z9e","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230811142639-wro6z9e","updated":"20230811142639"},"Children":[{"ID":"20230811142639-6rx4zaf","Type":"NodeParagraph","Properties":{"id":"20230811142639-6rx4zaf","updated":"20230811142639"},"Children":[{"Type":"NodeText","Data":"如果文件扩展名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":".json"},{"Type":"NodeText","Data":"​，则使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"JSONLoader"},{"Type":"NodeText","Data":"​ 加载器来加载文件，并结合 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ChineseTextSplitter"},{"Type":"NodeText","Data":"​ 对文本进行分割，最后将结果存储在 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"docs"},{"Type":"NodeText","Data":"​ 中。"}]}]},{"ID":"20230811142639-ia9mg11","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230811142639-ia9mg11","updated":"20230811142639"},"Children":[{"ID":"20230811142639-qs7cago","Type":"NodeParagraph","Properties":{"id":"20230811142639-qs7cago","updated":"20230811142639"},"Children":[{"Type":"NodeText","Data":"如果文件扩展名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":".txt"},{"Type":"NodeText","Data":"​，则使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"TextLoader"},{"Type":"NodeText","Data":"​ 加载器来加载文件，并结合 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ChineseTextSplitter"},{"Type":"NodeText","Data":"​ 对文本进行分割，最后将结果存储在 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"docs"},{"Type":"NodeText","Data":"​ 中。"}]}]},{"ID":"20230811142639-b5q0ckb","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230811142639-b5q0ckb","updated":"20230811142639"},"Children":[{"ID":"20230811142639-xbxve5c","Type":"NodeParagraph","Properties":{"id":"20230811142639-xbxve5c","updated":"20230811142639"},"Children":[{"Type":"NodeText","Data":"如果文件扩展名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":".pdf"},{"Type":"NodeText","Data":"​，则使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UnstructuredPaddlePDFLoader"},{"Type":"NodeText","Data":"​ 加载器来加载文件，并结合 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ChineseTextSplitter"},{"Type":"NodeText","Data":"​ 对文本进行分割，最后将结果存储在 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"docs"},{"Type":"NodeText","Data":"​ 中。"}]}]},{"ID":"20230811142639-uave9lb","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230811142639-uave9lb","updated":"20230811142639"},"Children":[{"ID":"20230811142639-fo0hgsa","Type":"NodeParagraph","Properties":{"id":"20230811142639-fo0hgsa","updated":"20230811142639"},"Children":[{"Type":"NodeText","Data":"如果文件扩展名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":".jpg"},{"Type":"NodeText","Data":"​ 或 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":".png"},{"Type":"NodeText","Data":"​，则使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UnstructuredPaddleImageLoader"},{"Type":"NodeText","Data":"​ 加载器以 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026quot;elements\u0026quot;"},{"Type":"NodeText","Data":"​ 模式加载文件，并结合 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ChineseTextSplitter"},{"Type":"NodeText","Data":"​ 对文本进行分割，最后将结果存储在 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"docs"},{"Type":"NodeText","Data":"​ 中。"}]}]},{"ID":"20230811142639-g4mx2nw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230811142639-g4mx2nw","updated":"20230811142639"},"Children":[{"ID":"20230811142639-6sdeiyj","Type":"NodeParagraph","Properties":{"id":"20230811142639-6sdeiyj","updated":"20230811142639"},"Children":[{"Type":"NodeText","Data":"如果以上条件都不满足，则使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UnstructuredFileLoader"},{"Type":"NodeText","Data":"​ 加载器以 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026quot;elements\u0026quot;"},{"Type":"NodeText","Data":"​ 模式加载文件，并结合 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ChineseTextSplitter"},{"Type":"NodeText","Data":"​ 对文本进行分割，最后将结果存储在 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"docs"},{"Type":"NodeText","Data":"​ 中。"}]}]}]},{"ID":"20230811142639-jbqz1d9","Type":"NodeParagraph","Properties":{"id":"20230811142639-jbqz1d9","updated":"20230811142639"},"Children":[{"Type":"NodeText","Data":"最后，函数调用了 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"write_check_file(filepath, docs)"},{"Type":"NodeText","Data":"​ 来写入检查文件，然后返回 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"docs"},{"Type":"NodeText","Data":"​ 列表作为结果。"}]},{"ID":"20230811142639-011zkhi","Type":"NodeParagraph","Properties":{"id":"20230811142639-011zkhi","updated":"20230811142650"},"Children":[{"Type":"NodeText","Data":"这段代码的作用是根据给定的文件路径加载文件内容，并根据文件的类型和规则进行解析和处理。"}]},{"ID":"20230811142642-badxd8z","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230811142642-badxd8z","updated":"20230811144135"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"def write_check_file(filepath, docs):\n  folder_path = os.path.join(os.path.dirname(filepath), \"tmp_files\")\n  if not os.path.exists(floder_path):\n    os.makedirs(folder_path)\n  fp = os.path.join(folder_path, 'load_file.txt')\n  with open(fp, 'a+', encoding='utf-8') as fout:\n    fout.write(\"filepath=%s,len=%s\" % (filepath, len(docs)))\n    fout.write('\\n')\n    for i in docs:\n      fout.write(str(i))\n      fout.write('\\n')\n    fout.close()\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230811144244-dard34s","Type":"NodeParagraph","Properties":{"id":"20230811144244-dard34s","updated":"20230811144244"},"Children":[{"Type":"NodeText","Data":"这段代码定义了一个名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"write_check_file"},{"Type":"NodeText","Data":"​ 的函数，它接受两个参数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"filepath"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"docs"},{"Type":"NodeText","Data":"​。"}]},{"ID":"20230811144244-p3ufewr","Type":"NodeParagraph","Properties":{"id":"20230811144244-p3ufewr","updated":"20230811144244"},"Children":[{"Type":"NodeText","Data":"函数的主要目的是将文件路径和文档内容写入到一个检查文件中。首先，函数创建了一个名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"tmp_files"},{"Type":"NodeText","Data":"​ 的文件夹路径，用于存放检查文件。如果该文件夹路径不存在，则创建它。"}]},{"ID":"20230811144244-pfkujp2","Type":"NodeParagraph","Properties":{"id":"20230811144244-pfkujp2","updated":"20230811144244"},"Children":[{"Type":"NodeText","Data":"然后，函数打开一个名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"load_file.txt"},{"Type":"NodeText","Data":"​ 的文件对象，并以追加模式打开。接下来，函数逐行将文件路径和文档内容写入文件中。首先写入文件路径和文档数量的信息，然后写入每个文档的内容。"}]},{"ID":"20230811144244-nc8xezi","Type":"NodeParagraph","Properties":{"id":"20230811144244-nc8xezi","updated":"20230811144244"},"Children":[{"Type":"NodeText","Data":"最后，函数关闭文件对象。"}]},{"ID":"20230811144244-f5atncd","Type":"NodeParagraph","Properties":{"id":"20230811144244-f5atncd","updated":"20230811144248"},"Children":[{"Type":"NodeText","Data":"总体来说，这段代码的作用是将文件路径和文档内容写入到一个检查文件中，用于记录加载文件的过程和结果。"}]},{"ID":"20230811145534-mdewey9","Type":"NodeParagraph","Properties":{"id":"20230811145534-mdewey9"}},{"ID":"20230811153230-5dkvzhv","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230811153230-5dkvzhv","updated":"20230811153746"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"def generate_prompt(related_docs: List[str], \n                    query: str,\n                    prompt_template: str = PROMPT_TEMPLATE, ) -\u003e str:\n    context = \"\\n\".join([doc.page_content for doc in related_docs])\n    prompt = prompt_template.replace(\"{question}\", query).replacec(\"{context}\",context)\n    return prompt\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230811153919-ss9bvpm","Type":"NodeParagraph","Properties":{"id":"20230811153919-ss9bvpm","updated":"20230811153919"},"Children":[{"Type":"NodeText","Data":"这段代码定义了一个名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"generate_prompt"},{"Type":"NodeText","Data":"​ 的函数。它接受三个参数："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"related_docs"},{"Type":"NodeText","Data":"​（相关文档列表）、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"query"},{"Type":"NodeText","Data":"​（查询内容）、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"prompt_template"},{"Type":"NodeText","Data":"​（提示模板），并返回一个字符串。"}]},{"ID":"20230811153919-a3kbqb6","Type":"NodeParagraph","Properties":{"id":"20230811153919-a3kbqb6","updated":"20230811153919"},"Children":[{"Type":"NodeText","Data":"该函数的主要目的是根据给定的相关文档、查询内容和提示模板生成一个提示文本。首先，通过列表解析式，将相关文档列表中每个文档的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"page_content"},{"Type":"NodeText","Data":"​ 属性提取出来，并使用换行符连接起来形成一个文本字符串，存储在变量 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"context"},{"Type":"NodeText","Data":"​ 中。"}]},{"ID":"20230811153919-qhd93qk","Type":"NodeParagraph","Properties":{"id":"20230811153919-qhd93qk","updated":"20230811153919"},"Children":[{"Type":"NodeText","Data":"然后，使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"prompt_template"},{"Type":"NodeText","Data":"​ 中的占位符 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"{question}"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"{context}"},{"Type":"NodeText","Data":"​ ，分别将查询内容和文档内容替换进去，得到最终的提示文本，存储在变量 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"prompt"},{"Type":"NodeText","Data":"​ 中。"}]},{"ID":"20230811153919-1cifx0x","Type":"NodeParagraph","Properties":{"id":"20230811153919-1cifx0x","updated":"20230811153919"},"Children":[{"Type":"NodeText","Data":"最后，将生成的提示文本作为函数的输出进行返回。"}]},{"ID":"20230811153919-5bbp1nt","Type":"NodeParagraph","Properties":{"id":"20230811153919-5bbp1nt","updated":"20230811153919"},"Children":[{"Type":"NodeText","Data":"需要注意的是，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"prompt_template"},{"Type":"NodeText","Data":"​ 参数有一个默认值 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"PROMPT_TEMPLATE"},{"Type":"NodeText","Data":"​，它表示如果没有提供 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"prompt_template"},{"Type":"NodeText","Data":"​ 参数，则使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"PROMPT_TEMPLATE"},{"Type":"NodeText","Data":"​ 的默认值。"}]},{"ID":"20230811153919-2x4xpgt","Type":"NodeParagraph","Properties":{"id":"20230811153919-2x4xpgt","updated":"20230811153919"},"Children":[{"Type":"NodeText","Data":"总体而言，这个函数用来根据相关文档、查询内容和提示模板生成一段提示文本。如果您还有其他问题，请随时提问。"}]},{"ID":"20230811153837-u03jkr2","Type":"NodeParagraph","Properties":{"id":"20230811153837-u03jkr2"}},{"ID":"20230811145535-lkkp0xv","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230811145535-lkkp0xv","updated":"20230811145536"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"def seperate_list(ls: List[int]) -\u003e List[List[int]]:\n    lists = []\n    ls1 = [ls[0]]\n    for i in range(1, len(ls)):\n        if ls[i - 1] + 1 == ls[i]:\n            ls1.append(ls[i])\n        else:\n            lists.append(ls1)\n            ls1 = [ls[i]]\n    lists.append(ls1)\n    return lists\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230811150133-wswzvn6","Type":"NodeParagraph","Properties":{"id":"20230811150133-wswzvn6","updated":"20230811150133"},"Children":[{"Type":"NodeText","Data":"这段代码定义了一个名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"separate_list"},{"Type":"NodeText","Data":"​ 的函数，该函数接受一个整数列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ls"},{"Type":"NodeText","Data":"​，并返回一个整数列表的列表。"}]},{"ID":"20230811150133-hxw6cmv","Type":"NodeParagraph","Properties":{"id":"20230811150133-hxw6cmv","updated":"20230811150133"},"Children":[{"Type":"NodeText","Data":"函数的主要目的是将连续递增的整数子序列划分为多个子列表。首先，函数创建一个空列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"lists"},{"Type":"NodeText","Data":"​ 用于存储结果子列表。"}]},{"ID":"20230811150133-nndwlaf","Type":"NodeParagraph","Properties":{"id":"20230811150133-nndwlaf","updated":"20230811150133"},"Children":[{"Type":"NodeText","Data":"接下来，函数初始化一个临时列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ls1"},{"Type":"NodeText","Data":"​，并将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ls"},{"Type":"NodeText","Data":"​ 中的第一个元素添加到其中。"}]},{"ID":"20230811150133-ociuh5t","Type":"NodeParagraph","Properties":{"id":"20230811150133-ociuh5t","updated":"20230811150133"},"Children":[{"Type":"NodeText","Data":"然后，函数通过遍历 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ls"},{"Type":"NodeText","Data":"​ 的索引从 1 到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ls"},{"Type":"NodeText","Data":"​ 的长度减一，进行以下操作："}]},{"ID":"20230811150133-d4nj6nv","Type":"NodeList","ListData":{},"Properties":{"id":"20230811150133-d4nj6nv","updated":"20230811150133"},"Children":[{"ID":"20230811150133-ymtdfj4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230811150133-ymtdfj4","updated":"20230811150133"},"Children":[{"ID":"20230811150133-7572z5l","Type":"NodeParagraph","Properties":{"id":"20230811150133-7572z5l","updated":"20230811150133"},"Children":[{"Type":"NodeText","Data":"如果当前元素 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ls[i]"},{"Type":"NodeText","Data":"​ 是前一个元素 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ls[i - 1]"},{"Type":"NodeText","Data":"​ 加 1，则说明它们属于同一个递增子序列，将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ls[i]"},{"Type":"NodeText","Data":"​ 添加到临时列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ls1"},{"Type":"NodeText","Data":"​ 中。"}]}]},{"ID":"20230811150133-0hixx7t","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230811150133-0hixx7t","updated":"20230811150133"},"Children":[{"ID":"20230811150133-hrctia9","Type":"NodeParagraph","Properties":{"id":"20230811150133-hrctia9","updated":"20230811150133"},"Children":[{"Type":"NodeText","Data":"否则，将临时列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ls1"},{"Type":"NodeText","Data":"​ 添加到结果列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"lists"},{"Type":"NodeText","Data":"​ 中，并重新初始化 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ls1"},{"Type":"NodeText","Data":"​ 为只包含当前元素 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ls[i]"},{"Type":"NodeText","Data":"​ 的列表。"}]}]}]},{"ID":"20230811150133-5trbvy5","Type":"NodeParagraph","Properties":{"id":"20230811150133-5trbvy5","updated":"20230811150133"},"Children":[{"Type":"NodeText","Data":"最后，循环结束后，将最后的临时列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ls1"},{"Type":"NodeText","Data":"​ 添加到结果列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"lists"},{"Type":"NodeText","Data":"​ 中，并返回结果列表作为函数的输出。"}]},{"ID":"20230811150133-zgbplhb","Type":"NodeParagraph","Properties":{"id":"20230811150133-zgbplhb","updated":"20230811150137"},"Children":[{"Type":"NodeText","Data":"总体而言，这段代码的作用是将给定的整数列表按照连续递增的子序列进行划分，并返回划分后的整数列表的列表。"}]},{"ID":"20230811151041-e50rh9d","Type":"NodeParagraph","Properties":{"id":"20230811151041-e50rh9d"}},{"ID":"20230811160951-z7b7488","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230811160951-z7b7488","updated":"20230814093026"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"# 基于向量得分的相似性检索\ndef similarity_search_with_score_by_vector(\n        self, embedding: List[float], k: int = 4\n) -\u003e List[Tuple[Document, float]]:\n\n# \n    scores, indices = self.index.search(np.array([embedding], dtype=np.float32),k)\n\n    docs = []\n    id_set = set()\n    store_len = len(self.index_to_docstore_id)\n    for j,i in enumerate(indices[0]):\n        if i == -1 or 0 \u003c self.score_threshold \u003c scores[0][j]:\n            # This happens when not enough docs are returned.\n            continue\n        _id = self.index_to_docstore_id[i]\n        doc = self.docstore.search(_id)\n        if not self.chunk_conent:\n            if not isinstance(doc, Document):\n                raise ValueError(f\"Could not find document for id {_id}, got {doc}\")\n            doc.metadata[\"score\"] = int(scores[0][j])\n            docs.append(doc)\n            continue\n        id_set.add(i)\n        docs_len = len(doc.page_content)\n        for k in range(1, max(i, store_len - i)):\n            break_flag = False\n            for l in [i + k, i - k]:\n                if 0 \u003c= l \u003c len(self.index_to_docstore_id):\n                    _id0 = self.index_to_docstore_id[l]\n                    doc0 = self.docstore.search(_id0)\n                    if docs_len + len(doc0.page_content) \u003e self.chunk_size:\n                        break_flag = True\n                        break\n                    elif doc0.metadata[\"source\"] == doc.metadata[\"source\"]:\n                        docs_len += len(doc0.page_content)\n                        id_set.add(l)\n            if break_flag:\n                break\n    if not self.chunk_conent:\n        return docs\n    if len(id_set) == 0 and self.score_threshold \u003e 0:\n        return []\n    id_list = sorted(list(id_set))\n    id_lists = seperate_list(id_list)\n    for id_seq in id_lists:\n        for id in id_seq:\n            if id == id_seq[0]:\n                _id = self.index_to_docstore_id[id]\n                doc = self.docstore.search(_id)\n            else:\n                _id0 = self.index_to_docstore_id[id]\n                doc0 = self.docstore.search(_id0)\n                doc.page_content += \" \" + doc0.page_content\n        if not isinstance(doc, Document):\n            raise ValueError(f\"Could not find document for id {_id}, got {doc}\")\n        try:\n            doc_score = min([scores[0][id] for id in [indices[0].tolist().index(i) for i in id_seq if i in indices[0]]])\n        except:\n            continue\n        doc.metadata[\"score\"] = int(doc_score)\n        docs.append(doc)\n    torch_gc()\n    return docs\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230814101238-hqmbp45","Type":"NodeParagraph","Properties":{"id":"20230814101238-hqmbp45","updated":"20230814101238"},"Children":[{"Type":"NodeText","Data":"这是一个名为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"similarity_search_with_score_by_vector"},{"Type":"NodeText","Data":"​的方法，该方法用于基于向量进行相似度搜索，并返回带有得分的文档列表。方法接收两个参数："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"embedding"},{"Type":"NodeText","Data":"​和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"k"},{"Type":"NodeText","Data":"​。"}]},{"ID":"20230814101238-0xuyrwd","Type":"NodeList","ListData":{},"Properties":{"id":"20230814101238-0xuyrwd","updated":"20230814101238"},"Children":[{"ID":"20230814101238-tswy6ov","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814101238-tswy6ov","updated":"20230814101238"},"Children":[{"ID":"20230814101238-bioso0g","Type":"NodeParagraph","Properties":{"id":"20230814101238-bioso0g","updated":"20230814101238"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"embedding"},{"Type":"NodeText","Data":"​是一个包含浮点数的列表，表示待搜索的向量。"}]}]},{"ID":"20230814101238-loi7jgs","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814101238-loi7jgs","updated":"20230814101238"},"Children":[{"ID":"20230814101238-0olloog","Type":"NodeParagraph","Properties":{"id":"20230814101238-0olloog","updated":"20230814101238"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"k"},{"Type":"NodeText","Data":"​表示返回结果的数量，默认为4。"}]}]}]},{"ID":"20230814101238-cclttjf","Type":"NodeParagraph","Properties":{"id":"20230814101238-cclttjf","updated":"20230814101238"},"Children":[{"Type":"NodeText","Data":"方法首先使用提供的向量进行搜索，并返回得分和索引。然后，它通过遍历索引并获取对应的文档信息来构建文档列表。"}]},{"ID":"20230814101238-jr2iwxu","Type":"NodeParagraph","Properties":{"id":"20230814101238-jr2iwxu","updated":"20230814101238"},"Children":[{"Type":"NodeText","Data":"在构建文档列表的过程中，方法会检查搜索结果的有效性，并排除一些特殊情况（例如搜索结果为空或得分不满足阈值要求）。然后，它会将文档对象添加到列表中，并设置文档的得分。"}]},{"ID":"20230814101238-t3qtov4","Type":"NodeParagraph","Properties":{"id":"20230814101238-t3qtov4","updated":"20230814101238"},"Children":[{"Type":"NodeText","Data":"最后，方法会对文档列表进行一些处理，包括合并具有相同来源的文档内容，并执行一些清理操作，然后返回最终的文档列表。"}]},{"ID":"20230814101238-0rh0yig","Type":"NodeParagraph","Properties":{"id":"20230814101238-0rh0yig","updated":"20230814101238"},"Children":[{"Type":"NodeText","Data":"需要注意的是，在这段代码中，还引用了一个名为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"seperate_list"},{"Type":"NodeText","Data":"​的函数，该函数用于分割ID列表。"}]},{"ID":"20230814091445-9dies6w","Type":"NodeParagraph","Properties":{"id":"20230814091445-9dies6w"}},{"ID":"20230814091445-ztxzige","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230814091445-ztxzige","updated":"20230814095615"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"def search_result2docs(search_results):\n    docs = []\n    for result in search_results:\n        doc = Document(page_content=result[\"snippet\"] if \"snippet\" in result.keys() else \"\",\n                       metadata={\"source\": result[\"link\"] if \"link\" in result.keys() else \"\",\n                                 \"filename\": result[\"title\"] if \"title\" in result.keys() else \"\"})\n        docs.append(doc)\n    return docs\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230814095715-g49evob","Type":"NodeParagraph","Properties":{"id":"20230814095715-g49evob","updated":"20230814095715"},"Children":[{"Type":"NodeText","Data":"这是一个名为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"search_result2docs"},{"Type":"NodeText","Data":"​的函数，函数的作用是将搜索结果转换为文档对象列表。函数接收一个"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"search_results"},{"Type":"NodeText","Data":"​参数，该参数是一个搜索结果列表。"}]},{"ID":"20230814095715-pweqiiw","Type":"NodeParagraph","Properties":{"id":"20230814095715-pweqiiw","updated":"20230814095715"},"Children":[{"Type":"NodeText","Data":"函数通过遍历搜索结果列表，在每个搜索结果中提取相关信息，并使用这些信息创建一个文档对象。其中，文档对象包括页面内容（如果存在）和元数据（来源链接和文件名）。将创建的文档对象添加到一个文档列表中。"}]},{"ID":"20230814095715-vdjqfyj","Type":"NodeParagraph","Properties":{"id":"20230814095715-vdjqfyj","updated":"20230814095715"},"Children":[{"Type":"NodeText","Data":"最后，函数返回这个文档对象列表。"}]},{"ID":"20230814095719-xhze99u","Type":"NodeParagraph","Properties":{"id":"20230814095719-xhze99u"}},{"ID":"20230814101021-v6vmlej","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230814101021-v6vmlej","updated":"20230814111645"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"class LocalDocQA:\n    llm: BaseAnswer = None\n    embeddings: object = None\n    top_k: int = VECTOR_SEARCH_TOP_K\n    chunk_size: int = CHUNK_SIZE\n    chunk_conent: bool = True\n    score_threshold: int = VECTOR_SEARCH_SCORE_THRESHOLD\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230814111648-8dgx83k","Type":"NodeParagraph","Properties":{"id":"20230814111648-8dgx83k","updated":"20230814111737"},"Children":[{"Type":"NodeText","Data":"定义了一个名为 LocalDocQA 的类，并且有一些类成员变量的初始化。"}]},{"ID":"20230814111738-nlgv7vq","Type":"NodeParagraph","Properties":{"id":"20230814111738-nlgv7vq","updated":"20230814111824"},"Children":[{"Type":"NodeText","Data":"类 LocalDocQA 有一些成员变量，包括："}]},{"ID":"20230814112922-tyem1mq","Type":"NodeList","ListData":{},"Properties":{"id":"20230814112922-tyem1mq","updated":"20230814112922"},"Children":[{"ID":"20230814112922-cnhf5ff","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814112922-cnhf5ff","updated":"20230814112922"},"Children":[{"ID":"20230814112922-p4pf2ep","Type":"NodeParagraph","Properties":{"id":"20230814112922-p4pf2ep","updated":"20230814112922"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"llm"},{"Type":"NodeText","Data":"​​：类型为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"BaseAnswer"},{"Type":"NodeText","Data":"​​的成员变量，默认值为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"None"},{"Type":"NodeText","Data":"​​。"}]}]},{"ID":"20230814112922-lf4kpzg","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814112922-lf4kpzg","updated":"20230814112922"},"Children":[{"ID":"20230814112922-irm8g4o","Type":"NodeParagraph","Properties":{"id":"20230814112922-irm8g4o","updated":"20230814112922"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"embeddings"},{"Type":"NodeText","Data":"​​：类型为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"object"},{"Type":"NodeText","Data":"​​的成员变量，默认值为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"None"},{"Type":"NodeText","Data":"​​。"}]}]},{"ID":"20230814112922-z6r5k5j","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814112922-z6r5k5j","updated":"20230814112922"},"Children":[{"ID":"20230814112922-ohk3sdt","Type":"NodeParagraph","Properties":{"id":"20230814112922-ohk3sdt","updated":"20230814112922"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"top_k"},{"Type":"NodeText","Data":"​​：类型为整数，值为常量"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"VECTOR_SEARCH_TOP_K"},{"Type":"NodeText","Data":"​​。"}]}]},{"ID":"20230814112922-lpagl0u","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814112922-lpagl0u","updated":"20230814112922"},"Children":[{"ID":"20230814112922-3xxynub","Type":"NodeParagraph","Properties":{"id":"20230814112922-3xxynub","updated":"20230814112922"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"chunk_size"},{"Type":"NodeText","Data":"​​：类型为整数，值为常量"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"CHUNK_SIZE"},{"Type":"NodeText","Data":"​​。"}]}]},{"ID":"20230814112922-uad8r9u","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814112922-uad8r9u","updated":"20230814112922"},"Children":[{"ID":"20230814112922-96azmgo","Type":"NodeParagraph","Properties":{"id":"20230814112922-96azmgo","updated":"20230814112922"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"chunk_content"},{"Type":"NodeText","Data":"​​：类型为布尔型，值为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"True"},{"Type":"NodeText","Data":"​​。"}]}]},{"ID":"20230814112922-mgtwnlb","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814112922-mgtwnlb","updated":"20230814112922"},"Children":[{"ID":"20230814112922-a0pms2q","Type":"NodeParagraph","Properties":{"id":"20230814112922-a0pms2q","updated":"20230814112922"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"score_threshold"},{"Type":"NodeText","Data":"​​：类型为整数，值为常量"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"VECTOR_SEARCH_SCORE_THRESHOLD"},{"Type":"NodeText","Data":"​​。"}]}]}]},{"ID":"20230814114447-ixr9kru","Type":"NodeParagraph","Properties":{"id":"20230814114447-ixr9kru"}},{"ID":"20230814114448-cwin2so","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230814114448-cwin2so","updated":"20230814140559"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"# class localDocQA\ndef init_cfg(self, \n              embedding_model: str = EMBEDDING_MODEL,\n              embedding_device=EMBEDdING_DEVICE,\n              llm_model: BaseAnswer = None,\n              top_k=VECTOR_SEARCH_TOP_K,\n            ):\n    self.llm = llm_model\n    self.embeddings = HuggingFaceEmbeddings(model_name=embedding_model_dict[emdedding_model], cache_folder=embedding_model_dict[embedding_model], model_kwargs={'devcie':embedding_device})\n\n    self.top_k = top_k\n    self.vector_store = None\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230814115837-q36ysw6","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230814115837-q36ysw6","updated":"20230814115837"},"Children":[{"ID":"20230814115837-unhn741","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230814115837-unhn741","updated":"20230814115837"},"Children":[{"ID":"20230814115837-eniohv2","Type":"NodeParagraph","Properties":{"id":"20230814115837-eniohv2","updated":"20230814115837"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"init_cfg"},{"Type":"NodeText","Data":"​方法有一些参数，包括："}]},{"ID":"20230814115837-2wixo52","Type":"NodeList","ListData":{},"Properties":{"id":"20230814115837-2wixo52","updated":"20230814115837"},"Children":[{"ID":"20230814115837-7vkvkaw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814115837-7vkvkaw","updated":"20230814115837"},"Children":[{"ID":"20230814115837-nuv65w9","Type":"NodeParagraph","Properties":{"id":"20230814115837-nuv65w9","updated":"20230814115837"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"embedding_model"},{"Type":"NodeText","Data":"​：字符串类型，表示嵌入模型的名称，默认值为常量"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"EMBEDDING_MODEL"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230814115837-xk4gu27","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814115837-xk4gu27","updated":"20230814115837"},"Children":[{"ID":"20230814115837-ky24u3x","Type":"NodeParagraph","Properties":{"id":"20230814115837-ky24u3x","updated":"20230814115837"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"embedding_device"},{"Type":"NodeText","Data":"​：表示嵌入模型使用的设备，默认值为常量"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"EMBEDDING_DEVICE"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230814115837-zxmnzvm","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814115837-zxmnzvm","updated":"20230814115837"},"Children":[{"ID":"20230814115837-juuz0ik","Type":"NodeParagraph","Properties":{"id":"20230814115837-juuz0ik","updated":"20230814115837"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"llm_model"},{"Type":"NodeText","Data":"​：类型为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"BaseAnswer"},{"Type":"NodeText","Data":"​，用于初始化"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"llm"},{"Type":"NodeText","Data":"​成员变量，默认值为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"None"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230814115837-mq9ok69","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814115837-mq9ok69","updated":"20230814115837"},"Children":[{"ID":"20230814115837-25lef5i","Type":"NodeParagraph","Properties":{"id":"20230814115837-25lef5i","updated":"20230814115837"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"top_k"},{"Type":"NodeText","Data":"​：整数类型，表示搜索结果的前k个，默认值为常量"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"VECTOR_SEARCH_TOP_K"},{"Type":"NodeText","Data":"​。"}]}]}]}]},{"ID":"20230814115837-198tdtl","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230814115837-198tdtl","updated":"20230814115837"},"Children":[{"ID":"20230814115837-kleeqk6","Type":"NodeParagraph","Properties":{"id":"20230814115837-kleeqk6","updated":"20230814115837"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"init_cfg"},{"Type":"NodeText","Data":"​方法的作用是进行一些初始化操作。具体地："}]},{"ID":"20230814115837-591xlbq","Type":"NodeList","ListData":{},"Properties":{"id":"20230814115837-591xlbq","updated":"20230814115837"},"Children":[{"ID":"20230814115837-904jazu","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814115837-904jazu","updated":"20230814115837"},"Children":[{"ID":"20230814115837-xs4b1xz","Type":"NodeParagraph","Properties":{"id":"20230814115837-xs4b1xz","updated":"20230814115837"},"Children":[{"Type":"NodeText","Data":"将传入的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"llm_model"},{"Type":"NodeText","Data":"​赋值给成员变量"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"llm"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230814115837-vpeo2tg","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814115837-vpeo2tg","updated":"20230814115837"},"Children":[{"ID":"20230814115837-fj7pt39","Type":"NodeParagraph","Properties":{"id":"20230814115837-fj7pt39","updated":"20230814115837"},"Children":[{"Type":"NodeText","Data":"使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"HuggingFaceEmbeddings"},{"Type":"NodeText","Data":"​类创建一个嵌入模型对象，并将其赋值给成员变量"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"embeddings"},{"Type":"NodeText","Data":"​，其中使用了"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"embedding_model"},{"Type":"NodeText","Data":"​和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"embedding_device"},{"Type":"NodeText","Data":"​参数。"}]}]},{"ID":"20230814115837-5ccb6me","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814115837-5ccb6me","updated":"20230814115837"},"Children":[{"ID":"20230814115837-4knj0jq","Type":"NodeParagraph","Properties":{"id":"20230814115837-4knj0jq","updated":"20230814115837"},"Children":[{"Type":"NodeText","Data":"将传入的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"top_k"},{"Type":"NodeText","Data":"​赋值给成员变量"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"top_k"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230814115837-sui2b0s","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814115837-sui2b0s","updated":"20230814115837"},"Children":[{"ID":"20230814115837-lgcg83v","Type":"NodeParagraph","Properties":{"id":"20230814115837-lgcg83v","updated":"20230814115837"},"Children":[{"Type":"NodeText","Data":"将"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vector_store"},{"Type":"NodeText","Data":"​赋值为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"None"},{"Type":"NodeText","Data":"​。"}]}]}]}]}]},{"ID":"20230814115849-dbgqctl","Type":"NodeParagraph","Properties":{"id":"20230814115849-dbgqctl","updated":"20230814115850"},"Children":[{"Type":"NodeText","Data":"代码中使用的一些常量，如"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"EMBEDDING_MODEL"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"EMBEDDING_DEVICE"},{"Type":"NodeText","Data":"​和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"VECTOR_SEARCH_TOP_K"},{"Type":"NodeText","Data":"​，应该在代码的其他地方有定义。"}]},{"ID":"20230814115851-tkdkkeb","Type":"NodeParagraph","Properties":{"id":"20230814115851-tkdkkeb"}},{"ID":"20230814140444-myrzheh","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230814140444-myrzheh","updated":"20230814142114"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"# class localDocQA\n# 初始化知识向量存储\n    def init_knowledge_vector_store(self,\n                                    filepath: str or List[str],\n                                    vs_path: str or os.PathLike = None,\n                                    sentence_size=SENTENCE_SIZE):\n        loaded_files = []\n        failed_files = []\n        if isinstance(filepath, str):\n            if not os.path.exists(filepath):\n                print(\"路径不存在\")\n                return None\n            elif os.path.isfile(filepath):\n                file = os.path.split(filepath)[-1]\n                try:\n                    docs = load_file(filepath, sentence_size)\n                    logger.info(f\"{file} 已成功加载\")\n                    loaded_files.append(filepath)\n                except Exception as e:\n                    logger.error(e)\n                    logger.info(f\"{file} 未能成功加载\")\n                    return None\n            elif os.path.isdir(filepath):\n                docs = []\n                for file in tqdm(os.listdir(filepath), desc=\"加载文件\"):\n                    fullfilepath = os.path.join(filepath, file)\n                    try:\n                        docs += load_file(fullfilepath, sentence_size)\n                        loaded_files.append(fullfilepath)\n                    except Exception as e:\n                        logger.error(e)\n                        failed_files.append(file)\n\n                if len(failed_files) \u003e 0:\n                    logger.info(\"以下文件未能成功加载：\")\n                    for file in failed_files:\n                        logger.info(f\"{file}\\n\")\n\n        else:\n            docs = []\n            for file in filepath:\n                try:\n                    docs += load_file(file)\n                    logger.info(f\"{file} 已成功加载\")\n                    loaded_files.append(file)\n                except Exception as e:\n                    logger.error(e)\n                    logger.info(f\"{file} 未能成功加载\")\n        if len(docs) \u003e 0:\n            logger.info(\"文件加载完毕，正在生成向量库\")\n            if vs_path and os.path.isdir(vs_path):\n                vector_store = FAISS.load_local(vs_path, self.embeddings)\n                vector_store.add_documents(docs)\n                torch_gc()\n            else:\n                if not vs_path:\n                    vs_path = os.path.join(VS_ROOT_PATH,\n                                           f\"\"\"{\"\".join(lazy_pinyin(os.path.splitext(file)[0]))}_FAISS_{datetime.datetime.now().strftime(\"%Y%m%d_%H%M%S\")}\"\"\")\n                vector_store = FAISS.from_documents(docs, self.embeddings)  # docs 为Document列表\n                torch_gc()\n\n            vector_store.save_local(vs_path)\n            return vs_path, loaded_files\n        else:\n            logger.info(\"文件均未成功加载，请检查依赖包或替换为其他文件再次上传。\")\n            return None, loaded_files\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230814142433-8r40b6m","Type":"NodeParagraph","Properties":{"id":"20230814142433-8r40b6m","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"这是一个Python类中的方法，根据给定的文件路径初始化一个知识向量库。"}]},{"ID":"20230814142433-sxpv8fk","Type":"NodeParagraph","Properties":{"id":"20230814142433-sxpv8fk","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"方法的参数包括："}]},{"ID":"20230814142433-shlbyvt","Type":"NodeList","ListData":{},"Properties":{"id":"20230814142433-shlbyvt","updated":"20230814142433"},"Children":[{"ID":"20230814142433-ii7n96x","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814142433-ii7n96x","updated":"20230814142433"},"Children":[{"ID":"20230814142433-vqq06uv","Type":"NodeParagraph","Properties":{"id":"20230814142433-vqq06uv","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self"},{"Type":"NodeText","Data":"​：表示对象本身。"}]}]},{"ID":"20230814142433-5owxgr7","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814142433-5owxgr7","updated":"20230814142433"},"Children":[{"ID":"20230814142433-u9bnah4","Type":"NodeParagraph","Properties":{"id":"20230814142433-u9bnah4","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"filepath"},{"Type":"NodeText","Data":"​：要加载的文件的路径，可以是一个字符串或字符串列表。"}]}]},{"ID":"20230814142433-tszjlla","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814142433-tszjlla","updated":"20230814142433"},"Children":[{"ID":"20230814142433-y8b9qxn","Type":"NodeParagraph","Properties":{"id":"20230814142433-y8b9qxn","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vs_path"},{"Type":"NodeText","Data":"​：（可选）向量库的保存路径，默认为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"None"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230814142433-ddbmkjk","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814142433-ddbmkjk","updated":"20230814142433"},"Children":[{"ID":"20230814142433-kdxwg5t","Type":"NodeParagraph","Properties":{"id":"20230814142433-kdxwg5t","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sentence_size"},{"Type":"NodeText","Data":"​：句子大小的限制，默认为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"SENTENCE_SIZE"},{"Type":"NodeText","Data":"​。"}]}]}]},{"ID":"20230814142433-38bkdnr","Type":"NodeParagraph","Properties":{"id":"20230814142433-38bkdnr","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"方法的功能如下："}]},{"ID":"20230814142433-3eh7jvv","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230814142433-3eh7jvv","updated":"20230814142433"},"Children":[{"ID":"20230814142433-299cfam","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230814142433-299cfam","updated":"20230814142433"},"Children":[{"ID":"20230814142433-xqxwekg","Type":"NodeParagraph","Properties":{"id":"20230814142433-xqxwekg","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"初始化一些变量来记录成功加载的文件和失败的文件。"}]}]},{"ID":"20230814142433-pmuspju","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230814142433-pmuspju","updated":"20230814142433"},"Children":[{"ID":"20230814142433-m0ov1uu","Type":"NodeParagraph","Properties":{"id":"20230814142433-m0ov1uu","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"根据传入的文件路径类型进行判断："}]},{"ID":"20230814142433-lbnnk2k","Type":"NodeList","ListData":{},"Properties":{"id":"20230814142433-lbnnk2k","updated":"20230814142433"},"Children":[{"ID":"20230814142433-y79lve8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814142433-y79lve8","updated":"20230814142433"},"Children":[{"ID":"20230814142433-qm9d36o","Type":"NodeParagraph","Properties":{"id":"20230814142433-qm9d36o","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"如果"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"filepath"},{"Type":"NodeText","Data":"​是一个字符串，那么判断路径是否存在，如果不存在则返回"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"None"},{"Type":"NodeText","Data":"​，如果存在则尝试加载文件，并将成功加载的文件添加到"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"loaded_files"},{"Type":"NodeText","Data":"​列表中。"}]}]},{"ID":"20230814142433-jema18m","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814142433-jema18m","updated":"20230814142433"},"Children":[{"ID":"20230814142433-kefinfb","Type":"NodeParagraph","Properties":{"id":"20230814142433-kefinfb","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"如果"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"filepath"},{"Type":"NodeText","Data":"​是一个目录，那么遍历目录下的文件，尝试加载每个文件，并将成功加载和未能加载的文件分别添加到相应的列表中。"}]}]},{"ID":"20230814142433-jw9x0yd","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814142433-jw9x0yd","updated":"20230814142433"},"Children":[{"ID":"20230814142433-l29u2i5","Type":"NodeParagraph","Properties":{"id":"20230814142433-l29u2i5","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"如果"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"filepath"},{"Type":"NodeText","Data":"​是一个字符串列表，那么遍历列表中的每个文件，尝试加载每个文件，并将成功加载的文件添加到"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"loaded_files"},{"Type":"NodeText","Data":"​列表中。"}]}]}]}]},{"ID":"20230814142433-23ibf4v","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230814142433-23ibf4v","updated":"20230814142433"},"Children":[{"ID":"20230814142433-qkra48t","Type":"NodeParagraph","Properties":{"id":"20230814142433-qkra48t","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"检查加载的文件数量，如果大于0，则继续生成向量库。"}]}]},{"ID":"20230814142433-ubxajp3","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20230814142433-ubxajp3","updated":"20230814142433"},"Children":[{"ID":"20230814142433-12leos4","Type":"NodeParagraph","Properties":{"id":"20230814142433-12leos4","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"根据"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vs_path"},{"Type":"NodeText","Data":"​是否存在来确定向量库的保存路径："}]},{"ID":"20230814142433-x7x1uhs","Type":"NodeList","ListData":{},"Properties":{"id":"20230814142433-x7x1uhs","updated":"20230814142433"},"Children":[{"ID":"20230814142433-gn80bd7","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814142433-gn80bd7","updated":"20230814142433"},"Children":[{"ID":"20230814142433-ezc7flr","Type":"NodeParagraph","Properties":{"id":"20230814142433-ezc7flr","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"如果"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vs_path"},{"Type":"NodeText","Data":"​存在且是一个目录，则使用该目录作为保存路径，通过调用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"FAISS.load_local()"},{"Type":"NodeText","Data":"​从保存的向量库中加载并将新文档添加到向量库中。"}]}]},{"ID":"20230814142433-67wb774","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814142433-67wb774","updated":"20230814142433"},"Children":[{"ID":"20230814142433-j2cu0m8","Type":"NodeParagraph","Properties":{"id":"20230814142433-j2cu0m8","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"如果"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vs_path"},{"Type":"NodeText","Data":"​不存在，则使用默认的保存路径，将文档作为新的向量库，并保存在指定路径中。"}]}]}]}]},{"ID":"20230814142433-xlq19w6","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20230814142433-xlq19w6","updated":"20230814142433"},"Children":[{"ID":"20230814142433-w4kxkdo","Type":"NodeParagraph","Properties":{"id":"20230814142433-w4kxkdo","updated":"20230814142433"},"Children":[{"Type":"NodeText","Data":"最后，返回向量库的保存路径和成功加载的文件列表。"}]}]}]},{"ID":"20230814142433-2o30d8t","Type":"NodeParagraph","Properties":{"id":"20230814142433-2o30d8t","updated":"20230814143135"},"Children":[{"Type":"NodeText","Data":"这是一个片段代码，缺少部分定义和引用的内容。"}]},{"ID":"20230814143154-6319cni","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230814143154-6319cni","style":"background-color: var(--b3-card-error-color); color: var(--b3-card-error-background);","updated":"20230814143308"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"# class localDocQA\n# 知识补充\n    def one_knowledge_add(self, vs_path, one_title, one_conent, one_content_segmentation, sentence_size):\n        try:\n            if not vs_path or not one_title or not one_conent:\n                logger.info(\"知识库添加错误，请确认知识库名字、标题、内容是否正确！\")\n                return None, [one_title]\n            docs = [Document(page_content=one_conent + \"\\n\", metadata={\"source\": one_title})]\n            if not one_content_segmentation:\n                text_splitter = ChineseTextSplitter(pdf=False, sentence_size=sentence_size)\n                docs = text_splitter.split_documents(docs)\n            if os.path.isdir(vs_path):\n                vector_store = FAISS.load_local(vs_path, self.embeddings)\n                vector_store.add_documents(docs)\n            else:\n                vector_store = FAISS.from_documents(docs, self.embeddings)  ##docs 为Document列表\n            torch_gc()\n            vector_store.save_local(vs_path)\n            return vs_path, [one_title]\n        except Exception as e:\n            logger.error(e)\n            return None, [one_title]\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230814144438-fplzitj","Type":"NodeParagraph","Properties":{"id":"20230814144438-fplzitj","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"这是一个Python类的方法，用于向知识向量库添加一条新的知识。"}]},{"ID":"20230814144438-83fief4","Type":"NodeParagraph","Properties":{"id":"20230814144438-83fief4","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"该方法的参数包括："}]},{"ID":"20230814144438-nyfzeiv","Type":"NodeList","ListData":{},"Properties":{"id":"20230814144438-nyfzeiv","updated":"20230814144438"},"Children":[{"ID":"20230814144438-ppzlpbj","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144438-ppzlpbj","updated":"20230814144438"},"Children":[{"ID":"20230814144438-z7w5szm","Type":"NodeParagraph","Properties":{"id":"20230814144438-z7w5szm","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self"},{"Type":"NodeText","Data":"​：表示对象本身。"}]}]},{"ID":"20230814144438-8v79qsq","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144438-8v79qsq","updated":"20230814144438"},"Children":[{"ID":"20230814144438-b19q9rg","Type":"NodeParagraph","Properties":{"id":"20230814144438-b19q9rg","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vs_path"},{"Type":"NodeText","Data":"​：知识向量库的保存路径。"}]}]},{"ID":"20230814144438-uq4jn47","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144438-uq4jn47","updated":"20230814144438"},"Children":[{"ID":"20230814144438-bfv4f3t","Type":"NodeParagraph","Properties":{"id":"20230814144438-bfv4f3t","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"one_title"},{"Type":"NodeText","Data":"​：知识的标题。"}]}]},{"ID":"20230814144438-xbn8zqg","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144438-xbn8zqg","updated":"20230814144438"},"Children":[{"ID":"20230814144438-23i3yq4","Type":"NodeParagraph","Properties":{"id":"20230814144438-23i3yq4","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"one_conent"},{"Type":"NodeText","Data":"​：知识的内容。"}]}]},{"ID":"20230814144438-zkr7639","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144438-zkr7639","updated":"20230814144438"},"Children":[{"ID":"20230814144438-la23cf9","Type":"NodeParagraph","Properties":{"id":"20230814144438-la23cf9","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"one_content_segmentation"},{"Type":"NodeText","Data":"​：（可选）知识内容是否已经分词，默认为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"False"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230814144438-x35a1x0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144438-x35a1x0","updated":"20230814144438"},"Children":[{"ID":"20230814144438-qlhll5a","Type":"NodeParagraph","Properties":{"id":"20230814144438-qlhll5a","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sentence_size"},{"Type":"NodeText","Data":"​：句子大小的限制。"}]}]}]},{"ID":"20230814144438-k30yvlf","Type":"NodeParagraph","Properties":{"id":"20230814144438-k30yvlf","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"方法的功能如下："}]},{"ID":"20230814144438-m4a69le","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230814144438-m4a69le","updated":"20230814144438"},"Children":[{"ID":"20230814144438-e83k21b","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230814144438-e83k21b","updated":"20230814144438"},"Children":[{"ID":"20230814144438-kuekrvh","Type":"NodeParagraph","Properties":{"id":"20230814144438-kuekrvh","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"首先，检查传入的参数是否为空。如果"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vs_path"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"one_title"},{"Type":"NodeText","Data":"​或"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"one_conent"},{"Type":"NodeText","Data":"​为空，则记录错误信息并返回"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"None"},{"Type":"NodeText","Data":"​和标题列表。"}]}]},{"ID":"20230814144438-yzdkwlj","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230814144438-yzdkwlj","updated":"20230814144438"},"Children":[{"ID":"20230814144438-a0jqmvx","Type":"NodeParagraph","Properties":{"id":"20230814144438-a0jqmvx","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"根据传入的知识内容是否已经分词的标志，进行相应的处理："}]},{"ID":"20230814144438-qclo2ca","Type":"NodeList","ListData":{},"Properties":{"id":"20230814144438-qclo2ca","updated":"20230814144438"},"Children":[{"ID":"20230814144438-xsd6bju","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144438-xsd6bju","updated":"20230814144438"},"Children":[{"ID":"20230814144438-8537yjs","Type":"NodeParagraph","Properties":{"id":"20230814144438-8537yjs","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"如果"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"one_content_segmentation"},{"Type":"NodeText","Data":"​为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"False"},{"Type":"NodeText","Data":"​，则使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ChineseTextSplitter"},{"Type":"NodeText","Data":"​对知识内容进行分句处理。"}]}]},{"ID":"20230814144438-38hoier","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144438-38hoier","updated":"20230814144438"},"Children":[{"ID":"20230814144438-ftpdnbp","Type":"NodeParagraph","Properties":{"id":"20230814144438-ftpdnbp","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"如果"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"one_content_segmentation"},{"Type":"NodeText","Data":"​为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"True"},{"Type":"NodeText","Data":"​，则直接将知识内容作为一个文档添加到向量库中。"}]}]}]}]},{"ID":"20230814144438-ifcz2hr","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230814144438-ifcz2hr","updated":"20230814144438"},"Children":[{"ID":"20230814144438-c6njpfg","Type":"NodeParagraph","Properties":{"id":"20230814144438-c6njpfg","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"根据"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vs_path"},{"Type":"NodeText","Data":"​是否存在来确定向量库的保存路径："}]},{"ID":"20230814144438-d2mrza1","Type":"NodeList","ListData":{},"Properties":{"id":"20230814144438-d2mrza1","updated":"20230814144438"},"Children":[{"ID":"20230814144438-id9shjd","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144438-id9shjd","updated":"20230814144438"},"Children":[{"ID":"20230814144438-xk1kwcc","Type":"NodeParagraph","Properties":{"id":"20230814144438-xk1kwcc","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"如果"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vs_path"},{"Type":"NodeText","Data":"​存在并且是一个目录，那么加载现有的向量库，并将新的文档添加到向量库中。"}]}]},{"ID":"20230814144438-wng8pef","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144438-wng8pef","updated":"20230814144438"},"Children":[{"ID":"20230814144438-6bpsmfb","Type":"NodeParagraph","Properties":{"id":"20230814144438-6bpsmfb","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"如果"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vs_path"},{"Type":"NodeText","Data":"​不存在或不是一个目录，那么创建一个新的向量库，并将新的文档作为文档列表添加到向量库中。"}]}]}]}]},{"ID":"20230814144438-22glhoq","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20230814144438-22glhoq","updated":"20230814144438"},"Children":[{"ID":"20230814144438-fv3gbgx","Type":"NodeParagraph","Properties":{"id":"20230814144438-fv3gbgx","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"在完成向量库的添加操作后，释放可能占用的内存资源。"}]}]},{"ID":"20230814144438-xntc06c","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20230814144438-xntc06c","updated":"20230814144438"},"Children":[{"ID":"20230814144438-pqxf2ed","Type":"NodeParagraph","Properties":{"id":"20230814144438-pqxf2ed","updated":"20230814144438"},"Children":[{"Type":"NodeText","Data":"最后，将向量库保存到指定路径，并返回保存路径和成功添加的标题列表。"}]}]}]},{"ID":"20230814144512-v4go1o9","Type":"NodeParagraph","Properties":{"id":"20230814144512-v4go1o9"}},{"ID":"20230814144512-9x8p6m7","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230814144512-9x8p6m7","updated":"20230814144558"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"# class localDocQA\n# 加载已保存的知识向量库\n    def load_faiss(self, vs_path):\n        self.vector_store = FAISS.load_local(vs_path, self.embeddings)\n        FAISS.similarity_search_with_score_by_vector = similarity_search_with_score_by_vector\n        self.vector_store.chunk_size = self.chunk_size\n        self.vector_store.chunk_conent = self.chunk_conent\n        self.vector_store.score_threshold = self.score_threshold\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230814144607-6zrj9x8","Type":"NodeParagraph","Properties":{"id":"20230814144607-6zrj9x8","updated":"20230814144607"},"Children":[{"Type":"NodeText","Data":"这是一个类方法，用于加载已保存的知识向量库。"}]},{"ID":"20230814144607-uacpa4j","Type":"NodeParagraph","Properties":{"id":"20230814144607-uacpa4j","updated":"20230814144607"},"Children":[{"Type":"NodeText","Data":"该方法的参数包括："}]},{"ID":"20230814144607-qr93g9y","Type":"NodeList","ListData":{},"Properties":{"id":"20230814144607-qr93g9y","updated":"20230814144607"},"Children":[{"ID":"20230814144607-fzcaru9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144607-fzcaru9","updated":"20230814144607"},"Children":[{"ID":"20230814144607-3ragot4","Type":"NodeParagraph","Properties":{"id":"20230814144607-3ragot4","updated":"20230814144607"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self"},{"Type":"NodeText","Data":"​：表示对象本身。"}]}]},{"ID":"20230814144607-44du6wt","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144607-44du6wt","updated":"20230814144607"},"Children":[{"ID":"20230814144607-zqsi5aq","Type":"NodeParagraph","Properties":{"id":"20230814144607-zqsi5aq","updated":"20230814144607"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vs_path"},{"Type":"NodeText","Data":"​：已保存的知识向量库的路径。"}]}]}]},{"ID":"20230814144607-5j9d2te","Type":"NodeParagraph","Properties":{"id":"20230814144607-5j9d2te","updated":"20230814144607"},"Children":[{"Type":"NodeText","Data":"方法的功能如下："}]},{"ID":"20230814144607-yrjzt7h","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230814144607-yrjzt7h","updated":"20230814144607"},"Children":[{"ID":"20230814144607-cbf18kp","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230814144607-cbf18kp","updated":"20230814144607"},"Children":[{"ID":"20230814144607-lz3msfb","Type":"NodeParagraph","Properties":{"id":"20230814144607-lz3msfb","updated":"20230814144607"},"Children":[{"Type":"NodeText","Data":"调用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"FAISS.load_local()"},{"Type":"NodeText","Data":"​方法加载已保存的知识向量库文件。加载成功后，返回一个"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"VectorStore"},{"Type":"NodeText","Data":"​对象。"}]}]},{"ID":"20230814144607-ybbkzk3","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230814144607-ybbkzk3","updated":"20230814144607"},"Children":[{"ID":"20230814144607-2bandum","Type":"NodeParagraph","Properties":{"id":"20230814144607-2bandum","updated":"20230814144607"},"Children":[{"Type":"NodeText","Data":"将自定义的"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"similarity_search_with_score_by_vector"},{"Type":"NodeText","Data":"​函数赋值给"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"FAISS.similarity_search_with_score_by_vector"},{"Type":"NodeText","Data":"​静态属性，以便在后续的相似度搜索中使用。"}]}]},{"ID":"20230814144607-f3ld0w2","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230814144607-f3ld0w2","updated":"20230814144607"},"Children":[{"ID":"20230814144607-2zatt8e","Type":"NodeParagraph","Properties":{"id":"20230814144607-2zatt8e","updated":"20230814144607"},"Children":[{"Type":"NodeText","Data":"设置"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"VectorStore"},{"Type":"NodeText","Data":"​对象的属性："}]},{"ID":"20230814144607-vtlg14q","Type":"NodeList","ListData":{},"Properties":{"id":"20230814144607-vtlg14q","updated":"20230814144607"},"Children":[{"ID":"20230814144607-hulbfh5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144607-hulbfh5","updated":"20230814144607"},"Children":[{"ID":"20230814144607-oxd9sjo","Type":"NodeParagraph","Properties":{"id":"20230814144607-oxd9sjo","updated":"20230814144607"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"chunk_size"},{"Type":"NodeText","Data":"​：块大小。"}]}]},{"ID":"20230814144607-wsbfg8o","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144607-wsbfg8o","updated":"20230814144607"},"Children":[{"ID":"20230814144607-mw2op10","Type":"NodeParagraph","Properties":{"id":"20230814144607-mw2op10","updated":"20230814144607"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"chunk_conent"},{"Type":"NodeText","Data":"​：用于块内层级聚合的内容。"}]}]},{"ID":"20230814144607-zjokyri","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144607-zjokyri","updated":"20230814144607"},"Children":[{"ID":"20230814144607-qo3pfxm","Type":"NodeParagraph","Properties":{"id":"20230814144607-qo3pfxm","updated":"20230814144607"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"score_threshold"},{"Type":"NodeText","Data":"​：阈值，用于筛选结果。"}]}]}]}]}]},{"ID":"20230814144607-oc0k2ej","Type":"NodeParagraph","Properties":{"id":"20230814144607-oc0k2ej","updated":"20230814144621"},"Children":[{"Type":"NodeText","Data":"请注意，该代码片段中引用了一些未给出的变量和函数，并涉及到特定库（FAISS）的操作。因此，需要根据您的具体代码和需求来检查和完善该方法。"}]},{"ID":"20230814144615-clv57cc","Type":"NodeParagraph","Properties":{"id":"20230814144615-clv57cc"}},{"ID":"20230814144720-4ju1is5","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230814144720-4ju1is5","updated":"20230814144801"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"# class localDocQA\n    @staticmethod\n    def _filter_docs(docs: List[Document], rate=400) -\u003e List[Document]:\n        final_docs = []\n        for doc in docs:\n            if doc.metadata[\"score\"] \u003c rate:\n                final_docs.append(doc)\n        return final_docs\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230814144815-j9m4v0h","Type":"NodeParagraph","Properties":{"id":"20230814144815-j9m4v0h","updated":"20230814144815"},"Children":[{"Type":"NodeText","Data":"这是一个静态方法，用于根据得分过滤文档列表。"}]},{"ID":"20230814144815-771p179","Type":"NodeParagraph","Properties":{"id":"20230814144815-771p179","updated":"20230814144815"},"Children":[{"Type":"NodeText","Data":"该方法的参数包括："}]},{"ID":"20230814144815-i1v6ilz","Type":"NodeList","ListData":{},"Properties":{"id":"20230814144815-i1v6ilz","updated":"20230814144815"},"Children":[{"ID":"20230814144815-cvpp6nn","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144815-cvpp6nn","updated":"20230814144815"},"Children":[{"ID":"20230814144815-jpmmpeq","Type":"NodeParagraph","Properties":{"id":"20230814144815-jpmmpeq","updated":"20230814144815"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"docs"},{"Type":"NodeText","Data":"​：待过滤的文档列表。"}]}]},{"ID":"20230814144815-ozn3luz","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814144815-ozn3luz","updated":"20230814144815"},"Children":[{"ID":"20230814144815-8w95tq7","Type":"NodeParagraph","Properties":{"id":"20230814144815-8w95tq7","updated":"20230814144815"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"rate"},{"Type":"NodeText","Data":"​：分数的筛选阈值，默认为400。"}]}]}]},{"ID":"20230814144815-8ohhmoe","Type":"NodeParagraph","Properties":{"id":"20230814144815-8ohhmoe","updated":"20230814144815"},"Children":[{"Type":"NodeText","Data":"方法的功能如下："}]},{"ID":"20230814144815-kivquhy","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230814144815-kivquhy","updated":"20230814144815"},"Children":[{"ID":"20230814144815-xor61yp","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230814144815-xor61yp","updated":"20230814144815"},"Children":[{"ID":"20230814144815-ybivj8q","Type":"NodeParagraph","Properties":{"id":"20230814144815-ybivj8q","updated":"20230814144815"},"Children":[{"Type":"NodeText","Data":"创建一个空列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"final_docs"},{"Type":"NodeText","Data":"​ 用于存储过滤后的文档。"}]}]},{"ID":"20230814144815-j95l6ro","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230814144815-j95l6ro","updated":"20230814144815"},"Children":[{"ID":"20230814144815-qjhmlam","Type":"NodeParagraph","Properties":{"id":"20230814144815-qjhmlam","updated":"20230814144815"},"Children":[{"Type":"NodeText","Data":"遍历输入的文档列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"docs"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230814144815-28s2w0r","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230814144815-28s2w0r","updated":"20230814144815"},"Children":[{"ID":"20230814144815-6k2esy4","Type":"NodeParagraph","Properties":{"id":"20230814144815-6k2esy4","updated":"20230814144815"},"Children":[{"Type":"NodeText","Data":"对于每个文档 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"doc"},{"Type":"NodeText","Data":"​，检查其元数据中的得分 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"doc.metadata[\u0026quot;score\u0026quot;]"},{"Type":"NodeText","Data":"​ 是否小于筛选阈值 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"rate"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230814144815-ppjmgze","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20230814144815-ppjmgze","updated":"20230814144815"},"Children":[{"ID":"20230814144815-3xspga1","Type":"NodeParagraph","Properties":{"id":"20230814144815-3xspga1","updated":"20230814144815"},"Children":[{"Type":"NodeText","Data":"如果得分小于阈值，则将该文档添加到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"final_docs"},{"Type":"NodeText","Data":"​ 列表中。"}]}]},{"ID":"20230814144815-8gqmjhl","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20230814144815-8gqmjhl","updated":"20230814144815"},"Children":[{"ID":"20230814144815-fzlziky","Type":"NodeParagraph","Properties":{"id":"20230814144815-fzlziky","updated":"20230814144815"},"Children":[{"Type":"NodeText","Data":"遍历完所有文档后，返回过滤后的文档列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"final_docs"},{"Type":"NodeText","Data":"​。"}]}]}]},{"ID":"20230814144815-tatjo1n","Type":"NodeParagraph","Properties":{"id":"20230814144815-tatjo1n","updated":"20230814144815"},"Children":[{"Type":"NodeText","Data":"请注意，该代码片段缺少一些定义和引用的内容，例如"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Document"},{"Type":"NodeText","Data":"​类的定义和对应的导入语句。您需要根据代码的上下文和您的具体需求来完善和调整该方法。如果有任何进一步的问题，请随时提问。"}]},{"ID":"20230814150907-xz2rpq7","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230814150907-xz2rpq7","updated":"20230814154056"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"# class localDocQA\ndef get_knowledge_based_answer(self, query, vs_path, chat_history=[], streaming: bool = STREAMING, rate=400):\n        if self.vector_store is None:\n            self.load_faiss(vs_path)\n  \n        related_docs_with_score = self.vector_store.similarity_search_with_score(query, k=self.top_k)\n        torch_gc()\n\n        filtered_docs = self._filter_docs(related_docs_with_score, rate)\n        if filtered_docs:\n            prompt = generate_prompt(related_docs_with_score, query)\n        else:\n            prompt = query\n\n        for answer_result in self.llm.generatorAnswer(prompt=prompt, history=chat_history, streaming=streaming):\n            resp = answer_result.llm_output[\"answer\"]\n            history = answer_result.history\n            history[-1][0] = query\n            response = {\"query\": query,\n                        \"result\": resp,\n                        \"source_documents\": filtered_docs}\n            yield response, history\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230814151216-snr3h45","Type":"NodeParagraph","Properties":{"id":"20230814151216-snr3h45","updated":"20230814151216"},"Children":[{"Type":"NodeText","Data":"这段代码是一个方法的实现，它接收一些输入参数并返回一个生成器对象。让我们逐行解释它："}]},{"ID":"20230814151216-qrldqj9","Type":"NodeList","ListData":{},"Properties":{"id":"20230814151216-qrldqj9","updated":"20230814151216"},"Children":[{"ID":"20230814151216-pv9xs8m","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814151216-pv9xs8m","updated":"20230814151216"},"Children":[{"ID":"20230814151216-4w2xnwg","Type":"NodeParagraph","Properties":{"id":"20230814151216-4w2xnwg","updated":"20230814151216"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"get_knowledge_based_answer(self, query, vs_path, chat_history=[], streaming: bool = STREAMING, rate=400)"},{"Type":"NodeText","Data":"​​：这是一个方法声明，接受几个参数："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self"},{"Type":"NodeText","Data":"​​（指向当前实例的引用）、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"query"},{"Type":"NodeText","Data":"​​（查询字符串）、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vs_path"},{"Type":"NodeText","Data":"​​（向量存储的路径）、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"chat_history"},{"Type":"NodeText","Data":"​​（聊天历史记录，默认为空列表）、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"streaming"},{"Type":"NodeText","Data":"​​（布尔值，默认为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"STREAMING"},{"Type":"NodeText","Data":"​​）、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"rate"},{"Type":"NodeText","Data":"​​（整数，默认为 400）。"}]}]},{"ID":"20230814151216-ss4oz7s","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814151216-ss4oz7s","updated":"20230814151216"},"Children":[{"ID":"20230814151216-gtgfumw","Type":"NodeParagraph","Properties":{"id":"20230814151216-gtgfumw","updated":"20230814151216"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"if self.vector_store is None: self.load_faiss(vs_path)"},{"Type":"NodeText","Data":"​​：检查当前实例的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vector_store"},{"Type":"NodeText","Data":"​​ 是否为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"None"},{"Type":"NodeText","Data":"​​，如果是，则调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"load_faiss(vs_path)"},{"Type":"NodeText","Data":"​​ 方法加载 Faiss 向量存储。"}]}]},{"ID":"20230814151216-nah26jl","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814151216-nah26jl","updated":"20230814151216"},"Children":[{"ID":"20230814151216-gwkl87s","Type":"NodeParagraph","Properties":{"id":"20230814151216-gwkl87s","updated":"20230814151216"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"related_docs_with_score = self.vector_store.similarity_search_with_score(query, k=self.top_k)"},{"Type":"NodeText","Data":"​​：使用 Faiss 向量存储中的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"similarity_search_with_score()"},{"Type":"NodeText","Data":"​​ 方法，基于查询字符串找到相关的文档，并返回带有得分的相关文档。"}]}]},{"ID":"20230814151216-lcsz5qy","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814151216-lcsz5qy","updated":"20230814151216"},"Children":[{"ID":"20230814151216-9uke2w5","Type":"NodeParagraph","Properties":{"id":"20230814151216-9uke2w5","updated":"20230814151216"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"torch_gc()"},{"Type":"NodeText","Data":"​​：调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"torch_gc()"},{"Type":"NodeText","Data":"​​ 函数，进行 Torch GC（垃圾回收）操作，释放不再使用的内存资源。"}]}]},{"ID":"20230814151216-ut8f7eg","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814151216-ut8f7eg","updated":"20230814151216"},"Children":[{"ID":"20230814151216-d8xxy40","Type":"NodeParagraph","Properties":{"id":"20230814151216-d8xxy40","updated":"20230814151216"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"filtered_docs = self._filter_docs(related_docs_with_score, rate)"},{"Type":"NodeText","Data":"​​：调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_filter_docs()"},{"Type":"NodeText","Data":"​​ 方法，过滤得分低于给定阈值 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"rate"},{"Type":"NodeText","Data":"​​ 的相关文档。"}]}]},{"ID":"20230814151216-txo2i6k","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814151216-txo2i6k","updated":"20230814151216"},"Children":[{"ID":"20230814151216-1e7f873","Type":"NodeParagraph","Properties":{"id":"20230814151216-1e7f873","updated":"20230814151216"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"if filtered_docs: prompt = generate_prompt(related_docs_with_score, query) else: prompt = query"},{"Type":"NodeText","Data":"​​：如果存在过滤后的相关文档，则调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"generate_prompt()"},{"Type":"NodeText","Data":"​​ 方法生成一个提示字符串 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"prompt"},{"Type":"NodeText","Data":"​​，否则将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"prompt"},{"Type":"NodeText","Data":"​​ 设置为查询字符串 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"query"},{"Type":"NodeText","Data":"​​。"}]}]},{"ID":"20230814151216-68bjtp1","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230814151216-68bjtp1","updated":"20230814151216"},"Children":[{"ID":"20230814151216-lk2eq5c","Type":"NodeParagraph","Properties":{"id":"20230814151216-lk2eq5c","updated":"20230814151216"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"for answer_result in self.llm.generatorAnswer(prompt=prompt, history=chat_history, streaming=streaming): resp = answer_result.llm_output[\u0026quot;answer\u0026quot;] history = answer_result.history history[-1][0] = query response = {\u0026quot;query\u0026quot;: query, \u0026quot;result\u0026quot;: resp, \u0026quot;source_documents\u0026quot;: filtered_docs} yield response, history"},{"Type":"NodeText","Data":"​​：使用 GPT-3.5 语言模型（LLM）的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"generatorAnswer()"},{"Type":"NodeText","Data":"​​ 方法生成回答。通过迭代 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"answer_result"},{"Type":"NodeText","Data":"​​ 中的结果，获取回答字符串 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"resp"},{"Type":"NodeText","Data":"​​ 和历史记录 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"history"},{"Type":"NodeText","Data":"​​。然后，将历史记录列表中最后一项的第一个元素设置为查询字符串 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"query"},{"Type":"NodeText","Data":"​​，并构建一个包含查询、回答和源文档的响应字典。最后，通过 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"yield"},{"Type":"NodeText","Data":"​​ 关键字返回响应和更新后的历史记录。"}]}]}]},{"ID":"20230814151216-bt6fnop","Type":"NodeParagraph","Properties":{"id":"20230814151216-bt6fnop","updated":"20230814151216"},"Children":[{"Type":"NodeText","Data":"总的来说，这个方法使用 Faiss 向量存储找到相关的文档，然后根据一些条件和规则生成一个提示字符串，并使用 GPT-3.5 语言模型生成回答。每次迭代生成器时，都会返回一个包含响应和更新后的历史记录的字典。"}]},{"ID":"20230814153840-q0ky196","Type":"NodeParagraph","Properties":{"id":"20230814153840-q0ky196"}},{"ID":"20230814153842-qz1pdkd","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230814153842-qz1pdkd","updated":"20230814155215"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"# class localDocQA\n    # query      查询内容\n    # vs_path    知识库路径\n    # chunk_conent   是否启用上下文关联\n    # score_threshold    搜索匹配score阈值\n    # vector_search_top_k   搜索知识库内容条数，默认搜索5条结果\n    # chunk_sizes    匹配单段内容的连接上下文长度\n    def get_knowledge_based_conent_test(self, query, vs_path, chunk_conent,\n                                        score_threshold=VECTOR_SEARCH_SCORE_THRESHOLD, vector_search_top_k=VECTOR_SEARCH_TOP_K, chunk_size=CHUNK_SIZE):\n        vector_store = FAISS.load_local(vs_path, self.embeddings)\n        FAISS.similarity_search_with_score_by_vector = similarity_search_with_score_by_vector\n        vector_store.chunk_conent = chunk_conent\n        vector_store.score_threshold = score_threshold\n        vector_store.chunk_size = chunk_size\n        related_docs_with_score = vector_store.similarity_search_with_score(query, k=vector_search_top_k)\n        if not related_docs_with_score:\n            response = {\"query\": query,\n                        \"source_documents\": []}\n            return response, \"\"\n        torch_gc()\n        prompt = \"\\n\".join([doc.page_content for doc in related_docs_with_score])\n        response = {\"query\": query,\n                    \"source_documents\": related_docs_with_score}\n        return response, prompt\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230814155827-j4w7e7c","Type":"NodeParagraph","Properties":{"id":"20230814155827-j4w7e7c","updated":"20230814155827"},"Children":[{"Type":"NodeText","Data":"根据给出的代码片段，我看到这段代码主要是根据输入的查询内容和知识库路径来获取相关的知识库内容。具体来说，这段代码执行以下操作："}]},{"ID":"20230814155827-8ec20wz","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230814155827-8ec20wz","updated":"20230814155827"},"Children":[{"ID":"20230814155827-wha0tdz","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230814155827-wha0tdz","updated":"20230814155827"},"Children":[{"ID":"20230814155827-fwukq88","Type":"NodeParagraph","Properties":{"id":"20230814155827-fwukq88","updated":"20230814155827"},"Children":[{"Type":"NodeText","Data":"加载存储在本地的向量索引（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vector_store"},{"Type":"NodeText","Data":"​）。"}]}]},{"ID":"20230814155827-841pyl4","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230814155827-841pyl4","updated":"20230814155827"},"Children":[{"ID":"20230814155827-cnrzsec","Type":"NodeParagraph","Properties":{"id":"20230814155827-cnrzsec","updated":"20230814155827"},"Children":[{"Type":"NodeText","Data":"设置一些参数，如是否启用上下文关联（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"chunk_conent"},{"Type":"NodeText","Data":"​）、搜索匹配分数阈值（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"score_threshold"},{"Type":"NodeText","Data":"​）、搜索知识库内容条数（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vector_search_top_k"},{"Type":"NodeText","Data":"​）和匹配单段内容的连接上下文长度（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"chunk_size"},{"Type":"NodeText","Data":"​）。"}]}]},{"ID":"20230814155827-pjzyvrp","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230814155827-pjzyvrp","updated":"20230814155827"},"Children":[{"ID":"20230814155827-w9ur6od","Type":"NodeParagraph","Properties":{"id":"20230814155827-w9ur6od","updated":"20230814155827"},"Children":[{"Type":"NodeText","Data":"执行相似性搜索函数（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"similarity_search_with_score"},{"Type":"NodeText","Data":"​），通过查询内容从向量索引中检索相关的文档，并返回与查询相关的文档以及一个提示字符串（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"prompt"},{"Type":"NodeText","Data":"​）。"}]}]},{"ID":"20230814155827-ku2zrt6","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20230814155827-ku2zrt6","updated":"20230814155827"},"Children":[{"ID":"20230814155827-q3den8z","Type":"NodeParagraph","Properties":{"id":"20230814155827-q3den8z","updated":"20230814155827"},"Children":[{"Type":"NodeText","Data":"将查询信息和源文档列表封装到响应中并返回。"}]}]}]},{"ID":"20230814155827-s50g60w","Type":"NodeParagraph","Properties":{"id":"20230814155827-s50g60w","updated":"20230814155827"},"Children":[{"Type":"NodeText","Data":"需要注意的是，这段代码使用了自定义的向量索引类（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"FAISS"},{"Type":"NodeText","Data":"​）和相似性搜索函数（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"similarity_search_with_score_by_vector"},{"Type":"NodeText","Data":"​），这些都是先前定义的内容，可能没有包含在代码片段中。"}]},{"ID":"20230814155904-u5ztkne","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230814155904-u5ztkne","updated":"20230814155919"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"# class localDocQA\ndef get_search_result_based_answer(self, query, chat_history=[], streaming: bool = STREAMING):\n        results = bing_search(query)\n        result_docs = search_result2docs(results)\n        prompt = generate_prompt(result_docs, query)\n\n        for answer_result in self.llm.generatorAnswer(prompt=prompt, history=chat_history,\n                                                      streaming=streaming):\n            resp = answer_result.llm_output[\"answer\"]\n            history = answer_result.history\n            history[-1][0] = query\n            response = {\"query\": query,\n                        \"result\": resp,\n                        \"source_documents\": result_docs}\n            yield response, history\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230814160115-aetjzzn","Type":"NodeParagraph","Properties":{"id":"20230814160115-aetjzzn","updated":"20230814160115"},"Children":[{"Type":"NodeText","Data":"根据给出的代码片段，这段代码用于根据查询内容从搜索引擎中获取结果，并生成回答。具体来说，这段代码执行以下操作："}]},{"ID":"20230814160115-cerct91","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230814160115-cerct91","updated":"20230814160115"},"Children":[{"ID":"20230814160115-lw4wjhz","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230814160115-lw4wjhz","updated":"20230814160115"},"Children":[{"ID":"20230814160115-d5bthg3","Type":"NodeParagraph","Properties":{"id":"20230814160115-d5bthg3","updated":"20230814160115"},"Children":[{"Type":"NodeText","Data":"调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"bing_search()"},{"Type":"NodeText","Data":"​ 函数，使用必应搜索引擎对查询内容进行搜索，返回搜索结果（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"results"},{"Type":"NodeText","Data":"​）。"}]}]},{"ID":"20230814160115-sqx0sws","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230814160115-sqx0sws","updated":"20230814160115"},"Children":[{"ID":"20230814160115-xiot4z2","Type":"NodeParagraph","Properties":{"id":"20230814160115-xiot4z2","updated":"20230814160115"},"Children":[{"Type":"NodeText","Data":"调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"search_result2docs()"},{"Type":"NodeText","Data":"​ 函数，将搜索结果转换为文档列表（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"result_docs"},{"Type":"NodeText","Data":"​）。"}]}]},{"ID":"20230814160115-3oethij","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230814160115-3oethij","updated":"20230814160115"},"Children":[{"ID":"20230814160115-4dsa69c","Type":"NodeParagraph","Properties":{"id":"20230814160115-4dsa69c","updated":"20230814160115"},"Children":[{"Type":"NodeText","Data":"调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"generate_prompt()"},{"Type":"NodeText","Data":"​ 函数，使用搜索结果和查询内容生成一个提示字符串（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"prompt"},{"Type":"NodeText","Data":"​）。"}]}]},{"ID":"20230814160115-toygud6","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20230814160115-toygud6","updated":"20230814160115"},"Children":[{"ID":"20230814160115-eqrpulb","Type":"NodeParagraph","Properties":{"id":"20230814160115-eqrpulb","updated":"20230814160115"},"Children":[{"Type":"NodeText","Data":"使用 GPT-3.5 语言模型（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self.llm"},{"Type":"NodeText","Data":"​）的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"generatorAnswer()"},{"Type":"NodeText","Data":"​ 方法，传入提示字符串和聊天历史（如果有），并生成回答。"}]}]},{"ID":"20230814160115-o5nrz6a","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20230814160115-o5nrz6a","updated":"20230814160115"},"Children":[{"ID":"20230814160115-56sugbo","Type":"NodeParagraph","Properties":{"id":"20230814160115-56sugbo","updated":"20230814160115"},"Children":[{"Type":"NodeText","Data":"遍历生成的回答结果，将回答信息、查询、搜索结果文档封装到响应中，并使用生成的历史记录作为下一次调用的聊天历史。"}]}]}]},{"ID":"20230814160115-tc0bt9g","Type":"NodeParagraph","Properties":{"id":"20230814160115-tc0bt9g","updated":"20230814160115"},"Children":[{"Type":"NodeText","Data":"这段代码还定义为生成器函数，因此可以使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"yield"},{"Type":"NodeText","Data":"​ 返回多个回答结果，而不是仅返回一个结果。"}]},{"ID":"20230814160115-k1ttry2","Type":"NodeParagraph","Properties":{"id":"20230814160115-k1ttry2","updated":"20230814160115"},"Children":[{"Type":"NodeText","Data":"需要注意的是，这段代码依赖一些自定义函数（如 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"bing_search()"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"search_result2docs()"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"generate_prompt()"},{"Type":"NodeText","Data":"​），这些函数的实现可能没有包含在代码片段中。此外，代码还使用了一个名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"STREAMING"},{"Type":"NodeText","Data":"​ 的常量，但在给出的代码中没有显示其定义。"}]},{"ID":"20230814160115-8xzinuq","Type":"NodeParagraph","Properties":{"id":"20230814160115-8xzinuq","updated":"20230814160115"},"Children":[{"Type":"NodeText","Data":"如果您有任何关于代码的具体问题，请提供更多细节，我将尽力帮助您解答。"}]},{"ID":"20230815090317-tq4usym","Type":"NodeParagraph","Properties":{"id":"20230815090317-tq4usym"}},{"ID":"20230815090320-s9viwni","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230815090320-s9viwni","updated":"20230815090333"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"    def process_step1(self, res_dict):\n        logging.info(f'in step1, res_dict: {str(res_dict)}')\n        task1_input = TASK1_TPROMPT + \"\\n\" + TASK1_PROMPT.replace(\"{input}\", res_dict[\"query\"])\n        for answer_result in self.llm.generatorAnswer(prompt=task1_input, history=[], streaming=False):\n            resp = answer_result.llm_output[\"answer\"]\n        try:\n            resp = json.loads(resp)\n        except:\n            resp = [{\"task\": \"答复生成\", \"id\": 0, \"dep\": -1}]\n        res_dict[\"step1_input\"] = task1_input\n        res_dict[\"step1_output\"] = resp\n        logging.info(\"task1 input: {}\\ntask1 output{}\".format(task1_input, resp))\n        return resp\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230815090702-me9ijxa","Type":"NodeParagraph","Properties":{"id":"20230815090702-me9ijxa","updated":"20230815090702"},"Children":[{"Type":"NodeText","Data":"根据给出的代码片段，这段代码是一个名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"process_step1"},{"Type":"NodeText","Data":"​ 的方法，用于处理步骤一的结果。具体来说，这段代码执行以下操作："}]},{"ID":"20230815090702-fuzmhye","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230815090702-fuzmhye","updated":"20230815090702"},"Children":[{"ID":"20230815090702-phnvhh8","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230815090702-phnvhh8","updated":"20230815090702"},"Children":[{"ID":"20230815090702-pa93ehp","Type":"NodeParagraph","Properties":{"id":"20230815090702-pa93ehp","updated":"20230815090702"},"Children":[{"Type":"NodeText","Data":"打印日志，记录输入参数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 的内容。"}]}]},{"ID":"20230815090702-ph130mx","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230815090702-ph130mx","updated":"20230815090702"},"Children":[{"ID":"20230815090702-1oyzr57","Type":"NodeParagraph","Properties":{"id":"20230815090702-1oyzr57","updated":"20230815090702"},"Children":[{"Type":"NodeText","Data":"根据指定的模板字符串 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"TASK1_TPROMPT"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"TASK1_PROMPT"},{"Type":"NodeText","Data":"​，生成任务一的提示字符串 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"task1_input"},{"Type":"NodeText","Data":"​。其中，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"TASK1_PROMPT"},{"Type":"NodeText","Data":"​ 的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"{input}"},{"Type":"NodeText","Data":"​ 部分会被替换为查询结果中的查询内容（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict[\u0026quot;query\u0026quot;]"},{"Type":"NodeText","Data":"​）。"}]}]},{"ID":"20230815090702-pbpgsrz","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230815090702-pbpgsrz","updated":"20230815090702"},"Children":[{"ID":"20230815090702-sc8udb7","Type":"NodeParagraph","Properties":{"id":"20230815090702-sc8udb7","updated":"20230815090702"},"Children":[{"Type":"NodeText","Data":"使用 GPT-3.5 语言模型（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self.llm"},{"Type":"NodeText","Data":"​）的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"generatorAnswer()"},{"Type":"NodeText","Data":"​ 方法，传入任务一的提示字符串和空的聊天历史（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"history=[]"},{"Type":"NodeText","Data":"​），生成回答。"}]}]},{"ID":"20230815090702-6jtxnwq","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20230815090702-6jtxnwq","updated":"20230815090702"},"Children":[{"ID":"20230815090702-w03yrk6","Type":"NodeParagraph","Properties":{"id":"20230815090702-w03yrk6","updated":"20230815090702"},"Children":[{"Type":"NodeText","Data":"获取生成的回答作为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"resp"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230815090702-x2js6kk","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20230815090702-x2js6kk","updated":"20230815090702"},"Children":[{"ID":"20230815090702-vybi25f","Type":"NodeParagraph","Properties":{"id":"20230815090702-vybi25f","updated":"20230815090702"},"Children":[{"Type":"NodeText","Data":"尝试将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"resp"},{"Type":"NodeText","Data":"​ 解析为 JSON 格式，如果解析失败，则将它赋值为一个默认的列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"resp = [{\u0026quot;task\u0026quot;: \u0026quot;答复生成\u0026quot;, \u0026quot;id\u0026quot;: 0, \u0026quot;dep\u0026quot;: -1}]"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230815090702-n0rzkma","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Ni4=","Num":6},"Properties":{"id":"20230815090702-n0rzkma","updated":"20230815090702"},"Children":[{"ID":"20230815090702-ral2k0j","Type":"NodeParagraph","Properties":{"id":"20230815090702-ral2k0j","updated":"20230815090702"},"Children":[{"Type":"NodeText","Data":"将任务一的输入（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"task1_input"},{"Type":"NodeText","Data":"​）和输出（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"resp"},{"Type":"NodeText","Data":"​）存储到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 中。"}]}]},{"ID":"20230815090702-rgtqzvm","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Ny4=","Num":7},"Properties":{"id":"20230815090702-rgtqzvm","updated":"20230815090702"},"Children":[{"ID":"20230815090702-jiz1jsy","Type":"NodeParagraph","Properties":{"id":"20230815090702-jiz1jsy","updated":"20230815090702"},"Children":[{"Type":"NodeText","Data":"打印日志，记录任务一的输入和输出内容。"}]}]},{"ID":"20230815090702-11dtp0k","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"OC4=","Num":8},"Properties":{"id":"20230815090702-11dtp0k","updated":"20230815090702"},"Children":[{"ID":"20230815090702-n5li6jr","Type":"NodeParagraph","Properties":{"id":"20230815090702-n5li6jr","updated":"20230815090702"},"Children":[{"Type":"NodeText","Data":"返回任务一的输出结果。"}]}]}]},{"ID":"20230815090702-euiqjlj","Type":"NodeParagraph","Properties":{"id":"20230815090702-euiqjlj","updated":"20230815090702"},"Children":[{"Type":"NodeText","Data":"需要注意的是，这段代码依赖于一些额外的变量和常量（如 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"TASK1_TPROMPT"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"TASK1_PROMPT"},{"Type":"NodeText","Data":"​），在提供的代码片段中没有显示其定义。此外，代码中的日志记录函数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"logging.info()"},{"Type":"NodeText","Data":"​ 是用于打印日志信息，具体的日志输出可能需要根据实际情况进行配置和处理。"}]},{"ID":"20230815090702-4atydg3","Type":"NodeParagraph","Properties":{"id":"20230815090702-4atydg3","updated":"20230815091349"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 是一个字典参数，作为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"process_step1"},{"Type":"NodeText","Data":"​ 方法的输入。它的作用是用于存储和传递处理过程中的结果和信息。"}]},{"ID":"20230815091413-bcq52m3","Type":"NodeParagraph","Properties":{"id":"20230815091413-bcq52m3","updated":"20230815091413"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 可能包含了调用该方法前已经计算或获取到的一些结果，然后在方法内部进行进一步的处理，并将产生的新结果添加到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 中，最后返回给调用者使用。"}]},{"ID":"20230815092348-7vv2pr9","Type":"NodeParagraph","Properties":{"id":"20230815092348-7vv2pr9"}},{"ID":"20230815092349-v2q7qca","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230815092349-v2q7qca","updated":"20230815092359"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"    def process_step2(self, task_name, res_dict):\n        logging.info(f'in step2, res_dict: str(res_dict)')\n        if task_name == \"技术标准检索\":\n            if self.vector_store is None:\n                self.load_faiss(vs_path)\n      \n            related_docs_with_score = self.vector_store.similarity_search_with_score(res_dict[\"query\"], k=self.top_k)\n            torch_gc()\n            filtered_docs = self._filter_docs(related_docs_with_score, rate)\n            res_dict[\"task2_qa_filtered_docs\"] = filtered_docs\n        else:\n            pass\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230815092458-oa15fou","Type":"NodeParagraph","Properties":{"id":"20230815092458-oa15fou","updated":"20230815092458"},"Children":[{"Type":"NodeText","Data":"根据给出的代码片段，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"process_step2"},{"Type":"NodeText","Data":"​ 是一个方法，用于处理步骤二的结果。具体来说，这段代码执行以下操作："}]},{"ID":"20230815092458-vrn317x","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230815092458-vrn317x","updated":"20230815092458"},"Children":[{"ID":"20230815092458-2wt65od","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230815092458-2wt65od","updated":"20230815092458"},"Children":[{"ID":"20230815092458-5gievca","Type":"NodeParagraph","Properties":{"id":"20230815092458-5gievca","updated":"20230815092458"},"Children":[{"Type":"NodeText","Data":"打印日志，记录输入参数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 的内容（注：在代码中使用了错误的字符串拼接方法，应为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"logging.info(f'in step2, res_dict: {str(res_dict)}')"},{"Type":"NodeText","Data":"​）。"}]}]},{"ID":"20230815092458-1k1tvyb","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230815092458-1k1tvyb","updated":"20230815092458"},"Children":[{"ID":"20230815092458-g42se51","Type":"NodeParagraph","Properties":{"id":"20230815092458-g42se51","updated":"20230815092458"},"Children":[{"Type":"NodeText","Data":"根据传入的任务名称 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"task_name"},{"Type":"NodeText","Data":"​ 进行条件判断。"}]},{"ID":"20230815092458-ez1gzlr","Type":"NodeList","ListData":{},"Properties":{"id":"20230815092458-ez1gzlr","updated":"20230815092458"},"Children":[{"ID":"20230815092458-1di3ct3","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815092458-1di3ct3","updated":"20230815092458"},"Children":[{"ID":"20230815092458-9haxvco","Type":"NodeParagraph","Properties":{"id":"20230815092458-9haxvco","updated":"20230815092458"},"Children":[{"Type":"NodeText","Data":"如果任务名称为 \"技术标准检索\"，则执行以下操作："}]},{"ID":"20230815092458-55rtux5","Type":"NodeList","ListData":{},"Properties":{"id":"20230815092458-55rtux5","updated":"20230815092458"},"Children":[{"ID":"20230815092458-kpiy38g","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815092458-kpiy38g","updated":"20230815092458"},"Children":[{"ID":"20230815092458-n8asdgw","Type":"NodeParagraph","Properties":{"id":"20230815092458-n8asdgw","updated":"20230815092458"},"Children":[{"Type":"NodeText","Data":"检查 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self.vector_store"},{"Type":"NodeText","Data":"​ 是否为空，如果为空，则调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self.load_faiss(vs_path)"},{"Type":"NodeText","Data":"​ 方法加载 Faiss 向量存储器。"}]}]},{"ID":"20230815092458-domj5zd","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815092458-domj5zd","updated":"20230815092458"},"Children":[{"ID":"20230815092458-endas1h","Type":"NodeParagraph","Properties":{"id":"20230815092458-endas1h","updated":"20230815092458"},"Children":[{"Type":"NodeText","Data":"调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self.vector_store.similarity_search_with_score()"},{"Type":"NodeText","Data":"​ 方法，使用相似度搜索获取与查询结果 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict[\u0026quot;query\u0026quot;]"},{"Type":"NodeText","Data":"​ 相关的文档及其得分，最多返回 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self.top_k"},{"Type":"NodeText","Data":"​ 个文档。"}]}]},{"ID":"20230815092458-3dw99ji","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815092458-3dw99ji","updated":"20230815092458"},"Children":[{"ID":"20230815092458-p1t7zq1","Type":"NodeParagraph","Properties":{"id":"20230815092458-p1t7zq1","updated":"20230815092458"},"Children":[{"Type":"NodeText","Data":"执行 Torch 垃圾回收（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"torch_gc()"},{"Type":"NodeText","Data":"​），以释放不再使用的内存资源。"}]}]},{"ID":"20230815092458-nh61pua","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815092458-nh61pua","updated":"20230815092458"},"Children":[{"ID":"20230815092458-0nuprew","Type":"NodeParagraph","Properties":{"id":"20230815092458-0nuprew","updated":"20230815092458"},"Children":[{"Type":"NodeText","Data":"调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_filter_docs()"},{"Type":"NodeText","Data":"​ 方法，根据一定比例 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"rate"},{"Type":"NodeText","Data":"​ 对相关文档进行筛选，并将筛选后的文档存储到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict[\u0026quot;task2_qa_filtered_docs\u0026quot;]"},{"Type":"NodeText","Data":"​ 中。"}]}]}]}]},{"ID":"20230815092458-hombjf0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815092458-hombjf0","updated":"20230815092458"},"Children":[{"ID":"20230815092458-op840pf","Type":"NodeParagraph","Properties":{"id":"20230815092458-op840pf","updated":"20230815092458"},"Children":[{"Type":"NodeText","Data":"如果任务名称不是 \"技术标准检索\"，则不执行任何操作。"}]}]}]}]},{"ID":"20230815092458-xru5e29","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230815092458-xru5e29","updated":"20230815092458"},"Children":[{"ID":"20230815092458-k31z6e2","Type":"NodeParagraph","Properties":{"id":"20230815092458-k31z6e2","updated":"20230815092458"},"Children":[{"Type":"NodeText","Data":"结束方法。"}]}]}]},{"ID":"20230815092458-4m0cvio","Type":"NodeParagraph","Properties":{"id":"20230815092458-4m0cvio","updated":"20230815092458"},"Children":[{"Type":"NodeText","Data":"需要注意的是，在该代码片段中，部分变量（如 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self.vector_store"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"vs_path"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self.top_k"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"rate"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_filter_docs()"},{"Type":"NodeText","Data":"​）没有提供具体实现或定义，因此无法准确理解该方法的完整功能。"}]},{"ID":"20230815092458-6wne3lq","Type":"NodeParagraph","Properties":{"id":"20230815092458-6wne3lq","updated":"20230815092653"}},{"ID":"20230815092720-36afbsx","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230815092720-36afbsx","updated":"20230815092745"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"    def process_step3(self, res_dict):\n        logging.info(f'in step3, res_dict: str(res_dict)')\n        if res_dict.get(\"task2_qa_filtered_docs\", None) is not None and res_dict[\"task2_qa_filtered_docs\"]:\n            prompt = generate_prompt(res_dict[\"task2_qa_filtered_docs\"], res_dict[\"query\"], TASK3_PROMPT_KD)\n        else:\n            prompt = res_dict[\"query\"]\n      \n        for answer_result in self.llm.generatorAnswer(prompt=prompt, history=res_dict[\"history\"], streaming=False):\n            resp = answer_result.llm_output[\"answer\"]\n            history = answer_result.history\n            history[-1][0] = res_dict[\"query\"]\n            res_dict[\"task3_input\"] = prompt\n            res_dict[\"task3_output\"] = identity_rule(resp)\n            # res_dict[\"history\"] = history\n        logging.info(f'task3 output: {str(res_dict)}')\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230815092824-ppvhrs2","Type":"NodeParagraph","Properties":{"id":"20230815092824-ppvhrs2","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"根据给出的代码片段，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"process_step3"},{"Type":"NodeText","Data":"​ 是一个方法，用于处理步骤三的结果。具体来说，这段代码执行以下操作："}]},{"ID":"20230815092824-3ii2t31","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230815092824-3ii2t31","updated":"20230815092824"},"Children":[{"ID":"20230815092824-9q4qobf","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230815092824-9q4qobf","updated":"20230815092824"},"Children":[{"ID":"20230815092824-8tuqgn5","Type":"NodeParagraph","Properties":{"id":"20230815092824-8tuqgn5","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"打印日志，记录输入参数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 的内容（注：在代码中使用了错误的字符串拼接方法，应为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"logging.info(f'in step3, res_dict: {str(res_dict)}')"},{"Type":"NodeText","Data":"​）。"}]}]},{"ID":"20230815092824-b6hgktj","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230815092824-b6hgktj","updated":"20230815092824"},"Children":[{"ID":"20230815092824-wa8qy7b","Type":"NodeParagraph","Properties":{"id":"20230815092824-wa8qy7b","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"检查 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 中是否存在键为 \"task2_qa_filtered_docs\" 的项，并且该项的值不为空列表。如果满足条件，则生成一个提示文本 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"prompt"},{"Type":"NodeText","Data":"​，并调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"generate_prompt()"},{"Type":"NodeText","Data":"​ 方法生成该文本。"}]},{"ID":"20230815092824-vr19jia","Type":"NodeList","ListData":{},"Properties":{"id":"20230815092824-vr19jia","updated":"20230815092824"},"Children":[{"ID":"20230815092824-aizcalu","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815092824-aizcalu","updated":"20230815092824"},"Children":[{"ID":"20230815092824-y3f2vpk","Type":"NodeParagraph","Properties":{"id":"20230815092824-y3f2vpk","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"generate_prompt()"},{"Type":"NodeText","Data":"​ 方法的输入包括 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict[\u0026quot;task2_qa_filtered_docs\u0026quot;]"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict[\u0026quot;query\u0026quot;]"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"TASK3_PROMPT_KD"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230815092824-vkrzlq0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815092824-vkrzlq0","updated":"20230815092824"},"Children":[{"ID":"20230815092824-zz68lpu","Type":"NodeParagraph","Properties":{"id":"20230815092824-zz68lpu","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"如果条件不满足，则将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"prompt"},{"Type":"NodeText","Data":"​ 设置为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict[\u0026quot;query\u0026quot;]"},{"Type":"NodeText","Data":"​。"}]}]}]}]},{"ID":"20230815092824-r84zveg","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230815092824-r84zveg","updated":"20230815092824"},"Children":[{"ID":"20230815092824-2v1mavb","Type":"NodeParagraph","Properties":{"id":"20230815092824-2v1mavb","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self.llm.generatorAnswer()"},{"Type":"NodeText","Data":"​ 方法进行回答生成。方法的输入包括 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"prompt"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict[\u0026quot;history\u0026quot;]"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"streaming=False"},{"Type":"NodeText","Data":"​。这个方法可能是一个语言模型，用于根据提示生成回答。"}]},{"ID":"20230815092824-n4gdp83","Type":"NodeList","ListData":{},"Properties":{"id":"20230815092824-n4gdp83","updated":"20230815092824"},"Children":[{"ID":"20230815092824-odgxj7l","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815092824-odgxj7l","updated":"20230815092824"},"Children":[{"ID":"20230815092824-x7tg3ag","Type":"NodeParagraph","Properties":{"id":"20230815092824-x7tg3ag","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"根据 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"answer_result"},{"Type":"NodeText","Data":"​ 中返回的结果获取回答 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"resp"},{"Type":"NodeText","Data":"​ 和更新后的历史记录 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"history"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230815092824-numt6fi","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815092824-numt6fi","updated":"20230815092824"},"Children":[{"ID":"20230815092824-3m5ih3m","Type":"NodeParagraph","Properties":{"id":"20230815092824-3m5ih3m","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict[\u0026quot;query\u0026quot;]"},{"Type":"NodeText","Data":"​ 更新到历史记录的最后一个元素中。"}]}]},{"ID":"20230815092824-kvwr9i6","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815092824-kvwr9i6","updated":"20230815092824"},"Children":[{"ID":"20230815092824-fw3t7jh","Type":"NodeParagraph","Properties":{"id":"20230815092824-fw3t7jh","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"将生成的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"prompt"},{"Type":"NodeText","Data":"​ 存储到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict[\u0026quot;task3_input\u0026quot;]"},{"Type":"NodeText","Data":"​ 中。"}]}]},{"ID":"20230815092824-uv8j396","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815092824-uv8j396","updated":"20230815092824"},"Children":[{"ID":"20230815092824-t1gtl5f","Type":"NodeParagraph","Properties":{"id":"20230815092824-t1gtl5f","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"将回答结果经过 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"identity_rule()"},{"Type":"NodeText","Data":"​ 方法的处理后存储到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict[\u0026quot;task3_output\u0026quot;]"},{"Type":"NodeText","Data":"​ 中。"}]}]},{"ID":"20230815092824-79lg8c3","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815092824-79lg8c3","updated":"20230815092824"},"Children":[{"ID":"20230815092824-zxmn1lx","Type":"NodeParagraph","Properties":{"id":"20230815092824-zxmn1lx","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"（注释掉的代码）将历史记录 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"history"},{"Type":"NodeText","Data":"​ 存储到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict[\u0026quot;history\u0026quot;]"},{"Type":"NodeText","Data":"​ 中。"}]}]}]}]},{"ID":"20230815092824-4kg0dih","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20230815092824-4kg0dih","updated":"20230815092824"},"Children":[{"ID":"20230815092824-9bi8t1r","Type":"NodeParagraph","Properties":{"id":"20230815092824-9bi8t1r","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"打印日志，记录任务三的输出结果，即记录 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 的内容（注：在代码中使用了错误的字符串拼接方法，应为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"logging.info(f'task3 output: {str(res_dict)}')"},{"Type":"NodeText","Data":"​）。"}]}]},{"ID":"20230815092824-b6eadve","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20230815092824-b6eadve","updated":"20230815092824"},"Children":[{"ID":"20230815092824-lhqvgox","Type":"NodeParagraph","Properties":{"id":"20230815092824-lhqvgox","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"结束方法。"}]}]}]},{"ID":"20230815092824-g6ecbz5","Type":"NodeParagraph","Properties":{"id":"20230815092824-g6ecbz5","updated":"20230815092824"},"Children":[{"Type":"NodeText","Data":"需要注意的是，在该代码片段中，部分变量（如 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"generate_prompt()"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"self.llm.generatorAnswer()"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"TASK3_PROMPT_KD"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"identity_rule()"},{"Type":"NodeText","Data":"​）没有提供具体实现或定义，因此无法准确理解该方法的完整功能。"}]},{"ID":"20230815094709-regq2wj","Type":"NodeParagraph","Properties":{"id":"20230815094709-regq2wj"}},{"ID":"20230815094716-52i8c7x","Type":"NodeParagraph","Properties":{"id":"20230815094716-52i8c7x"}},{"ID":"20230815094717-nrisgwq","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230815094717-nrisgwq","updated":"20230815094718"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"    def egpt_chat_main(self, query, history):\n        res_dict = {\"query\": query, \"history\": history}\n      \n        task1_resp = self.process_step1(res_dict)\n        task1_resp = sorted(task1_resp, key=lambda i:i[\"id\"])\n\n        # import pdb; pdb.set_trace()\n        for each_task in task1_resp[:-1]:\n            if each_task[\"task\"] != \"答复生成\":\n                self.process_step2(each_task[\"task\"], res_dict)\n            else:\n                self.process_step3(res_dict)\n\n        return res_dict\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230815094838-ysf68fv","Type":"NodeParagraph","Properties":{"id":"20230815094838-ysf68fv","updated":"20230815094838"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"egpt_chat_main"},{"Type":"NodeText","Data":"​ 是一个方法，它根据给定的查询和历史记录进行对话处理。具体来说，这段代码执行以下操作："}]},{"ID":"20230815094838-7vmrbny","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230815094838-7vmrbny","updated":"20230815094838"},"Children":[{"ID":"20230815094838-41191a4","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230815094838-41191a4","updated":"20230815094838"},"Children":[{"ID":"20230815094838-eupfybh","Type":"NodeParagraph","Properties":{"id":"20230815094838-eupfybh","updated":"20230815094838"},"Children":[{"Type":"NodeText","Data":"创建一个名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 的字典，其中包含键 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026quot;query\u0026quot;"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026quot;history\u0026quot;"},{"Type":"NodeText","Data":"​，分别对应传入的查询和历史记录。"}]}]},{"ID":"20230815094838-ayk83x8","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230815094838-ayk83x8","updated":"20230815094838"},"Children":[{"ID":"20230815094838-fru7xcl","Type":"NodeParagraph","Properties":{"id":"20230815094838-fru7xcl","updated":"20230815094838"},"Children":[{"Type":"NodeText","Data":"调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"process_step1"},{"Type":"NodeText","Data":"​ 方法，并将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 作为参数传递进去，得到任务一的响应结果，并按照每个项目的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026quot;id\u0026quot;"},{"Type":"NodeText","Data":"​ 进行排序（升序）。"}]}]},{"ID":"20230815094838-8jdy1zm","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230815094838-8jdy1zm","updated":"20230815094838"},"Children":[{"ID":"20230815094838-b8tzohs","Type":"NodeParagraph","Properties":{"id":"20230815094838-b8tzohs","updated":"20230815094838"},"Children":[{"Type":"NodeText","Data":"对于任务一的每个响应结果（除了最后一个），进行循环遍历："}]},{"ID":"20230815094838-824qffv","Type":"NodeList","ListData":{},"Properties":{"id":"20230815094838-824qffv","updated":"20230815094838"},"Children":[{"ID":"20230815094838-17pkigx","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815094838-17pkigx","updated":"20230815094838"},"Children":[{"ID":"20230815094838-klj9t65","Type":"NodeParagraph","Properties":{"id":"20230815094838-klj9t65","updated":"20230815094838"},"Children":[{"Type":"NodeText","Data":"如果任务不是 \"答复生成\"，则调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"process_step2"},{"Type":"NodeText","Data":"​ 方法，传递任务类型和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 作为参数。"}]}]},{"ID":"20230815094838-ac6cfg5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815094838-ac6cfg5","updated":"20230815094838"},"Children":[{"ID":"20230815094838-q44nmxm","Type":"NodeParagraph","Properties":{"id":"20230815094838-q44nmxm","updated":"20230815094838"},"Children":[{"Type":"NodeText","Data":"如果任务是 \"答复生成\"，则调用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"process_step3"},{"Type":"NodeText","Data":"​ 方法，传递 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 作为参数。"}]}]}]}]},{"ID":"20230815094838-gsv57nb","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20230815094838-gsv57nb","updated":"20230815094838"},"Children":[{"ID":"20230815094838-ic23pxl","Type":"NodeParagraph","Properties":{"id":"20230815094838-ic23pxl","updated":"20230815094838"},"Children":[{"Type":"NodeText","Data":"返回更新后的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​。"}]}]}]},{"ID":"20230815094838-9f3bci9","Type":"NodeParagraph","Properties":{"id":"20230815094838-9f3bci9","updated":"20230815095758"}},{"ID":"20230815095815-0y70r0e","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230815095815-0y70r0e","updated":"20230815095816"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"    @staticmethod\n    def get_source_text(res_dict):\n        if res_dict.get(\"task2_qa_filtered_docs\", None) is not None:\n            source_text = []\n            for inum, doc in enumerate(res_dict[\"task2_qa_filtered_docs\"]):\n                each_source_list = doc.metadata['source'].split(\"@splitter@\")\n                try:\n                    st_code, tk_code, tk_name = each_source_list\n                except:\n                    logging.error(\"Error in process source: {}\".format(doc.metadata['source']))\n                    continue\n                try:\n                    st_name = get_name_by_code(st_code)\n                except:\n                    st_name = \"未知\"\n                if tk_code == \"###none_title_number\": tk_code = \"无\"\n                if tk_name == \"###none_title_name\": tk_name = \"无\"\n                if len(tk_name) \u003e 10: tk_name = \"见正文\"\n                each_source = \"参考依据 [{}] 技术标准编号：{} | 技术标准名称：{} | 条款编号：{} | 条款名称：{}\".format(\\\n                    inum+1, st_code, st_name, tk_code, tk_name)\n                source_text.append(each_source)\n            return \"\\n\\n\" + \"\\n\".join(source_text)\n        else:\n            return \"\"\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230815100053-58zqd6i","Type":"NodeParagraph","Properties":{"id":"20230815100053-58zqd6i","updated":"20230815100423"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"get_source_text"},{"Type":"NodeText","Data":"​ 方法是一个静态方法，根据传入的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 字典返回源文本信息。获取参考源文本"}]},{"ID":"20230815100053-didb449","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230815100053-didb449","updated":"20230815100053"},"Children":[{"ID":"20230815100053-q1mfoni","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230815100053-q1mfoni","updated":"20230815100053"},"Children":[{"ID":"20230815100053-wpkeezu","Type":"NodeParagraph","Properties":{"id":"20230815100053-wpkeezu","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"首先，检查 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"res_dict"},{"Type":"NodeText","Data":"​ 中是否存在键 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026quot;task2_qa_filtered_docs\u0026quot;"},{"Type":"NodeText","Data":"​，并且其值不为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"None"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230815100053-wyqoc38","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230815100053-wyqoc38","updated":"20230815100053"},"Children":[{"ID":"20230815100053-mvch89m","Type":"NodeParagraph","Properties":{"id":"20230815100053-mvch89m","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"如果存在 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026quot;task2_qa_filtered_docs\u0026quot;"},{"Type":"NodeText","Data":"​，则创建一个空列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"source_text"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230815100053-orws0be","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230815100053-orws0be","updated":"20230815100053"},"Children":[{"ID":"20230815100053-frm15h4","Type":"NodeParagraph","Properties":{"id":"20230815100053-frm15h4","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"对于 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026quot;task2_qa_filtered_docs\u0026quot;"},{"Type":"NodeText","Data":"​ 中的每个索引和对应的文档："}]},{"ID":"20230815100053-4fokjtw","Type":"NodeList","ListData":{},"Properties":{"id":"20230815100053-4fokjtw","updated":"20230815100053"},"Children":[{"ID":"20230815100053-qxp35d7","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815100053-qxp35d7","updated":"20230815100053"},"Children":[{"ID":"20230815100053-jvzxky0","Type":"NodeParagraph","Properties":{"id":"20230815100053-jvzxky0","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"将文档的元数据中的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026quot;source\u0026quot;"},{"Type":"NodeText","Data":"​ 字段以 \"@splitter@\" 作为分隔符拆分成一个列表 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"each_source_list"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230815100053-d2nwvnx","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815100053-d2nwvnx","updated":"20230815100053"},"Children":[{"ID":"20230815100053-0bo4uwj","Type":"NodeParagraph","Properties":{"id":"20230815100053-0bo4uwj","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"尝试从 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"each_source_list"},{"Type":"NodeText","Data":"​ 中依次获取三个元素，分别赋值给 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"st_code"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"tk_code"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"tk_name"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230815100053-ygifh86","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815100053-ygifh86","updated":"20230815100053"},"Children":[{"ID":"20230815100053-ugontpk","Type":"NodeParagraph","Properties":{"id":"20230815100053-ugontpk","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"如果获取元素的过程中出现异常，则记录错误日志并继续处理下一个文档。"}]}]},{"ID":"20230815100053-y6rj9k5","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815100053-y6rj9k5","updated":"20230815100053"},"Children":[{"ID":"20230815100053-3vr2xw8","Type":"NodeParagraph","Properties":{"id":"20230815100053-3vr2xw8","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"尝试通过 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"get_name_by_code"},{"Type":"NodeText","Data":"​ 函数根据 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"st_code"},{"Type":"NodeText","Data":"​ 获取技术标准名称 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"st_name"},{"Type":"NodeText","Data":"​。"}]}]},{"ID":"20230815100053-uj6x3n2","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815100053-uj6x3n2","updated":"20230815100053"},"Children":[{"ID":"20230815100053-3ijs1g7","Type":"NodeParagraph","Properties":{"id":"20230815100053-3ijs1g7","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"对于一些特殊情况进行处理："}]},{"ID":"20230815100053-r7at2o4","Type":"NodeList","ListData":{},"Properties":{"id":"20230815100053-r7at2o4","updated":"20230815100053"},"Children":[{"ID":"20230815100053-ttvnv9l","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815100053-ttvnv9l","updated":"20230815100053"},"Children":[{"ID":"20230815100053-1uqrsrx","Type":"NodeParagraph","Properties":{"id":"20230815100053-1uqrsrx","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"如果 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"tk_code"},{"Type":"NodeText","Data":"​ 是 \"###none_title_number\"，则将其设置为 \"无\"。"}]}]},{"ID":"20230815100053-r6lwz6r","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815100053-r6lwz6r","updated":"20230815100053"},"Children":[{"ID":"20230815100053-52lrwyh","Type":"NodeParagraph","Properties":{"id":"20230815100053-52lrwyh","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"如果 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"tk_name"},{"Type":"NodeText","Data":"​ 是 \"###none_title_name\"，则将其设置为 \"无\"。"}]}]},{"ID":"20230815100053-w2t297c","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815100053-w2t297c","updated":"20230815100053"},"Children":[{"ID":"20230815100053-evmcwgy","Type":"NodeParagraph","Properties":{"id":"20230815100053-evmcwgy","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"如果 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"tk_name"},{"Type":"NodeText","Data":"​ 的长度超过10个字符，则将其设置为 \"见正文\"。"}]}]}]}]},{"ID":"20230815100053-q6adpih","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230815100053-q6adpih","updated":"20230815100053"},"Children":[{"ID":"20230815100053-fn6oejp","Type":"NodeParagraph","Properties":{"id":"20230815100053-fn6oejp","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"根据提供的格式，创建一条参考依据的文本，包含索引号、技术标准编号、技术标准名称、条款编号和条款名称，并将其添加到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"source_text"},{"Type":"NodeText","Data":"​ 列表中。"}]}]}]}]},{"ID":"20230815100053-hd725sg","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20230815100053-hd725sg","updated":"20230815100053"},"Children":[{"ID":"20230815100053-e6va9x4","Type":"NodeParagraph","Properties":{"id":"20230815100053-e6va9x4","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"返回一个包含所有参考依据文本的字符串，每个文本之间以换行符分隔。如果不存在 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026quot;task2_qa_filtered_docs\u0026quot;"},{"Type":"NodeText","Data":"​ 或其值为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"None"},{"Type":"NodeText","Data":"​，则返回空字符串。"}]}]}]},{"ID":"20230815100053-zrt5tj3","Type":"NodeParagraph","Properties":{"id":"20230815100053-zrt5tj3","updated":"20230815100053"},"Children":[{"Type":"NodeText","Data":"需要注意的是，某些处理过程依赖于其他函数和数据（如 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"get_name_by_code"},{"Type":"NodeText","Data":"​ 函数），这段代码片段没有提供这些具体实现细节，所以无法进一步解析。"}]},{"ID":"20230815100540-jn8gx8r","Type":"NodeParagraph","Properties":{"id":"20230815100540-jn8gx8r"}},{"ID":"20230815100541-5sm0n4b","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230815100541-5sm0n4b","updated":"20230815161238"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"if __name__ == \"__main__\":\n# 初始化日志记录器和时间格式化\n\n    # 获取当前时间，并格式化为月份和日期及小时分钟的字符串\n    now_time= time.strftime(\"%m%d_%H%M\", time.localtime())\n    # 设置日志的格式，包括时间、文件名、行号、日志级别和消息内容\n    log_format = '%(asctime)s - %(filename)s[line:%(lineno)d] - %(levelname)s: %(message)s'\n    # 设置日期的格式，包括月份、日期、年份、小时、分钟、秒和上午/下午标识。\n    data_format = '%m/%d/%Y %H:%M:%S %p'\n    # 配置日志器的基本设置 日志级别为 INFO，表示只记录INFO级别以上的日志，日志格式设定为 log_format,日志格式设定为 data_format；设置日志的处理程序。其中，FileHandler用于将日志写入文件中，文件名为当前时间；StreamHandler用于将日志输出到控制台。\n    logging.basicConfig(level=logging.INFO, format=log_format, datefmt=data_format, handlers=[\n        logging.FileHandler(f'./server_log/{now_time}.log', mode='a', encoding='utf-8'),\n        logging.StreamHandler()])\n\n    # 初始化消息\n    # 将args参数初始化为 None，使用parser.parse_args解析命令行参数，并将结果赋值给args 变量\n    args = None\n    args = parser.parse_args(args=['--no-remote-model', '--lora-dir', \"/opt2/code/ChatGLM-Tuning/output/COT/20230607/checkpoint-25848\"])\n\n    # 将args 对象转化为字典，并使用其中的参数来初始化一些全局变量\n    # 调用 var() 函数将args对象转化为字典形式，将其赋值给 args_dict 变量。\n    # 可以方便的通过键值对的方式访问和使用命令行参数\n    args_dict = vars(args)\n    # 创建 LoaderCheckPoint 类的实例，并将 args_dict 传递给构造函数进行初始化。这是实例被赋值给shared.loaderCheckPoint，用于加载和管理模型的检查点\n    shared.loaderCheckPoint = LoaderCheckPoint(args_dict)\n    # 调用 shared对象的 loaderLLM()方法，返回一个 llm_model_ins 对象,表示已加载的LLM模型的实例\n    llm_model_ins = shared.loaderLLM()\n    # 调用 llm_model_ins 对象的 set_history_len() 方法，将全局变量 LLM_HISTORY_LEN 作为参数传递进去，设置LLM模型的历史记录的长度\n    llm_model_ins.set_history_len(LLM_HISTORY_LEN)\n\n    # 创建一个 LocalDocQA 实例，并赋值给 local_doc_qa变量。这个类可能用于本地的文档问答任务\n    local_doc_qa = LocalDocQA()\n    # 调用 local_doc_qa 对象的init_cfg方法，将 llm_model_ins作为参数传递进去，用于初始化和配置该对象的相关属性和参数\n    local_doc_qa.init_cfg(llm_model=llm_model_ins)\n    # 将字符串赋值给 vs_path 变量，向量存储路径\n    vs_path = \"/opt2/code/langchain-ChatGLM/vector_store_song\"\n    rate = 500\n\n    # 用于加载已保存的知识向量库\n    local_doc_qa.load_faiss(vs_path)\n  \n    # 设置了缓存配置并初始化了缓存\n    # cache_config 定义了一个字典，包含了缓存的配置信息，具体配置如下\n    cache_config = {\n        \"CACHE_TYPE\": \"FileSystemCache\", # 指定缓存的类型为文件系统缓存\n        # 指定缓存的存储目录\n        \"CACHE_DIR\": f\"./server_log/cache/v1_2/production/20230720_144500\",\n        # 设置缓存在处理请求时忽略错误\n        \"CACHE_IGNORE_ERRORS\": True,\n        # 设置缓存的阈值为5000个条目\n        \"CACHE_THRESHOLD\": 5000,\n        # 设置默认的缓存超时时间为 1296000秒，15天\n        \"CACHE_DEFAULT_TIMEOUT\": 1296000\n        }\n    # 创建一个 Cache对象，并传入上述的缓存配置作为参数，将其赋值给cache变量。这个对象可能用于管理和操作缓存。\n    cache = Cache(config=cache_config)\n    # 创建一个Flask应用实例，并将当前模块的名字作为参数传递进去。\n    app = Flask(__name__)\n    # 通过CORS扩展为app应用添加跨域资源共享支持，以便在浏览器端访问该应用。\n    CORS(app)\n    # 通过调用init_app()方法，将app应用与缓存对象进行关联，以便在应用中使用缓存功能。\n    cache.init_app(app)\n\n    @app.route('/chat', methods=['POST'])\n    def chat():\n        data = request.get_json()\n        logger.info(\"get input：\\n{}\".format(data))\n        if not (query := data.get(\"prompt\", \"\")): return \"请求数据格式错误\"\n\n        def generate():\n            # import pdb; pdb.set_trace()\n            if (cache_res:=cache.get(query)) is None:\n                res_dict = local_doc_qa.egpt_chat_main(query, [])\n                if res_dict.get(\"task2_qa_filtered_docs\", None) is not None and res_dict[\"task2_qa_filtered_docs\"]:\n                    prompt = generate_prompt(res_dict[\"task2_qa_filtered_docs\"], res_dict[\"query\"], TASK3_PROMPT_KD)\n                else:\n                    prompt = res_dict[\"query\"]\n  \n                # import pdb; pdb.set_trace()\n                last_print_len = 0\n                output = \"\"\n                has_identity_rule_judged = False\n                identity_text = None\n                for answer_result in local_doc_qa.llm.generatorAnswer(prompt=prompt, history=res_dict[\"history\"], streaming=True):\n                    resp = answer_result.llm_output[\"answer\"]\n                    history = answer_result.history\n                    if not has_identity_rule_judged:\n                        output += resp[last_print_len:]\n                    else:\n                        output = resp[last_print_len:]\n                    last_print_len = len(resp)\n                    if not has_identity_rule_judged:\n                        if len(output) \u003c 25:\n                            pass\n                        else:\n                            identity_text = identity_rule(output)\n                            has_identity_rule_judged = True\n                            if identity_text is not None:\n                                output = identity_text\n                                break\n                            else:\n                                yield output\n                    else:\n                        yield output\n                if not has_identity_rule_judged:\n                    for c in output:\n                        yield c \n                        t = random.randint(1, 5) / 100\n                        time.sleep(t)\n                    logging.warn(f'value for has_identity_rule_judged is False')\n                elif identity_text is not None:\n                    for c in identity_text:\n                        yield c\n                        t = random.randint(1, 5) / 100\n                        time.sleep(t)\n                # import pdb; pdb.set_trace()\n                # yield local_doc_qa.process_step3_streaming(res_dict)\n                # import pdb; pdb.set_trace()\n                source_text = local_doc_qa.get_source_text(res_dict)\n                for c in source_text:\n                    yield c \n                    t = random.randint(1, 5) / 100\n                    time.sleep(t)\n                # yield source_text\n                res_dict[\"task3_input\"] = prompt\n                # res_dict[\"task3_output\"] = resp \n                res_dict[\"task3_output\"] = identity_text if identity_text is not None else resp\n                model_output = res_dict[\"task3_output\"] + source_text\n                # for k, v in res_dict.items():\n                #     logging.info(f\"{k}: {v}\")\n                logging.info(f\"model output is {model_output}\")\n                cache.set(query, (res_dict[\"task3_output\"], source_text))\n            else:\n                t = random.randint(4, 7)\n                time.sleep(t)\n                model_output = cache_res[0] + cache_res[1]\n                logging.info(f\"Get res from cache: {model_output}\")\n                for o in model_output:\n                    t = random.randint(1, 5) / 100\n                    time.sleep(t)\n                    yield o\n  \n        headers = {\n                    'Content-Type': 'text/event-stream',\n                    'Cache-Control': 'no-cache',\n                    'X-Accel-Buffering': 'no',\n        }\n        return Response(generate(), mimetype=\"text/event-stream\",headers=headers)\n\n    app.run(host='0.0.0.0', port=8002, debug=False)\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230815114104-jxjsrnd","Type":"NodeParagraph","Properties":{"id":"20230815114104-jxjsrnd","updated":"20230815114104"},"Children":[{"Type":"NodeText","Data":"这段代码是一个Python程序，主要实现了一个基于Flask框架的聊天机器人API接口。具体功能如下："}]},{"ID":"20230815114104-cyrnn2l","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230815114104-cyrnn2l","updated":"20230815114104"},"Children":[{"ID":"20230815114104-iu31ff4","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230815114104-iu31ff4","updated":"20230815114104"},"Children":[{"ID":"20230815114104-cj6dgsc","Type":"NodeParagraph","Properties":{"id":"20230815114104-cj6dgsc","updated":"20230815114104"},"Children":[{"Type":"NodeText","Data":"初始化日志记录器和时间格式化。"}]}]},{"ID":"20230815114104-xgt7zmd","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230815114104-xgt7zmd","updated":"20230815114104"},"Children":[{"ID":"20230815114104-k9cyaqi","Type":"NodeParagraph","Properties":{"id":"20230815114104-k9cyaqi","updated":"20230815114104"},"Children":[{"Type":"NodeText","Data":"解析命令行参数，并构建参数字典。"}]}]},{"ID":"20230815114104-yendsap","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230815114104-yendsap","updated":"20230815114104"},"Children":[{"ID":"20230815114104-l6wm2lo","Type":"NodeParagraph","Properties":{"id":"20230815114104-l6wm2lo","updated":"20230815114104"},"Children":[{"Type":"NodeText","Data":"加载LLM模型和本地文档问答系统。"}]}]},{"ID":"20230815114104-i227rn8","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20230815114104-i227rn8","updated":"20230815114104"},"Children":[{"ID":"20230815114104-hx5xqin","Type":"NodeParagraph","Properties":{"id":"20230815114104-hx5xqin","updated":"20230815114104"},"Children":[{"Type":"NodeText","Data":"加载Faiss向量存储。"}]}]},{"ID":"20230815114104-hq4cacz","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20230815114104-hq4cacz","updated":"20230815114104"},"Children":[{"ID":"20230815114104-vsfyvx3","Type":"NodeParagraph","Properties":{"id":"20230815114104-vsfyvx3","updated":"20230815114104"},"Children":[{"Type":"NodeText","Data":"配置缓存，并初始化应用程序。"}]}]},{"ID":"20230815114104-wudc55r","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Ni4=","Num":6},"Properties":{"id":"20230815114104-wudc55r","updated":"20230815114104"},"Children":[{"ID":"20230815114104-o4e0ywc","Type":"NodeParagraph","Properties":{"id":"20230815114104-o4e0ywc","updated":"20230815114104"},"Children":[{"Type":"NodeText","Data":"定义了一个"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/chat"},{"Type":"NodeText","Data":"​的POST路由，用于接收聊天请求并返回响应。"}]}]},{"ID":"20230815114104-xk7y8q1","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Ny4=","Num":7},"Properties":{"id":"20230815114104-xk7y8q1","updated":"20230815114104"},"Children":[{"ID":"20230815114104-5h4qwad","Type":"NodeParagraph","Properties":{"id":"20230815114104-5h4qwad","updated":"20230815114104"},"Children":[{"Type":"NodeText","Data":"在"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"/chat"},{"Type":"NodeText","Data":"​路由中，使用缓存来提高响应速度。"}]}]},{"ID":"20230815114104-9s7jznr","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"OC4=","Num":8},"Properties":{"id":"20230815114104-9s7jznr","updated":"20230815114104"},"Children":[{"ID":"20230815114104-fit0zam","Type":"NodeParagraph","Properties":{"id":"20230815114104-fit0zam","updated":"20230815114104"},"Children":[{"Type":"NodeText","Data":"使用生成器函数实现逐步生成响应结果。"}]}]},{"ID":"20230815114104-uzc70gx","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"OS4=","Num":9},"Properties":{"id":"20230815114104-uzc70gx","updated":"20230815114104"},"Children":[{"ID":"20230815114104-9l46ce9","Type":"NodeParagraph","Properties":{"id":"20230815114104-9l46ce9","updated":"20230815114104"},"Children":[{"Type":"NodeText","Data":"处理身份验证规则和输出结果。"}]}]},{"ID":"20230815114104-h49v31w","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MTAu","Num":10},"Properties":{"id":"20230815114104-h49v31w","updated":"20230815114104"},"Children":[{"ID":"20230815114104-ijajk4c","Type":"NodeParagraph","Properties":{"id":"20230815114104-ijajk4c","updated":"20230815114104"},"Children":[{"Type":"NodeText","Data":"返回生成的响应数据。"}]}]}]},{"ID":"20230815114104-hy1icyx","Type":"NodeParagraph","Properties":{"id":"20230815114104-hy1icyx","updated":"20230815114104"},"Children":[{"Type":"NodeText","Data":"最后，通过"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"app.run()"},{"Type":"NodeText","Data":"​方法运行Flask应用程序，监听在指定的主机和端口上。"}]},{"ID":"20230815144503-ob0qwlj","Type":"NodeParagraph","Properties":{"id":"20230815144503-ob0qwlj"}}]}