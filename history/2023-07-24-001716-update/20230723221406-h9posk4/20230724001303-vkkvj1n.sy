{"ID":"20230724001303-vkkvj1n","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f378","id":"20230724001303-vkkvj1n","tags":"TCP编程,TCP长连接","title":"TCP 长连接、短连接","updated":"20230724001321"},"Children":[{"ID":"20230724001307-xuy32q6","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724001307-xuy32q6","updated":"20230724001307"},"Children":[{"Type":"NodeText","Data":"短连接"}]},{"ID":"20230724001307-tpefj45","Type":"NodeParagraph","Properties":{"id":"20230724001307-tpefj45","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"概念"}]},{"ID":"20230724001307-l16s0ke","Type":"NodeParagraph","Properties":{"id":"20230724001307-l16s0ke","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"client与server通过三次握手建立连接，client发送请求消息，server返回响应，"},{"Type":"NodeTextMark","TextMarkType":"mark strong","TextMarkTextContent":"一次连接就完成了。"}]},{"ID":"20230724001307-je13upc","Type":"NodeParagraph","Properties":{"id":"20230724001307-je13upc","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"这时候双方任意都可以发起close操作，不过一般都是client先发起close操作。上述可知，"},{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"短连接一般只会在 client/server间传递一次请求操作。"}]},{"ID":"20230724001307-rmrym1k","Type":"NodeParagraph","Properties":{"id":"20230724001307-rmrym1k","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"短连接的优缺点"}]},{"ID":"20230724001307-qf1ope3","Type":"NodeParagraph","Properties":{"id":"20230724001307-qf1ope3","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"管理起来比较简单，"},{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"存在的连接都是有用的连接，不需要额外的控制手段。"}]},{"ID":"20230724001307-il0trfk","Type":"NodeParagraph","Properties":{"id":"20230724001307-il0trfk","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"使用场景"}]},{"ID":"20230724001307-zym0itx","Type":"NodeParagraph","Properties":{"id":"20230724001307-zym0itx","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"通常浏览器访问服务器的时候就是短连接。"}]},{"ID":"20230724001307-hfzu2vj","Type":"NodeParagraph","Properties":{"id":"20230724001307-hfzu2vj","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"对于服务端来说，长连接会耗费服务端的资源，而且用户用浏览器访问服务端相对而言不是很频繁的"}]},{"ID":"20230724001307-znu3bej","Type":"NodeParagraph","Properties":{"id":"20230724001307-znu3bej","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"如果有几十万，上百万的连接，服务端的压力会非常大，甚至会崩溃。"}]},{"ID":"20230724001307-3boml40","Type":"NodeParagraph","Properties":{"id":"20230724001307-3boml40","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"所以对于"},{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"并发量大，请求频率低的，建议使用短连接。"}]},{"ID":"20230724001307-m5h85fu","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724001307-m5h85fu","updated":"20230724001307"},"Children":[{"Type":"NodeText","Data":"长连接"}]},{"ID":"20230724001307-2ft5338","Type":"NodeParagraph","Properties":{"id":"20230724001307-2ft5338","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"什么是长连接"}]},{"ID":"20230724001307-59yqxwi","Type":"NodeParagraph","Properties":{"id":"20230724001307-59yqxwi","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"client向server发起连接，server接受client连接，双方建立连接。"}]},{"ID":"20230724001307-02mw9j5","Type":"NodeParagraph","Properties":{"id":"20230724001307-02mw9j5","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Client与server完成一次读写之后，****它们之间的连接并不会主动关闭，后续的读写操作会继续使用这个连接。"}]},{"ID":"20230724001307-mebf19p","Type":"NodeParagraph","Properties":{"id":"20230724001307-mebf19p","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"长连接的生命周期"}]},{"ID":"20230724001307-i92ne9s","Type":"NodeParagraph","Properties":{"id":"20230724001307-i92ne9s","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"正常情况下，一条TCP长连接建立后，只要双不提出关闭请求并且不出现异常情况，这条连接是一直存在的."}]},{"ID":"20230724001307-magxs9g","Type":"NodeParagraph","Properties":{"id":"20230724001307-magxs9g","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"操作系统不会自动去关闭它，甚至经过物理网络拓扑的改变之后仍然可以使用。"}]},{"ID":"20230724001307-hkd3nfj","Type":"NodeParagraph","Properties":{"id":"20230724001307-hkd3nfj","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"所以一条连接保持几天、几个月、几年或者更长时间都有可能，只要不出现异常情况或由用户（应用层）主动关闭。"}]},{"ID":"20230724001307-2zhc77q","Type":"NodeParagraph","Properties":{"id":"20230724001307-2zhc77q","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"mark strong","TextMarkTextContent":"客户端和服务端可一直使用该连接进行数据通信。"}]},{"ID":"20230724001307-inngnuo","Type":"NodeParagraph","Properties":{"id":"20230724001307-inngnuo","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"长连接的优点"}]},{"ID":"20230724001307-al6srxz","Type":"NodeParagraph","Properties":{"id":"20230724001307-al6srxz","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"长连接可以省去较多的TCP建立和关闭的操作，减少网络阻塞的影响，"}]},{"ID":"20230724001307-cxl56qv","Type":"NodeParagraph","Properties":{"id":"20230724001307-cxl56qv","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"当发生错误时，可以在不关闭连接的情况下进行提示，"}]},{"ID":"20230724001307-xia56wl","Type":"NodeParagraph","Properties":{"id":"20230724001307-xia56wl","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"减少CPU及内存的使用，因为不需要经常的建立及关闭连接。"}]},{"ID":"20230724001307-nd24lqx","Type":"NodeParagraph","Properties":{"id":"20230724001307-nd24lqx","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"长连接的缺点"}]},{"ID":"20230724001307-mzgyak1","Type":"NodeParagraph","Properties":{"id":"20230724001307-mzgyak1","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"连接数过多时，影响服务端的性能和并发数量。"}]},{"ID":"20230724001307-w3e4vp4","Type":"NodeParagraph","Properties":{"id":"20230724001307-w3e4vp4","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"使用场景"}]},{"ID":"20230724001307-i85ftfk","Type":"NodeParagraph","Properties":{"id":"20230724001307-i85ftfk","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"数据库的连接就是采用TCP长连接."}]},{"ID":"20230724001307-v3os1x9","Type":"NodeParagraph","Properties":{"id":"20230724001307-v3os1x9","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"RPC，远程服务调用，在服务器，一个服务进程频繁调用另一个服务进程，可使用长连接，减少连接花费的时间。"}]},{"ID":"20230724001307-7fd0de9","Type":"NodeParagraph","Properties":{"id":"20230724001307-7fd0de9","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"总结"}]},{"ID":"20230724001307-oojrhjw","Type":"NodeParagraph","Properties":{"id":"20230724001307-oojrhjw","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"1.对于长连接和短连接的使用是需要根据应用场景来判断的"}]},{"ID":"20230724001307-fjyzhf3","Type":"NodeParagraph","Properties":{"id":"20230724001307-fjyzhf3","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"2.长连接并不是万能的，也是需要维护的，"}]},{"ID":"20230724001307-qpdmc2c","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724001307-qpdmc2c","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"长连接的实现"}]},{"ID":"20230724001307-shgtlr6","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724001307-shgtlr6","updated":"20230724001307"},"Children":[{"Type":"NodeText","Data":"心跳机制"}]},{"ID":"20230724001307-jgyaysb","Type":"NodeParagraph","Properties":{"id":"20230724001307-jgyaysb","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"应用层协议大多都有HeartBeat机制，通常是客户端每隔一小段时间向服务器发送一个数据包，通知服务器自己仍然在线。"}]},{"ID":"20230724001307-4fophv7","Type":"NodeParagraph","Properties":{"id":"20230724001307-4fophv7","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"并传输一些可能必要的数据。"},{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"使用心跳包的典型协议是IM"},{"Type":"NodeText","Data":"，比如QQ/MSN/飞信等协议。"}]},{"ID":"20230724001307-fzr94jx","Type":"NodeParagraph","Properties":{"id":"20230724001307-fzr94jx","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"在TCP的机制里面，本身是存在有心跳包的机制的，也就是TCP的选项：SO_KEEPALIVE。"}]},{"ID":"20230724001307-idnxyx2","Type":"NodeParagraph","Properties":{"id":"20230724001307-idnxyx2","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"系统默认是设置的2小时的心跳频率。"},{"Type":"NodeText","Data":"但是它检查不到机器断电、网线拔出、防火墙这些断线。"}]},{"ID":"20230724001307-dl42nlv","Type":"NodeParagraph","Properties":{"id":"20230724001307-dl42nlv","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"mark","TextMarkTextContent":"而且逻辑层处理断线可能也不是那么好处理。一般，如果只是用于保活还是可以的。"}]},{"ID":"20230724001307-walynd6","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724001307-walynd6","updated":"20230724001307"},"Children":[{"Type":"NodeText","Data":"为什么需要心跳机制？"}]},{"ID":"20230724001307-zgqdsmh","Type":"NodeParagraph","Properties":{"id":"20230724001307-zgqdsmh","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"因为网络的不可靠性, 有可能在 TCP 保持长连接的过程中, 由于某些突发情况, 例如网线被拔出, 突然掉电等,会造成服务器和客户端的连接中断. 在这些突发情况下, 如果恰好服务器和客户端之间没有交互的话, 那么它们是不能在短时间内发现对方已经掉线的."}]},{"ID":"20230724001307-raaet7j","Type":"NodeParagraph","Properties":{"id":"20230724001307-raaet7j","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"mark strong","TextMarkTextContent":"由于某些突发情况, 例如网线被拔出, 突然掉电等,会造成服务器和客户端的连接中断. 及时发现对方掉线"}]},{"ID":"20230724001307-g7k1xre","Type":"NodeParagraph","Properties":{"id":"20230724001307-g7k1xre","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"心跳机制即可解决此类问题。"}]},{"ID":"20230724001307-gflaagz","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724001307-gflaagz","updated":"20230724001307"},"Children":[{"Type":"NodeText","Data":"TCP协议的KeepAlive机制"}]},{"ID":"20230724001307-kp37xqf","Type":"NodeParagraph","Properties":{"id":"20230724001307-kp37xqf","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"默认KeepAlive状态是不打开的。"}]},{"ID":"20230724001307-rnbkzu5","Type":"NodeParagraph","Properties":{"id":"20230724001307-rnbkzu5","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"需要将setsockopt将SOL_SOCKET.SO_KEEPALIVE设置为1才是打开KeepAlive状态，"}]},{"ID":"20230724001307-kr4gt5x","Type":"NodeParagraph","Properties":{"id":"20230724001307-kr4gt5x","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"并且可以设置三个参数："}]},{"ID":"20230724001307-9eybuoq","Type":"NodeParagraph","Properties":{"id":"20230724001307-9eybuoq","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"tcp_keepalive_time ，tcp_keepalive_probes ， tcp_keepalive_intvl"},{"Type":"NodeText","Data":"，"}]},{"ID":"20230724001307-58io7k9","Type":"NodeParagraph","Properties":{"id":"20230724001307-58io7k9","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"分别表示：连接闲置多久开始发keepalive的ack包、发几个ack包不回复才当对方已断线、两个ack包之间的间隔。"}]},{"ID":"20230724001307-49o717q","Type":"NodeParagraph","Properties":{"id":"20230724001307-49o717q","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"很多网络设备，尤其是NAT路由器，由于其硬件的限制（例如内存、CPU处理能力），无法保持其上的所有连接，因此在必要的时候，会在连接池中选择一些不活跃的连接踢掉。"}]},{"ID":"20230724001307-exoklvj","Type":"NodeParagraph","Properties":{"id":"20230724001307-exoklvj","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"典型做法是LRU，把最久没有数据的连接给T掉。"}]},{"ID":"20230724001307-1113qif","Type":"NodeParagraph","Properties":{"id":"20230724001307-1113qif","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"通过使用TCP的KeepAlive机制（修改那个time参数），可以让连接每隔一小段时间就产生一些ack包，以降低被踢掉的风险，当然，这样的代价是额外的网络和CPU负担。"}]},{"ID":"20230724001307-ye7so6z","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724001307-ye7so6z","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"如何实现心跳机制？"}]},{"ID":"20230724001307-0iiu02s","Type":"NodeParagraph","Properties":{"id":"20230724001307-0iiu02s","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"两种方式实现心跳机制:"}]},{"ID":"20230724001307-6xth34l","Type":"NodeList","ListData":{},"Properties":{"id":"20230724001307-6xth34l","updated":"20230724001307"},"Children":[{"ID":"20230724001307-zmfj6fx","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230724001307-zmfj6fx","updated":"20230724001307"},"Children":[{"ID":"20230724001307-27mnjn1","Type":"NodeParagraph","Properties":{"id":"20230724001307-27mnjn1","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"使用 TCP 协议层面的 keepalive 机制."}]}]},{"ID":"20230724001307-kc4iy5a","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230724001307-kc4iy5a","updated":"20230724001307"},"Children":[{"ID":"20230724001307-72635tz","Type":"NodeParagraph","Properties":{"id":"20230724001307-72635tz","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"在应用层上实现自定义的心跳机制."}]}]}]},{"ID":"20230724001307-uhr1gzb","Type":"NodeParagraph","Properties":{"id":"20230724001307-uhr1gzb","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"虽然在 TCP 协议层面上, 提供了 keepalive 保活机制, 但是使用它有几个缺点:"}]},{"ID":"20230724001307-acyv896","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230724001307-acyv896","updated":"20230724001307"},"Children":[{"ID":"20230724001307-6f4n1px","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230724001307-6f4n1px","updated":"20230724001307"},"Children":[{"ID":"20230724001307-g55t8se","Type":"NodeParagraph","Properties":{"id":"20230724001307-g55t8se","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"它不是 TCP 的标准协议, 并且是默认关闭的."}]}]},{"ID":"20230724001307-xonk2hg","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230724001307-xonk2hg","updated":"20230724001307"},"Children":[{"ID":"20230724001307-8j8jkjh","Type":"NodeParagraph","Properties":{"id":"20230724001307-8j8jkjh","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"TCP keepalive 机制依赖于操作系统的实现, 默认的 keepalive 心跳时间是 ****两个小时"},{"Type":"NodeText","Data":", 并且对 keepalive 的修改需要系统调用(或者修改系统配置), 灵活性不够."}]}]},{"ID":"20230724001307-d8p28sl","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230724001307-d8p28sl","updated":"20230724001307"},"Children":[{"ID":"20230724001307-4tdmd1x","Type":"NodeParagraph","Properties":{"id":"20230724001307-4tdmd1x","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"TCP keepalive 与 TCP 协议绑定, 因此如果需要更换为 UDP 协议时, keepalive 机制就失效了."}]}]}]},{"ID":"20230724001307-dvgb4ip","Type":"NodeParagraph","Properties":{"id":"20230724001307-dvgb4ip","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"使用 TCP 层面的 keepalive 机制比自定义的应用层心跳机制节省流量,"}]},{"ID":"20230724001307-tls82ro","Type":"NodeParagraph","Properties":{"id":"20230724001307-tls82ro","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"本文的主要介绍应用层方面实现心跳机制，使用netty实现心跳和断线重连。"}]},{"ID":"20230724001307-cypqkzz","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724001307-cypqkzz","updated":"20230724001307"},"Children":[{"Type":"NodeText","Data":"netty实现心跳机制"}]},{"ID":"20230724001307-pu993aq","Type":"NodeParagraph","Properties":{"id":"20230724001307-pu993aq","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"netty对心跳机制提供了机制，实现的关键是****IdleStateHandler"},{"Type":"NodeText","Data":"先来看一下他的构造函数"}]},{"ID":"20230724001307-464vj51","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724001307-464vj51","updated":"20230724001307"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"public IdleStateHandler(\n            long readerIdleTime, long writerIdleTime, long allIdleTime,\n            TimeUnit unit) {\n        this(false, readerIdleTime, writerIdleTime, allIdleTime, unit);\n    }\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230724001307-10m6dmi","Type":"NodeParagraph","Properties":{"id":"20230724001307-10m6dmi","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"实例化一个 IdleStateHandler 需要提供三个参数:"}]},{"ID":"20230724001307-k1d9fls","Type":"NodeList","ListData":{},"Properties":{"id":"20230724001307-k1d9fls","updated":"20230724001307"},"Children":[{"ID":"20230724001307-a2x4vyq","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230724001307-a2x4vyq","updated":"20230724001307"},"Children":[{"ID":"20230724001307-fc0wsyk","Type":"NodeParagraph","Properties":{"id":"20230724001307-fc0wsyk","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"readerIdleTimeSeconds, 读超时. 即当在指定的时间间隔内没有从 Channel 读取到数据时, 会触发一个 READER_IDLE 的 IdleStateEvent 事件."}]}]},{"ID":"20230724001307-5u3ndck","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230724001307-5u3ndck","updated":"20230724001307"},"Children":[{"ID":"20230724001307-oh4ds4f","Type":"NodeParagraph","Properties":{"id":"20230724001307-oh4ds4f","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"writerIdleTimeSeconds, 写超时. 即当在指定的时间间隔内没有数据写入到 Channel 时, 会触发一个 WRITER_IDLE 的 IdleStateEvent 事件."}]}]},{"ID":"20230724001307-cucdoym","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20230724001307-cucdoym","updated":"20230724001307"},"Children":[{"ID":"20230724001307-cfaszcf","Type":"NodeParagraph","Properties":{"id":"20230724001307-cfaszcf","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"allIdleTimeSeconds, 读和写都超时. 即当在指定的时间间隔内没有读并且写操作时, 会触发一个 ALL_IDLE 的 IdleStateEvent 事件."}]}]}]},{"ID":"20230724001307-265ol3c","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724001307-265ol3c","updated":"20230724001307"},"Children":[{"Type":"NodeText","Data":"netty心跳流程"}]},{"ID":"20230724001307-uu5p1g6","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20230724001307-uu5p1g6","updated":"20230724001307"},"Children":[{"ID":"20230724001307-fyfxhlq","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20230724001307-fyfxhlq","updated":"20230724001307"},"Children":[{"ID":"20230724001307-hqgwoym","Type":"NodeParagraph","Properties":{"id":"20230724001307-hqgwoym","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"客户端成功连接服务端。"}]}]},{"ID":"20230724001307-0iruehu","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20230724001307-0iruehu","updated":"20230724001307"},"Children":[{"ID":"20230724001307-v8q7vkq","Type":"NodeParagraph","Properties":{"id":"20230724001307-v8q7vkq","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"在客户端中的ChannelPipeline中加入IdleStateHandler，设置写事件触发事件为5s."}]}]},{"ID":"20230724001307-rdofufj","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20230724001307-rdofufj","updated":"20230724001307"},"Children":[{"ID":"20230724001307-5op2ut2","Type":"NodeParagraph","Properties":{"id":"20230724001307-5op2ut2","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"客户端超过5s未写数据，触发写事件，向服务端发送心跳包，"}]}]},{"ID":"20230724001307-q885mp2","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20230724001307-q885mp2","updated":"20230724001307"},"Children":[{"ID":"20230724001307-7z84xnf","Type":"NodeParagraph","Properties":{"id":"20230724001307-7z84xnf","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"同样，服务端要对心跳包做出响应，其实给客户端最好的回复就是“不回复”，减轻服务端的压力"}]}]},{"ID":"20230724001307-pp89doh","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20230724001307-pp89doh","updated":"20230724001307"},"Children":[{"ID":"20230724001307-fdz3gia","Type":"NodeParagraph","Properties":{"id":"20230724001307-fdz3gia","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"超过三次，1过0s服务端都会收到来自客户端的心跳信息，服务端可以认为客户端挂了，可以close链路。"}]}]},{"ID":"20230724001307-x185r5a","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Ni4=","Num":6},"Properties":{"id":"20230724001307-x185r5a","updated":"20230724001307"},"Children":[{"ID":"20230724001307-l3ep9tq","Type":"NodeParagraph","Properties":{"id":"20230724001307-l3ep9tq","updated":"20230724001307"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"客户端恢复正常，发现链路已断，重新连接服务端。"}]}]}]}]}