{"ID":"20231204205722-1cstga2","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f4e6","id":"20231204205722-1cstga2","tags":"深入理解GO标准库,公众号-凉凉的知识库,Go-http","title":"深入理解Go标准库 http server 的优雅关闭","updated":"20231211201842"},"Children":[{"ID":"20231204205745-wy1w9xc","Type":"NodeParagraph","Properties":{"id":"20231204205745-wy1w9xc"}},{"ID":"20231204205722-cl0vmm4","Type":"NodeParagraph","Properties":{"id":"20231204205722-cl0vmm4","updated":"20231211201659"},"Children":[{"Type":"NodeText","Data":"还记得怎么启动一个HTTP Server么？"}]},{"ID":"20231211201700-ggrpizr","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231211201700-ggrpizr","updated":"20231211201719"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"package main\n\nimport (\n\t\"net\"\n\t\"net/http\"\n)\n\nfunc main() {\n\t// 方式1\n\terr := http.ListenAndServe(\":8080\", nil)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\n\t// 方式2\n\t// server := \u0026http.Server{Addr: \":8080\"}\n\t// err := server.ListenAndServe()\n\t// if err != nil {\n\t//  panic(err)\n\t// }\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231211201737-s7tpwxv","Type":"NodeParagraph","Properties":{"id":"20231211201737-s7tpwxv","updated":"20231211201737"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ListenAndServe"},{"Type":"NodeText","Data":"​在不出错的情况下，会一直阻塞在这个位置，如何停止这样的一个HTTP Server呢？"}]},{"ID":"20231211201737-si0b1c6","Type":"NodeParagraph","Properties":{"id":"20231211201737-si0b1c6","updated":"20231211201737"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"CTRL+C"},{"Type":"NodeText","Data":"​是结束一个进程常用的方式，它和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"kill pid"},{"Type":"NodeText","Data":"​或者"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"kill -l 15 pid"},{"Type":"NodeText","Data":"​命令本质上没有任何区别，他们都是向进程发送了"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"SIGTERM"},{"Type":"NodeText","Data":"​信号。因为程序没有设置对"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"SIGTERM"},{"Type":"NodeText","Data":"​信号的处理程序，所以系统默认的信号处理程序结束了我们的进程"}]},{"ID":"20231211201746-n3aaama","Type":"NodeParagraph","Properties":{"id":"20231211201746-n3aaama","updated":"20231211201746"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"这会带来什么问题？"}]},{"ID":"20231211201746-lbjqm9j","Type":"NodeParagraph","Properties":{"id":"20231211201746-lbjqm9j","updated":"20231211201746"},"Children":[{"Type":"NodeText","Data":"在服务器的进程被杀死时，我们的服务器可能正在处理请求并未完成。因此对于客户端产生了一个预期外的错误"}]},{"ID":"20231211201747-wc9c20k","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231211201747-wc9c20k","updated":"20231211201753"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"curl -v --max-time 4 127.0.0.1:8009/foo\n\n* Connection #0 to host 127.0.0.1 left intact\n*   Trying 127.0.0.1:8009...\n* Connected to 127.0.0.1 (127.0.0.1) port 8009 (#0)\n\u003e GET /foo HTTP/1.1\n\u003e Host: 127.0.0.1:8009\n\u003e User-Agent: curl/7.86.0\n\u003e Accept: */*\n\u003e \n\n* Empty reply from server\n* Closing connection 0\ncurl: (52) Empty reply from server\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231211201759-nw9biig","Type":"NodeParagraph","Properties":{"id":"20231211201759-nw9biig","updated":"20231211201759"},"Children":[{"Type":"NodeText","Data":"如果有nginx代理，因为upstream的中断，nginx会产生502的响应"}]},{"ID":"20231211201800-s1a8iep","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231211201800-s1a8iep","updated":"20231211201805"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"curl -v --max-time 11 127.0.0.1:8010/foo\n*   Trying 127.0.0.1:8010...\n* Connected to 127.0.0.1 (127.0.0.1) port 8010 (#0)\n\u003e GET /foo HTTP/1.1\n\u003e Host: 127.0.0.1:8010\n\u003e User-Agent: curl/7.86.0\n\u003e Accept: */*\n\u003e \n* Mark bundle as not supporting multiuse\n\u003c HTTP/1.1 502 Bad Gateway\n\u003c Server: nginx/1.25.3\n\u003c Date: Sat, 02 Dec 2023 10:14:33 GMT\n\u003c Content-Type: text/html\n\u003c Content-Length: 497\n\u003c Connection: keep-alive\n\u003c ETag: \"6537cac7-1f1\"\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231211201811-w7nj2pa","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20231211201811-w7nj2pa","updated":"20231211201811"},"Children":[{"Type":"NodeText","Data":"优雅关闭的初步实现"}]},{"ID":"20231211201811-t1oaxyt","Type":"NodeParagraph","Properties":{"id":"20231211201811-t1oaxyt","updated":"20231211201811"},"Children":[{"Type":"NodeText","Data":"优雅关闭（"},{"Type":"NodeTextMark","TextMarkType":"em","TextMarkTextContent":"graceful shutdown"},{"Type":"NodeText","Data":"）指的是我们的HTTP Server关闭前既拒绝新来的请求，又正确的处理完正在进行中的请求，随后进程退出。如何实现？"}]},{"ID":"20231211201811-nprw0dr","Type":"NodeParagraph","Properties":{"id":"20231211201811-nprw0dr","updated":"20231211201811"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"🌲 异步启动HTTP server"}]},{"ID":"20231211201811-qli369x","Type":"NodeParagraph","Properties":{"id":"20231211201811-qli369x","updated":"20231211201811"},"Children":[{"Type":"NodeText","Data":"因为"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"ListenAndServe"},{"Type":"NodeText","Data":"​会阻塞goroutine，如果还需要让代码继续执行，我们需要把它放到一个异步的goroutine中"}]},{"ID":"20231211201815-i48lkl4","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231211201815-i48lkl4","updated":"20231211201842"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"go func() {\n  if err := srv.ListenAndServe();\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]}