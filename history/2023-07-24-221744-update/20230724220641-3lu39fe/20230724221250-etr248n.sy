{"ID":"20230724221250-etr248n","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f981","id":"20230724221250-etr248n","tags":"docker 搭建服务,elasticsearch","title":"Elk日志收集系统搭建","updated":"20230724221654"},"Children":[{"ID":"20230724221253-mhg87hf","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724221253-mhg87hf","updated":"20230724221253"},"Children":[{"Type":"NodeText","Data":"Dokcer环境安装 elasticsearch"}]},{"ID":"20230724221253-mc8hrzq","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724221253-mc8hrzq","updated":"20230724221253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"docker run -p 9200:9200 -p 9300:9300 --name elasticsearch --n\\\n-e \"discovery.type=single-node\" \\\n-e \"cluster.name=elasticsearch\" \\\n-e \"ES_JAVA_OPTS=-Xms512m -Xmx1024m\" \\\n-v /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins \\\n-v /mydata/elasticsearch/data:/usr/share/elasticsearch/data \\\n-d elasticsearch:8.5.3\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230724221253-nila784","Type":"NodeParagraph","Properties":{"id":"20230724221253-nila784","updated":"20230724221253"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"修改 /mydata/elasticsearch/data 的目录权限，"}]},{"ID":"20230724221253-nsj3v4d","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724221253-nsj3v4d","updated":"20230724221253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"chmod 777 /mydata/elasticsearch/data/\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230724221253-a0kkiwi","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724221253-a0kkiwi","updated":"20230724221253"},"Children":[{"Type":"NodeText","Data":"运行Logstash 容器，"}]},{"ID":"20230724221253-ypou7o9","Type":"NodeParagraph","Properties":{"id":"20230724221253-ypou7o9","updated":"20230724221253"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"logstash.conf"}]},{"ID":"20230724221253-9eocofu","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724221253-9eocofu","updated":"20230724221253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"input {\n  tcp {\n    mode =\u003e \"server\"\n    host =\u003e \"0.0.0.0\"\n    port =\u003e 4560\n    codec =\u003e json_lines\n    type =\u003e \"debug\"\n  }\n  tcp {\n    mode =\u003e \"server\"\n    host =\u003e \"0.0.0.0\"\n    port =\u003e 4561\n    codec =\u003e json_lines\n    type =\u003e \"error\"\n  }docker\n  tcp {\n    mode =\u003e \"server\"\n    host =\u003e \"0.0.0.0\"\n    port =\u003e 4562\n    codec =\u003e json_lines\n    type =\u003e \"business\"\n  }\n  tcp {\n    mode =\u003e \"server\"\n    host =\u003e \"0.0.0.0\"\n    port =\u003e 4563\n    codec =\u003e json_lines\n    type =\u003e \"record\"\n  }\n}\nfilter{\n  if [type] == \"record\" {\n    mutate {\n      remove_field =\u003e \"port\"\n      remove_field =\u003e \"host\"\n      remove_field =\u003e \"@version\"\n    }\n    json {\n      source =\u003e \"message\"\n      remove_field =\u003e [\"message\"]\n    }\n  }\n}\noutput {\n  elasticsearch {\n    hosts =\u003e \"localhost:9200\"\n    index =\u003e \"mall-%{type}-%{+YYYY.MM.dd}\"\n  }\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230724221253-afwnvrr","Type":"NodeParagraph","Properties":{"id":"20230724221253-afwnvrr","updated":"20230724221654"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"docker 安装 Logstash"}]},{"ID":"20230724221253-dqc59ma","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724221253-dqc59ma","updated":"20230724221253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"docker run --name logstash -p 4560:4560 -p 4561:4561 -p 4562:4562 -p 4563:4563 \\\n--link elasticsearch:es \\\n-v /mydata/logstash/logstash.conf:/usr/share/logstash/pipeline/logstash.conf \\\n-d logstash:8.5.3\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230724221253-la0n2gv","Type":"NodeParagraph","Properties":{"id":"20230724221253-la0n2gv","updated":"20230724221253"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"进入容器内部，安装 json_lines 插件"}]},{"ID":"20230724221253-913qzy1","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724221253-913qzy1","updated":"20230724221253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"docker exec -it logstash /bin/bash\nlogstash-plugin install logstash-codec-json_lines\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230724221253-ycfkpum","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724221253-ycfkpum","updated":"20230724221253"},"Children":[{"Type":"NodeText","Data":"安装并运行 Kibana容器，"}]},{"ID":"20230724221253-djg9mjk","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724221253-djg9mjk","updated":"20230724221253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"docker run --name kibana -p 5601:5601 \\\n--link elasticsearch:es \\\n-e \"elasticsearch.hosts=http://es:9200\" \\\n-d kibana:8.5.3\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230724221253-6jxv1og","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724221253-6jxv1og","updated":"20230724221253"},"Children":[{"Type":"NodeText","Data":"kibana UI 设置中文"}]},{"ID":"20230724221253-cflig4b","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724221253-cflig4b","updated":"20230724221253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"docker exec -it kibana /bin/bash\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230724221253-zjvzzcb","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724221253-zjvzzcb","updated":"20230724221253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"cd /config\nvi kibana.yml\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230724221253-o218eia","Type":"NodeParagraph","Properties":{"id":"20230724221253-o218eia","updated":"20230724221253"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"配置文件中加入一行"}]},{"ID":"20230724221253-9phb7n9","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724221253-9phb7n9","updated":"20230724221253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"i18n.locale: \"zh-CN\" \n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230724221253-bt360ud","Type":"NodeParagraph","Properties":{"id":"20230724221253-bt360ud","updated":"20230724221253"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"退出并重启容器"}]},{"ID":"20230724221253-tx3rvcn","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724221253-tx3rvcn","updated":"20230724221253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"exit \ndocker restart kibana\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230724221253-vt7wquv","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724221253-vt7wquv","updated":"20230724221253"},"Children":[{"Type":"NodeText","Data":"访问日志网页"}]},{"ID":"20230724221253-ff8nhtr","Type":"NodeParagraph","Properties":{"id":"20230724221253-ff8nhtr","updated":"20230724221253"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"ELK日志收集系统启动完成后，就可以访问Kibana的界面了，访问地址："},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://link.juejin.cn/?target=http%3A%2F%2F192.168.3.105%3A5601","TextMarkTextContent":"http://192.168.3.105:5601"}]},{"ID":"20230724221253-x80damv","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724221253-x80damv","updated":"20230724221253"},"Children":[{"Type":"NodeText","Data":"日志收集原理"}]},{"ID":"20230724221253-ffo70e6","Type":"NodeParagraph","Properties":{"id":"20230724221253-ffo70e6","updated":"20230724221253"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"日志收集系统的原理是这样的，首先应用集成了Logstash插件，通过TCP向Logstash传输日志。Logstash接收到日志后根据日志类型将日志存储到Elasticsearch的不同索引上去，Kibana从Elasticsearch中读取日志，然后我们就可以在Kibana中进行可视化日志分析了，具体流程图如下。"}]},{"ID":"20230724221253-5k4u4af","Type":"NodeParagraph","Properties":{"id":"20230724221253-5k4u4af","updated":"20230724221253"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"1658816262224"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"file://E:\\Typora%20picture\\1658816262224.png?lastModify=1690207966"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20230724221253-nsvki1v","Type":"NodeParagraph","Properties":{"id":"20230724221253-nsvki1v","updated":"20230724221253"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"这里把日志分为如下四种类型，方便查看"}]},{"ID":"20230724221253-s45enie","Type":"NodeParagraph","Properties":{"id":"20230724221253-s45enie","updated":"20230724221253"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"调试日志（mall-debug）：所有的DEBUG级别以上日志；"}]},{"ID":"20230724221253-e53161c","Type":"NodeParagraph","Properties":{"id":"20230724221253-e53161c","updated":"20230724221253"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"错误日志（mall-error）：所有的ERROR级别日志；"}]},{"ID":"20230724221253-c0d4k2y","Type":"NodeParagraph","Properties":{"id":"20230724221253-c0d4k2y","updated":"20230724221253"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"业务日志（mall-business）："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"com.macro.mall"},{"Type":"NodeText","Data":"​包下的所有DEBUG级别以上日志；"}]},{"ID":"20230724221253-93jw0f9","Type":"NodeParagraph","Properties":{"id":"20230724221253-93jw0f9","updated":"20230724221253"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"记录日志（mall-record）："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"com.macro.mall.tiny.component.WebLogAspect"},{"Type":"NodeText","Data":"​类下所有DEBUG级别以上日志，该类是统计接口访问信息的AOP切面类。"}]},{"ID":"20230724221253-sz93sk0","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724221253-sz93sk0","updated":"20230724221253"},"Children":[{"Type":"NodeText","Data":"启动应用"}]},{"ID":"20230724221253-xezb79v","Type":"NodeParagraph","Properties":{"id":"20230724221253-xezb79v","updated":"20230724221253"},"Children":[{"Type":"NodeText","Data":"** 首先得把mall项目的三个应用启动起来，通过**"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"--link logstash:logstash"},{"Type":"NodeText","Data":"​连接到Logstash。"}]},{"ID":"20230724221253-s9wv14k","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724221253-s9wv14k","updated":"20230724221253"},"Children":[{"Type":"NodeText","Data":"mall-admin"}]},{"ID":"20230724221253-ffqmb0p","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724221253-ffqmb0p","updated":"20230724221253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"docker run -p 8080:8080 --name mall-admin \\\n--link mysql:db \\\n--link redis:redis \\\n--link logstash:logstash \\\n-v /etc/localtime:/etc/localtime \\\n-v /mydata/app/admin/logs:/var/logs \\\n-d mall/mall-admin:1.0-SNAPSHOT\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230724221253-9z4xlnb","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724221253-9z4xlnb","updated":"20230724221253"},"Children":[{"Type":"NodeText","Data":"mall-portal"}]},{"ID":"20230724221253-3wjgjcp","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724221253-3wjgjcp","updated":"20230724221253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"docker run -p 8085:8085 --name mall-portal \\\n--link mysql:db \\\n--link redis:redis \\\n--link mongo:mongo \\\n--link rabbitmq:rabbit \\\n--link logstash:logstash \\\n-v /etc/localtime:/etc/localtime \\\n-v /mydata/app/portal/logs:/var/logs \\\n-d mall/mall-portal:1.0-SNAPSHOT\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20230724221253-sky4ccc","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724221253-sky4ccc","updated":"20230724221253"},"Children":[{"Type":"NodeText","Data":"mall-search"}]},{"ID":"20230724221253-5rr2v9w","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20230724221253-5rr2v9w","updated":"20230724221253"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker"},{"Type":"NodeCodeBlockCode","Data":"docker run -p 8081:8081 --name mall-search \\\n--link elasticsearch:es \\\n--link mysql:db \\\n--link logstash:logstash \\\n-v /etc/localtime:/etc/localtime \\\n-v /mydata/app/search/logs:/var/logs \\\n-d mall/mall-search:1.0-SNAPSHOT\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]}