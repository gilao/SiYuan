{"ID":"20231204094124-bvi179e","Spec":"1","Type":"NodeDocument","Properties":{"id":"20231204094124-bvi179e","tags":"公众号-polarisxu,Go-1.22,Go-for","title":"定了：Go 1.22将修复for循环变量错误","updated":"20231204095945"},"Children":[{"ID":"20231204094124-uizo7lk","Type":"NodeParagraph","Properties":{"id":"20231204094124-uizo7lk","updated":"20231204095416"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"Go 开发者经常会犯的错误是在循环迭代结束后，保留对循环变量的引用，此时它会采用预期之外的新值。"}]},{"ID":"20231204095417-z8ubkaf","Type":"NodeParagraph","Properties":{"id":"20231204095417-z8ubkaf","updated":"20231204095507"},"Children":[{"Type":"NodeText","Data":"例如下面的程序："}]},{"ID":"20231204095507-8vtckvb","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231204095507-8vtckvb","updated":"20231204095805"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"func main() {\n\tdone := make(chan bool)\n\n\tvalues := []string{\"a\",\"b\",\"c\"}\n\tfor _, v := range values {\n\t\tgo func() {\n\t\t\tfmt.Println(v)\n\t\t\tdone \u003c- true\n\t\t}()\n\t}\n\n\t// wait for all goroutines to complete before exiting\n\tfor _ = range values {\n\t\t\u003c-done\n\t}\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231204095814-cnuyupr","Type":"NodeParagraph","Properties":{"id":"20231204095814-cnuyupr","updated":"20231204095824"},"Children":[{"Type":"NodeText","Data":"其创建的三个 goroutine 都用于打印相同的变量 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"v"},{"Type":"NodeText","Data":"​，因此它们只会打印出 “c”, “c”, “c”，而不是按顺序打印 “a”, “b”, 和 “c”。"}]},{"ID":"20231204095814-zkw9vfr","Type":"NodeParagraph","Properties":{"id":"20231204095814-zkw9vfr","updated":"20231204095836"},"Children":[{"Type":"NodeText","Data":"从 Go1.21 开始，开发者可以启用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"GOEXPERIMENT=loopvar"},{"Type":"NodeText","Data":"​ 来构建 Go 程序，以解决上文提到的 for 循环变量问题。"}]},{"ID":"20231204095819-4xu3l8w","Type":"NodeParagraph","Properties":{"id":"20231204095819-4xu3l8w","updated":"20231204095911"},"Children":[{"Type":"NodeText","Data":"构建命令："}]},{"ID":"20231204095933-2ge17cp","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20231204095933-2ge17cp","updated":"20231204095943"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28="},{"Type":"NodeCodeBlockCode","Data":"GOEXPERIMENT\\=loopvar go install my/program\nGOEXPERIMENT\\=loopvar go build my/program\nGOEXPERIMENT\\=loopvar go test my/program\nGOEXPERIMENT\\=loopvar go test my/program -bench\\=.\n...\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20231204095945-6om27pi","Type":"NodeParagraph","Properties":{"id":"20231204095945-6om27pi"}}]}