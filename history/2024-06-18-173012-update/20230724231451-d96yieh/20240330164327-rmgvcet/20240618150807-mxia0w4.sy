{"ID":"20240618150807-mxia0w4","Spec":"1","Type":"NodeDocument","Properties":{"icon":"1f638","id":"20240618150807-mxia0w4","title":"如何实现埋点日志精准监控","type":"doc","updated":"20240618172317"},"Children":[{"ID":"20240618150829-j06llx6","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240618150829-j06llx6","updated":"20240618172217"},"Children":[{"Type":"NodeText","Data":"1 引言"}]},{"ID":"20240618150853-igg3eiq","Type":"NodeParagraph","Properties":{"id":"20240618150853-igg3eiq","updated":"20240618172217"},"Children":[{"Type":"NodeText","Data":"日志中台，作为百度数据埋点的全套一站式解决方案，目前已覆盖了厂内以手机百度 APP 作为代表的大多数重点产品，承载着每天千亿量级的埋点日志 PV。"}]},{"ID":"20240618150853-qnlr8fx","Type":"NodeParagraph","Properties":{"id":"20240618150853-qnlr8fx","updated":"20240618172217"},"Children":[{"Type":"NodeText","Data":"埋点日志的实时监控，在日志中台应对突发流量、业务迭代埋点逻辑、埋点计费结算等场景中均发挥着不可或缺的作用。而在海量的数据下，如何对埋点日志进行精准地监控，保证监控的易用性、稳定性与准确性，是日志中台的一大难题。"}]},{"ID":"20240618150853-hnl6we3","Type":"NodeParagraph","Properties":{"id":"20240618150853-hnl6we3","updated":"20240618172217"},"Children":[{"Type":"NodeText","Data":"本文首先对日志中台的 UBC 埋点相关概念进行了简单介绍，分析了埋点监控的需求，并深入讲解了埋点监控的架构设计，最后重点分析了实现过程中的难点、解决方案以及实践过程中的思考。"}]},{"ID":"20240618150807-zj6r9c4","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240618150807-zj6r9c4","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"2 概念简介\u0026需求分析"}]},{"ID":"20240618151503-2u4pheq","Type":"NodeParagraph","Properties":{"id":"20240618151503-2u4pheq","updated":"20240618172215"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"UBC"},{"Type":"NodeText","Data":"（User Behavior Collection）即用户行为收集，是日志中台数据埋点的主流协议。按上报端的类型，分为 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"UBC 端日志、UBC Server 日志、UBC H5 日志三大类。"}]},{"ID":"20240618151503-g6mjn2w","Type":"NodeParagraph","Properties":{"id":"20240618151503-g6mjn2w","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"每条 UBC 日志中，都携带日志的 UBC ID，用于区分用户的不同行为。"}]},{"ID":"20240618171951-jpe6ydf","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240618171951-jpe6ydf","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"2.1 UBC 打点类型"}]},{"ID":"20240618172007-7gslcm1","Type":"NodeParagraph","Properties":{"id":"20240618172007-7gslcm1","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"根据打点所表达的场景，UBC 日志可分为"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"事件打点"},{"Type":"NodeText","Data":"和"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"流式打点"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240618172007-phso741","Type":"NodeParagraph","Properties":{"id":"20240618172007-phso741","updated":"20240618172215"},"Children":[{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color1);"},"TextMarkType":"strong text","TextMarkTextContent":"事件打点"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color1);\"}"},{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color1);"},"TextMarkType":"text","TextMarkTextContent":"用来记录一个单次行为，"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color1);\"}"},{"Type":"NodeText","Data":"例如一次点击、一次列表页展示等，通常以 pv 作为统计值。"}]},{"ID":"20240618172007-imm4ije","Type":"NodeParagraph","Properties":{"id":"20240618172007-imm4ije","updated":"20240618172215"},"Children":[{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color1);"},"TextMarkType":"strong text","TextMarkTextContent":"流式打点"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color1);\"}"},{"Type":"NodeTextMark","Properties":{"style":"color: var(--b3-font-color1);"},"TextMarkType":"text","TextMarkTextContent":"用来记录一个持续行为"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"color: var(--b3-font-color1);\"}"},{"Type":"NodeText","Data":"，例如一次视频观看、某功能的使用时长等。流式打点特有 duration 字段，用来表达行为的持续时间，通常 pv 和 duration 都会作为统计值。"}]},{"ID":"20240618172009-ichwzy7","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240618172009-ichwzy7","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"2.2 公共参数与业务参数"}]},{"ID":"20240618172051-sba66pv","Type":"NodeParagraph","Properties":{"id":"20240618172051-sba66pv","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"UBC 日志中，部分参数是广泛存在于所有打点的，由 UBC 的打点 SDK 统一获取并上报，例如系统类型（Android/IOS 等）、设备 ID、APP 名称、APP 版本等。这些参数被称作"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"公共参数"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240618172051-jz57gno","Type":"NodeParagraph","Properties":{"id":"20240618172051-jz57gno","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"除公共参数外，业务在打点时可自行定义其他参数，对同一类 UBC ID 的行为日志进行进一步细分。"}]},{"ID":"20240618172051-tt68z3k","Type":"NodeParagraph","Properties":{"id":"20240618172051-tt68z3k","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"例如：我们用 UBC ID = 10397 表达 Feed 业务的一次点击行为，这个点击可能来自不同的页面，便可以定义名为 from 的字段，用于区分点击的页面来源，按不同页面分别点击量 pv 和占比。"}]},{"ID":"20240618172051-o1ohtr2","Type":"NodeParagraph","Properties":{"id":"20240618172051-o1ohtr2","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"这些参数按照 UBC ID 粒度进行参数的管理，支持不同行为下，由业务个性化定义，被称作"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"业务参数"},{"Type":"NodeText","Data":"。"}]},{"ID":"20240618172122-15qd4vo","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240618172122-15qd4vo","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"2.3 埋点监控需求分析"}]},{"ID":"20240618172138-l2qwgbh","Type":"NodeParagraph","Properties":{"id":"20240618172138-l2qwgbh","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"作为监控，需要应对突发流量、埋点变更等场景，必然对时效性有较高的要求。"}]},{"ID":"20240618172138-mmz8rc9","Type":"NodeParagraph","Properties":{"id":"20240618172138-mmz8rc9","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"同时，监控维度需要尽可能多样化，除了公共参数外，还需要能支持业务参数的自由组合。"}]},{"ID":"20240618172138-cwkzlxu","Type":"NodeParagraph","Properties":{"id":"20240618172138-cwkzlxu","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"结合上面的基本概念，我们可以得到埋点监控的核心目标："}]},{"ID":"20240618172138-raij8pa","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240618172138-raij8pa","updated":"20240618172215"},"Children":[{"ID":"20240618172143-lnyn14w","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240618172143-lnyn14w","updated":"20240618172143"},"Children":[{"ID":"20240618172143-wup80wl","Type":"NodeParagraph","Properties":{"id":"20240618172143-wup80wl","updated":"20240618172143"},"Children":[{"Type":"NodeText","Data":"能够有较高的时效性，在分钟级的延迟内查看埋点的数据趋势。"}]}]}]},{"ID":"20240618172138-ihi0qjk","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240618172138-ihi0qjk","updated":"20240618172215"},"Children":[{"ID":"20240618172145-4g2gvme","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240618172145-4g2gvme","updated":"20240618172145"},"Children":[{"ID":"20240618172145-uehjbdd","Type":"NodeParagraph","Properties":{"id":"20240618172145-uehjbdd","updated":"20240618172145"},"Children":[{"Type":"NodeText","Data":"对于事件类型的打点，以 PV 作为统计口径；对于流式类型的打点，以PV和 总时长作为统计口径。"}]}]}]},{"ID":"20240618172138-u1wlj2a","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240618172138-u1wlj2a","updated":"20240618172215"},"Children":[{"ID":"20240618172146-y7gs3bq","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240618172146-y7gs3bq","updated":"20240618172146"},"Children":[{"ID":"20240618172146-8g616et","Type":"NodeParagraph","Properties":{"id":"20240618172146-8g616et","updated":"20240618172146"},"Children":[{"Type":"NodeText","Data":"埋点数据和趋势，同时支持按照公共参数与业务参数组装筛选条件。"}]}]}]},{"ID":"20240618172138-gra9lml","Type":"NodeParagraph","Properties":{"id":"20240618172138-gra9lml","updated":"20240618172215"},"Children":[{"Type":"NodeText","Data":"基于上述目标，我们结合目前日志中台的实时流架构，对埋点监控能力进行了方案设计。"}]},{"ID":"20240618172158-dkyr7me","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20240618172158-dkyr7me","updated":"20240618172207"},"Children":[{"Type":"NodeText","Data":"3 整体方案"}]},{"ID":"20240618172222-7j2djas","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240618172222-7j2djas","updated":"20240618172240"},"Children":[{"Type":"NodeText","Data":"3.1 日志中台架构现状"}]},{"ID":"20240618172247-2vmrum9","Type":"NodeParagraph","Properties":{"id":"20240618172247-2vmrum9","updated":"20240618172247"},"Children":[{"Type":"NodeText","Data":"日志中台的端日志与 H5 日志经由客户端 SDK 上报至专门的日志接收 server，初步解析后进行原始日志落盘。"}]},{"ID":"20240618172247-4ju7kmp","Type":"NodeParagraph","Properties":{"id":"20240618172247-4ju7kmp","updated":"20240618172247"},"Children":[{"Type":"NodeText","Data":"Server 日志则有对应的业务服务直接按照指定的格式进行原始日志落盘。"}]},{"ID":"20240618172247-844xvj9","Type":"NodeParagraph","Properties":{"id":"20240618172247-844xvj9","updated":"20240618172247"},"Children":[{"Type":"NodeText","Data":"落盘后的原始日志经由日志传输组件采集至中转消息队列，由流式任务订阅处理后交付给业务使用。"}]},{"ID":"20240618172247-yidpaz2","Type":"NodeParagraph","Properties":{"id":"20240618172247-yidpaz2","updated":"20240618172247"},"Children":[{"Type":"NodeText","Data":"整体流程图大致如下："}]},{"ID":"20240618172253-b5ulews","Type":"NodeParagraph","Properties":{"id":"20240618172253-b5ulews","updated":"20240618172255"},"Children":[{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"display: block;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"23f1f03526ab12014fcc58c7701717e1"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/23f1f03526ab12014fcc58c7701717e1-20240618172253-1z6hkwv.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: parent-style=\"display: block;\"}"}]},{"ID":"20240618172300-u0bo6aq","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240618172300-u0bo6aq","updated":"20240618172317"},"Children":[{"Type":"NodeText","Data":"3.2 埋点监控架构设计"}]}]}