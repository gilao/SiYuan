{"ID":"20230724231415-v08snax","Spec":"1","Type":"NodeDocument","Properties":{"id":"20230724231415-v08snax","title":"GO Context 原理及函数","updated":"20230724231415"},"Children":[{"ID":"20230724231416-grla47s","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20230724231416-grla47s","updated":"20230724231416"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"# ","Properties":{"id":""}},{"Type":"NodeText","Data":"Context 原理"}]},{"ID":"20230724231417-g1kea1f","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20230724231417-g1kea1f","updated":"20230724231417"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"# ","Properties":{"id":""}},{"Type":"NodeText","Data":"1. 前言"}]},{"ID":"20230724231418-pns56cl","Type":"NodeParagraph","Properties":{"id":"20230724231418-pns56cl","updated":"20230724231418"},"Children":[{"Type":"NodeText","Data":"Golang context是Golang应用开发常用的并发控制技术，它与WaitGroup最大的不同点是context对于派生goroutine有更强的控制力，它可以控制多级的goroutine。"}]},{"ID":"20230724231419-r9qm45i","Type":"NodeParagraph","Properties":{"id":"20230724231419-r9qm45i","updated":"20230724231419"},"Children":[{"Type":"NodeText","Data":"context翻译成中文是”上下文”，即它可以控制一组呈树状结构的goroutine，每个goroutine拥有相同的上下文。"}]},{"ID":"20230724231420-flkuyoc","Type":"NodeParagraph","Properties":{"id":"20230724231420-flkuyoc","updated":"20230724231420"},"Children":[{"Type":"NodeText","Data":"典型的使用场景如下图所示："}]},{"ID":"20230724231421-dtt1rz4","Type":"NodeParagraph","Properties":{"id":"20230724231421-dtt1rz4","updated":"20230724231421"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"null","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"../../Typora picture/m_fbdcf78fa8ee5b280dae750ff631c3d6_r.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20230724231422-qi223wq","Type":"NodeParagraph","Properties":{"id":"20230724231422-qi223wq","updated":"20230724231422"},"Children":[{"Type":"NodeText","Data":"上图中由于goroutine派生出子goroutine，而子goroutine又继续派生新的goroutine，这种情况下使用WaitGroup就不太容易，因为子goroutine个数不容易确定。而使用context就可以很容易实现。"}]},{"ID":"20230724231423-h9vsn16","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20230724231423-h9vsn16","updated":"20230724231423"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"# ","Properties":{"id":""}},{"Type":"NodeText","Data":"2. Context实现原理"}]},{"ID":"20230724231424-tojmda5","Type":"NodeParagraph","Properties":{"id":"20230724231424-tojmda5","updated":"20230724231424"},"Children":[{"Type":"NodeText","Data":"context实际上只定义了接口，凡是实现该接口的类都可称为是一种context，官方包中实现了几个常用的context，分别可用于不同的场景。"}]},{"ID":"20230724231425-jkkcybh","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724231425-jkkcybh","updated":"20230724231425"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.1 接口定义"}]},{"ID":"20230724231426-6tcag1i","Type":"NodeParagraph","Properties":{"id":"20230724231426-6tcag1i","updated":"20230724231426"},"Children":[{"Type":"NodeText","Data":"源码包中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"src/context/context.go:Context"},{"Type":"NodeText","Data":" 定义了该接口："}]},{"ID":"20230724231427-0h8n0pg","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231427-0h8n0pg","updated":"20230724231427"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"type Context interface {\n    Deadline() (deadline time.Time, ok bool)\n\n    Done() \u003c-chan struct{}\n\n    Err() error\n\n    Value(key interface{}) interface{}\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231428-4zyogcs","Type":"NodeParagraph","Properties":{"id":"20230724231428-4zyogcs","updated":"20230724231428"},"Children":[{"Type":"NodeText","Data":"基础的context接口只定义了4个方法，下面分别简要说明一下："}]},{"ID":"20230724231429-7icrhfu","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231429-7icrhfu","updated":"20230724231429"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.1.1 Deadline()"}]},{"ID":"20230724231430-qgmjvef","Type":"NodeParagraph","Properties":{"id":"20230724231430-qgmjvef","updated":"20230724231430"},"Children":[{"Type":"NodeText","Data":"该方法返回一个deadline和标识是否已设置deadline的bool值，"},{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"如果没有设置deadline，则ok == false"},{"Type":"NodeMark2CloseMarker","Data":"=="}]},{"Type":"NodeText","Data":"，此时deadline为一个初始值的time.Time值"}]},{"ID":"20230724231431-3o094s6","Type":"NodeParagraph","Properties":{"id":"20230724231431-3o094s6","updated":"20230724231431"},"Children":[{"Type":"NodeText","Data":"该方法会返回一个超时时间，routine获得了超时时间后，可以对某些io操作设定超时时间。"}]},{"ID":"20230724231432-vn7sduc","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231432-vn7sduc","updated":"20230724231432"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.1.2 Done()"}]},{"ID":"20230724231433-2hruxi1","Type":"NodeParagraph","Properties":{"id":"20230724231433-2hruxi1","updated":"20230724231433"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"该方法返回一个channel"},{"Type":"NodeMark2CloseMarker","Data":"=="}]},{"Type":"NodeText","Data":"，需要在select-case语句中使用，如”case \u003c-context.Done():”。"}]},{"ID":"20230724231434-9dq87xs","Type":"NodeParagraph","Properties":{"id":"20230724231434-9dq87xs","updated":"20230724231434"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"当context关闭后，Done()返回一个被关闭的管道"},{"Type":"NodeMark2CloseMarker","Data":"=="}]},{"Type":"NodeText","Data":"，"},{"Type":"NodeStrong","Children":[{"Type":"NodeStrongA6kOpenMarker","Data":"**"},{"Type":"NodeText","Data":"关闭的管道仍然是可读的"},{"Type":"NodeStrongA6kCloseMarker","Data":"**"}]},{"Type":"NodeText","Data":"，据此goroutine可以收到关闭请求；"}]},{"ID":"20230724231435-nj4wqjz","Type":"NodeParagraph","Properties":{"id":"20230724231435-nj4wqjz","updated":"20230724231435"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"当context还未关闭时，Done()返回nil"},{"Type":"NodeMark2CloseMarker","Data":"=="}]},{"Type":"NodeText","Data":"。"}]},{"ID":"20230724231436-2zwffv5","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231436-2zwffv5","updated":"20230724231436"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.1.3 Err()"}]},{"ID":"20230724231437-sossrf0","Type":"NodeParagraph","Properties":{"id":"20230724231437-sossrf0","updated":"20230724231437"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"该方法描述context关闭的原因"},{"Type":"NodeMark2CloseMarker","Data":"=="}]},{"Type":"NodeText","Data":"。关闭原因由context实现控制，不需要用户设置。比如Deadline context，关闭原因可能是因为deadline，也可能提前被主动关闭，那么关闭原因就会不同:"}]},{"ID":"20230724231438-ves3ve9","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231438-ves3ve9","updated":"20230724231438"},"Children":[{"ID":"20230724231439-r1nu2dw","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231439-r1nu2dw","updated":"20230724231439"},"Children":[{"ID":"20230724231440-jw12wvv","Type":"NodeParagraph","Properties":{"id":"20230724231440-jw12wvv","updated":"20230724231440"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"因deadline关闭：“context deadline exceeded”；"}]}]},{"ID":"20230724231441-f93kc4a","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231441-f93kc4a","updated":"20230724231441"},"Children":[{"ID":"20230724231442-hybihpm","Type":"NodeParagraph","Properties":{"id":"20230724231442-hybihpm","updated":"20230724231442"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"因主动关闭： “context canceled”。"}]}]}]},{"ID":"20230724231443-p377ebp","Type":"NodeParagraph","Properties":{"id":"20230724231443-p377ebp","updated":"20230724231443"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"当context关闭后，Err()返回context的关闭原因；"},{"Type":"NodeMark2CloseMarker","Data":"=="}]},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"当context还未关闭时，Err()返回nil；"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]},{"ID":"20230724231444-4pgnhfb","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231444-4pgnhfb","updated":"20230724231444"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.1.4 Value()"}]},{"ID":"20230724231445-6e1fr44","Type":"NodeParagraph","Properties":{"id":"20230724231445-6e1fr44","updated":"20230724231445"},"Children":[{"Type":"NodeText","Data":"有一种context，它"},{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"不是用于控制呈树状分布的goroutine"},{"Type":"NodeMark2CloseMarker","Data":"=="}]},{"Type":"NodeText","Data":"，而是"},{"Type":"NodeStrong","Children":[{"Type":"NodeStrongA6kOpenMarker","Data":"**"},{"Type":"NodeText","Data":"用于在树状分布的goroutine间传递信息。"},{"Type":"NodeStrongA6kCloseMarker","Data":"**"}]}]},{"ID":"20230724231446-jjwd9h4","Type":"NodeParagraph","Properties":{"id":"20230724231446-jjwd9h4","updated":"20230724231446"},"Children":[{"Type":"NodeText","Data":"Value()方法就是用于此种类型的context，该"},{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"方法根据key值查询map中的value。"},{"Type":"NodeMark2CloseMarker","Data":"=="}]},{"Type":"NodeText","Data":"具体使用后面示例说明。"}]},{"ID":"20230724231447-39xd0yx","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724231447-39xd0yx","updated":"20230724231447"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.2 空context"}]},{"ID":"20230724231448-y3by3iz","Type":"NodeParagraph","Properties":{"id":"20230724231448-y3by3iz","updated":"20230724231448"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"context包中定义了一个空的context"},{"Type":"NodeText","Data":"， 名为"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"emptyCtx"},{"Type":"NodeText","Data":"，"},{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"用于context的根节点，"},{"Type":"NodeMark2CloseMarker","Data":"=="}]},{"Type":"NodeText","Data":"空的context只是简单的实现了Context，本身不包含任何值，仅用于其他context的父节点。"}]},{"ID":"20230724231449-n5tpivy","Type":"NodeParagraph","Properties":{"id":"20230724231449-n5tpivy","updated":"20230724231449"},"Children":[{"Type":"NodeText","Data":"emptyCtx类型定义如下代码所示："}]},{"ID":"20230724231450-05le0la","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231450-05le0la","updated":"20230724231450"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"type emptyCtx int\n\nfunc (*emptyCtx) Deadline() (deadline time.Time, ok bool) {\n    return\n}\n\nfunc (*emptyCtx) Done() \u003c-chan struct{} {\n    return nil\n}\n\nfunc (*emptyCtx) Err() error {\n    return nil\n}\n\nfunc (*emptyCtx) Value(key interface{}) interface{} {\n    return nil\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231451-bayhqil","Type":"NodeParagraph","Properties":{"id":"20230724231451-bayhqil","updated":"20230724231451"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"context包中定义了一个公用的emptCtx全局变量，名为background，可以使用context.Background()获取它，"},{"Type":"NodeMark2CloseMarker","Data":"=="}]},{"Type":"NodeText","Data":"实现代码如下所示："}]},{"ID":"20230724231452-a1x2q31","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231452-a1x2q31","updated":"20230724231452"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"var background = new(emptyCtx)\nfunc Background() Context {\n    return background\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231453-oocuuoj","Type":"NodeParagraph","Properties":{"id":"20230724231453-oocuuoj","updated":"20230724231453"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"context包提供了4个方法创建不同类型的context，使用这四个方法时如果没有父context，都需要传入backgroud，即backgroud作为其父节点："}]},{"ID":"20230724231454-0vzqvs4","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231454-0vzqvs4","updated":"20230724231454"},"Children":[{"ID":"20230724231455-vsci74t","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231455-vsci74t","updated":"20230724231455"},"Children":[{"ID":"20230724231456-dc3ujhk","Type":"NodeParagraph","Properties":{"id":"20230724231456-dc3ujhk","updated":"20230724231456"},"Children":[{"Type":"NodeText","Data":"WithCancel()"}]}]},{"ID":"20230724231457-20kvw8l","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231457-20kvw8l","updated":"20230724231457"},"Children":[{"ID":"20230724231458-tv2gjrr","Type":"NodeParagraph","Properties":{"id":"20230724231458-tv2gjrr","updated":"20230724231458"},"Children":[{"Type":"NodeText","Data":"WithDeadline()"}]}]},{"ID":"20230724231459-7htjjj2","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231459-7htjjj2","updated":"20230724231459"},"Children":[{"ID":"20230724231460-mkus8ce","Type":"NodeParagraph","Properties":{"id":"20230724231460-mkus8ce","updated":"20230724231460"},"Children":[{"Type":"NodeText","Data":"WithTimeout()"}]}]},{"ID":"20230724231461-35dgpd1","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231461-35dgpd1","updated":"20230724231461"},"Children":[{"ID":"20230724231462-ck4vbqj","Type":"NodeParagraph","Properties":{"id":"20230724231462-ck4vbqj","updated":"20230724231462"},"Children":[{"Type":"NodeText","Data":"WithValue()"}]}]}]},{"ID":"20230724231463-zmlbz30","Type":"NodeParagraph","Properties":{"id":"20230724231463-zmlbz30","updated":"20230724231463"},"Children":[{"Type":"NodeText","Data":"context包中实现Context接口的struct，除了emptyCtx外，还有cancelCtx、timerCtx和valueCtx三种，正是基于这三种context实例，实现了上述4种类型的context。"}]},{"ID":"20230724231464-89oy0ti","Type":"NodeParagraph","Properties":{"id":"20230724231464-89oy0ti","updated":"20230724231464"},"Children":[{"Type":"NodeText","Data":"context包中各context类型之间的关系，如下图所示："}]},{"ID":"20230724231465-ol0hena","Type":"NodeParagraph","Properties":{"id":"20230724231465-ol0hena","updated":"20230724231465"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"null","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"../../Typora picture/m_f41adc85deafd7243fc1eb3e6c553ced_r.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20230724231466-n6pftyg","Type":"NodeParagraph","Properties":{"id":"20230724231466-n6pftyg","updated":"20230724231466"},"Children":[{"Type":"NodeText","Data":"struct cancelCtx、timerCtx、valueCtx都继承于Context，下面分别介绍这三个struct。"}]},{"ID":"20230724231467-xueo1ws","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724231467-xueo1ws","updated":"20230724231467"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.3 cancelCtx"}]},{"ID":"20230724231468-j83nf31","Type":"NodeParagraph","Properties":{"id":"20230724231468-j83nf31","updated":"20230724231468"},"Children":[{"Type":"NodeText","Data":"源码包中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"src/context/context.go:cancelCtx"},{"Type":"NodeText","Data":" 定义了该类型context："}]},{"ID":"20230724231469-d0dv5nv","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231469-d0dv5nv","updated":"20230724231469"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"type cancelCtx struct {\n    Context\n\n    mu       sync.Mutex            // protects following fields\n    done     chan struct{}         // created lazily, closed by first cancel call\n    children map[canceler]struct{} // set to nil by the first cancel call\n    err      error                 // set to non-nil by the first cancel call\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231470-kemn1hn","Type":"NodeParagraph","Properties":{"id":"20230724231470-kemn1hn","updated":"20230724231470"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"children中记录了由此context派生的所有child，此context被cancel时会把其中的所有child都cancel掉。"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]},{"ID":"20230724231471-w9vl1et","Type":"NodeParagraph","Properties":{"id":"20230724231471-w9vl1et","updated":"20230724231471"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"cancelCtx与deadline和value无关，所以只需要实现Done()和Err()外露接口即可"},{"Type":"NodeText","Data":"。"}]},{"ID":"20230724231472-9ydq3gk","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231472-9ydq3gk","updated":"20230724231472"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.3.1 Done()接口实现"}]},{"ID":"20230724231473-rb87jfr","Type":"NodeParagraph","Properties":{"id":"20230724231473-rb87jfr","updated":"20230724231473"},"Children":[{"Type":"NodeText","Data":"按照Context定义，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"Done()接口只需要返回一个channel即可"},{"Type":"NodeText","Data":"，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"对于cancelCtx来说只需要返回成员变量done即可。"}]},{"ID":"20230724231474-gzzv6v7","Type":"NodeParagraph","Properties":{"id":"20230724231474-gzzv6v7","updated":"20230724231474"},"Children":[{"Type":"NodeText","Data":"这里直接看下源码，非常简单："}]},{"ID":"20230724231475-l1b6s0i","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231475-l1b6s0i","updated":"20230724231475"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"func (c *cancelCtx) Done() \u003c-chan struct{} {\n    c.mu.Lock()\n    if c.done == nil {\n        c.done = make(chan struct{})\n    }\n    d := c.done\n    c.mu.Unlock()\n    return d\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231476-ned1rhq","Type":"NodeParagraph","Properties":{"id":"20230724231476-ned1rhq","updated":"20230724231476"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"由于cancelCtx没有指定初始化函数，所以cancelCtx.done可能还未分配，所以需要考虑初始化。"},{"Type":"NodeMark2CloseMarker","Data":"=="}]},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeStrong","Children":[{"Type":"NodeStrongA6kOpenMarker","Data":"**"},{"Type":"NodeText","Data":"cancelCtx.done会在context被cancel时关闭，所以cancelCtx.done的值一般经历如下三个阶段："},{"Type":"NodeStrongA6kCloseMarker","Data":"**"}]},{"Type":"NodeSoftBreak","Data":"\n","Properties":{"id":""}},{"Type":"NodeStrong","Children":[{"Type":"NodeStrongA6kOpenMarker","Data":"**"},{"Type":"NodeText","Data":"nil –\u003e chan struct{} –\u003e closed chan。"},{"Type":"NodeStrongA6kCloseMarker","Data":"**"}]}]},{"ID":"20230724231477-9q5a66r","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231477-9q5a66r","updated":"20230724231477"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.3.2 Err()接口实现"}]},{"ID":"20230724231478-7xwx0jn","Type":"NodeParagraph","Properties":{"id":"20230724231478-7xwx0jn","updated":"20230724231478"},"Children":[{"Type":"NodeText","Data":"按照Context定义，"},{"Type":"NodeStrong","Children":[{"Type":"NodeStrongA6kOpenMarker","Data":"**"},{"Type":"NodeText","Data":"Err()只需要返回一个error告知context被关闭的原因。"},{"Type":"NodeStrongA6kCloseMarker","Data":"**"}]},{"Type":"NodeText","Data":"对于cancelCtx来说只需要返回成员变量err即可。"}]},{"ID":"20230724231479-abybte9","Type":"NodeParagraph","Properties":{"id":"20230724231479-abybte9","updated":"20230724231479"},"Children":[{"Type":"NodeText","Data":"还是直接看下源码："}]},{"ID":"20230724231480-bzragh4","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231480-bzragh4","updated":"20230724231480"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"func (c *cancelCtx) Err() error {\n    c.mu.Lock()\n    err := c.err\n    c.mu.Unlock()\n    return err\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231481-sewmkof","Type":"NodeParagraph","Properties":{"id":"20230724231481-sewmkof","updated":"20230724231481"},"Children":[{"Type":"NodeText","Data":"cancelCtx.err默认是nil，在context被cancel时指定一个error变量： "},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"var Canceled = errors.New(\u0026quot;context canceled\u0026quot;)"},{"Type":"NodeText","Data":"。"}]},{"ID":"20230724231482-00y4g8u","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231482-00y4g8u","updated":"20230724231482"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.3.3 cancel()接口实现"}]},{"ID":"20230724231483-hhp0kf2","Type":"NodeParagraph","Properties":{"id":"20230724231483-hhp0kf2","updated":"20230724231483"},"Children":[{"Type":"NodeText","Data":"cancel()内部方法是理解cancelCtx的最关键的方法，"},{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"其作用是关闭自己和其后代，其后代存储在cancelCtx.children的map中，其中key值即后代对象，value值并没有意义，这里使用map只是为了方便查询而已。"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]},{"ID":"20230724231484-6usj7zd","Type":"NodeParagraph","Properties":{"id":"20230724231484-6usj7zd","updated":"20230724231484"},"Children":[{"Type":"NodeText","Data":"cancel方法实现伪代码如下所示："}]},{"ID":"20230724231485-0559y52","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231485-0559y52","updated":"20230724231485"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"func (c *cancelCtx) cancel(removeFromParent bool, err error) {\n    c.mu.Lock()\n\n    c.err = err                          //设置一个error，说明关闭原因\n    close(c.done)                     //将channel关闭，以此通知派生的context\n\n    for child := range c.children {   //遍历所有children，逐个调用cancel方法\n        child.cancel(false, err)\n    }\n    c.children = nil\n    c.mu.Unlock()\n\n    if removeFromParent {            //正常情况下，需要将自己从parent删除\n        removeChild(c.Context, c)\n    }\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231486-9fvobs2","Type":"NodeParagraph","Properties":{"id":"20230724231486-9fvobs2","updated":"20230724231486"},"Children":[{"Type":"NodeText","Data":"实际上，WithCancel()返回的第二个用于cancel context的方法正是此cancel()。"}]},{"ID":"20230724231487-gb8uyk4","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231487-gb8uyk4","updated":"20230724231487"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.3.4 WithCancel()方法实现"}]},{"ID":"20230724231488-fl2p3ez","Type":"NodeParagraph","Properties":{"id":"20230724231488-fl2p3ez","updated":"20230724231488"},"Children":[{"Type":"NodeText","Data":"WithCancel()方法作了三件事："}]},{"ID":"20230724231489-swg7e16","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231489-swg7e16","updated":"20230724231489"},"Children":[{"ID":"20230724231490-3807alf","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231490-3807alf","updated":"20230724231490"},"Children":[{"ID":"20230724231491-2myqqeb","Type":"NodeParagraph","Properties":{"id":"20230724231491-2myqqeb","updated":"20230724231491"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"初始化一个cancelCtx实例"}]}]},{"ID":"20230724231492-bbxy8d2","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231492-bbxy8d2","updated":"20230724231492"},"Children":[{"ID":"20230724231493-shvwe9b","Type":"NodeParagraph","Properties":{"id":"20230724231493-shvwe9b","updated":"20230724231493"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"将cancelCtx实例添加到其父节点的children中(如果父节点也可以被cancel的话)"}]}]},{"ID":"20230724231494-qqnaml2","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231494-qqnaml2","updated":"20230724231494"},"Children":[{"ID":"20230724231495-ic7lp6a","Type":"NodeParagraph","Properties":{"id":"20230724231495-ic7lp6a","updated":"20230724231495"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"返回cancelCtx实例和cancel()方法"}]}]}]},{"ID":"20230724231496-ewc81vq","Type":"NodeParagraph","Properties":{"id":"20230724231496-ewc81vq","updated":"20230724231496"},"Children":[{"Type":"NodeText","Data":"其实现源码如下所示："}]},{"ID":"20230724231497-210pb9l","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231497-210pb9l","updated":"20230724231497"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"func WithCancel(parent Context) (ctx Context, cancel CancelFunc) {\n    c := newCancelCtx(parent)\n    propagateCancel(parent, \u0026c)   //将自身添加到父节点\n    return \u0026c, func() { c.cancel(true, Canceled) }\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231498-ztv6c5t","Type":"NodeParagraph","Properties":{"id":"20230724231498-ztv6c5t","updated":"20230724231498"},"Children":[{"Type":"NodeText","Data":"这里将自身添加到父节点的过程有必要简单说明一下："}]},{"ID":"20230724231499-tmhbpuc","Type":"NodeList","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20230724231499-tmhbpuc","updated":"20230724231499"},"Children":[{"ID":"20230724231500-65u95ls","Type":"NodeListItem","Data":"1","ListData":{"Typ":1,"Tight":true,"Start":1,"Delimiter":46,"Padding":3,"Marker":"MQ==","Num":1},"Properties":{"id":"20230724231500-65u95ls","updated":"20230724231500"},"Children":[{"ID":"20230724231501-yan7fr9","Type":"NodeParagraph","Properties":{"id":"20230724231501-yan7fr9","updated":"20230724231501"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"如果父节点也支持cancel，也就是说其父节点肯定有children成员，那么把新context添加到children里即可；"}]}]},{"ID":"20230724231502-e4zs39x","Type":"NodeListItem","Data":"2","ListData":{"Typ":1,"Tight":true,"Start":2,"Delimiter":46,"Padding":3,"Marker":"Mg==","Num":2},"Properties":{"id":"20230724231502-e4zs39x","updated":"20230724231502"},"Children":[{"ID":"20230724231503-k9jcjzq","Type":"NodeParagraph","Properties":{"id":"20230724231503-k9jcjzq","updated":"20230724231503"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"如果父节点不支持cancel，就继续向上查询，直到找到一个支持cancel的节点，把新context添加到children里；"}]}]},{"ID":"20230724231504-f6ho02n","Type":"NodeListItem","Data":"3","ListData":{"Typ":1,"Tight":true,"Start":3,"Delimiter":46,"Padding":3,"Marker":"Mw==","Num":3},"Properties":{"id":"20230724231504-f6ho02n","updated":"20230724231504"},"Children":[{"ID":"20230724231505-5hlilfw","Type":"NodeParagraph","Properties":{"id":"20230724231505-5hlilfw","updated":"20230724231505"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"如果所有的父节点均不支持cancel，则启动一个协程等待父节点结束，然后再把当前context结束。"}]}]}]},{"ID":"20230724231506-tmojq1j","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231506-tmojq1j","updated":"20230724231506"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.3.5 典型使用案例"}]},{"ID":"20230724231507-9t7hy6k","Type":"NodeParagraph","Properties":{"id":"20230724231507-9t7hy6k","updated":"20230724231507"},"Children":[{"Type":"NodeText","Data":"一个典型的使用cancel context的例子如下所示："}]},{"ID":"20230724231508-dru0f3k","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231508-dru0f3k","updated":"20230724231508"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"package main\n\nimport (\n    \"fmt\"\n    \"time\"\n    \"context\"\n)\n\nfunc HandelRequest(ctx context.Context) {\n    go WriteRedis(ctx)\n    go WriteDatabase(ctx)\n    for {\n        select {\n        case \u003c-ctx.Done():\n            fmt.Println(\"HandelRequest Done.\")\n            return\n        default:\n            fmt.Println(\"HandelRequest running\")\n            time.Sleep(2 * time.Second)\n        }\n    }\n}\n\nfunc WriteRedis(ctx context.Context) {\n    for {\n        select {\n        case \u003c-ctx.Done():\n            fmt.Println(\"WriteRedis Done.\")\n            return\n        default:\n            fmt.Println(\"WriteRedis running\")\n            time.Sleep(2 * time.Second)\n        }\n    }\n}\n\nfunc WriteDatabase(ctx context.Context) {\n    for {\n        select {\n        case \u003c-ctx.Done():\n            fmt.Println(\"WriteDatabase Done.\")\n            return\n        default:\n            fmt.Println(\"WriteDatabase running\")\n            time.Sleep(2 * time.Second)\n        }\n    }\n}\n\nfunc main() {\n    ctx, cancel := context.WithCancel(context.Background())\n    go HandelRequest(ctx)\n\n    time.Sleep(5 * time.Second)\n    fmt.Println(\"It's time to stop all sub goroutines!\")\n    cancel()\n\n    //Just for test whether sub goroutines exit or not\n    time.Sleep(5 * time.Second)\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231509-cnvaxp2","Type":"NodeParagraph","Properties":{"id":"20230724231509-cnvaxp2","updated":"20230724231509"},"Children":[{"Type":"NodeText","Data":"上面代码中协程HandelRequest()用于处理某个请求，其又会创建两个协程：WriteRedis()、WriteDatabase()，main协程创建context，并把context在各子协程间传递，main协程在适当的时机可以cancel掉所有子协程。"}]},{"ID":"20230724231510-x79teeo","Type":"NodeParagraph","Properties":{"id":"20230724231510-x79teeo","updated":"20230724231510"},"Children":[{"Type":"NodeText","Data":"程序输出如下所示："}]},{"ID":"20230724231511-zaxqfpu","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231511-zaxqfpu","updated":"20230724231511"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"HandelRequest running\nWriteDatabase running\nWriteRedis running\nHandelRequest running\nWriteDatabase running\nWriteRedis running\nHandelRequest running\nWriteDatabase running\nWriteRedis running\nIt's time to stop all sub goroutines!\nWriteDatabase Done.\nHandelRequest Done.\nWriteRedis Done.\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231512-1tco6sq","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724231512-1tco6sq","updated":"20230724231512"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.4 timerCtx"}]},{"ID":"20230724231513-z06mf1u","Type":"NodeParagraph","Properties":{"id":"20230724231513-z06mf1u","updated":"20230724231513"},"Children":[{"Type":"NodeText","Data":"源码包中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"src/context/context.go:timerCtx"},{"Type":"NodeText","Data":" 定义了该类型context："}]},{"ID":"20230724231514-jv2lfb8","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231514-jv2lfb8","updated":"20230724231514"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"type timerCtx struct {\n    cancelCtx\n    timer *time.Timer // Under cancelCtx.mu.\n\n    deadline time.Time\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231515-bs04qez","Type":"NodeParagraph","Properties":{"id":"20230724231515-bs04qez","updated":"20230724231515"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"timerCtx在cancelCtx基础上增加了deadline用于标示自动cancel的最终时间，而timer就是一个触发自动cancel的定时器。"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]},{"ID":"20230724231516-cntfrme","Type":"NodeParagraph","Properties":{"id":"20230724231516-cntfrme","updated":"20230724231516"},"Children":[{"Type":"NodeText","Data":"由此，衍生出"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"WithDeadline()"},{"Type":"NodeText","Data":"和"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"WithTimeout()"},{"Type":"NodeText","Data":"。实现上这两种类型实现原理一样，只不过使用语境不一样："}]},{"ID":"20230724231517-zmy2mdi","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231517-zmy2mdi","updated":"20230724231517"},"Children":[{"ID":"20230724231518-1rsuqfn","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231518-1rsuqfn","updated":"20230724231518"},"Children":[{"ID":"20230724231519-9yvviqb","Type":"NodeParagraph","Properties":{"id":"20230724231519-9yvviqb","updated":"20230724231519"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"deadline: 指定最后期限"},{"Type":"NodeText","Data":"，比如context将2018.10.20 00:00:00之时自动结束"}]}]},{"ID":"20230724231520-qykarny","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231520-qykarny","updated":"20230724231520"},"Children":[{"ID":"20230724231521-hzb8f24","Type":"NodeParagraph","Properties":{"id":"20230724231521-hzb8f24","updated":"20230724231521"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"timeout: 指定最长存活时间"},{"Type":"NodeText","Data":"，比如context将在30s后结束。"}]}]}]},{"ID":"20230724231522-rjlp977","Type":"NodeParagraph","Properties":{"id":"20230724231522-rjlp977","updated":"20230724231522"},"Children":[{"Type":"NodeText","Data":"对于接口来说，timerCtx在cancelCtx基础上还需要实现Deadline()和cancel()方法，其中cancel()方法是重写的。"}]},{"ID":"20230724231523-t0e5jhs","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231523-t0e5jhs","updated":"20230724231523"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.4.1 Deadline()接口实现"}]},{"ID":"20230724231524-i4nv4rn","Type":"NodeParagraph","Properties":{"id":"20230724231524-i4nv4rn","updated":"20230724231524"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"Deadline()方法仅仅是返回timerCtx.deadline而矣"},{"Type":"NodeText","Data":"。而timerCtx.deadline是WithDeadline()或WithTimeout()方法设置的。"}]},{"ID":"20230724231525-8ohsa99","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231525-8ohsa99","updated":"20230724231525"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.4.2 cancel()接口实现"}]},{"ID":"20230724231526-ucgxl97","Type":"NodeParagraph","Properties":{"id":"20230724231526-ucgxl97","updated":"20230724231526"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"cancel()方法基本继承cancelCtx，只需要额外把timer关闭。"}]},{"ID":"20230724231527-md5bpky","Type":"NodeParagraph","Properties":{"id":"20230724231527-md5bpky","updated":"20230724231527"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"timerCtx被关闭后，timerCtx.cancelCtx.err将会存储关闭原因："},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]},{"ID":"20230724231528-l6z2fob","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231528-l6z2fob","updated":"20230724231528"},"Children":[{"ID":"20230724231529-4gomm0o","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231529-4gomm0o","updated":"20230724231529"},"Children":[{"ID":"20230724231530-gk2r5pq","Type":"NodeParagraph","Properties":{"id":"20230724231530-gk2r5pq","updated":"20230724231530"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"如果deadline到来之前手动关闭，则关闭原因与cancelCtx显示一致；"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]}]},{"ID":"20230724231531-i443aan","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231531-i443aan","updated":"20230724231531"},"Children":[{"ID":"20230724231532-kmcrozl","Type":"NodeParagraph","Properties":{"id":"20230724231532-kmcrozl","updated":"20230724231532"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"如果deadline到来时自动关闭，则原因为：”context deadline exceeded”"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]}]}]},{"ID":"20230724231533-duniweh","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231533-duniweh","updated":"20230724231533"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.4.3 WithDeadline()方法实现"}]},{"ID":"20230724231534-mweqsa3","Type":"NodeParagraph","Properties":{"id":"20230724231534-mweqsa3","updated":"20230724231534"},"Children":[{"Type":"NodeText","Data":"WithDeadline()方法实现步骤如下："}]},{"ID":"20230724231535-g1lx691","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231535-g1lx691","updated":"20230724231535"},"Children":[{"ID":"20230724231536-1xpbfgw","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231536-1xpbfgw","updated":"20230724231536"},"Children":[{"ID":"20230724231537-axlhdmu","Type":"NodeParagraph","Properties":{"id":"20230724231537-axlhdmu","updated":"20230724231537"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"初始化一个timerCtx实例"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]}]},{"ID":"20230724231538-haxzgu3","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231538-haxzgu3","updated":"20230724231538"},"Children":[{"ID":"20230724231539-tdq3wz7","Type":"NodeParagraph","Properties":{"id":"20230724231539-tdq3wz7","updated":"20230724231539"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"将timerCtx实例添加到其父节点的children中(如果父节点也可以被cancel的话)"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]}]},{"ID":"20230724231540-gunm5ya","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231540-gunm5ya","updated":"20230724231540"},"Children":[{"ID":"20230724231541-k10aevf","Type":"NodeParagraph","Properties":{"id":"20230724231541-k10aevf","updated":"20230724231541"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"启动定时器，定时器到期后会自动cancel本context"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]}]},{"ID":"20230724231542-myg7ijs","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231542-myg7ijs","updated":"20230724231542"},"Children":[{"ID":"20230724231543-o76wavu","Type":"NodeParagraph","Properties":{"id":"20230724231543-o76wavu","updated":"20230724231543"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"返回timerCtx实例和cancel()方法"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]}]}]},{"ID":"20230724231544-w3owxyh","Type":"NodeParagraph","Properties":{"id":"20230724231544-w3owxyh","updated":"20230724231544"},"Children":[{"Type":"NodeText","Data":"也就是说，"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"timerCtx类型的context不仅支持手动cancel，也会在定时器到来后自动cancel。"}]},{"ID":"20230724231545-ltyhozr","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231545-ltyhozr","updated":"20230724231545"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.4.4 WithTimeout()方法实现"}]},{"ID":"20230724231546-t2hr7yv","Type":"NodeParagraph","Properties":{"id":"20230724231546-t2hr7yv","updated":"20230724231546"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"WithTimeout()实际调用了WithDeadline"},{"Type":"NodeText","Data":"，二者实现原理一致。"}]},{"ID":"20230724231547-dq8ijcf","Type":"NodeParagraph","Properties":{"id":"20230724231547-dq8ijcf","updated":"20230724231547"},"Children":[{"Type":"NodeText","Data":"看代码会非常清晰："}]},{"ID":"20230724231548-wtrep8c","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231548-wtrep8c","updated":"20230724231548"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) {\n    return WithDeadline(parent, time.Now().Add(timeout))\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231549-stapnk0","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231549-stapnk0","updated":"20230724231549"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.4.5 典型使用案例"}]},{"ID":"20230724231550-bsnzloa","Type":"NodeParagraph","Properties":{"id":"20230724231550-bsnzloa","updated":"20230724231550"},"Children":[{"Type":"NodeText","Data":"下面例子中使用WithTimeout()获得一个context并在其子协程中传递："}]},{"ID":"20230724231551-gy37em2","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231551-gy37em2","updated":"20230724231551"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"package main\n\nimport (\n    \"fmt\"\n    \"time\"\n    \"context\"\n)\n\nfunc HandelRequest(ctx context.Context) {\n    go WriteRedis(ctx)\n    go WriteDatabase(ctx)\n    for {\n        select {\n        case \u003c-ctx.Done():\n            fmt.Println(\"HandelRequest Done.\")\n            return\n        default:\n            fmt.Println(\"HandelRequest running\")\n            time.Sleep(2 * time.Second)\n        }\n    }\n}\n\nfunc WriteRedis(ctx context.Context) {\n    for {\n        select {\n        case \u003c-ctx.Done():\n            fmt.Println(\"WriteRedis Done.\")\n            return\n        default:\n            fmt.Println(\"WriteRedis running\")\n            time.Sleep(2 * time.Second)\n        }\n    }\n}\n\nfunc WriteDatabase(ctx context.Context) {\n    for {\n        select {\n        case \u003c-ctx.Done():\n            fmt.Println(\"WriteDatabase Done.\")\n            return\n        default:\n            fmt.Println(\"WriteDatabase running\")\n            time.Sleep(2 * time.Second)\n        }\n    }\n}\n\nfunc main() {\n    ctx, _ := context.WithTimeout(context.Background(), 5 * time.Second)\n    go HandelRequest(ctx)\n\n    time.Sleep(10 * time.Second)\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231552-qnrggf7","Type":"NodeParagraph","Properties":{"id":"20230724231552-qnrggf7","updated":"20230724231552"},"Children":[{"Type":"NodeText","Data":"主协程中创建一个10s超时的context，并将其传递给子协程，10s自动关闭context。程序输出如下："}]},{"ID":"20230724231553-f12amz8","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231553-f12amz8","updated":"20230724231553"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"HandelRequest running\nWriteRedis running\nWriteDatabase running\nHandelRequest running\nWriteRedis running\nWriteDatabase running\nHandelRequest running\nWriteRedis running\nWriteDatabase running\nHandelRequest Done.\nWriteDatabase Done.\nWriteRedis Done.\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231554-v777p4y","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20230724231554-v777p4y","updated":"20230724231554"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.5 valueCtx"}]},{"ID":"20230724231555-lhe8y64","Type":"NodeParagraph","Properties":{"id":"20230724231555-lhe8y64","updated":"20230724231555"},"Children":[{"Type":"NodeText","Data":"源码包中"},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"code","TextMarkTextContent":"src/context/context.go:valueCtx"},{"Type":"NodeText","Data":" 定义了该类型context："}]},{"ID":"20230724231556-389v843","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231556-389v843","updated":"20230724231556"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"type valueCtx struct {\n    Context\n    key, val interface{}\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231557-t5jiji2","Type":"NodeParagraph","Properties":{"id":"20230724231557-t5jiji2","updated":"20230724231557"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"valueCtx只是在Context基础上增加了一个key-value对，用于在各级协程间传递一些数据。"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]},{"ID":"20230724231558-ba2f2pf","Type":"NodeParagraph","Properties":{"id":"20230724231558-ba2f2pf","updated":"20230724231558"},"Children":[{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"由于valueCtx既不需要cancel，也不需要deadline，那么只需要实现Value()接口即可。"}]},{"ID":"20230724231559-uutw2kz","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231559-uutw2kz","updated":"20230724231559"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.5.1 Value（）接口实现"}]},{"ID":"20230724231560-vcldw9t","Type":"NodeParagraph","Properties":{"id":"20230724231560-vcldw9t","updated":"20230724231560"},"Children":[{"Type":"NodeText","Data":"由valueCtx数据结构定义可见，valueCtx.key和valueCtx.val分别代表其key和value值。 实现也很简单："}]},{"ID":"20230724231561-hliqmzf","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231561-hliqmzf","updated":"20230724231561"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"func (c *valueCtx) Value(key interface{}) interface{} {\n    if c.key == key {\n        return c.val\n    }\n    return c.Context.Value(key)\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231562-udxbsaw","Type":"NodeParagraph","Properties":{"id":"20230724231562-udxbsaw","updated":"20230724231562"},"Children":[{"Type":"NodeText","Data":"这里有个细节需要关注一下，即"},{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"当前context查找不到key时，会向父节点查找，如果查询不到则最终返回interface{}。也就是说，可以通过子context查询到父的value值。"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]},{"ID":"20230724231563-2wl2lr3","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231563-2wl2lr3","updated":"20230724231563"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.5.2 WithValue（）方法实现"}]},{"ID":"20230724231564-4pu4snw","Type":"NodeParagraph","Properties":{"id":"20230724231564-4pu4snw","updated":"20230724231564"},"Children":[{"Type":"NodeText","Data":"WithValue()实现也是非常的简单, 伪代码如下："}]},{"ID":"20230724231565-xf7mf99","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231565-xf7mf99","updated":"20230724231565"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"func WithValue(parent Context, key, val interface{}) Context {\n    if key == nil {\n        panic(\"nil key\")\n    }\n    return \u0026valueCtx{parent, key, val}\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231566-bvpvo14","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20230724231566-bvpvo14","updated":"20230724231566"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"### ","Properties":{"id":""}},{"Type":"NodeText","Data":"2.5.3 典型使用案例"}]},{"ID":"20230724231567-j65q96f","Type":"NodeParagraph","Properties":{"id":"20230724231567-j65q96f","updated":"20230724231567"},"Children":[{"Type":"NodeText","Data":"下面示例程序展示valueCtx的用法："}]},{"ID":"20230724231568-78e176f","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockInfo":"Z28=","CodeBlockCloseFence":"YGBg","Properties":{"id":"20230724231568-78e176f","updated":"20230724231568"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Z28=","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"package main\n\nimport (\n    \"fmt\"\n    \"time\"\n    \"context\"\n)\n\nfunc HandelRequest(ctx context.Context) {\n    for {\n        select {\n        case \u003c-ctx.Done():\n            fmt.Println(\"HandelRequest Done.\")\n            return\n        default:\n            fmt.Println(\"HandelRequest running, parameter: \", ctx.Value(\"parameter\"))\n            time.Sleep(2 * time.Second)\n        }\n    }\n}\n\nfunc main() {\n    ctx := context.WithValue(context.Background(), \"parameter\", \"1\")\n    go HandelRequest(ctx)\n\n    time.Sleep(10 * time.Second)\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20230724231569-kuoqqce","Type":"NodeParagraph","Properties":{"id":"20230724231569-kuoqqce","updated":"20230724231569"},"Children":[{"Type":"NodeText","Data":"上例main()中通过WithValue()方法获得一个context，需要指定一个父context、key和value。然后通将该context传递给子协程HandelRequest，子协程可以读取到context的key-value。"}]},{"ID":"20230724231570-dufoi6o","Type":"NodeParagraph","Properties":{"id":"20230724231570-dufoi6o","updated":"20230724231570"},"Children":[{"Type":"NodeText","Data":"注意："},{"Type":"NodeTextMark","Properties":{"id":""},"TextMarkType":"strong","TextMarkTextContent":"本例中子协程无法自动结束，因为context是不支持cancle的，也就是说\u0026lt;-ctx.Done()永远无法返回。如果需要返回，需要在创建context时指定一个可以cancel的context作为父节点，使用父节点的cancel()在适当的时机结束整个context。"}]},{"ID":"20230724231571-jvqwrqh","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20230724231571-jvqwrqh","updated":"20230724231571"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"# ","Properties":{"id":""}},{"Type":"NodeText","Data":"总结"}]},{"ID":"20230724231572-89bt5un","Type":"NodeList","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231572-89bt5un","updated":"20230724231572"},"Children":[{"ID":"20230724231573-8bf80hl","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231573-8bf80hl","updated":"20230724231573"},"Children":[{"ID":"20230724231574-u1a7hvc","Type":"NodeParagraph","Properties":{"id":"20230724231574-u1a7hvc","updated":"20230724231574"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"Context仅仅是一个接口定义，根据实现的不同，可以衍生出不同的context类型；"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]}]},{"ID":"20230724231575-udjw5zi","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231575-udjw5zi","updated":"20230724231575"},"Children":[{"ID":"20230724231576-wv6oqf8","Type":"NodeParagraph","Properties":{"id":"20230724231576-wv6oqf8","updated":"20230724231576"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"cancelCtx实现了Context接口，通过WithCancel()创建cancelCtx实例；"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]}]},{"ID":"20230724231577-o8eam3w","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231577-o8eam3w","updated":"20230724231577"},"Children":[{"ID":"20230724231578-yu7nxho","Type":"NodeParagraph","Properties":{"id":"20230724231578-yu7nxho","updated":"20230724231578"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"timerCtx实现了Context接口，通过WithDeadline()和WithTimeout()创建timerCtx实例；"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]}]},{"ID":"20230724231579-3ym5yhh","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231579-3ym5yhh","updated":"20230724231579"},"Children":[{"ID":"20230724231580-6okqfrw","Type":"NodeParagraph","Properties":{"id":"20230724231580-6okqfrw","updated":"20230724231580"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"valueCtx实现了Context接口，通过WithValue()创建valueCtx实例；"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]}]},{"ID":"20230724231581-gz8yq8b","Type":"NodeListItem","Data":"-","ListData":{"Tight":true,"BulletChar":45,"Padding":2,"Marker":"LQ==","Num":-1},"Properties":{"id":"20230724231581-gz8yq8b","updated":"20230724231581"},"Children":[{"ID":"20230724231582-mzm8bfg","Type":"NodeParagraph","Properties":{"id":"20230724231582-mzm8bfg","updated":"20230724231582"},"Children":[{"Type":"NodeMark","Children":[{"Type":"NodeMark2OpenMarker","Data":"=="},{"Type":"NodeText","Data":"三种context实例可互为父节点，从而可以组合成不同的应用形式；"},{"Type":"NodeMark2CloseMarker","Data":"=="}]}]}]}]}]}